<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OP Mini Overlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            background: transparent !important;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }

        .drag-region {
            -webkit-app-region: drag;
        }

        .no-drag {
            -webkit-app-region: no-drag;
        }

        .glass {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scroll-area {
            max-height: 180px;
            overflow-y: auto;
        }

        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #06b6d4 0%, #3b82f6 100%);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #22d3ee 0%, #60a5fa 100%);
        }
    </style>
</head>

<body>
    <div id="overlay" class="glass rounded-lg shadow-2xl overflow-hidden" style="width: 100%;">

        <!-- Title Bar with controls -->
        <div id="title-bar" class="p-2 drag-region border-b border-white/10 flex items-center justify-between">
            <span class="text-cyan-400 text-xs font-bold">üè• OP Systems</span>
            <div class="flex gap-0.5 no-drag">
                <button onclick="openBlacklistPanel()" id="blacklist-btn" title="Blacklist"
                    class="w-5 h-5 flex items-center justify-center text-white bg-rose-600 hover:bg-rose-500 rounded text-[10px]">‚ö†Ô∏è</button>
                <button onclick="showAddMenu()" id="add-panel-btn" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"
                    class="w-5 h-5 flex items-center justify-center text-white bg-cyan-600 hover:bg-cyan-500 rounded text-xs font-bold">+</button>
                <button onclick="showSettingsMenu()" id="settings-btn" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"
                    class="w-5 h-5 flex items-center justify-center text-slate-400 hover:text-cyan-400 rounded text-[10px]">‚öôÔ∏è</button>
                <button id="lock-btn" onclick="toggleLock()" title="‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"
                    class="w-5 h-5 flex items-center justify-center text-slate-400 hover:text-amber-400 rounded text-[10px]">üîì</button>
                <button onclick="exitOverlay()" title="‡∏õ‡∏¥‡∏î"
                    class="w-5 h-5 flex items-center justify-center text-slate-400 hover:text-red-400 rounded text-[10px]">‚úï</button>
            </div>
        </div>

        <!-- Game Mode Notification -->
        <div id="game-mode-notify"
            class="hidden absolute top-12 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm font-bold z-50 transition-all duration-300">
        </div>

        <!-- Settings Menu -->
        <div id="settings-menu"
            class="hidden absolute left-2 top-10 w-[200px] glass rounded-lg p-2 z-50 border border-white/20">
            <div class="text-[10px] text-slate-400 mb-1">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Overlay</div>
            <div class="space-y-2">
                <div>
                    <label class="text-[9px] text-slate-500">Opacity (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)</label>
                    <input type="range" id="opacity-slider" min="30" max="100" value="95"
                        class="w-full h-1 rounded-lg appearance-none cursor-pointer bg-slate-700"
                        oninput="changeOpacity(this.value)">
                    <div class="flex justify-between text-[8px] text-slate-500">
                        <span>30%</span>
                        <span id="opacity-value">95%</span>
                        <span>100%</span>
                    </div>
                </div>
                <button onclick="saveCurrentPosition()"
                    class="w-full text-left px-2 py-1 hover:bg-white/10 rounded text-[10px] text-emerald-400">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ
                </button>
            </div>
        </div>


        <!-- Add Menu Dropdown -->
        <div id="add-menu"
            class="hidden absolute left-2 top-10 w-[200px] glass rounded-lg p-1 z-50 border border-white/20">
            <button onclick="openPanelWindow('price')"
                class="w-full text-left px-2 py-1 hover:bg-white/10 rounded text-xs text-emerald-400">üí∞
                ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤</button>
            <button onclick="openPanelWindow('copy')"
                class="w-full text-left px-2 py-1 hover:bg-white/10 rounded text-xs text-blue-400">üìã
                ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>

        </div>

        <!-- OP Info Header -->
        <div class="p-2 border-b border-white/10 text-[11px]">
            <div class="flex justify-between items-center">
                <span class="text-white">OP: <span id="op-name" class="text-cyan-400 font-bold">-</span> <span
                        id="op-ic" class="text-slate-500">-</span></span>
                <span id="op-timer" class="text-emerald-400 font-mono">00:00:00</span>
            </div>
            <div class="flex items-center mt-1">
                <span class="text-white">Sup OP: <span id="sup-op-name" class="text-purple-400 font-bold">-</span> <span
                        id="sup-op-ic" class="text-slate-500">-</span></span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-2 space-y-2 pb-3">
            <!-- On Duty Section -->
            <div>
                <div class="text-emerald-400 text-[11px] font-bold mb-1">üü¢ On Duty (<span id="on-duty-count">0</span>)
                </div>
                <div id="on-duty-list"
                    class="text-[10px] text-slate-300 space-y-0.5 max-h-[150px] overflow-y-auto pr-1">
                </div>
            </div>

            <!-- AFK Section -->
            <div>
                <div class="text-amber-400 text-[11px] font-bold mb-1">üí§ AFK (<span id="afk-count">0</span>)</div>
                <div id="afk-list" class="text-[10px] text-slate-400 space-y-0.5"></div>
            </div>

            <!-- Off Duty Section -->
            <div>
                <div class="text-slate-400 text-[11px] font-bold mb-1">‚ö´ Off Duty (<span id="off-duty-count">0</span>)
                </div>
                <div id="off-duty-list" class="text-[10px] text-slate-500 space-y-0.5"></div>
            </div>

            <!-- Stories Section -->
            <div class="border-t border-white/10 pt-2">
                <div class="text-rose-400 text-[11px] font-bold mb-1">‚öîÔ∏è ‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (<span id="story-count">0</span>)
                </div>
                <div id="story-list" class="text-[10px] text-slate-300 space-y-1.5 max-h-[120px] overflow-y-auto pr-1">
                </div>
            </div>
        </div>
        <!-- Bottom Border -->
        <div class="h-[3px] bg-gradient-to-r from-cyan-500/50 via-purple-500/50 to-rose-500/50"></div>
    </div>

    <script>
        // Firebase config (same as main app)
        const firebaseConfig = {
            apiKey: "AIzaSyCPnd6bmpPe0cbWXbNh2LsYaeGcFHZNNsU",
            authDomain: "medic-op.firebaseapp.com",
            projectId: "medic-op",
            storageBucket: "medic-op.firebasestorage.app",
            messagingSenderId: "628357107384",
            appId: "1:628357107384:web:3050de54d5a84d10ae75e2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let isExpanded = false;

        function toggleExpand() {
            isExpanded = !isExpanded;
            document.getElementById('collapsed-view').classList.toggle('hidden', isExpanded);
            document.getElementById('expanded-view').classList.toggle('hidden', !isExpanded);

            if (isExpanded) {
                window.overlayAPI.expand();
            } else {
                window.overlayAPI.collapse();
            }
        }

        function hideOverlay() {
            window.overlayAPI.hide();
        }

        function exitOverlay() {
            window.overlayAPI.exit();
        }

        let isLocked = false;
        function toggleLock() {
            isLocked = !isLocked;
            const titleBar = document.getElementById('title-bar');
            const lockBtn = document.getElementById('lock-btn');

            if (isLocked) {
                titleBar.classList.remove('drag-region');
                lockBtn.textContent = 'üîí';
                lockBtn.classList.add('text-amber-400');
            } else {
                titleBar.classList.add('drag-region');
                lockBtn.textContent = 'üîì';
                lockBtn.classList.remove('text-amber-400');
            }
        }

        // Game Mode Notification
        if (window.overlayAPI?.onGameModeChanged) {
            window.overlayAPI.onGameModeChanged((isGameMode) => {
                const notify = document.getElementById('game-mode-notify');
                if (isGameMode) {
                    notify.textContent = 'üéÆ Game Mode ON';
                    notify.className = 'absolute top-12 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm font-bold z-50 bg-emerald-600/90 text-white';
                } else {
                    notify.textContent = 'üñ±Ô∏è Interactive Mode';
                    notify.className = 'absolute top-12 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm font-bold z-50 bg-amber-600/90 text-white';
                }
                notify.classList.remove('hidden');
                setTimeout(() => notify.classList.add('hidden'), 1500);
            });
        }

        // Add Menu
        function showAddMenu() {
            const menu = document.getElementById('add-menu');
            document.getElementById('settings-menu').classList.add('hidden');
            menu.classList.toggle('hidden');
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeAddMenu, { once: true });
            }, 10);
        }
        function closeAddMenu(e) {
            const menu = document.getElementById('add-menu');
            if (!menu.contains(e.target) && e.target.id !== 'add-panel-btn') {
                menu.classList.add('hidden');
            }
        }

        // Settings Menu
        function showSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            document.getElementById('add-menu').classList.add('hidden');
            menu.classList.toggle('hidden');
            // Load current opacity from shared settings
            if (window.overlayAPI?.getAllOpacity) {
                window.overlayAPI.getAllOpacity().then(opacity => {
                    const slider = document.getElementById('opacity-slider');
                    const value = document.getElementById('opacity-value');
                    if (opacity) {
                        slider.value = Math.round(opacity * 100);
                        value.textContent = slider.value + '%';
                    }
                });
            }
            setTimeout(() => {
                document.addEventListener('click', closeSettingsMenu, { once: true });
            }, 10);
        }
        function closeSettingsMenu(e) {
            const menu = document.getElementById('settings-menu');
            if (!menu.contains(e.target) && e.target.id !== 'settings-btn') {
                menu.classList.add('hidden');
            }
        }
        function changeOpacity(value) {
            document.getElementById('opacity-value').textContent = value + '%';
            if (window.overlayAPI?.setAllOpacity) {
                window.overlayAPI.setAllOpacity(value / 100);
            }
        }
        function saveCurrentPosition() {
            if (window.overlayAPI?.savePosition) {
                window.overlayAPI.savePosition();
                // Visual feedback
                const btn = event.target;
                btn.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                setTimeout(() => btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ', 1500);
            }
        }

        // Open panel as separate window
        function openPanelWindow(panelType) {
            window.overlayAPI.openPanel(panelType);
            document.getElementById('add-menu').classList.add('hidden');
        }

        // Open Blacklist panel (focused mode - hides other overlays)
        function openBlacklistPanel() {
            if (window.overlayAPI?.openBlacklistPanel) {
                window.overlayAPI.openBlacklistPanel();
            }
        }

        // Copy Story Announcement (Cooldown / Enter Area) - Exact text from Desktop OP
        function copyStoryAnnounce(type, partyA, partyB) {
            const cmd = '/an';
            let msg = '';

            if (type === 'cooldown') {
                // Exact text from Desktop OP line 8293
                const now = new Date();
                const later = new Date(now.getTime() + 10 * 60 * 1000);
                const timeFormat = { hour: '2-digit', minute: '2-digit' };
                const nowStr = now.toLocaleTimeString('th-TH', timeFormat);
                const laterStr = later.toLocaleTimeString('th-TH', timeFormat);
                msg = `${cmd} ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${partyA} vs ${partyB} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤ ${nowStr} - ${laterStr} ‡∏ô. ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`;
            } else {
                // Exact text from Desktop OP line 8294
                msg = `${cmd} ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà ${partyA} vs ${partyB} ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πä‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å`;
            }

            navigator.clipboard.writeText(msg);
            // Show feedback
            const buttons = event.target.closest('.flex')?.querySelectorAll('button');
            if (buttons) {
                buttons.forEach(btn => btn.disabled = true);
            }
            event.target.textContent = '‚úÖ Copied!';
            event.target.classList.add('bg-emerald-600');
            setTimeout(() => {
                event.target.textContent = type === 'cooldown' ? 'üìã ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå' : 'üìã ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà';
                event.target.classList.remove('bg-emerald-600');
                if (buttons) {
                    buttons.forEach(btn => btn.disabled = false);
                }
            }, 1000);
        }

        // Toggle OP Controls Panel
        function toggleOPControlsPanel() {
            const panel = document.getElementById('panel-opcontrols');
            document.getElementById('add-menu').classList.add('hidden');

            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                activePanel = 'opcontrols';
                renderOPControls();
            } else {
                panel.classList.add('hidden');
                activePanel = null;
            }
        }

        // Floating Panels
        const panelLocks = {};

        function showFloatingPanel(panelName) {
            const panel = document.getElementById(`floating-${panelName}`);
            if (panel) {
                panel.classList.remove('hidden');
                if (panelName === 'blacklist') loadFloatingBlacklist();
            }
            document.getElementById('add-menu').classList.add('hidden');
        }

        function hideFloatingPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) panel.classList.add('hidden');
        }

        function togglePanelLock(panelId) {
            panelLocks[panelId] = !panelLocks[panelId];
            const panel = document.getElementById(panelId);
            const lockBtn = panel.querySelector('.panel-lock');
            const header = panel.querySelector('.panel-header');

            if (panelLocks[panelId]) {
                lockBtn.textContent = 'üîí';
                lockBtn.classList.add('text-amber-400');
                header.classList.remove('cursor-move');
            } else {
                lockBtn.textContent = 'üîì';
                lockBtn.classList.remove('text-amber-400');
                header.classList.add('cursor-move');
            }
        }

        // Drag functionality for floating panels
        let dragPanel = null;
        let dragOffset = { x: 0, y: 0 };

        function startDrag(e, panelId) {
            if (panelLocks[panelId]) return;
            e.preventDefault();
            dragPanel = document.getElementById(panelId);
            const rect = dragPanel.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if (!dragPanel) return;
            dragPanel.style.left = (e.clientX - dragOffset.x) + 'px';
            dragPanel.style.top = (e.clientY - dragOffset.y) + 'px';
        }

        function stopDrag() {
            dragPanel = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function loadFloatingBlacklist() {
            db.collection('blacklist').limit(10).get().then(snapshot => {
                const content = document.getElementById('floating-blacklist-content');
                if (snapshot.empty) {
                    content.innerHTML = '<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                    return;
                }
                content.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="flex justify-between py-1 border-b border-white/5">
                        <span>${d.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        <span class="text-red-400 text-[10px]">${d.reason || '-'}</span>
                    </div>`;
                }).join('');
            }).catch(() => {
                document.getElementById('floating-blacklist-content').innerHTML = '<div class="text-red-400">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
            });
        }

        // Feature Panels
        let activePanel = null;
        function togglePanel(panelName) {
            const panels = ['price', 'copy', 'blacklist', 'opcontrols'];
            panels.forEach(p => {
                const panel = document.getElementById(`panel-${p}`);
                if (p === panelName && activePanel !== panelName) {
                    panel.classList.remove('hidden');
                    if (p === 'blacklist') loadBlacklist();
                    if (p === 'opcontrols') renderOPControls();
                } else {
                    panel.classList.add('hidden');
                }
            });
            activePanel = activePanel === panelName ? null : panelName;

            // Resize window based on active panel
            if (activePanel) {
                window.overlayAPI.expandPanel();
            } else {
                window.overlayAPI.collapsePanel();
            }
        }

        function copyCommand(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.classList.add('bg-emerald-600');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-emerald-600');
                }, 1000);
            });
        }

        function loadBlacklist() {
            db.collection('blacklist').limit(10).get().then(snapshot => {
                const content = document.getElementById('blacklist-content');
                if (snapshot.empty) {
                    content.innerHTML = '<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                    return;
                }
                content.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="flex justify-between py-1 border-b border-white/5">
                        <span>${d.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
                        <span class="text-red-400">${d.reason || '-'}</span>
                    </div>`;
                }).join('');
            }).catch(err => {
                document.getElementById('blacklist-content').innerHTML = '<div class="text-red-400">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
            });
        }

        // OP Controls Functions
        let currentData = null;
        let isOP = false;
        let allUsers = []; // Store user data for IC phones

        // Load all users for IC phone lookup
        db.collection('op_users').onSnapshot(snap => {
            allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        });

        // OP Timer - Update every second (like Desktop)
        setInterval(() => {
            const timerEl = document.getElementById('op-timer');
            if (!timerEl || !currentData?.shiftStart) {
                if (timerEl) timerEl.textContent = '00:00:00';
                return;
            }
            const d = Date.now() - currentData.shiftStart;
            const h = String(Math.floor(d / 3600000)).padStart(2, '0');
            const m = String(Math.floor((d % 3600000) / 60000)).padStart(2, '0');
            const s = String(Math.floor((d % 60000) / 1000)).padStart(2, '0');
            timerEl.textContent = `${h}:${m}:${s}`;
        }, 1000);

        function checkIfOP(data) {
            // Get username from URL params
            const params = new URLSearchParams(window.location.search);
            const userData = params.get('userData');
            if (!userData) return false;
            try {
                const user = JSON.parse(decodeURIComponent(userData));
                // Allow OP, Sup OP, or Admin/Owner role (case-insensitive)
                const role = (user.role || '').toLowerCase();
                const isAdmin = role === 'admin' || role === 'owner';
                const isCurrentOP = data.currentOP === user.username;
                const isSupOP = data.supOP === user.username;
                console.log('üîê OP Check:', { username: user.username, role: user.role, isAdmin, isCurrentOP, isSupOP });
                return isCurrentOP || isSupOP || isAdmin;
            } catch (e) {
                console.error('‚ùå checkIfOP error:', e);
                return false;
            }
        }

        // Helper to check if current user is OP (firstName match)
        function checkIfOP(data) {
            if (!data?.currentOP) return false;
            let currentUser = null;
            try {
                const params = new URLSearchParams(window.location.search);
                const userDataStr = params.get('userData');
                if (userDataStr) currentUser = JSON.parse(decodeURIComponent(userDataStr));
            } catch (e) { }

            if (!currentUser) return false;

            // Check first name match
            const userFirst = currentUser.fullName?.split(' ')[0];
            const opFirst = data.currentOP?.split(' ')[0];
            const supOpFirst = data.supOP?.split(' ')[0];

            return (userFirst && opFirst && userFirst === opFirst) ||
                (userFirst && supOpFirst && userFirst === supOpFirst);
        }

        function renderOPControls() {
            if (!currentData) return;
            const onDuty = currentData.onDuty || [];
            const afk = currentData.afk || [];
            const statuses = currentData.medicStatuses || {};
            const isOP = checkIfOP(currentData);

            // On Duty List with status buttons
            const onDutyEl = document.getElementById('op-onduty-list');
            if (onDuty.length > 0) {
                onDutyEl.innerHTML = onDuty.map((name, idx) => {
                    const status = statuses[name] || 'none';
                    const statusIcon = status === 'accept' ? '‚úÖ' : status === 'waitfix' ? '‚è≥' : status === 'decline' ? '‚ùå' : '‚ö™';

                    const controls = isOP ? `
                        <div class="flex gap-1 justify-center">
                            <button onclick="changeMedicStatus('${name}', 'accept')" 
                                class="text-[9px] px-2 py-0.5 rounded ${status === 'accept' ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-emerald-600/50'}">
                                ‚úÖ ‡∏£‡∏±‡∏ö
                            </button>
                            <button onclick="changeMedicStatus('${name}', 'waitfix')" 
                                class="text-[9px] px-2 py-0.5 rounded ${status === 'waitfix' ? 'bg-amber-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-amber-600/50'}">
                                ‚è≥ ‡∏£‡∏≠‡πÅ‡∏Å‡πâ
                            </button>
                            <button onclick="changeMedicStatus('${name}', 'decline')" 
                                class="text-[9px] px-2 py-0.5 rounded ${status === 'decline' ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-red-600/50'}">
                                ‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö
                            </button>
                        </div>
                    ` : '';

                    return `
                    <div class="flex flex-col gap-1 bg-slate-800/50 px-2 py-1.5 rounded">
                        <div class="flex justify-between items-center">
                            <span class="flex-1">${statusIcon} ${idx + 1}. ${name.split(' ')[0]}</span>
                            ${isOP ? `
                            <div class="flex gap-1">
                                <button onclick="moveToAFK('${name}')" class="text-amber-400 hover:bg-amber-500/20 px-1 rounded" title="‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ AFK">üí§</button>
                                <button onclick="removeFromDuty('${name}')" class="text-red-400 hover:bg-red-500/20 px-1 rounded" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏£">üö´</button>
                            </div>` : ''}
                        </div>
                        ${controls}
                    </div>`;
                }).join('');
            } else {
                onDutyEl.innerHTML = '<div class="text-slate-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ</div>';
            }

            // AFK List
            const afkEl = document.getElementById('op-afk-list');
            if (afk.length > 0) {
                afkEl.innerHTML = afk.map(name => `
                    <div class="flex justify-between items-center bg-slate-800/50 px-2 py-1 rounded">
                        <span class="flex-1">${name.split(' ')[0]}</span>
                        ${isOP ? `<button onclick="moveToOnDuty('${name}')" class="text-emerald-400 hover:bg-emerald-500/20 px-1 rounded" title="‡∏Å‡∏•‡∏±‡∏ö On Duty">‚úÖ</button>` : ''}
                    </div>
                `).join('');
            } else {
                afkEl.innerHTML = '<div class="text-slate-500 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ</div>';
            }
        }

        function changeMedicStatus(name, status) {
            if (!currentData) return;
            const statuses = { ...(currentData.medicStatuses || {}) };

            // If clicking the same status again, toggle it off
            if (statuses[name] === status) {
                delete statuses[name];
                console.log(`üîÑ Status cleared: ${name}`);
            } else {
                // For 'accept' - only allow 1 person to have accept status
                if (status === 'accept') {
                    // Clear accept from all others first
                    Object.keys(statuses).forEach(key => {
                        if (statuses[key] === 'accept') {
                            delete statuses[key];
                        }
                    });
                }
                statuses[name] = status;
                console.log(`‚úÖ Status changed: ${name} -> ${status}`);
            }

            db.collection('op_data').doc('current').update({
                medicStatuses: statuses
            }).catch(err => {
                console.error('Failed to update status:', err);
            });
        }

        function moveToAFK(name) {
            if (!currentData) return;
            const onDuty = currentData.onDuty || [];
            const afk = currentData.afk || [];

            // Remove from onDuty, add to afk
            const newOnDuty = onDuty.filter(n => n !== name);
            const newAfk = [...afk, name];

            db.collection('op_data').doc('current').update({
                onDuty: newOnDuty,
                afk: newAfk
            });
        }

        function moveToOnDuty(name) {
            if (!currentData) return;
            const onDuty = currentData.onDuty || [];
            const afk = currentData.afk || [];

            // Remove from afk, add to onDuty
            const newAfk = afk.filter(n => n !== name);
            const newOnDuty = [...onDuty, name];

            db.collection('op_data').doc('current').update({
                onDuty: newOnDuty,
                afk: newAfk
            });
        }

        function removeFromDuty(name) {
            if (!currentData) return;
            const onDuty = currentData.onDuty || [];

            // Remove from onDuty completely
            const newOnDuty = onDuty.filter(n => n !== name);

            db.collection('op_data').doc('current').update({
                onDuty: newOnDuty
            });
        }

        // Real-time listener
        db.collection('op_data').doc('current').onSnapshot(doc => {
            if (!doc.exists) return;
            const data = doc.data();

            // Store data for OP controls
            currentData = data;

            // Check if user is OP (for logging only)
            isOP = checkIfOP(data);
            // OP Controls button is always visible now

            // Re-render OP controls if panel is open
            if (activePanel === 'opcontrols') {
                renderOPControls();
            }

            // OP Name and IC
            const fullName = data.currentOP || '-';
            const opName = fullName.split(' ')[0];
            document.getElementById('op-name').textContent = opName;
            document.getElementById('op-ic').textContent = data.currentOPIC || '-';

            // Sup OP - uses 'supOP' field (not currentSupOP)
            const supFullName = data.supOP || '-';
            const supFirstName = supFullName !== '-' ? supFullName.split(' ')[0] : '-';
            document.getElementById('sup-op-name').textContent = supFirstName;
            // Lookup Sup OP IC from allUsers
            const supUser = allUsers.find(u => u.fullName === supFullName || u.firstName === supFirstName);
            document.getElementById('sup-op-ic').textContent = supUser?.icPhone || '-';

            // Counts
            const onDuty = data.onDuty || [];
            const afk = data.afk || [];
            const offDuty = data.offDuty || [];
            const cases = data.cases || [];
            const activeCases = cases.filter(c => !c.closed);

            document.getElementById('on-duty-count').textContent = onDuty.length;
            document.getElementById('afk-count').textContent = afk.length;
            document.getElementById('off-duty-count').textContent = offDuty.length;
            document.getElementById('story-count').textContent = activeCases.length;

            // On Duty List - with IC, status, and OP controls
            const onDutyListEl = document.getElementById('on-duty-list');
            const medicStatuses = data.medicStatuses || {};
            if (onDuty.length > 0) {
                onDutyListEl.innerHTML = onDuty.map(n => {
                    const firstName = n.split(' ')[0];
                    const matchedUser = allUsers.find(u => u.firstName && u.firstName === firstName);
                    const icPhone = matchedUser?.icPhone || '';
                    const st = medicStatuses[n] || '';
                    const statusIcon = st === 'accept' ? '‚úì' : st === 'waitfix' ? '‚è≥' : st === 'decline' ? '‚ùå' : '';
                    const statusClass = st === 'accept' ? 'text-cyan-400' : st === 'waitfix' ? 'text-amber-400' : st === 'decline' ? 'text-rose-400' : 'text-slate-500';
                    const phoneDisplay = icPhone ? `<span class="text-slate-500 ml-1">üìû${icPhone}</span>` : '';
                    const statusDisplay = statusIcon ? `<span class="${statusClass} ml-1">${statusIcon}</span>` : '';

                    // OP Controls - show status buttons if user is OP
                    let opButtons = '';
                    if (isOP) {
                        opButtons = `
                            <div class="flex gap-0.5 ml-auto">
                                <button onclick="changeMedicStatus('${n}', 'accept')" 
                                    class="text-[8px] px-1 rounded ${st === 'accept' ? 'bg-emerald-600 text-white' : 'bg-slate-700/50 text-slate-400 hover:bg-emerald-600/50'}" title="‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™">‚úÖ</button>
                                <button onclick="changeMedicStatus('${n}', 'waitfix')" 
                                    class="text-[8px] px-1 rounded ${st === 'waitfix' ? 'bg-amber-600 text-white' : 'bg-slate-700/50 text-slate-400 hover:bg-amber-600/50'}" title="‡∏£‡∏≠‡πÄ‡∏Ñ‡∏™‡πÅ‡∏Å‡πâ">‚è≥</button>
                                <button onclick="changeMedicStatus('${n}', 'decline')" 
                                    class="text-[8px] px-1 rounded ${st === 'decline' ? 'bg-red-600 text-white' : 'bg-slate-700/50 text-slate-400 hover:bg-red-600/50'}" title="‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™">‚ùå</button>
                            </div>`;
                    }
                    return `<div class="flex items-center"><span>‚Ä¢ ${firstName}</span>${phoneDisplay}${statusDisplay}${opButtons}</div>`;
                }).join('');
            } else {
                onDutyListEl.innerHTML = '<div class="text-slate-500">-</div>';
            }

            // AFK List - with timer from afkTimes
            const afkListEl = document.getElementById('afk-list');
            const afkTimes = data.afkTimes || {};
            if (afk.length > 0) {
                afkListEl.innerHTML = afk.map(name => {
                    const n = name.split(' ')[0];
                    const start = afkTimes[name] || Date.now();
                    const elapsed = Math.floor((Date.now() - start) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    const timeStr = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                    return `<div class="flex justify-between"><span>‚Ä¢ ${n}</span><span class="text-amber-500">${timeStr}</span></div>`;
                }).join('');
            } else {
                afkListEl.innerHTML = '<div class="text-slate-500">-</div>';
            }

            // Off Duty List
            const offDutyListEl = document.getElementById('off-duty-list');
            if (offDuty.length > 0) {
                offDutyListEl.innerHTML = offDuty.map(name => {
                    const n = typeof name === 'string' ? name.split(' ')[0] : name.name?.split(' ')[0] || '?';
                    return `<div>‚Ä¢ ${n}</div>`;
                }).join('');
            } else {
                offDutyListEl.innerHTML = '<div class="text-slate-500">-</div>';
            }

            // Stories List - show pairs with what, where, time (today only)
            const storyListEl = document.getElementById('story-list');

            // Filter by storyDate (YYYY-MM-DD format) to show only today's stories
            const now = new Date();
            const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            const todayCases = activeCases.filter(c => {
                // If no storyDate, include it (current shift story)
                if (!c.storyDate) return true;
                return c.storyDate === todayStr;
            });

            document.getElementById('story-count').textContent = todayCases.length;

            if (todayCases.length > 0) {
                // Get current user info for permission check
                let currentUsername = '';
                try {
                    const params = new URLSearchParams(window.location.search);
                    const userData = params.get('userData');
                    if (userData) {
                        const user = JSON.parse(decodeURIComponent(userData));
                        currentUsername = user.fullName || user.username || '';
                    }
                } catch (e) { }

                storyListEl.innerHTML = todayCases.map((c, i) => {
                    const medics = c.medics ? c.medics.map(m => m.split(' ')[0]).join(', ') : '-';
                    const storyType = c.storyType || c.caseType || '‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà';
                    const location = c.location || '-';
                    const timeStr = c.startTime || '-';

                    // Check if current user can see copy buttons (OP or assigned medic)
                    const isAssigned = c.medics && c.medics.some(m => m.includes(currentUsername.split(' ')[0]));
                    const canCopy = isOP || isAssigned;

                    // Copy buttons HTML (only for authorized users)
                    const copyButtons = canCopy ? `
                        <div class="flex gap-1 mt-1">
                            <button onclick="copyStoryAnnounce('cooldown', '${c.partyA}', '${c.partyB}')" 
                                class="text-[8px] px-1.5 py-0.5 bg-cyan-700/60 hover:bg-cyan-600 text-white rounded">üìã ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå</button>
                            <button onclick="copyStoryAnnounce('enter', '${c.partyA}', '${c.partyB}')" 
                                class="text-[8px] px-1.5 py-0.5 bg-purple-700/60 hover:bg-purple-600 text-white rounded">üìã ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
                        </div>
                    ` : '';

                    return `<div class="bg-slate-800/50 rounded p-1.5">
                        <div class="flex justify-between items-center">
                            <span class="text-rose-300 font-medium">${c.partyA || '?'} vs ${c.partyB || '?'}</span>
                            <span class="text-cyan-400 text-[9px]">${timeStr}</span>
                        </div>
                        <div class="text-slate-400 text-[9px] mt-0.5">üìç ${location} ‚Ä¢ üìã ${storyType}</div>
                        <div class="text-emerald-400 text-[9px]">üë®‚Äç‚öïÔ∏è ${medics}</div>
                        ${copyButtons}
                    </div>`;
                }).join('');
            } else {
                storyListEl.innerHTML = '<div class="text-slate-500 text-center py-1">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
            }

            // Auto-resize window based on content height
            requestAnimationFrame(() => {
                const overlay = document.getElementById('overlay');
                if (overlay && window.overlayAPI?.resizeToFit) {
                    const height = overlay.offsetHeight + 20; // Add padding
                    window.overlayAPI.resizeToFit(height);
                }
            });
        });
    </script>
</body>

</html>