name: Build EXE
on:
  push:
    branches: [main, master]
    paths:
      - 'electron-app/**'
      - '.github/workflows/build-exe.yml'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Install dependencies
        working-directory: electron-app
        run: npm ci

      - name: Build and Publish
        working-directory: electron-app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run publish

      - name: Get app info from package.json
        id: app_info
        working-directory: electron-app
        shell: pwsh
        run: |
          $pkg = Get-Content package.json | ConvertFrom-Json
          $productName = $pkg.build.productName -replace ' ', '-'
          $version = $pkg.version
          echo "PRODUCT_NAME=$productName" >> $env:GITHUB_OUTPUT
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "ZIP_NAME=$productName-$version-portable.zip" >> $env:GITHUB_OUTPUT

      - name: Create portable ZIP from win-unpacked
        working-directory: electron-app/dist
        shell: pwsh
        run: |
          $zipName = "${{ steps.app_info.outputs.ZIP_NAME }}"
          Write-Host "Creating portable ZIP: $zipName"
          Compress-Archive -Path "win-unpacked\*" -DestinationPath $zipName -Force
          Write-Host "ZIP created successfully!"
          Get-ChildItem $zipName

      - name: Upload portable ZIP to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: electron-app/dist/${{ steps.app_info.outputs.ZIP_NAME }}
          tag_name: v${{ steps.app_info.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (EXE + ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: Medical-OP-Systems-Setup
          path: |
            electron-app/dist/*.exe
            electron-app/dist/*.zip
          retention-days: 30
