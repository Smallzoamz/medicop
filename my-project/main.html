<!DOCTYPE html>
<html lang="th" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One City Medical Recruitment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" href="https://img5.pic.in.th/file/secure-sv1/image352ad154a6a24fdc.png" type="image/png">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.8s ease-out', 'scroll-up': 'scrollUp 20s linear infinite', 'popup': 'popup 0.3s cubic-bezier(0.16, 1, 0.3, 1)' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        scrollUp: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-50%)' } },
                        popup: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* Windows 11 Design System */
        :root {
            --win11-radius: 12px;
            --win11-radius-lg: 16px;
            --win11-radius-sm: 8px;
            --win11-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
            --win11-shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            --win11-blur: blur(20px);
            --win11-transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .dark body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        /* Windows 11 Glass/Mica Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: var(--win11-blur);
            -webkit-backdrop-filter: var(--win11-blur);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: var(--win11-radius);
            box-shadow: var(--win11-shadow);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .pause-hover:hover {
            animation-play-state: paused;
        }

        .btn-smooth {
            transition: var(--win11-transition);
            border-radius: var(--win11-radius-sm);
        }

        .btn-smooth:active {
            transform: scale(0.97);
        }

        .btn-smooth:hover {
            transform: translateY(-1px);
        }

        /* Windows 11 Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.5);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.8);
        }

        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: opacity, transform;
        }

        .reveal-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Windows 11 Input Style */
        .inp-primary {
            border-radius: var(--win11-radius-sm);
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            outline: none;
            transition: var(--win11-transition);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .inp-primary:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        /* Animations for Popups */
        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #10b981;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 10% auto;
            box-shadow: inset 0px 0px 0px #10b981;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .checkmark-check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        .cross-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #ef4444;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .cross-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            margin: 10% auto;
            box-shadow: inset 0px 0px 0px #ef4444;
            animation: fill-red .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .cross-line {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {

            0%,
            100% {
                transform: none;
            }

            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px #10b981;
            }
        }

        @keyframes fill-red {
            100% {
                box-shadow: inset 0px 0px 0px 30px #ef4444;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dark .inp-primary {
            background-color: rgba(51, 65, 85, 0.8);
            border-color: rgba(71, 85, 105, 0.5);
            color: #f1f5f9;
        }

        .dark .inp-primary:focus {
            background-color: rgba(30, 41, 59, 0.9);
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Windows 11 Card Style */
        .win11-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--win11-blur);
            border-radius: var(--win11-radius-lg);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: var(--win11-shadow);
            transition: var(--win11-transition);
        }

        .win11-card:hover {
            box-shadow: var(--win11-shadow-lg);
            transform: translateY(-2px);
        }

        .dark .win11-card {
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Windows 11 Button Style */
        .win11-btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--win11-radius-sm);
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--win11-transition);
            border: 1px solid transparent;
            cursor: pointer;
        }

        .win11-btn:hover {
            transform: translateY(-1px);
        }

        .win11-btn:active {
            transform: scale(0.98);
        }

        .win11-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
        }

        .win11-btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .win11-btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark .win11-btn-secondary {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Input Groups with Icons */
        .input-group {
            position: relative;
            width: 100%;
        }

        .input-group-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 10;
        }

        .inp-icon-pad {
            padding-left: 45px !important;
        }

        /* Admin Data Grids */
        .admin-header {
            font-weight: bold;
            font-size: 0.85rem;
            color: #64748b;
            padding: 0.5rem 0.75rem;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .dark .admin-header {
            color: #94a3b8;
            border-bottom-color: #334155;
        }

        .admin-grid-row {
            display: grid;
            gap: 0.75rem;
            align-items: center;
        }

        /* Grid Column Definitions */
        .grid-announce {
            grid-template-columns: 1fr 50px;
        }

        .grid-blacklist {
            grid-template-columns: 1fr 1.5fr 0.8fr 100px 50px;
        }

        .grid-founders {
            grid-template-columns: 60px 1.5fr 1fr 50px;
        }

        .grid-roster {
            grid-template-columns: 1fr 130px 150px 150px 140px 50px;
        }

        .grid-retired {
            grid-template-columns: 1fr 140px 80px 50px;
        }

        @media (max-width: 768px) {
            .admin-grid-row {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        html {
            scroll-behavior: smooth;
            scroll-padding-top: 90px;
        }
    </style>
</head>

<body
    class="bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800 dark:from-slate-900 dark:to-slate-950 dark:text-slate-100 transition-colors duration-300 overflow-x-hidden min-h-screen">
    <!-- Navbar (Windows 11 Style) -->
    <nav class="fixed w-full z-50 bg-white/85 dark:bg-slate-900/85 backdrop-blur-2xl border-b border-slate-200/50 dark:border-slate-800/50 transition-all duration-300 shadow-sm"
        id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center cursor-pointer group" onclick="navigateTo('home')">
                    <img id="nav-logo" src="" alt="EMS"
                        class="h-10 w-10 mr-3 group-hover:rotate-12 transition duration-500 drop-shadow-md">
                    <div>
                        <span
                            class="block text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-sky-500 to-blue-600 dark:from-sky-400 dark:to-blue-500">ONE
                            CITY</span>
                        <span
                            class="block text-[10px] text-slate-500 dark:text-slate-400 tracking-wider font-semibold -mt-1">MEDICAL
                            CENTER</span>
                    </div>
                </div>
                <div class="hidden lg:flex items-center space-x-1">
                    <button onclick="navigateTo('home')"
                        class="nav-item px-3 py-2 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-sky-600 dark:hover:text-sky-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition btn-smooth"
                        data-target="home">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                    <button onclick="navigateTo('announcement')"
                        class="nav-item px-3 py-2 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-sky-600 dark:hover:text-sky-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition btn-smooth"
                        data-target="announcement">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                    <button onclick="navigateTo('status')"
                        class="nav-item px-3 py-2 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-sky-600 dark:hover:text-sky-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition btn-smooth"
                        data-target="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                    <button onclick="navigateTo('personnel-zone')"
                        class="nav-item px-3 py-2 rounded-xl text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-sky-600 dark:hover:text-sky-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition btn-smooth"
                        data-target="personnel-zone">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
                    <div id="navbar-user-section" class="relative">
                        <button onclick="toggleAdminPanel()" id="nav-login-btn"
                            class="px-3 py-2 rounded-xl text-sm font-medium text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transaction btn-smooth">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                    <div class="h-4 w-px bg-slate-300 dark:bg-slate-700 mx-2"></div>
                    <button onclick="toggleTheme()"
                        class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 transition btn-smooth"
                        title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î"><span class="text-xl">üåô</span></button>
                    <button onclick="navigateTo('apply')"
                        class="bg-sky-500 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-sky-600 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all btn-smooth whitespace-nowrap"
                        data-target="apply">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</button>
                </div>
                <div class="flex items-center lg:hidden space-x-3">
                    <button onclick="toggleTheme()"
                        class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 btn-smooth"></button>
                    <span class="text-xl">üåô</span>
                    </button>
                    <button onclick="toggleMobileMenu()"
                        class="p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 focus:outline-none transition btn-smooth">
                        <svg class="h-6 w-6 text-slate-600 dark:text-slate-300" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu"
            class="hidden lg:hidden bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 absolute w-full top-16 left-0 shadow-lg z-40 transition-all duration-300">
            <div class="px-4 pt-2 pb-4 space-y-1">
                <button onclick="navigateTo('home'); toggleMobileMenu()"
                    class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="navigateTo('announcement'); toggleMobileMenu()"
                    class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                <button onclick="navigateTo('status'); toggleMobileMenu()"
                    class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <button onclick="navigateTo('personnel-zone'); toggleMobileMenu()"
                    class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
                <button onclick="toggleAdminPanel(); toggleMobileMenu()"
                    class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl text-slate-500">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="navigateTo('apply'); toggleMobileMenu()"
                    class="w-full mt-4 bg-sky-500 text-white px-4 py-3 rounded-xl text-base font-medium shadow-md">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-8 space-y-12">
        <!-- Hero Section (Windows 11 Style) -->
        <section id="home" class="scroll-mt-24 reveal-on-scroll">
            <div
                class="relative rounded-3xl overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 shadow-2xl shadow-slate-900/20 transform hover:scale-[1.005] transition-all duration-500 cursor-default">
                <div
                    class="absolute inset-0 opacity-30 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-sky-400 via-blue-900 to-transparent">
                </div>
                <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-8 p-8 md:p-12 items-center">
                    <div class="space-y-5 md:space-y-6 text-center md:text-left order-2 md:order-1">
                        <div
                            class="inline-block bg-sky-500/20 text-sky-300 text-xs font-bold px-4 py-1.5 rounded-full border border-sky-500/30 backdrop-blur-sm">
                            OPEN RECRUITMENT 2025</div>
                        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white leading-tight">
                            ‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á<br><span class="text-sky-400">‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå One City</span></h1>
                        <blockquote
                            class="border-l-4 border-sky-500/50 pl-4 py-2 italic text-slate-300/90 text-base md:text-lg">
                            "‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï... ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô Roleplay"</blockquote>
                        <div class="pt-2">
                            <button onclick="navigateTo('apply')"
                                class="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-bold py-3.5 px-10 rounded-xl shadow-lg shadow-sky-500/25 hover:shadow-sky-500/40 hover:scale-[1.02] transition-all btn-smooth">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                        </div>
                    </div>
                    <div class="flex justify-center items-center order-1 md:order-2">
                        <div
                            class="w-48 h-48 sm:w-64 sm:h-64 md:w-80 md:h-80 bg-white/5 rounded-full flex items-center justify-center border border-white/10 backdrop-blur-sm shadow-inner relative animate-pulse">
                            <img id="hero-logo" src="" alt="Logo"
                                class="w-full h-full object-contain p-4 drop-shadow-2xl">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Announcement Section (Windows 11 Style) -->
        <section id="announcement" class="scroll-mt-24 reveal-on-scroll">
            <div
                class="bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl p-6 md:p-8 shadow-lg shadow-sky-500/20 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-8 -mr-8 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl">
                </div>
                <div class="absolute bottom-0 left-0 -mb-8 -ml-8 w-32 h-32 bg-white opacity-5 rounded-full blur-xl">
                </div>
                <div class="relative z-10">
                    <h3 class="text-xl font-bold mb-3 flex items-center"><span class="text-2xl mr-2">üì¢</span>
                        ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h3>
                    <div id="announce-carousel" class="overflow-hidden relative h-32 md:h-24">
                        <div id="announce-track" class="carousel-track h-full flex transition-transform duration-500">
                            <div class="h-full min-w-full flex items-center justify-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...</div>
                        </div>
                    </div>
                    <div id="announce-dots" class="flex justify-center gap-2 mt-3"></div>
                </div>
            </div>
        </section>

        <section id="status" class="scroll-mt-24 space-y-6 reveal-on-scroll">
            <div class="text-center max-w-2xl mx-auto px-2">
                <h2 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div
                    class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm p-5 md:p-6 rounded-2xl border border-slate-100 dark:border-slate-700/50 shadow-sm hover:shadow-lg transition-all duration-300">
                    <h3
                        class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-4 border-b border-slate-100 dark:border-slate-700/50 pb-2">
                        ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÅ‡∏û‡∏ó‡∏¢‡πå</h3>
                    <div class="chart-container w-full h-64 relative"><canvas id="patientChart"></canvas></div>
                </div>
                <div class="space-y-6">
                    <div
                        class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 dark:border-slate-700/50 border-l-4 border-l-orange-400 hover:translate-x-1 transition-all duration-300">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">‚ö†Ô∏è ‡∏†‡∏≤‡∏ß‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h3>
                        <p id="status-emergency-text"
                            class="text-slate-600 dark:text-slate-300 mt-2 text-sm whitespace-pre-line">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                        <div
                            class="mt-3 pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                            <span class="text-sm font-bold text-slate-500 dark:text-slate-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span id="status-total-medics"
                                class="text-lg font-bold text-sky-600 bg-sky-50 dark:bg-sky-900/30 px-3 py-0.5 rounded-full">-
                                ‡∏ó‡πà‡∏≤‡∏ô</span>
                        </div>
                    </div>
                    <div
                        class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm p-6 rounded-2xl shadow-sm hover:shadow-md border border-slate-100 dark:border-slate-700/50 border-l-4 border-l-green-500 hover:translate-x-1 transition-all duration-300">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">üíº ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</h3>
                        <p id="status-welfare-text"
                            class="text-slate-600 dark:text-slate-300 mt-2 text-sm whitespace-pre-line">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="personnel-zone" class="space-y-16 scroll-mt-24 reveal-on-scroll">
            <div id="founders" class="animate-fade-in delay-200">
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-white">‡∏ú‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á</h2>
                    <p class="text-slate-500 dark:text-slate-400 mt-2">‡∏ú‡∏π‡πâ‡∏ö‡∏∏‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• One City</p>
                </div>
                <div id="founders-grid" class="flex flex-wrap justify-center gap-8 max-w-5xl mx-auto"></div>
            </div>
            <div id="leadership" class="animate-fade-in delay-200">
                <div class="text-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á</h2>
                </div>
                <div id="leadership-grid"
                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 md:gap-8 max-w-5xl mx-auto"></div>
            </div>
            <div id="roster" class="max-w-6xl mx-auto animate-fade-in delay-200">
                <div class="flex flex-col items-center mb-6 text-center">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
                    <div class="w-24 h-1 bg-sky-500 rounded mt-4"></div>
                </div>
                <div
                    class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700 hover:shadow-xl transition duration-300">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[600px]">
                            <thead class="bg-slate-100 dark:bg-slate-900/50">
                                <tr>
                                    <th
                                        class="p-4 pl-6 text-sm font-semibold text-slate-600 dark:text-slate-300 w-16 md:w-20 whitespace-nowrap">
                                        Avatar</th>
                                    <th
                                        class="p-4 text-sm font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap">
                                        ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th
                                        class="p-4 text-sm font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap">
                                        ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th
                                        class="p-4 text-sm font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap text-center">
                                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th
                                        class="p-4 text-sm font-semibold text-slate-600 dark:text-slate-300 whitespace-nowrap text-right">
                                        ‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô</th>
                                </tr>
                            </thead>
                            <tbody id="roster-list" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                        </table>
                    </div>
                    <div
                        class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                        <button onclick="changeRosterPage(-1)" id="roster-prev"
                            class="px-3 py-1 text-xs border rounded-lg disabled:opacity-50">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                        <span id="roster-page-info" class="text-xs text-slate-500">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                        <button onclick="changeRosterPage(1)" id="roster-next"
                            class="px-3 py-1 text-xs border rounded-lg disabled:opacity-50">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                    </div>
                </div>
            </div>
            <div id="retired"
                class="max-w-5xl mx-auto bg-slate-100 dark:bg-slate-800/50 rounded-2xl md:rounded-3xl p-4 md:p-8 border border-slate-200 dark:border-slate-700 animate-fade-in delay-300 hover:shadow-lg transition duration-300">
                <div class="text-center mb-6">
                    <h2 class="text-xl md:text-2xl font-bold text-slate-700 dark:text-slate-200">üéñÔ∏è
                        ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡∏≤‡∏£</h2>
                </div>
                <div
                    class="hidden lg:grid grid-cols-4 gap-4 pb-2 border-b border-slate-300 dark:border-slate-600 text-sm font-semibold text-slate-600 dark:text-slate-300 px-4">
                    <div class="col-span-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</div>
                    <div class="col-span-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏î</div>
                    <div class="col-span-1">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå</div>
                    <div class="col-span-1 text-right">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                </div>
                <div
                    class="relative overflow-hidden h-[180px] bg-white dark:bg-slate-900/30 rounded-b-lg border border-t-0 border-slate-200 dark:border-slate-700 group">
                    <div id="retired-scroller" class="animate-scroll-up pause-hover w-full min-w-[600px]"></div>
                </div>
            </div>
        </section>

        <section id="blacklist" class="scroll-mt-24 max-w-6xl mx-auto reveal-on-scroll">
            <div class="flex flex-col items-center mb-6 text-center">
                <h2 class="text-2xl md:text-3xl font-bold text-red-600 dark:text-red-500">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏î‡∏≥ (Blacklist)</h2>
                <p class="text-slate-600 dark:text-slate-400 mt-2 text-sm">
                    ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•/‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</p>
            </div>
            <div
                class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg overflow-hidden border border-red-200 dark:border-red-900/50">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead class="bg-red-50 dark:bg-red-900/20">
                            <tr>
                                <th class="p-4 text-sm font-semibold text-slate-700 dark:text-slate-200">
                                    ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πä‡∏á/‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</th>
                                <th class="p-4 text-sm font-semibold text-slate-700 dark:text-slate-200">‡∏Ç‡πâ‡∏≠‡∏´‡∏≤</th>
                                <th class="p-4 text-sm font-semibold text-slate-700 dark:text-slate-200 text-right">
                                    ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</th>
                                <th class="p-4 text-sm font-semibold text-slate-700 dark:text-slate-200">‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                </th>
                                <th class="p-4 text-sm font-semibold text-slate-700 dark:text-slate-200 text-right">
                                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="blacklist-list" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
                <div
                    class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                    <button onclick="changeBLPage(-1)" id="bl-prev"
                        class="px-3 py-1 text-xs border rounded-lg disabled:opacity-50">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                    <span id="bl-page-info" class="text-xs text-slate-500">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                    <button onclick="changeBLPage(1)" id="bl-next"
                        class="px-3 py-1 text-xs border rounded-lg disabled:opacity-50">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                </div>
            </div>
        </section>

        <section id="rules"
            class="scroll-mt-24 bg-white dark:bg-slate-800 rounded-2xl shadow-lg overflow-hidden transition-colors reveal-on-scroll hover:shadow-xl transition duration-300">
            <div class="bg-slate-800 dark:bg-slate-900 text-white p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold">DOC-REV-01 ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</h2>
            </div>
            <div class="p-4 md:p-6">
                <div
                    class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl mb-6">
                    <button onclick="switchTab('general')" id="tab-general"
                        class="flex-1 py-2 text-sm font-medium rounded-lg bg-white text-slate-800 shadow-sm transition-all btn-smooth">‡∏Å‡∏é‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                    <button onclick="switchTab('roleplay')" id="tab-roleplay"
                        class="flex-1 py-2 text-sm font-medium rounded-lg text-slate-500 transition-all btn-smooth">Roleplay</button>
                </div>
                <div id="rules-container" class="space-y-4 animate-fade-in min-h-[200px]"></div>
            </div>
        </section>

        <section id="apply" class="scroll-mt-24 max-w-3xl mx-auto reveal-on-scroll">
            <div
                class="bg-white dark:bg-slate-800 rounded-xl shadow-xl p-6 md:p-8 border border-slate-200 dark:border-slate-700 hover:shadow-2xl transition duration-300">
                <div class="text-center mb-6 md:mb-8">
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800 dark:text-white">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                </div>
                <form id="recruitmentForm" class="space-y-4 md:space-y-6" onsubmit="handleFormSubmit(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•
                                (IC) *</label>
                            <div class="input-group">
                                <span class="input-group-icon">üë§</span>
                                <input type="text" name="ic_name" required class="inp-primary w-full inp-icon-pad"
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (OC)
                                *</label>
                            <div class="input-group">
                                <span class="input-group-icon">üéÇ</span>
                                <input type="number" name="oc_age" required class="inp-primary w-full inp-icon-pad"
                                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏£‡∏¥‡∏á">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Discord ID
                                *</label>
                            <div class="input-group">
                                <span class="input-group-icon">üÜî</span>
                                <input type="text" name="discord_id" required class="inp-primary w-full inp-icon-pad"
                                    placeholder="18-digit ID">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                                *</label>
                            <div class="input-group">
                                <span class="input-group-icon">‚è∞</span>
                                <div class="flex items-center gap-2 w-full">
                                    <input type="time" id="app-time-start" required
                                        class="inp-primary w-full h-[46px] text-center cursor-pointer"
                                        onchange="updateAppOnlineTime()">
                                    <span class="text-slate-400 font-bold">-</span>
                                    <input type="time" id="app-time-end" required
                                        class="inp-primary w-full h-[46px] text-center cursor-pointer"
                                        onchange="updateAppOnlineTime()">
                                </div>
                                <input type="hidden" name="online_time" id="app-online-time">
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏≠?
                                *</label>
                            <div class="input-group">
                                <textarea name="motivation" required rows="4"
                                    class="inp-primary w-full p-3 rounded-xl focus:ring-2 focus:ring-sky-500 focus:outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white transition-all"
                                    placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡∏®‡∏ô‡∏Ñ‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mt-2 px-1">
                        <input type="checkbox" id="terms-agree" required
                            class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded focus:ring-sky-500 dark:focus:ring-sky-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600 cursor-pointer">
                        <label for="terms-agree"
                            class="text-sm font-medium text-slate-700 dark:text-slate-300 select-none cursor-pointer">‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡πâ‡∏ß</label>
                    </div>

                    <div class="flex justify-end pt-4">
                        <button type="submit" id="submitBtn"
                            class="bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-sky-500/30 hover:scale-105 transition btn-smooth w-full md:w-auto">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</button>
                    </div>
                </form>
            </div>
        </section>

        <footer class="py-6 mt-16 border-t border-slate-200 dark:border-slate-800 text-center">
            <p class="text-sm text-slate-500 dark:text-slate-400">
                &copy; 2025 One City Hospital. All Rights Reserved.
            </p>
            <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">
                Powered by <span class="font-bold text-sky-500">Bonchon-studio</span>
            </p>
        </footer>

        <!-- Admin Modal -->
        <div id="admin-modal" class="fixed inset-0 z-[60] hidden flex items-end md:items-center justify-center">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleAdminPanel()">
            </div>
            <div class="bg-white dark:bg-slate-900 w-full md:w-[85%] md:max-w-6xl h-[85vh] md:h-[90vh] rounded-t-2xl md:rounded-2xl shadow-2xl z-10 overflow-hidden flex flex-col relative transition-transform duration-300 transform translate-y-0"
                id="admin-modal-content">
                <div
                    class="bg-slate-900 p-4 md:p-5 flex justify-between items-center text-white shrink-0 border-b border-slate-700 shadow-sm">
                    <span class="text-lg md:text-xl font-bold truncate flex items-center gap-3">
                        <span class="bg-sky-500/20 text-sky-400 p-1.5 rounded-lg">üè•</span>
                        Hospital Admin Panel
                        <span id="mode-indicator"
                            class="text-[10px] md:text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded ml-2 align-middle font-mono border border-slate-600">Guest</span>
                    </span>
                    <button onclick="toggleAdminPanel()"
                        class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 transition">‚úï</button>
                </div>
                <div id="admin-login-view"
                    class="flex-1 flex flex-col items-center justify-center p-6 md:p-12 relative overflow-hidden bg-slate-50 dark:bg-slate-950">
                    <!-- Background Decoration -->
                    <div
                        class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-30 dark:opacity-20">
                        <div
                            class="absolute -top-[20%] -right-[10%] w-[60%] h-[60%] rounded-full bg-sky-500/20 blur-3xl rounded-full">
                        </div>
                        <div
                            class="absolute -bottom-[20%] -left-[10%] w-[60%] h-[60%] rounded-full bg-blue-600/20 blur-3xl rounded-full">
                        </div>
                    </div>

                    <div
                        class="w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-xl dark:shadow-slate-900/50 border border-slate-200 dark:border-slate-800 p-8 relative z-10">
                        <div class="text-center mb-8">
                            <div
                                class="inline-block p-4 rounded-full bg-sky-50 dark:bg-sky-900/30 text-sky-600 dark:text-sky-400 mb-4 text-3xl shadow-sm">
                                üë®‚Äç‚öïÔ∏è</div>
                            <h3 class="text-2xl font-bold text-slate-800 dark:text-white">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Staff)</h3>
                            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</p>
                        </div>

                        <div id="staff-login-form" class="space-y-5">
                            <div class="space-y-1">
                                <label
                                    class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase ml-1">Discord
                                    ID</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üÜî</span>
                                    <input type="text" id="login-discord-id" placeholder="Ex. 558269..."
                                        class="inp-primary w-full pl-10 dark:bg-slate-800 dark:focus:bg-slate-800 transition-all">
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label
                                    class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase ml-1">Password</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîí</span>
                                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        class="inp-primary w-full pl-10 dark:bg-slate-800 dark:focus:bg-slate-800 transition-all">
                                </div>
                            </div>

                            <div class="flex items-center gap-2 px-1">
                                <input type="checkbox" id="login-remember"
                                    class="w-4 h-4 text-sky-600 bg-gray-100 border-gray-300 rounded focus:ring-sky-500 dark:focus:ring-sky-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600 cursor-pointer">
                                <label for="login-remember"
                                    class="text-sm font-medium text-slate-600 dark:text-slate-400 select-none cursor-pointer">‡∏à‡∏î‡∏à‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                                    7 ‡∏ß‡∏±‡∏ô</label>
                            </div>

                            <button onclick="handleStaffLogin()"
                                class="w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-sky-500/20 transform active:scale-95 transition-all">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            </button>

                            <div class="text-center">
                                <p id="first-time-msg"
                                    class="text-xs text-slate-400 cursor-pointer hover:text-sky-500 transition-colors inline-flex items-center gap-1"
                                    onclick="toggleRegisterMode()">
                                    <span>‚ú® ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å?</span> <span
                                        class="underline decoration-dashed">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-800 text-center">
                            <p class="text-[10px] uppercase font-bold text-slate-400 mb-3 tracking-wider">Owner Access
                            </p>
                            <button onclick="loginWithGoogle()"
                                class="w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 py-2.5 rounded-xl font-bold shadow-sm transition text-sm flex items-center justify-center gap-2 group">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg"
                                    class="w-5 h-5 group-hover:scale-110 transition-transform">
                                <span>Login with Google</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="admin-dashboard-view" class="hidden flex-1 flex flex-col md:flex-row overflow-hidden">
                    <div class="w-full md:w-64 bg-slate-100 dark:bg-slate-900 border-b md:border-b-0 md:border-r border-slate-200 dark:border-slate-700 p-2 md:p-4 flex md:flex-col space-x-2 md:space-x-0 md:space-y-2 flex-shrink-0 overflow-x-auto whitespace-nowrap"
                        id="admin-menu-bar"></div>
                    <div class="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50 dark:bg-slate-950"
                        id="admin-content-area">
                        <div id="admin-editor-announce" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h2>
                            <div id="admin-announce-list" class="space-y-3 mb-4"></div><button
                                onclick="addAnnouncementRow()"
                                class="w-full border-dashed border-2 p-2 rounded-xl text-slate-500">+
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°</button><button onclick="saveData('announcements')"
                                class="mt-4 bg-green-600 text-white px-6 py-2 rounded-xl shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <div id="admin-editor-users" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                            <div class="flex gap-2 mb-4">
                                <input id="new-user-id" class="inp-primary flex-1" placeholder="Discord ID (18 digits)">
                                <button onclick="addManualUser()"
                                    class="bg-sky-600 text-white px-4 py-2 rounded-xl text-sm whitespace-nowrap">+
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                            </div>
                            <table class="w-full text-sm">
                                <tbody id="admin-users-list"></tbody>
                            </table>
                            <button onclick="saveData('authUsers')"
                                class="mt-4 bg-green-600 text-white px-6 py-2 rounded-xl shadow float-right">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <div id="admin-editor-applicants" class="hidden animate-fade-in">
                            <div
                                class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h3
                                        class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        ‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö <span
                                            class="bg-indigo-100 text-indigo-600 text-xs px-2 py-1 rounded-full">New</span>
                                    </h3>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">
                                        ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå</p>
                                </div>
                                <button onclick="fetchApplicants()"
                                    class="text-indigo-600 hover:bg-indigo-50 px-3 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition">
                                    <span>üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                                </button>
                            </div>
                            <div id="admin-applicants-list"
                                class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                                <!-- Rendered by JS -->
                            </div>
                        </div>
                        <div id="admin-editor-blacklist" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Blacklist</h2>
                            <div id="admin-bl-list" class="space-y-3"></div><button onclick="addBlacklistRow()"
                                class="mt-4 w-full border-dashed border-2 p-2 rounded-xl text-slate-500">+
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°</button><button onclick="saveData('blacklist')"
                                class="mt-6 bg-green-600 text-white px-6 py-2 rounded-xl shadow float-right">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <div id="admin-editor-status" class="hidden">
                            <h2 class="font-bold mb-6 text-xl dark:text-white border-b dark:border-slate-700 pb-2">
                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div
                                    class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 shadow-sm">
                                    <label
                                        class="block text-sm font-bold text-slate-700 dark:text-sky-400 mb-3 flex items-center gap-2"><span
                                            class="text-xl">üö®</span> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</label>
                                    <textarea id="edit-status-emergency"
                                        class="inp-primary w-full h-32 p-3 text-sm leading-relaxed resize-none"
                                        placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏î‡∏á, ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ñ‡∏™‡∏´‡∏ô‡∏±‡∏Å..."></textarea>
                                </div>
                                <div
                                    class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 shadow-sm">
                                    <label
                                        class="block text-sm font-bold text-slate-700 dark:text-sky-400 mb-3 flex items-center gap-2"><span
                                            class="text-xl">üéÅ</span> ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£</label>
                                    <textarea id="edit-status-welfare"
                                        class="inp-primary w-full h-32 p-3 text-sm leading-relaxed resize-none"
                                        placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ü‡∏£‡∏µ, ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô..."></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="saveData('statusInfo')"
                                    class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-bold px-8 py-3 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center gap-2">
                                    <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                                </button>
                            </div>
                        </div>

                        <!-- NEW SHIFTS EDITOR -->
                        <div id="admin-editor-shifts" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white flex items-center gap-2"><span>‚è∞</span> ‡πÄ‡∏ß‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå
                                (Medical Shifts)</h2>
                            <div class="mb-4">
                                <input type="text" id="shift-search" onkeyup="renderShifts()"
                                    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏¢‡∏®..." class="inp-primary w-full">
                            </div>
                            <div
                                class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                                <table class="w-full text-sm text-left">
                                    <thead
                                        class="bg-slate-50 dark:bg-slate-700/50 text-slate-500 uppercase font-bold text-xs">
                                        <tr>
                                            <th class="p-3 text-center w-12">#</th>
                                            <th class="p-3">‡∏¢‡∏®</th>
                                            <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠</th>
                                            <th class="p-3">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</th>
                                            <th class="p-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-shift-list"
                                        class="divide-y divide-slate-100 dark:divide-slate-700">
                                        <!-- Rendered by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="admin-editor-founders" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white">‡∏ú‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á</h2>
                            <div id="admin-founders-list" class="space-y-3"></div><button onclick="saveData('founders')"
                                class="mt-4 bg-green-600 text-white px-4 py-2 rounded-xl float-right">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

                        </div>
                        <div id="admin-editor-roster" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white">‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå</h2>
                            <div id="admin-roster-list" class="space-y-3"></div><button onclick="addRosterRow()"
                                class="mt-4 w-full border-dashed border-2 p-2 rounded-xl text-slate-500">+
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°</button><button onclick="saveData('roster')"
                                class="mt-4 bg-green-600 text-white px-4 py-2 rounded-xl float-right">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <div id="admin-editor-retired" class="hidden">
                            <h2 class="font-bold mb-4 dark:text-white">‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡∏≤‡∏£</h2>
                            <div id="admin-retired-list" class="space-y-3"></div><button onclick="addRetiredRow()"
                                class="mt-4 w-full border-dashed border-2 p-2 rounded text-slate-500">+
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°</button><button onclick="saveData('retired')"
                                class="mt-4 bg-green-600 text-white px-4 py-2 rounded float-right">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                        <div id="admin-editor-rules" class="hidden">
                            <h2 class="font-bold mb-6 text-xl dark:text-white border-b dark:border-slate-700 pb-2">
                                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</h2>
                            <div class="space-y-6">
                                <div
                                    class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 shadow-sm">
                                    <label
                                        class="block text-sm font-bold text-slate-700 dark:text-sky-400 mb-3 flex items-center gap-2"><span
                                            class="text-xl">üìú</span> ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Rules) <span
                                            class="text-xs font-normal text-slate-400 ml-auto opacity-70">1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1
                                            ‡∏Ç‡πâ‡∏≠</span></label>
                                    <textarea id="edit-rules-general"
                                        class="inp-primary w-full h-48 p-3 font-mono text-sm leading-loose"
                                        placeholder="‡∏´‡πâ‡∏≤‡∏° DM ‡∏´‡∏≤‡∏´‡∏°‡∏≠...&#10;‡∏´‡πâ‡∏≤‡∏°‡∏™‡πÅ‡∏õ‡∏°..."></textarea>
                                </div>
                                <div
                                    class="bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 shadow-sm">
                                    <label
                                        class="block text-sm font-bold text-slate-700 dark:text-sky-400 mb-3 flex items-center gap-2"><span
                                            class="text-xl">üé≠</span> ‡∏Å‡∏é‡∏Å‡∏≤‡∏£ Roleplay (Roleplay Rules)</label>
                                    <textarea id="edit-rules-roleplay"
                                        class="inp-primary w-full h-48 p-3 font-mono text-sm leading-loose"
                                        placeholder="‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Story...&#10;‡∏´‡πâ‡∏≤‡∏° Powergaming..."></textarea>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button onclick="saveData('rules')"
                                    class="bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-bold px-8 py-3 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center gap-2">
                                    <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notification" class="fixed inset-0 flex items-center justify-center z-[70] hidden">
            <div class="absolute inset-0 bg-black opacity-50"></div>
            <div
                class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-2xl z-10 text-center max-w-sm w-full mx-4 transition-transform transform scale-100">
                <div id="notif-icon" class="mb-8 flex justify-center h-16"></div>
                <h3 id="notif-title" class="text-xl font-bold mb-2 text-slate-800 dark:text-white"></h3>
                <p id="notif-msg" class="text-slate-600 dark:text-slate-300 mb-6"></p><button
                    onclick="document.getElementById('notification').classList.add('hidden')"
                    class="w-full bg-slate-800 text-white px-4 py-2 rounded">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <div id="profile-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleProfileModal()"></div>
            <div
                class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl z-10 overflow-hidden transform scale-100 transition-all mx-4">
                <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
                    <h3 class="font-bold text-lg flex items-center gap-2">üë§ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <button onclick="toggleProfileModal()" class="text-slate-400 hover:text-white">‚úï</button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-center mb-4">
                        <div class="relative w-24 h-24">
                            <img id="profile-edit-img" src=""
                                class="w-full h-full rounded-full object-cover border-4 border-slate-100 dark:border-slate-800 shadow-md">
                            <div class="absolute bottom-0 right-0 bg-sky-500 rounded-full p-1.5 border-2 border-white dark:border-slate-900 cursor-pointer hover:bg-sky-600 transition"
                                onclick="document.getElementById('profile-edit-url').focus()">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                    </path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
                                (IC)</label>
                            <input id="profile-edit-name" class="inp-primary w-full font-bold"
                                placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                            <input id="profile-edit-url" class="inp-primary w-full text-xs font-mono"
                                placeholder="http://..."
                                onchange="document.getElementById('profile-edit-img').src = this.value || 'https://via.placeholder.com/150'">
                        </div>
                        <div class="col-span-2">
                            <label
                                class="text-xs font-bold text-slate-500 uppercase mb-1 block">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£</label>
                            <div class="flex items-center gap-2">
                                <input type="time" id="profile-edit-start"
                                    class="inp-primary w-full text-center cursor-pointer">
                                <span class="text-slate-400 font-bold">-</span>
                                <input type="time" id="profile-edit-end"
                                    class="inp-primary w-full text-center cursor-pointer">
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Discord ID
                                (Locked)</label>
                            <input id="profile-edit-discord"
                                class="inp-primary w-full bg-slate-100 dark:bg-slate-800 text-slate-500 cursor-not-allowed"
                                readonly>
                        </div>
                    </div>
                </div>
                <div
                    class="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50 flex justify-end gap-2">
                    <button onclick="toggleProfileModal()"
                        class="px-4 py-2 text-slate-500 hover:text-slate-700 font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="saveUserProfile()"
                        class="px-6 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-xl font-bold shadow-lg shadow-sky-500/20 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>

        <div id="confirm-modal" class="fixed inset-0 flex items-center justify-center z-[80] hidden">
            <div class="absolute inset-0 bg-black opacity-50"></div>
            <div
                class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-2xl z-10 text-center max-w-sm w-full mx-4 transform scale-100 transition-transform">
                <h3 id="confirm-title" class="text-xl font-bold mb-2 text-slate-800 dark:text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </h3>
                <p id="confirm-msg" class="text-slate-600 dark:text-slate-300 mb-6 font-mono text-sm"></p>
                <div class="flex gap-3 justify-center">
                    <button id="confirm-yes-btn"
                        class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    <button id="confirm-no-btn"
                        class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 px-4 py-2 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Shift Schedule Modal -->
        <div id="shift-schedule-modal" class="fixed inset-0 z-[60] hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity backdrop-blur-sm" aria-hidden="true"
                    onclick="toggleShiftModal()"></div>
                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                <div
                    class="inline-block align-bottom bg-white dark:bg-slate-900 rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full border border-slate-100 dark:border-slate-700">
                    <div class="bg-white dark:bg-slate-900 px-6 pt-6 pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-2xl leading-6 font-bold text-slate-800 dark:text-white"
                                        id="modal-title">
                                        üóìÔ∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞ (Shift Schedule)
                                    </h3>
                                    <button onclick="toggleShiftModal()"
                                        class="text-slate-400 hover:text-slate-500 transition">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div class="mt-4">
                                    <!-- Tabs (Windows 11 Style) -->
                                    <div
                                        class="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar bg-slate-100/50 dark:bg-slate-800/50 p-1.5 rounded-2xl">
                                        <button onclick="switchShiftTab('00-06')" id="tab-00-06"
                                            class="shift-tab flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all">
                                            üåï 00:00 - 06:00
                                        </button>
                                        <button onclick="switchShiftTab('06-12')" id="tab-06-12"
                                            class="shift-tab flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all">
                                            üåÖ 06:00 - 12:00
                                        </button>
                                        <button onclick="switchShiftTab('12-17')" id="tab-12-17"
                                            class="shift-tab flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all">
                                            ‚òÄÔ∏è 12:00 - 17:00
                                        </button>
                                        <button onclick="switchShiftTab('17-00')" id="tab-17-00"
                                            class="shift-tab flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all">
                                            üåÜ 17:00 - 00:00
                                        </button>
                                    </div>

                                    <!-- Operator Header (Windows 11 Style) -->
                                    <div
                                        class="text-center mb-6 bg-gradient-to-br from-slate-50 to-white dark:from-slate-800/80 dark:to-slate-900/80 rounded-2xl p-6 border border-slate-200/50 dark:border-slate-700/50 shadow-sm backdrop-blur-sm">
                                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">
                                            ‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡∏≤‡∏£ (Operator of the shift)
                                        </h2>
                                        <div
                                            class="inline-flex items-center justify-center bg-white dark:bg-slate-800 rounded-2xl px-10 py-5 shadow-lg shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-100 dark:border-slate-700 min-w-[220px]">
                                            <div class="overflow-hidden h-10">
                                                <div id="operator-name-slot"
                                                    class="text-2xl font-bold bg-gradient-to-r from-blue-600 via-indigo-600 to-violet-600 bg-clip-text text-transparent transition-transform duration-700">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-5 flex items-center justify-center gap-3 flex-wrap">
                                            <button onclick="toggleOpPanel()"
                                                class="px-5 py-2.5 bg-slate-700 hover:bg-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 text-white text-sm font-bold rounded-xl shadow-sm transition-all flex items-center gap-2">
                                                üìü ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ OP
                                            </button>
                                            <button onclick="resetOperator()"
                                                class="px-4 py-2.5 bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 text-sm font-bold rounded-xl shadow-sm transition-all flex items-center gap-2">
                                                üîÑ Reset OP
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Action Button Area -->
                                    <div id="extra-shift-btn-area"
                                        class="mb-4 flex justify-end gap-2 min-h-[40px] flex-wrap"></div>

                                    <!-- Table -->
                                    <div
                                        class="overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                                        <table class="w-full text-sm text-left">
                                            <thead
                                                class="text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                                                <tr>
                                                    <th class="px-6 py-4 font-semibold">Active Time</th>
                                                    <th class="px-6 py-4 font-semibold">Medic</th>
                                                    <th class="px-6 py-4 font-semibold text-center">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="shift-table-body"
                                                class="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-900">
                                                <!-- JS Injected -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="bg-gray-50 dark:bg-slate-800/50 px-6 py-4 sm:flex sm:flex-row-reverse border-t border-slate-100 dark:border-slate-800">
                        <button type="button"
                            class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-6 py-2 bg-slate-800 dark:bg-slate-700 text-base font-medium text-white hover:bg-slate-900 dark:hover:bg-slate-600 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition shadow-lg shadow-slate-500/20"
                            onclick="toggleShiftModal()">
                            ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- OP Support Panel Modal (Windows 11 Style) -->
        <div id="op-panel-modal" class="fixed z-50 inset-0 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity"></div>

            <div class="flex items-center justify-center min-h-screen p-4 fade-in">
                <!-- Window Container -->
                <div
                    class="relative bg-white/85 dark:bg-slate-900/85 backdrop-blur-2xl w-full max-w-7xl h-[85vh] rounded-2xl shadow-2xl border border-white/20 dark:border-slate-700/50 flex flex-col overflow-hidden animate-zoom-in">

                    <!-- Title Bar -->
                    <div
                        class="h-10 bg-slate-50/50 dark:bg-slate-800/50 border-b border-black/5 dark:border-white/5 flex justify-between items-center px-4 select-none drag-handle">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleOpPanel(true)"
                                class="p-1 hover:bg-black/5 dark:hover:bg-white/10 rounded transition text-slate-500">
                                <span class="sr-only">Back</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </button>
                            <span
                                class="text-xs font-semibold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-indigo-500"></span> ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ OP
                            </span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2 px-3 py-1 bg-black/5 dark:bg-white/5 rounded-full">
                                <span class="text-[10px] uppercase font-bold text-slate-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                                <span class="text-xs font-mono font-bold text-emerald-600 dark:text-emerald-400"
                                    id="op-shift-date">-</span>
                            </div>
                            <div class="flex items-center gap-2 px-3 py-1 bg-black/5 dark:bg-white/5 rounded-full">
                                <span class="text-[10px] uppercase font-bold text-slate-400">Shift Timer</span>
                                <span class="text-xs font-mono font-bold text-indigo-600 dark:text-indigo-400"
                                    id="op-shift-timer">00:00:00</span>
                            </div>
                            <button onclick="toggleOpPanel()"
                                class="p-1.5 hover:bg-rose-500 hover:text-white rounded-md transition text-slate-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Layout Grid -->
                    <div class="flex-1 overflow-hidden grid grid-cols-12 gap-0 relative">

                        <!-- Sidebar: Controls & Lists (3 Cols) -->
                        <div
                            class="col-span-12 lg:col-span-3 bg-slate-50/50 dark:bg-black/20 border-r border-slate-200/50 dark:border-slate-800/50 flex flex-col overflow-hidden">

                            <!-- Control Panel -->
                            <div class="p-4 space-y-4 border-b border-slate-200/50 dark:border-slate-800/50">
                                <div>
                                    <label
                                        class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Operator</label>
                                    <div
                                        class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate flex items-center gap-2">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                                        <span id="op-panel-name">Checking...</span>
                                    </div>
                                </div>
                                <div id="ctrl-sup-op">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Support
                                        OP</label>
                                    <select id="op-sup-select" onchange="updateSupOp(this.value); saveOpConfig();"
                                        class="mt-1 w-full text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 focus:ring-indigo-500 p-2">
                                        <option value="">-- Select --</option>
                                    </select>
                                </div>
                                <!-- Sup OP Display for non-OP users -->
                                <div id="sup-op-viewer" style="display: none;">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Support
                                        OP</label>
                                    <div
                                        class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate flex items-center gap-2 mt-1">
                                        <div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                                        <span id="sup-op-display">-</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-2" id="op-action-buttons">
                                    <button id="op-start-btn" onclick="saveOpConfig()"
                                        class="bg-slate-700 hover:bg-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 text-white text-xs font-bold py-2 rounded-lg shadow-sm transition">
                                        ‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏∞
                                    </button>
                                    <button onclick="endOpShift()"
                                        class="bg-slate-200 hover:bg-slate-300 text-slate-600 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-400 text-xs font-bold py-2 rounded-lg transition">
                                        ‡∏à‡∏ö‡∏Å‡∏∞
                                    </button>
                                </div>
                            </div>

                            <!-- Personnel Lists -->
                            <div class="flex-1 overflow-hidden flex flex-col p-3 gap-3 h-full min-h-0">
                                <!-- Tabs -->
                                <div class="bg-slate-200/50 dark:bg-slate-800/50 p-1 rounded-lg flex gap-1 shrink-0">
                                    <button onclick="setSidebarTab('working')" id="tab-btn-working"
                                        class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all bg-white dark:bg-slate-700 shadow-sm text-indigo-600 dark:text-white flex items-center justify-center gap-1">
                                        Working <span id="count-tab-working"
                                            class="bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-1.5 rounded-full text-[9px]">0</span>
                                    </button>
                                    <button onclick="setSidebarTab('afk')" id="tab-btn-afk"
                                        class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50 flex items-center justify-center gap-1">
                                        AFK üí§ <span id="count-tab-afk"
                                            class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400 px-1.5 rounded-full text-[9px]">0</span>
                                    </button>
                                </div>

                                <!-- Tab View: Working (On Duty + Off Duty) -->
                                <div id="sidebar-view-working" class="flex-1 flex flex-col gap-3 overflow-hidden">
                                    <!-- On Duty (Takes remaining space, scrollable) -->
                                    <div
                                        class="flex-1 bg-white/40 dark:bg-slate-800/40 rounded-xl border border-white/40 dark:border-slate-700/50 flex flex-col overflow-hidden min-h-[150px]">
                                        <div
                                            class="px-3 py-2 border-b border-white/20 dark:border-slate-700/30 flex justify-between items-center bg-emerald-500/5 shrink-0">
                                            <span
                                                class="text-xs font-bold text-emerald-600 dark:text-emerald-400 flex items-center gap-1">
                                                üü¢ On Duty
                                            </span>
                                            <span class="text-[10px] font-bold opacity-60 flex items-center gap-1">
                                                üë§ <span id="count-on-duty">0</span>
                                            </span>
                                        </div>
                                        <div class="p-2 border-b border-white/20 dark:border-slate-700/30 shrink-0">
                                            <div class="flex gap-1" id="manual-add-container">
                                                <input id="manual-add-name"
                                                    class="flex-1 text-[10px] rounded border-white/20 bg-white/50 dark:bg-slate-900/50 p-1.5"
                                                    placeholder="Add Name..."
                                                    onkeypress="if(event.key==='Enter') addManualMedic()">
                                                <button onclick="addManualMedic()"
                                                    class="bg-emerald-500 text-white px-2 rounded hover:bg-emerald-600">+</button>
                                            </div>
                                        </div>
                                        <div id="list-on-duty"
                                            class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
                                    </div>

                                    <!-- Off Duty (Fixed height, always visible) -->
                                    <div
                                        class="h-[140px] shrink-0 bg-white/40 dark:bg-slate-800/40 rounded-xl border border-white/40 dark:border-slate-700/50 flex flex-col overflow-hidden">
                                        <div
                                            class="px-3 py-2 border-b border-white/20 dark:border-slate-700/30 flex justify-between items-center bg-slate-500/5 shrink-0">
                                            <span
                                                class="text-xs font-bold text-slate-500 dark:text-slate-400 flex items-center gap-1">
                                                üî¥ Off Duty
                                            </span>
                                            <span class="text-[10px] font-bold opacity-60 flex items-center gap-1">
                                                üë§ <span id="count-off-duty">0</span>
                                            </span>
                                        </div>
                                        <div id="list-off-duty"
                                            class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
                                    </div>
                                </div>

                                <!-- Tab View: AFK -->
                                <div id="sidebar-view-afk"
                                    class="hidden flex-1 bg-yellow-50/40 dark:bg-yellow-900/10 rounded-xl border border-white/40 dark:border-yellow-900/20 flex flex-col overflow-hidden min-h-0">
                                    <div
                                        class="px-3 py-2 border-b border-white/20 dark:border-yellow-900/20 flex justify-between items-center bg-yellow-500/5 shrink-0">
                                        <span
                                            class="text-xs font-bold text-yellow-600 dark:text-yellow-400 flex items-center gap-1">
                                            üí§ AFK List
                                        </span>
                                        <span class="text-[10px] font-bold opacity-60 flex items-center gap-1">
                                            üë§ <span id="count-afk">0</span>
                                        </span>
                                    </div>
                                    <div id="list-afk"
                                        class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar full-height-afk">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content: Dashboard (9 Cols) -->
                        <div
                            class="col-span-12 lg:col-span-9 bg-slate-100/30 dark:bg-black/40 flex flex-col p-6 gap-6 overflow-hidden">

                            <!-- Phone Command Shortcuts (Available to All) -->
                            <div
                                class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-xl rounded-2xl shadow-sm border border-white/50 dark:border-slate-700 p-4 shrink-0">
                                <h4
                                    class="font-bold text-slate-700 dark:text-white flex items-center gap-2 mb-3 text-sm">
                                    <span
                                        class="p-1.5 bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-400 rounded-lg shadow-sm">üìû</span>
                                    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
                                </h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="flex gap-1">
                                        <input type="text" id="phone-input-1" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..."
                                            class="flex-1 text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                        <button onclick="copyPhoneNotFound()"
                                            class="text-xs bg-slate-600 hover:bg-slate-700 dark:bg-slate-500 dark:hover:bg-slate-400 text-white px-3 rounded-lg transition whitespace-nowrap shadow-sm">
                                            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™
                                        </button>
                                    </div>
                                    <div class="flex gap-1">
                                        <input type="text" id="phone-input-2" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..."
                                            class="flex-1 text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                        <button onclick="copyPhoneUnreachable()"
                                            class="text-xs bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white px-3 rounded-lg transition whitespace-nowrap shadow-sm">
                                            ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Case Creation -->
                            <div class="bg-white/70 dark:bg-slate-800/70 backdrop-blur-xl rounded-2xl shadow-sm border border-white/50 dark:border-slate-700 p-5 relative overflow-hidden shrink-0"
                                id="case-creation-card">

                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold text-slate-700 dark:text-white flex items-center gap-2">
                                        <span
                                            class="p-1.5 bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 rounded-lg shadow-sm">‚ö°</span>
                                        Dispatch New Case
                                    </h4>
                                    <div class="flex items-center gap-2">
                                        <label class="text-[10px] font-bold text-slate-400 uppercase">Start Time</label>
                                        <input type="time" id="case-time"
                                            class="text-xs font-bold rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-1.5">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                                    <!-- VS Section -->
                                    <div
                                        class="md:col-span-5 flex items-center gap-2 bg-slate-50/50 dark:bg-slate-900/50 p-1.5 rounded-xl border border-slate-200/50 dark:border-slate-700">
                                        <input id="case-party-a" placeholder="Party A"
                                            class="w-full bg-transparent border-0 text-right text-xs font-bold focus:ring-0 text-slate-700 dark:text-slate-200">
                                        <span
                                            class="text-rose-500 italic font-black text-[10px] px-1 bg-rose-50 dark:bg-rose-900/20 rounded">VS</span>
                                        <input id="case-party-b" placeholder="Party B"
                                            class="w-full bg-transparent border-0 text-left text-xs font-bold focus:ring-0 text-slate-700 dark:text-slate-200">
                                    </div>

                                    <!-- Location & Radio & Council -->
                                    <div class="md:col-span-7 grid grid-cols-12 gap-2">
                                        <select id="case-location"
                                            class="col-span-5 text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                            <option value="">Loc...</option>
                                            <option value="‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏á</option>
                                            <option value="‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡∏ó‡∏£‡∏≤‡∏¢">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏ó‡∏∞‡πÄ‡∏•‡∏ó‡∏£‡∏≤‡∏¢</option>
                                            <option value="‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£">‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£</option>
                                            <option value="‡∏õ‡∏±‡πâ‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ö‡∏ô">‡∏õ‡∏±‡πâ‡∏°‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ö‡∏ô</option>
                                            <option value="‡πÇ‡∏£‡∏á‡πÄ‡∏ä‡∏∑‡∏≠‡∏î‡πÑ‡∏Å‡πà">‡πÇ‡∏£‡∏á‡πÄ‡∏ä‡∏∑‡∏≠‡∏î‡πÑ‡∏Å‡πà</option>
                                        </select>
                                        <input id="case-radio" placeholder="Radio"
                                            class="col-span-3 text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                        <input id="case-council" placeholder="Council"
                                            class="col-span-4 text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                    </div>

                                    <!-- Medic Selection -->
                                    <div class="md:col-span-12 grid grid-cols-3 gap-2">
                                        <select id="case-medic-1"
                                            class="text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                            <option value="">-- Medic 1 --</option>
                                        </select>
                                        <select id="case-medic-2"
                                            class="text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                            <option value="">-- Medic 2 (Opt) --</option>
                                        </select>
                                        <select id="case-medic-3"
                                            class="text-xs rounded-lg border-slate-200 bg-white/50 dark:bg-slate-900/50 dark:border-slate-700 p-2">
                                            <option value="">-- Medic 3 (Opt) --</option>
                                        </select>
                                    </div>
                                </div>

                                <button onclick="createOpCase()"
                                    class="absolute bottom-5 right-5 bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full shadow-lg shadow-indigo-500/30 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- Case List Header & Container -->
                            <div class="flex-1 flex flex-col min-h-0">
                                <h3
                                    class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2 shrink-0 flex items-center gap-2">
                                    <span class="w-1 h-4 bg-indigo-500 rounded"></span>
                                    ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà
                                </h3>
                                <div class="flex-1 overflow-y-auto custom-scrollbar pr-2 -mr-2">
                                    <div id="op-case-list" class="space-y-4 pb-4"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shift Summary Modal -->
        <div id="shift-summary-modal" class="fixed z-[60] inset-0 hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeShiftSummary()"></div>
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="relative bg-white/95 dark:bg-slate-900/95 backdrop-blur-2xl w-full max-w-2xl rounded-2xl shadow-2xl border border-white/20 dark:border-slate-700/50 overflow-hidden animate-zoom-in">
                    <!-- Header -->
                    <div
                        class="bg-gradient-to-r from-indigo-500 to-violet-600 px-6 py-4 flex justify-between items-center">
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£ OP
                        </h2>
                        <button onclick="closeShiftSummary()"
                            class="text-white/80 hover:text-white p-1 hover:bg-white/20 rounded-lg transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="p-6 max-h-[70vh] overflow-y-auto custom-scrollbar space-y-6" id="shift-summary-content">
                        <!-- Will be populated by JS -->
                    </div>

                    <!-- Footer -->
                    <div class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-2">
                        <button onclick="copyShiftSummary()"
                            class="px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition text-sm font-semibold flex items-center gap-2">
                            üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                        </button>
                        <button onclick="closeShiftSummary()"
                            class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl transition text-sm font-semibold">
                            ‡∏õ‡∏¥‡∏î
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script id="main-script">
            // --- 1. CONFIG & STATE ---


            const LOGO_URL = "https://img5.pic.in.th/file/secure-sv1/image352ad154a6a24fdc.png";
            const DISCORD_NOTIFY_WEBHOOK = "https://discord.com/api/webhooks/1447310477335068855/2jgMgTejY8csowTJ_vqLa5XvP4P1DxooZbzzAdA207sCTBGjhwWtF7IJnTc94U7NxQNu";
            const DISCORD_DELETE_WEBHOOK = "https://discord.com/api/webhooks/1447300001209253920/vEOiNdQH8a3q27h9YoyERAeojvHjGWXZzkeoQiFwEoN4lBgr_lZyubHLDkPj-ZHFLDNK";

            // --- 1. CONFIG & STATE ---
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCVBhZt0Ss5W6uUANk2EjTr16pMB4N069U",
                authDomain: "onemedicrecruitment-db.firebaseapp.com",
                projectId: "onemedicrecruitment-db",
                storageBucket: "onemedicrecruitment-db.firebasestorage.app",
                messagingSenderId: "939737328936",
                appId: "1:939737328936:web:436a3d563b4d928ba1b41d",
                measurementId: "G-22KDKTREDD"
            };
            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            let appData = {
                statusInfo: {}, founders: [], roster: [], retired: [], rules: { general: [], roleplay: [] },
                announcements: [{ text: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà One City Hospital", author: "System" }],
                blacklist: [], authUsers: {}, applicants: [], operatorSchedule: null,
                opSupport: { opName: "", supOp: "", shiftStart: null, onDuty: [], offDuty: [], cases: [] }
            };

            let rosterPage = 1, blPage = 1;
            const rosterPerPage = 5, blPerPage = 5;
            let currentUser = null;
            let currentAdminTab = 'status'; // Global State for Admin Tab Persistence
            let announcementInterval = null;
            let isAuthLoaded = false; // Flag to prevent overwriting passwords

            const navLogo = document.getElementById('nav-logo');
            const heroLogo = document.getElementById('hero-logo');
            if (navLogo) navLogo.src = LOGO_URL;
            if (heroLogo) heroLogo.src = LOGO_URL;
            let db = null; let isFirebaseActive = false;

            const THEME_COLORS = {
                'orange': { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200', darkBg: 'dark:bg-orange-900/50', darkText: 'dark:text-orange-200', darkBorder: 'dark:border-orange-800' },
                'brown': { bg: 'bg-stone-200', text: 'text-stone-800', border: 'border-stone-300', darkBg: 'dark:bg-[#4E342E]', darkText: 'dark:text-[#D7CCC8]', darkBorder: 'dark:border-[#795548]' },
                'red': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-200', darkBg: 'dark:bg-red-900/50', darkText: 'dark:text-red-200', darkBorder: 'dark:border-red-800' },
                'green': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-200', darkBg: 'dark:bg-green-900/50', darkText: 'dark:text-green-200', darkBorder: 'dark:border-green-800' },
                'yellow': { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-200', darkBg: 'dark:bg-yellow-900/50', darkText: 'dark:text-yellow-200', darkBorder: 'dark:border-yellow-800' },
                'sky': { bg: 'bg-sky-100', text: 'text-sky-800', border: 'border-sky-200', darkBg: 'dark:bg-sky-900/50', darkText: 'dark:text-sky-200', darkBorder: 'dark:border-sky-800' },
                'gray': { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-200', darkBg: 'dark:bg-gray-700', darkText: 'dark:text-gray-300', darkBorder: 'dark:border-gray-600' }
            };

            const RANKS = {
                'Director': { label: '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£', badge: 'DIR', priority: 1, colorKey: 'orange' },
                'Deputy': { label: '‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£', badge: 'DEP', priority: 2, colorKey: 'brown' },
                'AsstDeputy': { label: '‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£', badge: 'AST', priority: 3, colorKey: 'red' },
                'HeadDoc': { label: '‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå', badge: 'H.DOC', priority: 4, colorKey: 'green' },
                'Specialist': { label: '‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏≤‡∏á', badge: 'SPEC', priority: 5, colorKey: 'yellow' },
                'Doctor': { label: '‡πÅ‡∏û‡∏ó‡∏¢‡πå', badge: 'MD', priority: 6, colorKey: 'sky' },
                'Intern': { label: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå', badge: 'INT', priority: 7, colorKey: 'gray' }
            };

            // --- 2. HELPERS & UTILS ---
            function showNotif(title, msg, type = null) {
                const modal = document.getElementById('notification');
                const titleEl = document.getElementById('notif-title');
                const msgEl = document.getElementById('notif-msg');
                const iconEl = document.getElementById('notif-icon');

                titleEl.textContent = title;
                msgEl.textContent = msg;

                // Infer type if not provided
                if (!type) {
                    if (/Success|Saved|Approved|Copied|‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å|‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à|‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å/.test(title)) type = 'success';
                    else if (/Error|Failed|Rejected|‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î|Limit/.test(title)) type = 'error';
                    else if (/Info|‡πÅ‡∏à‡πâ‡∏á|‡πÑ‡∏°‡πà‡∏°‡∏µ/.test(title)) type = 'info';
                }

                if (type === 'success') {
                    iconEl.innerHTML = `<div class="checkmark-circle"></div><div class="checkmark"><div class="checkmark-check"></div></div><svg class="w-14 h-14" viewBox="0 0 52 52"><circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/></svg>`;
                    // Easier SVG injection for animation consistency
                    iconEl.innerHTML = `<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg>`;
                } else if (type === 'error') {
                    iconEl.innerHTML = `<svg class="cross-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="cross-circle" cx="26" cy="26" r="25" fill="none"/><path class="cross-line" fill="none" d="M16 16 36 36 M36 16 16 36"/></svg>`;
                } else if (type === 'info') {
                    iconEl.innerHTML = `<svg class="info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52" style="width: 56px; height: 56px;">
                        <circle cx="26" cy="26" r="25" fill="none" stroke="#3b82f6" stroke-width="2" style="stroke-dasharray: 166; stroke-dashoffset: 166; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;"/>
                        <text x="26" y="34" text-anchor="middle" font-size="32" font-weight="bold" fill="#3b82f6" style="opacity: 0; animation: fadeIn 0.3s ease 0.6s forwards;">!</text>
                    </svg>`;
                } else {
                    iconEl.innerHTML = ''; // No icon for generic
                }

                modal.classList.remove('hidden');
                // Auto hide after 2s if success or info
                if (type === 'success' || type === 'info') {
                    setTimeout(() => modal.classList.add('hidden'), 2000);
                }
            }

            function showConfirm(title, msg) {
                return new Promise(resolve => {
                    document.getElementById('confirm-title').innerText = title;
                    document.getElementById('confirm-msg').innerText = msg;
                    const modal = document.getElementById('confirm-modal');
                    modal.classList.remove('hidden');
                    const yesBtn = document.getElementById('confirm-yes-btn');
                    const noBtn = document.getElementById('confirm-no-btn');

                    const newYes = yesBtn.cloneNode(true);
                    const newNo = noBtn.cloneNode(true);
                    yesBtn.parentNode.replaceChild(newYes, yesBtn);
                    noBtn.parentNode.replaceChild(newNo, noBtn);

                    newYes.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                    newNo.onclick = () => { modal.classList.add('hidden'); resolve(false); };
                });
            }

            function formatDate(dateStr) {
                if (!dateStr) return "-";
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            function calculateDuration(startDate) {
                if (!startDate) return "-";
                const diffTime = Math.abs(new Date() - new Date(startDate));
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const years = Math.floor(diffDays / 365);
                const months = Math.floor((diffDays % 365) / 30);
                const days = diffDays % 30;
                let s = "";
                if (years > 0) s += `${years} ‡∏õ‡∏µ `;
                if (months > 0) s += `${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô `;
                s += `${days} ‡∏ß‡∏±‡∏ô`;
                return s;
            }

            function calculateEndDate(dischargeDate, cdDays) {
                if (!dischargeDate || !cdDays) return { text: "-", date: null };
                const end = new Date(new Date(dischargeDate).getTime() + (parseInt(cdDays) * 24 * 60 * 60 * 1000));
                return { text: formatDate(end), date: end };
            }

            function navigateTo(id) {
                const element = document.getElementById(id);
                if (element) {
                    const offsetPosition = element.getBoundingClientRect().top + window.pageYOffset - 90;
                    window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                    document.querySelectorAll('.nav-item').forEach(link => { link.classList.remove('active'); if (link.getAttribute('data-target') === id) link.classList.add('active'); });
                }
                document.getElementById('mobile-menu').classList.add('hidden');
            }

            function renderShifts() {
                const container = document.getElementById('admin-shift-list');
                if (!container) return;

                const search = document.getElementById('shift-search').value.toLowerCase();
                const list = appData.roster || [];

                // Sort by Rank
                const sorted = [...list].sort((a, b) => {
                    const pA = RANKS[a.roleKey]?.priority || 99;
                    const pB = RANKS[b.roleKey]?.priority || 99;
                    return pA - pB;
                });

                let html = '';
                let index = 1;
                sorted.forEach(r => {
                    const rank = RANKS[r.roleKey] || { label: 'Unknown', colorKey: 'gray' };
                    const match = r.name.toLowerCase().includes(search) || rank.label.toLowerCase().includes(search);
                    if (!match) return;

                    let statusColor = 'text-emerald-500';
                    if (r.status === '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô') statusColor = 'text-slate-400';
                    if (r.status === '‡∏•‡∏≤‡∏á‡∏≤‡∏ô') statusColor = 'text-amber-500';
                    if (r.status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô') statusColor = 'text-red-500';

                    html += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                        <td class="p-3 text-center text-slate-400 font-mono text-xs">${index++}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded-md text-xs font-bold bg-slate-100 dark:bg-slate-700 ${THEME_COLORS[rank.colorKey]?.text || ''} ${THEME_COLORS[rank.colorKey]?.darkText || ''}">${rank.badge}</span></td>
                        <td class="p-3 font-medium text-slate-800 dark:text-gray-200">${r.name}</td>
                        <td class="p-3 text-slate-500 text-xs font-mono">${r.onlineTime || '-'}</td>
                        <td class="p-3 text-center font-bold text-xs ${statusColor}">${r.status || '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'}</td>
                     </tr>`;
                });

                if (html === '') html = '<tr><td colspan="5" class="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                container.innerHTML = html;
            }

            function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
            function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('hidden'); }
            function toggleAdminPanel() {
                const modal = document.getElementById('admin-modal');
                const content = document.getElementById('admin-modal-content');
                const dash = document.getElementById('admin-dashboard-view');
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) { content.classList.remove('animate-popup'); void content.offsetWidth; content.classList.add('animate-popup'); if (!dash.classList.contains('hidden')) renderAll(); }
            }
            function switchAdminTab(tab, btnElement) {
                currentAdminTab = tab; // Persist State
                ['founders', 'roster', 'retired', 'rules', 'status', 'announce', 'blacklist', 'users', 'applicants', 'shifts', 'permissions', 'logs'].forEach(t => {
                    const el = document.getElementById(`admin-editor-${t}`);
                    if (el) el.classList.add('hidden');
                });

                const target = document.getElementById(`admin-editor-${tab}`);
                if (target) target.classList.remove('hidden');

                if (tab === 'applicants') fetchApplicants();
                if (tab === 'shifts') renderShifts();
                if (tab === 'permissions') renderPermissionsTab();
                if (tab === 'logs') renderLogsTab();

                document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                    btn.classList.remove('bg-white', 'text-sky-600', 'shadow-md', 'ring-1', 'ring-slate-200', 'dark:bg-slate-800', 'dark:text-sky-400', 'dark:ring-slate-700');
                    btn.classList.add('text-slate-500');
                });
                if (btnElement) {
                    btnElement.classList.remove('text-slate-500');
                    btnElement.classList.add('bg-white', 'text-sky-600', 'shadow-md', 'ring-1', 'ring-slate-200', 'dark:bg-slate-800', 'dark:text-sky-400', 'dark:ring-slate-700');
                }
            }
            // --- 3. CORE LOGIC & RENDERS ---
            function renderAll() {
                renderStatus();
                renderAnnouncement();
                renderBlacklist();
                renderFounders();
                renderRoster();
                renderRetired();
                renderRules();
                renderUserManagement();
                renderShifts();
                renderStatusChart();
            }

            function startAnnounceCarousel(len) {
                if (announcementInterval) clearInterval(announcementInterval);
                const track = document.getElementById('announce-track');
                const dots = document.getElementById('announce-dots');
                let idx = 0;
                announcementInterval = setInterval(() => {
                    idx = (idx + 1) % len;
                    track.scrollTo({ left: track.clientWidth * idx, behavior: 'smooth' });
                    if (dots) Array.from(dots.children).forEach((d, i) => {
                        d.className = `w-2 h-2 rounded-full bg-white transition-all duration-300 ${i === idx ? 'opacity-100 scale-125' : 'opacity-40'}`;
                    });
                }, 5000);
            }

            function animateShuffle(obj, finalValue, duration) {
                const startTime = Date.now();
                const interval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    if (elapsed >= duration) {
                        clearInterval(interval);
                        // Final Value: Show naturally (e.g. "15" instead of "015")
                        obj.innerText = finalValue + " ‡∏ó‡πà‡∏≤‡∏ô";
                    } else {
                        // Random 3 digit number (Slot machine effect)
                        const randomNum = Math.floor(Math.random() * 1000);
                        obj.innerText = randomNum.toString().padStart(3, '0') + " ‡∏ó‡πà‡∏≤‡∏ô";
                    }
                }, 50);
            }

            function renderStatus() {
                if (!appData.statusInfo) return;
                const em = appData.statusInfo.emergency || '-';
                const wel = appData.statusInfo.welfare || '-';
                const emEl = document.getElementById('status-emergency-text');
                if (emEl) emEl.innerText = em;
                const welEl = document.getElementById('status-welfare-text');
                if (welEl) welEl.innerText = wel;

                const total = (appData.roster || []).length;
                const totalEl = document.getElementById('status-total-medics');
                if (totalEl) {
                    animateShuffle(totalEl, total, 2000); // Shuffle for 2 seconds
                }

                // Admin inputs for status
                const editEm = document.getElementById('edit-status-emergency');
                if (editEm) editEm.value = em;
                const editWel = document.getElementById('edit-status-welfare');
                if (editWel) editWel.value = wel;
            }

            function addAnnouncementRow() {
                if (!appData.announcements) appData.announcements = [];
                if (appData.announcements.length >= 7) return showNotif('Limit Reached', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 7 ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®');

                appData.announcements.push({
                    text: "",
                    author: currentUser ? currentUser.name : "Admin"
                });
                renderAnnouncement();
                saveData('announcements', true, true);
            }

            function updateAnnouncementText(index, value) {
                if (!appData.announcements[index]) return;
                appData.announcements[index].text = value;
                saveData('announcements', true, true);
            }

            function renderAnnouncement() {
                const track = document.getElementById('announce-track');
                if (!track) return;
                const list = appData.announcements || [];
                if (list.length === 0) { track.innerHTML = '<div class="h-full min-w-full flex items-center justify-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div>'; return; }
                track.innerHTML = list.map(a => `<div class="h-full min-w-full flex flex-col items-center justify-center text-center px-8 snap-center"><p class="text-lg md:text-2xl font-medium leading-relaxed drop-shadow-md">\"${a.text}\"</p><p class="text-sm mt-2 opacity-80">- ${a.author} -</p></div>`).join('');
                const dots = document.getElementById('announce-dots');
                if (dots) dots.innerHTML = list.map((_, i) => `<div class="w-2 h-2 rounded-full bg-white transition-all duration-300 ${i === 0 ? 'opacity-100 scale-125' : 'opacity-40'}"></div>`).join('');
                startAnnounceCarousel(list.length);

                // Admin
                const adminList = document.getElementById('admin-announce-list');
                if (adminList) {
                    adminList.innerHTML = list.map((a, i) => `
                        <div class="admin-announce-row flex gap-2 items-center bg-white dark:bg-slate-800 p-2 rounded-xl border dark:border-slate-700 shadow-sm">
                            <div class="flex-1">
                                <textarea class="inp-text inp-primary w-full text-sm mb-1" rows="2" onchange="updateAnnouncementText(${i}, this.value)">${a.text}</textarea>
                                <span class="text-xs text-slate-400">By: ${a.author}</span>
                            </div>
                            <button onclick="appData.announcements.splice(${i},1); saveData('announcements', true, true); renderAnnouncement();" class="text-red-500 hover:bg-red-50 p-2 rounded-xl">üóëÔ∏è</button>
                        </div>`).join('');
                }
            }

            function renderFounders() {
                const list = appData.founders || [];
                document.getElementById('founders-grid').innerHTML = list.map(f => `
                            <div class="flex flex-col items-center group max-w-sm mx-auto text-center hover-card p-4 rounded-2xl transition">
                                <div class="w-32 h-32 md:w-40 md:h-40 mb-5 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-700 dark:to-slate-800 p-1.5 shadow-xl group-hover:scale-105 transition duration-300 overflow-hidden relative">
                                    ${(f.imageUrl && f.imageUrl.trim() !== '') ? `<img src="${f.imageUrl}" class="w-full h-full rounded-full object-cover shadow-inner bg-white dark:bg-slate-800">` : (f.discordId ? `<img src="https://cdn.discordapp.com/embed/avatars/0.png" data-discord-id="${f.discordId}" class="w-full h-full rounded-full object-cover shadow-inner bg-white dark:bg-slate-800">` :
                        `<div class="w-full h-full rounded-full bg-white dark:bg-slate-800 flex items-center justify-center text-5xl md:text-6xl select-none shadow-inner">${f.icon || 'üëë'}</div>`)}
                                </div>
                                <h3 class="font-bold text-xl md:text-2xl text-slate-800 dark:text-white mb-2 group-hover:text-sky-600 transition">${f.name}</h3>
                                <span class="px-3 py-1 bg-sky-100 text-sky-700 dark:bg-sky-900/50 dark:text-sky-300 text-xs rounded-full font-bold uppercase tracking-wider mb-4 inline-block">${f.role}</span>
                                ${f.history ? `<p class="text-sm md:text-base text-slate-600 dark:text-slate-300 leading-relaxed font-light px-2 min-h-[60px]">${f.history}</p>` : ''}
                            </div>`).join('');

                // Admin
                const adminList = document.getElementById('admin-founders-list');
                if (adminList) {
                    adminList.innerHTML = list.map((f, i) => `
                                <div class="admin-lead-row flex flex-col gap-3 bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700">
                                    <div class="flex gap-2 items-center">
                                        <input class="inp-image-url inp-primary flex-1" value="${f.imageUrl || ''}" placeholder="Image URL (http...)">
                                        <input class="inp-icon inp-primary w-16 text-center" value="${f.icon || ''}" placeholder="Emoji">
                                    </div>
                                    <div class="flex gap-2 items-center">
                                        <input class="inp-name inp-primary flex-1 font-bold" value="${f.name}" placeholder="Name">
                                        <input class="inp-role inp-primary w-1/3" value="${f.role}" placeholder="Role">
                                    </div>
                                    <textarea class="inp-history inp-primary w-full text-sm leading-relaxed" rows="3" placeholder="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤...">${f.history || ''}</textarea>
                                </div>`).join('');
                }
            }

            const invalidLanyardIds = new Set(); // Cache for failed IDs

            async function fetchDiscordAvatar(element) {
                const id = element.getAttribute('data-discord-id');
                if (!id) return;
                if (invalidLanyardIds.has(id)) return; // Skip known invalid IDs

                try {
                    const response = await fetch(`https://api.lanyard.rest/v1/users/${id}`);
                    if (!response.ok) {
                        invalidLanyardIds.add(id); // Mark as invalid
                        return;
                    }
                    const data = await response.json();
                    if (data.success && data.data.discord_user.avatar) {
                        const avatarId = data.data.discord_user.avatar;
                        const isGif = avatarId.startsWith('a_');
                        element.src = `https://cdn.discordapp.com/avatars/${id}/${avatarId}.${isGif ? 'gif' : 'png'}`;
                    } else {
                        invalidLanyardIds.add(id); // Mark as invalid if no avatar/success
                    }
                } catch (e) {
                    invalidLanyardIds.add(id); // Mark as invalid on error
                }
            }

            function updateDiscordImages() {
                document.querySelectorAll('img[data-discord-id]').forEach(img => {
                    if (img.dataset.processed) return;
                    img.dataset.processed = "true";
                    fetchDiscordAvatar(img);
                });
            }

            function renderRoster() {
                const list = appData.roster || [];
                list.forEach(r => { if (!r.roleKey || !RANKS[r.roleKey]) r.roleKey = 'Intern'; });
                const sortedRoster = [...list].sort((a, b) => {
                    const pA = RANKS[a.roleKey]?.priority || 99; const pB = RANKS[b.roleKey]?.priority || 99;
                    return pA - pB;
                });
                const leaders = sortedRoster.filter(r => RANKS[r.roleKey].priority < 4);
                document.getElementById('leadership-grid').innerHTML = leaders.map(r => {
                    const rank = RANKS[r.roleKey]; const color = THEME_COLORS[rank.colorKey];
                    let status = r.status || '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô';
                    let statusColor = status === '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' ? 'bg-emerald-500' : (status === '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô' ? 'bg-slate-400' : (status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' ? 'bg-red-500' : 'bg-amber-500'));

                    if (status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' && r.statusDate) {
                        const diffDays = Math.ceil(Math.abs(new Date() - new Date(r.statusDate)) / (1000 * 60 * 60 * 24));
                        status += ` (${diffDays} ‡∏ß‡∏±‡∏ô)`;
                    }

                    // Use Discord ID for image if available
                    // Use Image URL if available, else Discord ID, else Placeholder
                    const imgAttr = (r.imageUrl && r.imageUrl.trim() !== '')
                        ? `src="${r.imageUrl}"`
                        : (r.discordId ? `src="https://cdn.discordapp.com/embed/avatars/0.png" data-discord-id="${r.discordId}"` : `src="https://via.placeholder.com/150?text=IMG"`);

                    return `<div class="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-md border-t-4 ${color.border.replace('border-', 'border-t-')} hover:-translate-y-1 transition duration-300 relative overflow-hidden">
                                    <div class="absolute top-2 right-2 flex items-center gap-1.5"><span class="w-2 h-2 rounded-full ${statusColor} animate-pulse"></span><span class="text-[10px] text-slate-400">${status}</span></div>
                                    <div class="flex items-center space-x-4">
                                        <img ${imgAttr} class="w-16 h-16 rounded-full object-cover ring-2 ring-offset-2 ring-slate-100 dark:ring-slate-700">
                                            <div><h3 class="font-bold text-slate-800 dark:text-white">${r.name}</h3><span class="inline-block px-2 py-0.5 mt-1 rounded text-xs font-bold ${color.bg} ${color.text} ${color.darkBg} ${color.darkText}">${rank.label}</span></div>
                                    </div></div>`;
                }).join('');

                const paged = sortedRoster.slice((rosterPage - 1) * rosterPerPage, rosterPage * rosterPerPage);
                document.getElementById('roster-list').innerHTML = paged.map(r => {
                    const rank = RANKS[r.roleKey]; const color = THEME_COLORS[rank.colorKey]; const duration = calculateDuration(r.startDate);
                    let status = r.status || '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô';
                    let statusColor = status === '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' ? 'bg-emerald-500' : (status === '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô' ? 'bg-slate-400' : (status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' ? 'bg-red-500' : 'bg-amber-500'));

                    if (status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' && r.statusDate) {
                        const diffDays = Math.ceil(Math.abs(new Date() - new Date(r.statusDate)) / (1000 * 60 * 60 * 24));
                        status += ` (${diffDays} ‡∏ß‡∏±‡∏ô)`;
                    }

                    const imgAttr = (r.imageUrl && r.imageUrl.trim() !== '')
                        ? `src="${r.imageUrl}"`
                        : (r.discordId ? `src="https://cdn.discordapp.com/embed/avatars/0.png" data-discord-id="${r.discordId}"` : `src="https://via.placeholder.com/150?text=IMG"`);

                    return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition border-b border-slate-100 dark:border-slate-800/50 last:border-0">
                                    <td class="p-4 pl-6 align-middle"><img ${imgAttr} class="w-10 h-10 rounded-full object-cover ring-2 ring-slate-100 dark:ring-slate-700"></td>
                                    <td class="p-4 align-middle whitespace-nowrap font-bold text-slate-800 dark:text-white text-base">${r.name}</td>
                                    <td class="p-4 align-middle whitespace-nowrap"><span class="px-2.5 py-1 rounded-lg text-xs font-bold shadow-sm border border-black/5 ${color.bg} ${color.text} ${color.darkBg} ${color.darkText}">${rank.label}</span></td>
                                    <td class="p-4 align-middle whitespace-nowrap text-center">
                                        <div class="inline-flex items-center justify-center gap-2 px-3 py-1 bg-slate-50 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700">
                                            <span class="w-2 h-2 rounded-full ${statusColor} animate-pulse shadow-sm shadow-${statusColor}/50"></span>
                                            <span class="text-xs text-slate-600 dark:text-slate-300 font-medium">${status}</span>
                                        </div>
                                    </td>
                                    <td class="p-4 align-middle text-right whitespace-nowrap text-slate-500 dark:text-slate-400 text-sm font-mono">${duration}</td>
                                </tr>`;
                }).join('');
                document.getElementById('roster-page-info').innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${rosterPage} / ${Math.ceil(sortedRoster.length / rosterPerPage) || 1}`;
                document.getElementById('roster-prev').disabled = rosterPage === 1;
                document.getElementById('roster-next').disabled = rosterPage >= Math.ceil(sortedRoster.length / rosterPerPage);
                updateDiscordImages();

                // Admin
                const adminList = document.getElementById('admin-roster-list');
                if (adminList) {
                    adminList.innerHTML = list.map((r, i) => `
                                <div class="admin-roster-row bg-white dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 shadow-sm flex flex-col gap-3 group">
                                    <div class="grid grid-cols-12 gap-3 items-start">
                                        <div class="col-span-12 md:col-span-4">
                                            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                            <input class="inp-name inp-primary w-full font-bold" value="${r.name}" placeholder="Name">
                                        </div>
                                        <div class="col-span-6 md:col-span-4">
                                            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                            <select class="inp-role inp-primary w-full dark:bg-slate-700">
                                            ${Object.keys(RANKS).map(k => `<option value="${k}" ${r.roleKey === k ? 'selected' : ''}>${RANKS[k].label}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="col-span-6 md:col-span-4">
                                            <label class="text-[10px] uppercase font-bold text-slate-400 mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                                            <select class="inp-status inp-primary w-full dark:bg-slate-700">
                                                <option value="‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" ${r.status === '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' ? 'selected' : ''}>üü¢ ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</option>
                                                <option value="‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô" ${r.status === '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô' ? 'selected' : ''}>‚ö™ ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô</option>
                                                <option value="‡∏•‡∏≤‡∏á‡∏≤‡∏ô" ${r.status === '‡∏•‡∏≤‡∏á‡∏≤‡∏ô' ? 'selected' : ''}>üü† ‡∏•‡∏≤‡∏á‡∏≤‡∏ô</option>
                                                <option value="‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" ${r.status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' ? 'selected' : ''}>üî¥ ‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 7 ‡∏ß‡∏±‡∏ô)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-12 gap-3 items-center">
                                        <div class="col-span-12 md:col-span-3">
                                            <input class="inp-discord-id inp-primary w-full text-xs font-mono" value="${r.discordId || ''}" placeholder="Discord ID">
                                        </div>
                                        <div class="col-span-12 md:col-span-5">
                                            <input class="inp-image-url inp-primary w-full text-xs font-mono" value="${r.imageUrl || ''}" placeholder="Image URL (Optional)">
                                        </div>
                                        <div class="col-span-8 md:col-span-3">
                                            <input type="date" class="inp-start-date inp-primary w-full dark:bg-slate-700 text-xs" value="${r.startDate || ''}">
                                        </div>
                                        <div class="col-span-4 md:col-span-1 text-right">
                                            <button onclick="appData.roster.splice(${i},1); renderRoster();" class="text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-lg transition-colors w-full flex justify-center items-center h-full border border-transparent hover:border-red-200 dark:hover:border-red-900">
                                                <span class="material-icons">üóëÔ∏è</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>`).join('');
                }
            }

            function renderRetired() {
                const list = appData.retired || [];
                const container = document.getElementById('retired-scroller');
                if (list.length === 0) { container.innerHTML = '<div class="p-4 text-center text-slate-500">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</div>'; return; }
                container.innerHTML = list.map(r => {
                    const endInfo = calculateEndDate(r.dischargeDate, r.cooldownDays);
                    const isFree = !endInfo.date || new Date() > endInfo.date;
                    return `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4 px-4 py-4 border-b border-slate-100 dark:border-slate-800 text-sm items-center hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
                                    <div class="col-span-1 font-medium text-slate-800 dark:text-white flex items-center gap-2">
                                        <span class="sm:hidden text-xs text-slate-400 w-20">‡∏ä‡∏∑‡πà‡∏≠:</span>
                                        ${r.name}
                                    </div>
                                    <div class="col-span-1 text-slate-500 flex items-center gap-2">
                                        <span class="sm:hidden text-xs text-slate-400 w-20">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏î:</span>
                                        ${formatDate(r.dischargeDate)}
                                    </div>
                                    <div class="col-span-1 text-slate-500 flex items-center gap-2">
                                        <span class="sm:hidden text-xs text-slate-400 w-20">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</span>
                                        ${r.cooldownDays} ‡∏ß‡∏±‡∏ô (${endInfo.text})
                                    </div>
                                    <div class="col-span-1 text-left lg:text-right flex items-center gap-2">
                                        <span class="sm:hidden text-xs text-slate-400 w-20">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${isFree ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isFree ? '‡∏´‡∏°‡∏î‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå' : '‡∏ï‡∏¥‡∏î‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå'}</span>
                                    </div>
                                </div>`;
                }).join('');
                // Admin (No Change needed here)
                const adminList = document.getElementById('admin-retired-list');
                if (adminList) {
                    adminList.innerHTML = list.map((r, i) => `
                                <div class="admin-retired-row flex gap-2 items-center bg-white dark:bg-slate-800 p-2 rounded-xl border dark:border-slate-700">
                                    <input class="inp-name inp-primary flex-1" value="${r.name}" placeholder="Name">
                                    <input type="date" class="inp-date inp-primary w-32 dark:bg-slate-700" value="${r.dischargeDate}">
                                    <input class="inp-cd-days inp-primary w-20" value="${r.cooldownDays}" placeholder="Days">
                                    <button onclick="appData.retired.splice(${i},1); renderRetired();" class="text-red-500 p-2">üóëÔ∏è</button>
                                </div>`).join('');
                }
            }

            // --- Helper Add Functions ---
            function addRosterRow() {
                if (!appData.roster) appData.roster = [];
                appData.roster.push({
                    name: "",
                    discordId: "",
                    roleKey: "Intern",
                    status: "‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô",
                    startDate: new Date().toISOString().split('T')[0],
                    imageUrl: ""
                });
                renderRoster();
            }

            function addRetiredRow() {
                if (!appData.retired) appData.retired = [];
                appData.retired.push({
                    name: "",
                    dischargeDate: new Date().toISOString().split('T')[0],
                    cooldownDays: 30
                });
                renderRetired();
            }

            function addBlacklistRow() {
                if (!appData.blacklist) appData.blacklist = [];
                appData.blacklist.push({
                    name: "",
                    reason: "",
                    penalty: "",
                    recorder: currentUser ? currentUser.name : "Admin",
                    status: "Active"
                });
                renderBlacklist();
            }

            function addFounderRow() {
                if (!appData.founders) appData.founders = [];
                appData.founders.push({
                    name: "",
                    role: "",
                    imageUrl: "",
                    icon: "üëë",
                    history: ""
                });
                renderFounders();
            }

            let activeRuleTab = 'general';
            function switchTab(t) {
                activeRuleTab = t;
                renderRules();
            }

            function renderRules() {
                const list = appData.rules ? (appData.rules[activeRuleTab] || []) : [];
                const container = document.getElementById('rules-container');
                if (container) {
                    let html = list.map((r, i) =>
                        `<div class="flex items-start animate-fade-in">
                                    <div class="flex-shrink-0 h-5 w-5 md:h-6 md:w-6 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center text-[10px] md:text-xs font-bold mr-3 mt-0.5">${i + 1}</div>
                                    <p class="text-slate-600 dark:text-slate-300 text-sm md:text-base leading-relaxed">${r}</p>
                                </div>`
                    ).join('');

                    html += `<div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800 animate-fade-in">
                                    <a href="https://wiki.onecity-rp.com/" target="_blank" class="flex items-center justify-center gap-2 w-full p-3 rounded-lg bg-sky-50 dark:bg-sky-900/20 text-sky-600 dark:text-sky-400 hover:bg-sky-100 dark:hover:bg-sky-900/40 transition group">
                                        <span class="text-lg group-hover:scale-110 transition-transform">üìö</span>
                                        <span class="text-sm font-bold">‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Wiki)</span>
                                        <span class="text-xs opacity-70">onecity-rp.com</span>
                                    </a>
                                </div>`;
                    container.innerHTML = html;
                }

                // Update Tabs UI
                const btnGen = document.getElementById('tab-general');
                const btnRp = document.getElementById('tab-roleplay');
                if (btnGen && btnRp) {
                    if (activeRuleTab === 'general') {
                        btnGen.className = "flex-1 py-2 text-sm font-bold rounded-md bg-white text-sky-600 shadow-sm transition-all btn-smooth";
                        btnRp.className = "flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition-all btn-smooth";
                    } else {
                        btnGen.className = "flex-1 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition-all btn-smooth";
                        btnRp.className = "flex-1 py-2 text-sm font-bold rounded-md bg-white text-sky-600 shadow-sm transition-all btn-smooth";
                    }
                }

                // Admin inputs for rules
                if (appData.rules) {
                    const editGen = document.getElementById('edit-rules-general');
                    if (editGen) editGen.value = (appData.rules.general || []).join('\n');
                    const editRp = document.getElementById('edit-rules-roleplay');
                    if (editRp) editRp.value = (appData.rules.roleplay || []).join('\n');
                }
            }

            function addManualUser() {
                const idInput = document.getElementById('new-user-id');
                const id = idInput.value.trim();
                if (!id) return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ Discord ID');
                if (id.length < 18) return showNotif('Warning', 'Discord ID ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ 18 ‡∏´‡∏•‡∏±‡∏Å');

                if (!appData.authUsers) appData.authUsers = {};
                if (appData.authUsers[id]) return showNotif('Error', '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');

                appData.authUsers[id] = {
                    role: 'staff',
                    password: '123456',
                    requiresReset: true
                };
                saveData('authUsers', true);
                idInput.value = '';
                renderUserManagement();
                showNotif('Success', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            function updateUserRole(id, role) {
                if (appData.authUsers && appData.authUsers[id]) {
                    appData.authUsers[id].role = role;
                    saveData('authUsers', true); // Auto save for role change
                }
            }

            function deleteUser(id) {
                if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ' + id + '?')) return;
                if (appData.authUsers && appData.authUsers[id]) {
                    delete appData.authUsers[id];
                    saveData('authUsers', true);
                    renderUserManagement();
                }
            }

            function renderUserManagement() {
                const list = document.getElementById('admin-users-list'); if (!list) return;
                const userIds = Object.keys(appData.authUsers || {});
                list.innerHTML = userIds.map(id => {
                    const user = appData.authUsers[id];
                    const rosterMatch = (appData.roster || []).find(r => r.discordId === id);
                    return `<tr class="border-b dark:border-slate-700"><td class="p-2 font-mono text-xs">${id}</td><td class="p-2 text-sm">${rosterMatch ? rosterMatch.name : 'Unknown'}</td><td class="p-2 text-sm"><select onchange="updateUserRole('${id}', this.value)" class="p-1 rounded dark:bg-slate-700 border border-slate-300"><option value="staff" ${user.role === 'staff' ? 'selected' : ''}>Staff</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option></select></td><td class="p-2 text-right"><button onclick="deleteUser('${id}')" class="text-red-500 hover:underline text-xs">‡∏•‡∏ö</button></td></tr>`;
                }).join('');
            }

            // --- APPLICANTS LOGIC ---
            async function fetchApplicants() {
                if (!isFirebaseActive || !db) return;
                const container = document.getElementById('admin-applicants-list');
                container.innerHTML = '<div class="text-center p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

                try {
                    const snap = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                    // Filter only pending applications (or legacy ones without status)
                    appData.applicants = snap.docs
                        .map(d => ({ id: d.id, ...d.data() }))
                        .filter(a => !a.status || a.status === 'pending');
                    renderApplicants();
                } catch (e) {
                    console.error(e);
                    container.innerHTML = `<div class="text-red-500 text-center">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}</div>`;
                }
            }

            function renderApplicants() {
                const list = appData.applicants || [];
                const container = document.getElementById('admin-applicants-list');
                if (!container) return;

                if (list.length === 0) {
                    container.innerHTML = '<div class="text-center p-8 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>';
                    return;
                }

                container.innerHTML = list.map((app, i) => `
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden hover:shadow-md transition-shadow duration-300">
                        <!-- Card Header -->
                        <div class="px-5 py-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <span class="w-2 h-8 rounded-full bg-sky-500"></span>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800 dark:text-white leading-tight">
                                        ${app.ic_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                                    </h3>
                                    <div class="text-xs font-mono text-slate-500 dark:text-slate-400 mt-0.5 flex items-center gap-1">
                                        <span class="opacity-50">ID:</span> ${app.discord_id || '-'}
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1">
                                <span class="px-2.5 py-1 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-[10px] font-bold text-slate-600 dark:text-slate-300 shadow-sm">
                                    ‡∏≠‡∏≤‡∏¢‡∏∏ OC: ${app.oc_age || '-'}
                                </span>
                                <span class="text-[10px] text-slate-400">
                                    ${app.timestamp ? new Date(app.timestamp.toDate()).toLocaleDateString('th-TH') : '-'}
                                </span>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="p-5 space-y-4">
                            <!-- Info Grid -->
                            <div class="grid grid-cols-1 gap-4 text-sm">
                                <div>
                                    <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å</span>
                                    <div class="font-medium text-slate-700 dark:text-slate-200 flex items-center gap-2">
                                        <span class="text-base">‚è∞</span> ${app.online_time || '-'}
                                    </div>
                                </div>
                                <div>
                                    <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                                    <div class="p-3 rounded-xl bg-slate-50 dark:bg-slate-900/50 text-slate-600 dark:text-slate-300 leading-relaxed text-sm border border-slate-100 dark:border-slate-800">
                                        ${app.motivation || '-'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="px-5 pb-5 pt-0 flex gap-3">
                            <button onclick="approveApplicant(${i})" class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 text-white py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/30 hover:-translate-y-0.5 transition-all duration-200 active:scale-95 flex items-center justify-center gap-2">
                                <span>‚úÖ</span> ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                            </button>
                            <button onclick="rejectApplicant(${i})" class="flex-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-red-50 dark:hover:bg-red-900/10 hover:text-red-600 dark:hover:text-red-400 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 active:scale-95 flex items-center justify-center gap-2">
                                <span>‚ùå</span> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            async function approveApplicant(index) {
                if (!await showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ Discord')) return;
                const app = appData.applicants[index];
                if (!app) return;

                const btn = document.querySelectorAll('#admin-applicants-list button')[index * 2];
                if (btn) btn.innerText = "Processing...";

                try {
                    if (DISCORD_NOTIFY_WEBHOOK) {
                        const payload = {
                            "username": "Medic Recruitment Bot",
                            "avatar_url": LOGO_URL,
                            "embeds": [{
                                "title": "‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà",
                                "color": 5763719,
                                "fields": [
                                    { "name": "üë§ ‡∏ä‡∏∑‡πà‡∏≠ IC", "value": app.ic_name || "-", "inline": true },
                                    { "name": "üéÇ ‡∏≠‡∏≤‡∏¢‡∏∏ OC", "value": app.oc_age || "-", "inline": true },
                                    { "name": "üÜî Discord ID", "value": app.discord_id || "-", "inline": false },
                                    { "name": "‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå", "value": app.online_time || "-", "inline": false },
                                    { "name": "üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£", "value": app.motivation || "-", "inline": false },
                                    { "name": "üëÆ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", "value": currentUser ? currentUser.name : "System", "inline": false }
                                ],
                                "footer": { "text": "One City Hospital Recruitment System" },
                                "timestamp": new Date().toISOString()
                            }]
                        };
                        const discordFormData = new FormData();
                        discordFormData.append('payload_json', JSON.stringify(payload));
                        await fetch(DISCORD_NOTIFY_WEBHOOK, { method: 'POST', mode: 'no-cors', body: discordFormData });
                    }

                    if (!appData.roster) appData.roster = [];
                    appData.roster.unshift({
                        name: app.ic_name,
                        roleKey: 'Intern',
                        status: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô',
                        imageUrl: '',
                        discordId: app.discord_id,
                        onlineTime: app.online_time,
                        startDate: new Date().toISOString().split('T')[0],
                        statusDate: null
                    });

                    await saveData('roster', true, true);

                    if (isFirebaseActive && db) {
                        await db.collection('applicants').doc(app.id).update({
                            status: 'approved',
                            decisionDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    appData.applicants.splice(index, 1);
                    renderApplicants();
                    renderRoster();
                    syncRosterUsers();
                    showNotif('Success', `‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${app.ic_name} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß`);

                } catch (e) {
                    console.error(e);
                    showNotif('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
                }
            }


            async function rejectApplicant(index) {
                if (!await showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£', '‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "Rejected" ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ 7 ‡∏ß‡∏±‡∏ô')) return;
                const app = appData.applicants[index];

                try {
                    if (isFirebaseActive && db) {
                        await db.collection('applicants').doc(app.id).update({
                            status: 'rejected',
                            decisionDate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    appData.applicants.splice(index, 1);
                    renderApplicants();
                    showNotif('Rejected', '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 7 ‡∏ß‡∏±‡∏ô)');
                } catch (e) {
                    showNotif('Error', e.message);
                }
            }

            // --- SYSTEM LOGS LOGIC ---
            function renderLogsTab() {
                const container = document.getElementById('admin-content-area');
                if (!container) return;

                let logDiv = document.getElementById('admin-editor-logs');
                if (!logDiv) {
                    logDiv = document.createElement('div');
                    logDiv.id = 'admin-editor-logs';
                    logDiv.className = 'hidden';
                    container.appendChild(logDiv);
                }

                logDiv.innerHTML = `<div class="p-6 text-center text-slate-500">Loading logs & status...</div>`;

                if (!db) {
                    logDiv.innerHTML = `<div class="p-6 text-center text-red-500">Database connection not available.</div>`;
                    return;
                }

                Promise.all([
                    db.collection('system_logs').orderBy('timestamp', 'desc').limit(50).get(),
                    db.collection('config').doc('bot_status').get()
                ]).then(([snap, configSnap]) => {
                    const isActive = configSnap.exists ? configSnap.data().active : true;

                    let logRows = '';
                    if (snap.empty) {
                        logRows = `<tr><td colspan="3" class="p-4 text-center text-slate-400">No logs found</td></tr>`;
                    } else {
                        snap.forEach(doc => {
                            const d = doc.data();
                            const time = d.timestamp ? new Date(d.timestamp.toDate()).toLocaleString('th-TH') : '-';
                            let badge = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-slate-100 text-slate-600">INFO</span>`;
                            if (d.level === 'WARN') badge = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-amber-100 text-amber-600">WARN</span>`;
                            if (d.level === 'ERROR') badge = `<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-600">ERROR</span>`;

                            logRows += `<tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                <td class="p-3 text-xs text-slate-500 font-mono">${time}</td>
                                <td class="p-3">${badge}</td>
                                <td class="p-3 text-sm text-slate-700 dark:text-slate-300 font-mono break-all">${d.message}</td>
                            </tr>`;
                        });
                    }

                    const html = `
                        <div class="p-6 md:p-8 space-y-6 animate-fade-in">
                           <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                <div>
                                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">System Logs</h2>
                                    <p class="text-slate-500 text-sm mt-1">Monitoring Bot & System Events</p>
                                </div>
                                <div class="flex flex-wrap items-center gap-3">
                                    
                                    <!-- Bot Toggle Switch -->
                                    <div class="flex items-center gap-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-xl shadow-sm">
                                        <div class="flex flex-col">
                                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Bot Status</span>
                                            <span id="bot-status-text" class="${isActive ? 'text-xs font-bold text-green-500' : 'text-xs font-bold text-slate-400'}">${isActive ? "ONLINE" : "OFFLINE"}</span>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="bot-toggle-input" class="sr-only peer" onchange="toggleBot(this.checked)" ${isActive ? 'checked' : ''}>
                                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:shadow-sm after:transition-all dark:border-gray-600 peer-checked:bg-green-500"></div>
                                        </label>
                                    </div>

                                    <div class="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden md:block"></div>

                                    <button onclick="renderLogsTab()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition flex items-center gap-2">
                                        <span>üîÑ</span> <span class="hidden sm:inline">Refresh</span>
                                    </button>
                                    <button onclick="clearLogs()" class="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 px-3 py-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition flex items-center gap-2">
                                        <span>üóëÔ∏è</span> <span class="hidden sm:inline">Clear</span>
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
                                <div class="overflow-x-auto max-h-[600px]">
                                    <table class="w-full text-left border-collapse relative">
                                        <thead class="bg-slate-50 dark:bg-slate-800/90 border-b border-slate-200 dark:border-slate-700 sticky top-0 backdrop-blur-sm z-10">
                                            <tr>
                                                <th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider w-40">Time</th>
                                                <th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider w-24">Level</th>
                                                <th class="p-3 text-xs font-bold text-slate-500 uppercase tracking-wider">Message</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${logRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    logDiv.innerHTML = html;
                }).catch(e => {
                    console.error(e);
                    logDiv.innerHTML = `<div class="p-6 text-center text-red-500">Failed to load logs: ${e.message}</div>`;
                });
            }

            async function clearLogs() {
                if (!await showConfirm('Clear Logs?', 'This will delete all system logs permanently.')) return;
                const batch = db.batch();
                const snap = await db.collection('system_logs').get();
                snap.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                showNotif('Success', 'Logs Cleared');
                renderLogsTab();
            }

            async function toggleBot(isActive) {
                const label = document.getElementById('bot-status-text');
                if (label) {
                    label.innerText = isActive ? "STARTING..." : "STOPPING...";
                    label.className = "text-xs font-bold text-amber-500";
                }
                const toggleInput = document.getElementById('bot-toggle-input');
                if (toggleInput) toggleInput.disabled = true;

                try {
                    const toggleFn = firebase.app().functions('asia-southeast1').httpsCallable('toggleBot');
                    const result = await toggleFn({ active: isActive });
                    showNotif('Success', result.data.message);
                    renderLogsTab();
                } catch (e) {
                    console.error(e);
                    showNotif('Error', 'Toggle failed: ' + e.message);
                    renderLogsTab();
                }
            }

            // --- PERMISSIONS LOGIC ---
            function renderPermissionsTab() {
                const container = document.getElementById('admin-content-area');
                if (!container) return;

                let permDiv = document.getElementById('admin-editor-permissions');
                if (!permDiv) {
                    permDiv = document.createElement('div');
                    permDiv.id = 'admin-editor-permissions';
                    permDiv.className = 'hidden';
                    container.appendChild(permDiv);
                }

                if (!appData.permissions) appData.permissions = { roles: { staff: ['announce', 'blacklist', 'applicants', 'shifts'] }, users: {} };
                const perms = appData.permissions;

                const allMenus = [
                    { key: 'status', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' },
                    { key: 'announce', label: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®' },
                    { key: 'founders', label: '‡∏ú‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á' },
                    { key: 'roster', label: '‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö' },
                    { key: 'retired', label: '‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏î‡∏Ø' },
                    { key: 'blacklist', label: 'Blacklist' },
                    { key: 'rules', label: '‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö' },
                    { key: 'shifts', label: '‡πÄ‡∏ß‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå' },
                    { key: 'applicants', label: '‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' },
                    { key: 'users', label: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Users)' }
                ];

                let html = `
                    <div class="p-6 md:p-8 space-y-8 animate-fade-in max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Admin Permissions</h2>
                                <p class="text-slate-500 text-sm mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Role ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
                            </div>
                            <button onclick="saveData('permissions', false, true)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow font-medium transition flex items-center gap-2">
                                <span>üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                            </button>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                            <h3 class="font-bold text-lg text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-600 p-1 rounded">üõ°Ô∏è</span> Role: Staff
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                ${allMenus.map(m => {
                    const isChecked = (perms.roles.staff || []).includes(m.key) ? 'checked' : '';
                    return `
                                        <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-100 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer">
                                            <input type="checkbox" onchange="updateRolePerm('staff', '${m.key}', this.checked)" ${isChecked} class="w-4 h-4 text-indigo-600 rounded">
                                            <span class="text-sm font-medium text-slate-700 dark:text-slate-300">${m.label}</span>
                                        </label>
                                    `;
                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                             <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                    <span class="bg-purple-100 text-purple-600 p-1 rounded">üë§</span> User Exceptions (‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•)
                                </h3>
                                <button onclick="addUserPermException()" class="text-sm text-indigo-600 hover:text-indigo-800 font-bold">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                            </div>
                            <div id="user-perms-list" class="space-y-4">
                                ${Object.keys(perms.users || {}).map(uid => {
                    const userMenus = perms.users[uid] || [];
                    const rosterMatch = (appData.roster || []).find(r => r.discordId === uid);
                    const name = rosterMatch ? rosterMatch.name : uid;
                    return `
                                        <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-4">
                                            <div class="flex justify-between items-center mb-3">
                                                <div class="font-bold text-slate-700 dark:text-slate-200">${name} <span class="text-xs font-mono text-slate-400 font-normal">(${uid})</span></div>
                                                <button onclick="deleteUserPerm('${uid}')" class="text-red-500 hover:text-red-700 text-sm">‡∏•‡∏ö</button>
                                            </div>
                                            <div class="flex flex-wrap gap-2">
                                                ${allMenus.map(m => {
                        const isChecked = userMenus.includes(m.key) ? 'checked' : '';
                        const style = isChecked ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-slate-50 border-slate-200 text-slate-500';
                        return `
                                                        <label class="px-2 py-1 rounded text-xs border cursor-pointer select-none transition ${style}">
                                                            <input type="checkbox" class="hidden" onchange="updateUserPerm('${uid}', '${m.key}', this.checked)" ${isChecked}>
                                                            ${m.label}
                                                        </label>
                                                    `;
                    }).join('')}
                                            </div>
                                        </div>
                                    `;
                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                permDiv.innerHTML = html;
            }

            function updateRolePerm(role, key, checked) {
                if (!appData.permissions) appData.permissions = { roles: {}, users: {} };
                if (!appData.permissions.roles[role]) appData.permissions.roles[role] = [];
                if (checked) {
                    if (!appData.permissions.roles[role].includes(key)) appData.permissions.roles[role].push(key);
                } else {
                    appData.permissions.roles[role] = appData.permissions.roles[role].filter(k => k !== key);
                }
            }

            function updateUserPerm(uid, key, checked) {
                if (!appData.permissions) appData.permissions = { roles: {}, users: {} };
                if (!appData.permissions.users[uid]) appData.permissions.users[uid] = [];
                if (checked) {
                    if (!appData.permissions.users[uid].includes(key)) appData.permissions.users[uid].push(key);
                } else {
                    appData.permissions.users[uid] = appData.permissions.users[uid].filter(k => k !== key);
                }
            }

            function addUserPermException() {
                const id = prompt("‡∏Å‡∏£‡∏≠‡∏Å Discord ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:");
                if (!id) return;
                if (!appData.permissions) appData.permissions = { roles: {}, users: {} };
                if (appData.permissions.users[id]) return alert("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                appData.permissions.users[id] = [];
                saveData('permissions', true, true);
                renderPermissionsTab();
            }

            function deleteUserPerm(uid) {
                if (!confirm(`‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á ${uid}?`)) return;
                delete appData.permissions.users[uid];
                saveData('permissions', true, true);
                renderPermissionsTab();
            }

            function renderAdminMenu() {
                const menuBar = document.getElementById('admin-menu-bar'); if (!menuBar) return;
                let menuItems = [
                    { key: 'status', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', icon: 'üìä' },
                    { key: 'announce', label: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®', icon: 'üì¢' },
                    { key: 'founders', label: '‡∏ú‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á', icon: 'üëë' },
                    { key: 'roster', label: '‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö', icon: 'üë®‚Äç‚öïÔ∏è' },
                    { key: 'retired', label: '‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏î‡∏Ø', icon: 'üéñÔ∏è' },
                    { key: 'blacklist', label: 'Blacklist', icon: 'üö´' },
                    { key: 'rules', label: '‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö', icon: 'üìú' },
                    { key: 'shifts', label: '‡πÄ‡∏ß‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', icon: '‚è∞' }
                ];

                if (currentUser) {
                    menuItems.push({ key: 'applicants', label: '‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£', icon: 'üìù' });
                    menuItems.push({ key: 'users', label: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', icon: 'üë•' });

                    const perms = appData.permissions || {
                        roles: { staff: ['announce', 'blacklist', 'applicants', 'shifts'] }
                    };
                    const role = (currentUser.role || '').toLowerCase().trim();
                    const uid = currentUser.id;

                    console.log('Admin Render:', { role, uid });

                    if (role === 'owner') {
                        menuItems.push({ key: 'permissions', label: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', icon: '‚öôÔ∏è' });
                        menuItems.push({ key: 'logs', label: 'System Logs', icon: 'üìã' });
                    }
                    else {
                        let allowed = [];
                        if (perms.users && perms.users[uid]) {
                            allowed = perms.users[uid];
                        } else if (role === 'staff') {
                            allowed = perms.roles.staff || [];
                        } else if (role === 'admin') {
                            allowed = ['status', 'announce', 'founders', 'roster', 'retired', 'blacklist', 'rules', 'shifts', 'applicants', 'users']; // Default Admin
                        }

                        // SAFETY FALLBACK: If Admin is locked out (empty allowed), restore defaults
                        if (role === 'admin' && allowed.length === 0) {
                            console.warn('Admin Locked Out! Restoring Defaults.');
                            allowed = ['status', 'announce', 'founders', 'roster', 'retired', 'blacklist', 'rules', 'shifts', 'applicants', 'users'];
                        }

                        menuItems = menuItems.filter(item => allowed.includes(item.key));
                    }
                }

                menuBar.innerHTML = `<div class="px-4 py-4 mb-2 hidden md:block"><h3 class="text-xs uppercase font-bold text-slate-400 tracking-wider mb-1">Admin Panel</h3><div class="text-lg font-bold text-slate-800 dark:text-gray-200">Management</div></div>
                                <div class="flex md:flex-col space-x-2 md:space-x-0 md:space-y-1 overflow-x-auto md:overflow-visible pb-2 md:pb-0">${menuItems.map(item => `<button onclick="switchAdminTab('${item.key}', this)" class="admin-tab-btn flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 text-slate-500 hover:bg-white hover:text-sky-600 hover:shadow-sm dark:hover:bg-slate-800 dark:hover:text-sky-400 whitespace-nowrap group"><span class="text-lg group-hover:scale-110 transition-transform duration-200">${item.icon}</span><span>${item.label}</span></button>`).join('')}</div>
                                <div class="md:mt-auto pt-4 border-t border-slate-200 dark:border-slate-700 w-full mt-2"><button onclick="logout()" class="w-full text-left px-4 py-3 rounded-xl text-sm font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all flex items-center gap-3 group"><span class="text-lg group-hover:-translate-x-1 transition-transform duration-200">üö™</span><span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></button></div>`;

                if (menuItems.length > 0) {
                    const isValid = menuItems.some(m => m.key === currentAdminTab);
                    if (!isValid) currentAdminTab = menuItems[0].key;
                    setTimeout(() => {
                        const allBtns = Array.from(document.querySelectorAll('.admin-tab-btn'));
                        const targetLabel = menuItems.find(m => m.key === currentAdminTab).label;
                        const targetBtn = allBtns.find(b => b.innerText.includes(targetLabel));
                        if (targetBtn) {
                            switchAdminTab(currentAdminTab, targetBtn);
                        } else {
                            switchAdminTab(currentAdminTab, null);
                        }
                    }, 0);
                }
            }


            function toggleRegisterMode() {
                const btn = document.querySelector('#staff-login-form button');
                const link = document.getElementById('first-time-msg');
                const title = document.querySelector('#staff-login-container h3');
                const passwordInput = document.getElementById('login-password');

                if (btn.innerText.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö")) {
                    btn.innerText = "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà";
                    link.innerHTML = `<span>üîê ‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß?</span> <span class="underline decoration-dashed">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>`;
                    if (title) title.innerText = "‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Staff)";
                    passwordInput.placeholder = "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà";
                } else {
                    btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ";
                    link.innerHTML = `<span>‚ú® ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å?</span> <span class="underline decoration-dashed">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</span>`;
                    if (title) title.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Staff)";
                    passwordInput.placeholder = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
                }
                document.getElementById('login-discord-id').value = '';
                passwordInput.value = '';
            }

            async function handleStaffLogin() {
                const id = document.getElementById('login-discord-id').value.trim();
                const pass = document.getElementById('login-password').value.trim();
                const btnText = document.querySelector('#staff-login-form button').innerText;

                if (!id || !pass) return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

                const roster = appData.roster || [];
                const user = roster.find(r => r.discordId === id);

                if (btnText.includes("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")) {
                    if (!user) return showNotif('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå');

                    const existing = appData.authUsers && appData.authUsers[id];
                    if (existing && existing.password !== '123456' && !existing.requiresReset) {
                        return showNotif('Error', '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                    }

                    if (!appData.authUsers) appData.authUsers = {};
                    appData.authUsers[id] = {
                        password: pass,
                        role: existing ? existing.role : 'staff',
                        requiresReset: false
                    };

                    const memberName = user ? user.name : 'Staff Member';
                    currentUser = {
                        name: memberName,
                        type: 'staff',
                        role: existing ? existing.role : 'staff',
                        id: id
                    };
                    saveData('authUsers', true);
                    showNotif('Success', `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser.name}`);
                    if (document.getElementById('login-remember').checked) {
                        localStorage.setItem('authSession', JSON.stringify({
                            user: currentUser,
                            expiry: Date.now() + (7 * 24 * 60 * 60 * 1000)
                        }));
                    }
                    loginSuccess(currentUser);
                } else {
                    if (!appData.authUsers || !appData.authUsers[id]) {
                        // Fallback
                        if (pass === '123456' && user) {
                            // Force Password Change for First Time User
                            showNotif('Warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å');
                            toggleRegisterMode();
                            document.getElementById('login-discord-id').value = id;
                            return;
                        }
                        return showNotif('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    }

                    const userData = appData.authUsers[id];
                    if (userData.password !== pass) return showNotif('Error', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

                    if (userData.password === '123456' || userData.requiresReset) {
                        showNotif('Warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢');
                        toggleRegisterMode();
                        document.getElementById('login-discord-id').value = id;
                        return;
                    }

                    const role = userData.role || 'staff';
                    const memberName = user ? user.name : 'Staff Member';
                    currentUser = { name: memberName, type: 'staff', role: role, id: id };
                    showNotif('Success', `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${currentUser.name}`);
                    if (document.getElementById('login-remember').checked) {
                        localStorage.setItem('authSession', JSON.stringify({ user: currentUser, expiry: Date.now() + (7 * 24 * 60 * 60 * 1000) }));
                    }
                    loginSuccess(currentUser);
                }
            }


            function loginSuccess(user, silent = false) {
                if (!user) return;
                if (!silent) showNotif('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${user.name} (${user.role.toUpperCase()})`);

                // Save Session for 7 Days
                localStorage.setItem('authSession', JSON.stringify({ user: user, expiry: Date.now() + 86400000 * 7 }));

                // Hide Login/Admin Modal if open
                if (document.getElementById('admin-modal')) document.getElementById('admin-modal').classList.add('hidden');

                renderNavbarUser();

                // Update Admin Badge
                const indicator = document.getElementById('mode-indicator');
                if (indicator) {
                    const role = user.role.toUpperCase();
                    indicator.textContent = role;
                    let bgClass = "bg-gray-500";
                    if (role === 'OWNER') bgClass = "bg-red-500";
                    else if (role === 'ADMIN') bgClass = "bg-orange-500";
                    else if (role === 'STAFF') bgClass = "bg-sky-500";

                    indicator.className = `text-[10px] md:text-xs px-2 py-0.5 rounded ml-2 align-middle text-white ${bgClass}`;
                }

                // Legacy: Prepare Dashboard View but keep it hidden until requested
                document.getElementById('admin-login-view').classList.add('hidden');
                document.getElementById('admin-dashboard-view').classList.remove('hidden');
                renderAdminMenu();
                renderAll();
                renderShiftSchedule();
            }

            function loginWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider)
                    .then((result) => {
                        currentUser = {
                            type: 'google',
                            id: result.user.uid,
                            name: result.user.displayName,
                            role: 'owner' // Default
                        };
                        loginSuccess(currentUser);
                    })
                    .catch(e => showNotif('Error', e.message));
            }

            function logout() {
                const doLogout = () => {
                    localStorage.removeItem('authSession');
                    showNotif('Success', '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    document.getElementById('admin-dashboard-view').classList.add('hidden');
                    document.getElementById('admin-login-view').classList.remove('hidden');
                    currentUser = null;
                    const indicator = document.getElementById('mode-indicator');
                    if (indicator) {
                        indicator.textContent = "Guest";
                        indicator.className = "text-[10px] md:text-xs bg-gray-500 px-2 py-0.5 rounded ml-2 align-middle";
                    }
                    renderNavbarUser();
                    renderShiftSchedule();
                };

                if (currentUser && currentUser.type === 'google' && typeof isFirebaseActive !== 'undefined' && isFirebaseActive) {
                    firebase.auth().signOut().then(doLogout).catch(e => {
                        console.error(e);
                        doLogout();
                    });
                } else {
                    doLogout();
                }
            }

            function renderNavbarUser() {
                try {
                    const container = document.getElementById('navbar-user-section');
                    const mobileMenu = document.getElementById('mobile-menu');

                    if (!container) return;

                    if (!currentUser) {
                        // Desktop Login Button
                        container.innerHTML = `<button onclick="toggleAdminPanel()" id="nav-login-btn" class="px-3 py-2 rounded-xl text-sm font-medium text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transaction btn-smooth">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>`;

                        // Default Mobile Menu
                        if (mobileMenu) {
                            mobileMenu.innerHTML = `
            <div class="px-4 pt-2 pb-4 space-y-1">
                <button onclick="navigateTo('home'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="navigateTo('announcement'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                <button onclick="navigateTo('status'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <button onclick="navigateTo('personnel-zone'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
                <button onclick="toggleAdminPanel(); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl text-slate-500">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="navigateTo('apply'); toggleMobileMenu()" class="w-full mt-4 bg-sky-500 text-white px-4 py-3 rounded-xl text-base font-medium shadow-md">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</button>
            </div>`;
                        }

                    } else {
                        // Find user image
                        let avatar = 'https://ui-avatars.com/api/?name=' + currentUser.name + '&background=0ea5e9&color=fff';

                        // Try to get better avatar from Roster
                        if (currentUser.id) {
                            const rosterUser = (appData.roster || []).find(r => r.discordId === currentUser.id);
                            if (rosterUser && rosterUser.imageUrl) {
                                avatar = rosterUser.imageUrl;
                            } else if (currentUser.imageUrl) {
                                avatar = currentUser.imageUrl; // Use session image if available
                            }
                        }

                        // Desktop Dropdown
                        container.innerHTML = `
                            <div class="relative group h-full flex items-center">
                                <button class="flex items-center gap-2 focus:outline-none py-2">
                                    <img id="nav-user-avatar" src="${avatar}" class="w-9 h-9 rounded-full object-cover border-2 border-slate-200 dark:border-slate-700 hover:border-sky-500 transition" >
                                </button>
                                <!-- Dropdown with top padding to bridge the gap -->
                                <div class="absolute right-0 top-full pt-2 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-100 dark:border-slate-800 overflow-hidden transform origin-top-right">
                                        <div class="px-4 py-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                                            <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Signed in as</p>
                                            <p class="text-sm font-bold text-slate-800 dark:text-white truncate" title="${currentUser.name}">${currentUser.name}</p>
                                        </div>
                                        <div class="py-1">
                                            <button onclick="toggleAdminPanel()" class="w-full text-left px-4 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-sky-50 dark:hover:bg-slate-800 hover:text-sky-600 dark:hover:text-sky-400 transition flex items-center gap-2">
                                                <span>‚öôÔ∏è</span> Admin Panel
                                            </button>
                                            <button onclick="toggleShiftModal()" class="w-full text-left px-4 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-sky-50 dark:hover:bg-slate-800 hover:text-sky-600 dark:hover:text-sky-400 transition flex items-center gap-2">
                                                <span>üóìÔ∏è</span> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞
                                            </button>
                                            <button onclick="openProfileEditor()" class="w-full text-left px-4 py-2 text-sm text-slate-600 dark:text-slate-300 hover:bg-sky-50 dark:hover:bg-slate-800 hover:text-sky-600 dark:hover:text-sky-400 transition flex items-center gap-2">
                                                <span>üë§</span> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                                            </button>
                                            <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition flex items-center gap-2">
                                                <span>üö™</span> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Mobile Menu (Logged In)
                        if (mobileMenu) {
                            mobileMenu.innerHTML = `
            <div class="px-4 pt-2 pb-4 space-y-1">
                <button onclick="navigateTo('home'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="navigateTo('announcement'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                <button onclick="navigateTo('status'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                <button onclick="navigateTo('personnel-zone'); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</button>
                
                <div class="border-t border-slate-100 dark:border-slate-800 pt-4 mt-2">
                     <div class="flex items-center px-3 mb-3">
                         <img src="${avatar}" class="w-10 h-10 rounded-full border-2 border-white dark:border-slate-700 shadow-sm">
                         <div class="ml-3">
                             <div class="font-bold text-slate-800 dark:text-white leading-tight">${currentUser.name}</div>
                             <div class="text-xs text-slate-500 font-medium">${currentUser.role || 'Staff'}</div>
                         </div>
                     </div>
                     <button onclick="toggleAdminPanel(); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">‚öôÔ∏è Admin Panel</button>
                     <button onclick="toggleShiftModal(); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">üóìÔ∏è ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞</button>
                     <button onclick="openProfileEditor(); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium hover:bg-slate-50 dark:hover:bg-slate-800 dark:text-slate-300 rounded-xl">üë§ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                     <button onclick="logout(); toggleMobileMenu()" class="block w-full text-left px-3 py-3 text-base font-medium text-red-500 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>`;
                        }

                        if (typeof updateDiscordImages === 'function') updateDiscordImages();
                    }
                } catch (e) { console.error("Navbar Render Error:", e); }
            }

            function toggleProfileModal() {
                const modal = document.getElementById('profile-modal');
                modal.classList.toggle('hidden');
            }

            function openProfileEditor() {
                if (!currentUser || !currentUser.id) return showNotif('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                const rosterUser = (appData.roster || []).find(r => r.discordId === currentUser.id);

                // If not in roster? (Admin but not Doctor?)
                const name = rosterUser ? rosterUser.name : currentUser.name;
                const img = rosterUser ? (rosterUser.imageUrl || '') : '';
                const discord = currentUser.id;
                const time = rosterUser ? (rosterUser.onlineTime || '') : '';

                // Parse Time (Handle "18.00 - 00.00" or "18:00 - 00:00")
                let t = time.replace(' ‡∏ô.', '').replace(' ‡∏ô', '');
                const parts = t.split('-').map(x => x.trim().replace('.', ':'));
                const tStart = parts[0] || '';
                const tEnd = parts[1] || '';

                document.getElementById('profile-edit-name').value = name;
                document.getElementById('profile-edit-url').value = img;
                document.getElementById('profile-edit-img').src = img || 'https://placehold.co/150';

                document.getElementById('profile-edit-start').value = tStart;
                document.getElementById('profile-edit-end').value = tEnd;
                document.getElementById('profile-edit-discord').value = discord;

                toggleProfileModal();
            }

            async function saveUserProfile() {
                if (!currentUser || !currentUser.id) return;
                const btn = document.querySelector('#profile-modal button[onclick="saveUserProfile()"]');
                const originalText = btn.innerText;
                btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;

                try {
                    const newName = document.getElementById('profile-edit-name').value;
                    const newImg = document.getElementById('profile-edit-url').value;

                    const tStart = document.getElementById('profile-edit-start').value;
                    const tEnd = document.getElementById('profile-edit-end').value;
                    const newTime = (tStart && tEnd) ? `${tStart} - ${tEnd}` : '';

                    // Update Roster
                    const rosterIndex = (appData.roster || []).findIndex(r => r.discordId === currentUser.id);
                    if (rosterIndex !== -1) {
                        appData.roster[rosterIndex].name = newName;
                        appData.roster[rosterIndex].imageUrl = newImg;
                        appData.roster[rosterIndex].onlineTime = newTime; // Save new field
                        await saveData('roster', true, true);
                    } else {
                        // User is Admin but not in Roster? Maybe just update AuthUser name?
                        if (appData.authUsers[currentUser.id]) {
                            // AuthUsers doesn't store name usually, it relies on Roster, but we can update current session name
                        }
                    }

                    currentUser.name = newName;
                    currentUser.imageUrl = newImg; // Save image to session user object

                    // Update Session (Keep logged in with new data)
                    localStorage.setItem('authSession', JSON.stringify({
                        user: currentUser,
                        expiry: Date.now() + 86400000 * 7
                    }));

                    renderNavbarUser();
                    toggleProfileModal();
                    showNotif('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    renderAll();

                } catch (e) {
                    showNotif('Error', e.message);
                } finally {
                    btn.innerText = originalText; btn.disabled = false;
                }
            }

            function changeRosterPage(delta) { rosterPage += delta; renderRoster(); }

            function changeBLPage(d) { blPage += d; renderBlacklist(); }

            function addBlacklistRow() {
                if (!appData.blacklist) appData.blacklist = [];
                appData.blacklist.unshift({
                    id: Date.now().toString().slice(-6),
                    name: '',
                    charge: '',
                    fee: '',
                    status: 'Blacklist',
                    author: currentUser ? currentUser.name : 'Unknown',
                    date: new Date().toISOString()
                });
                renderBlacklist();
                saveData('blacklist', true, true);
            }

            function updateBlacklistField(index, field, value) {
                if (!appData.blacklist[index]) return;
                appData.blacklist[index][field] = value;
                saveData('blacklist', true, true);
            }

            function updateBlacklistStatus(index, newStatus) {
                if (!appData.blacklist[index]) return;
                const entry = appData.blacklist[index];
                entry.status = newStatus;

                if (newStatus === 'Paid') {
                    entry.paidDate = new Date().toISOString();
                } else {
                    delete entry.paidDate;
                }
                renderBlacklist();
                saveData('blacklist', true, true);
            }

            function renderBlacklist() {
                const list = appData.blacklist || [];
                // Sort by date (newest first)
                list.sort((a, b) => new Date(b.date) - new Date(a.date));

                const tbody = document.getElementById('blacklist-list');
                const adminContainer = document.getElementById('admin-bl-list');

                // Pagination
                const totalPages = Math.ceil(list.length / blPerPage) || 1;
                if (blPage > totalPages) blPage = totalPages;
                const start = (blPage - 1) * blPerPage;
                const paged = list.slice(start, start + blPerPage);

                if (tbody) {
                    if (list.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</td></tr>';
                    } else {
                        tbody.innerHTML = paged.map(b => {
                            const isPaid = b.status === 'Paid';
                            const statusBadge = isPaid
                                ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">Paid (${calculateDuration(b.paidDate)})</span>`
                                : `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">Blacklist</span>`;

                            return `<tr class="border-b border-slate-100 dark:border-slate-800 transition hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                <td class="p-3 font-bold text-slate-800 dark:text-white">${b.name || '-'}</td>
                                <td class="p-3 text-red-500 text-sm">${b.charge || '-'}</td>
                                <td class="p-3 text-right text-sm font-mono">${b.fee ? parseInt(b.fee).toLocaleString() : '-'}</td>
                                <td class="p-3 text-sm text-slate-500 dark:text-slate-400">${b.author || '-'}</td>
                                <td class="p-3 text-right">${statusBadge}</td>
                            </tr>`;
                        }).join('');
                    }

                    const pageInfo = document.getElementById('bl-page-info');
                    if (pageInfo) pageInfo.innerText = `‡∏´‡∏ô‡πâ‡∏≤ ${blPage} / ${totalPages}`;
                    const prevBtn = document.getElementById('bl-prev');
                    if (prevBtn) prevBtn.disabled = blPage === 1;
                    const nextBtn = document.getElementById('bl-next');
                    if (nextBtn) nextBtn.disabled = blPage >= totalPages;
                }

                if (adminContainer) {
                    adminContainer.innerHTML = paged.map((b, i) => {
                        const globalIndex = start + i;
                        return `<div class="bg-white dark:bg-slate-800 p-3 rounded border dark:border-slate-700 flex flex-col md:flex-row gap-2 items-start md:items-center">
                            <div class="flex-1 w-full grid grid-cols-2 md:grid-cols-4 gap-2">
                                <input class="inp-bl-name inp-primary text-xs" placeholder="Name" value="${b.name}" onchange="updateBlacklistField(${globalIndex}, 'name', this.value)">
                                <input class="inp-bl-charge inp-primary text-xs text-red-500" placeholder="Charge" value="${b.charge}" onchange="updateBlacklistField(${globalIndex}, 'charge', this.value)">
                                <input class="inp-bl-fee inp-primary text-xs font-mono" placeholder="Fee" value="${b.fee}" onchange="updateBlacklistField(${globalIndex}, 'fee', this.value)">
                                <div class="flex gap-1">
                                    <select class="inp-bl-status inp-primary flex-1 text-xs" onchange="updateBlacklistStatus(${globalIndex}, this.value)">
                                        <option value="Blacklist" ${b.status === 'Blacklist' ? 'selected' : ''}>Blacklist</option>
                                        <option value="Paid" ${b.status === 'Paid' ? 'selected' : ''}>Paid</option>
                                    </select>
                                    <button onclick="appData.blacklist.splice(${globalIndex}, 1); saveData('blacklist', true, true); renderBlacklist();" class="bg-red-100 text-red-500 p-1.5 rounded hover:bg-red-200 transition">
                                        <span class="material-icons text-sm">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
            }

            async function saveData(type, silent = false, useMemory = false) {
                if (!currentUser || (currentUser.type !== 'google' && currentUser.type !== 'staff')) return;
                let dataToSave = {};

                // Use memory directly for blacklist, roster, and announcements if specified
                if (type === 'blacklist' || (useMemory && type === 'blacklist')) {
                    dataToSave = { items: appData.blacklist || [] };
                } else if (useMemory && type === 'roster') {
                    dataToSave = { items: appData.roster || [] };
                } else if (type === 'announcements' || (useMemory && type === 'announcements')) {
                    // Memory-based saving for announcements to preserve author
                    dataToSave = { items: appData.announcements || [] };
                } else if (type === 'founders') {
                    const rows = document.querySelectorAll('.admin-lead-row');
                    appData.founders = Array.from(rows).map(r => ({
                        name: r.querySelector('.inp-name').value,
                        role: r.querySelector('.inp-role').value,
                        history: r.querySelector('.inp-history').value,
                        imageUrl: r.querySelector('.inp-image-url').value,
                        icon: r.querySelector('.inp-icon').value
                    }));
                    dataToSave = { items: appData.founders };
                } else if (type === 'roster') {
                    // Fallback to DOM scraping if NOT using memory
                    const rows = document.querySelectorAll('.admin-roster-row');

                    // SAFETY GUARD: Prevent wiping database if called from non-admin page
                    if (rows.length === 0) {
                        console.error("[Save] Aborted roster save: No DOM rows found (Protective Block)");
                        if (!silent) showNotif('Warning', '‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á');
                        return;
                    }

                    const oldRoster = appData.roster || [];
                    appData.roster = Array.from(rows).map(r => {
                        const name = r.querySelector('.inp-name').value;
                        const discordId = r.querySelector('.inp-discord-id').value;
                        const status = r.querySelector('.inp-status').value;

                        // Find existing to preserve hidden/other data
                        const existing = oldRoster.find(x => x.discordId === discordId) || oldRoster.find(x => x.name === name);
                        let statusDate = existing ? existing.statusDate : null;
                        // Fix for Firestore Error: undefined is not invalid. Must default to null or string.
                        let onlineTime = (existing && existing.onlineTime !== undefined) ? existing.onlineTime : null;
                        let extraShifts = (existing && existing.extraShifts) ? existing.extraShifts : []; // Preserve Extra Shifts

                        if (status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô') {
                            if (!statusDate || (existing && existing.status !== '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô')) {
                                statusDate = new Date().toISOString();
                            }
                        } else {
                            statusDate = null;
                        }

                        return {
                            name,
                            roleKey: r.querySelector('.inp-role').value,
                            status,
                            discordId,
                            imageUrl: r.querySelector('.inp-image-url').value,
                            startDate: r.querySelector('.inp-start-date').value,
                            statusDate: statusDate,
                            onlineTime: onlineTime || null, // Ensure null if falsey/undefined
                            extraShifts: extraShifts // Explicitly save extraShifts
                        };
                    });
                    dataToSave = { items: appData.roster };
                    // Auto-sync users when roster is manually saved
                    syncRosterUsers();
                } else if (type === 'retired') {
                    const rows = document.querySelectorAll('.admin-retired-row');
                    appData.retired = Array.from(rows).map(r => ({ name: r.querySelector('.inp-name').value, dischargeDate: r.querySelector('.inp-date').value, cooldownDays: r.querySelector('.inp-cd-days').value }));
                    dataToSave = { items: appData.retired };
                } else if (type === 'rules') {
                    appData.rules = { general: document.getElementById('edit-rules-general').value.split('\n').filter(x => x), roleplay: document.getElementById('edit-rules-roleplay').value.split('\n').filter(x => x) };
                    dataToSave = appData.rules;
                } else if (type === 'statusInfo') {
                    appData.statusInfo = { emergency: document.getElementById('edit-status-emergency').value, welfare: document.getElementById('edit-status-welfare').value };
                    dataToSave = appData.statusInfo;
                } else if (type === 'operatorSchedule') {
                    // Logic for operatorSchedule if needed, currently it seems it's just saved directly through mem
                    dataToSave = appData.operatorSchedule;
                } else if (type === 'operatorSchedule') {
                    // Logic for operatorSchedule if needed, currently it seems it's just saved directly through mem
                    dataToSave = appData.operatorSchedule;
                } else if (type === 'opSupport') {
                    dataToSave = appData.opSupport;
                } else if (type === 'permissions') {
                    dataToSave = appData.permissions || { roles: {}, users: {} };
                } else if (type === 'authUsers') {
                    dataToSave = appData.authUsers || {};
                }

                if (isFirebaseActive && db) {
                    try {
                        await db.collection('cms_content').doc(type).set(dataToSave);
                        if (!silent) showNotif('Saved', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                        localStorage.setItem('oneCityData', JSON.stringify(appData));
                        renderAll();
                    } catch (e) { showNotif('Error', e.message); }
                } else {
                    localStorage.setItem('oneCityData', JSON.stringify(appData));
                    renderAll();
                    if (!silent) showNotif('Demo Mode', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                }
            }

            function updateAppOnlineTime() {
                const s = document.getElementById('app-time-start').value;
                const e = document.getElementById('app-time-end').value;
                if (s && e) {
                    document.getElementById('app-online-time').value = `${s} - ${e}`;
                } else {
                    document.getElementById('app-online-time').value = "";
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                const btn = document.getElementById('submitBtn');
                const originalText = btn.innerText;
                btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";

                const formData = new FormData(e.target);
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                try {
                    // 0. Check if already in Roster
                    const existingStaff = (appData.roster || []).find(r => r.discordId === data.discord_id);
                    if (existingStaff) {
                        throw new Error('‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß');
                    }

                    // 1. Check duplicate 7 days (Firestore)
                    if (isFirebaseActive && db) {
                        const q = await db.collection('applicants')
                            .where('discord_id', '==', data.discord_id)
                            .get();

                        if (!q.empty) {
                            // Sort in JS to avoid Index requirement
                            const docs = q.docs.map(d => d.data()).sort((a, b) => b.timestamp - a.timestamp);
                            const lastApp = docs[0];

                            if (lastApp && lastApp.timestamp) {
                                const lastDate = lastApp.timestamp.toDate();
                                const diffDays = (new Date() - lastDate) / (1000 * 60 * 60 * 24);

                                if (diffDays < 7) {
                                    throw new Error(`Discord ID ‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${Math.floor(diffDays)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏ï‡∏¥‡∏î CoolDown 7 ‡∏ß‡∏±‡∏ô)`);
                                }
                            }
                        }

                        // 2. Save new application to Firestore
                        await db.collection('applicants').add({
                            ...data,
                            status: 'pending', // Default status
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

                    // 3. No Immediate Discord Notification (Moved to Approval Step)
                    // Just reset form and notify user
                    showNotif('Success', '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)');
                    e.target.reset();

                } catch (err) {
                    console.error(err);
                    showNotif('Error', err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                } finally {
                    btn.disabled = false; btn.innerText = originalText;
                }
            }


            async function checkApplicantRetention() {
                if (!isFirebaseActive || !db) return;
                try {
                    const now = new Date();
                    const batch = db.batch();
                    let count = 0;

                    const allSnap = await db.collection('applicants').get();

                    allSnap.forEach(doc => {
                        const data = doc.data();
                        if ((data.status === 'approved' || data.status === 'rejected') && data.decisionDate) {
                            const decisionTime = data.decisionDate.toDate();
                            const diffDays = (now - decisionTime) / (1000 * 60 * 60 * 24);

                            if (diffDays > 7) {
                                batch.delete(doc.ref);
                                count++;
                            }
                        }
                    });

                    if (count > 0) {
                        await batch.commit();
                        console.log(`Cleaned up ${count} old applications.`);
                    }

                } catch (e) {
                    console.error("Auto-delete applicants error:", e);
                }
            }

            async function checkAutoDelete() {
                if (!appData.roster) return;
                const now = new Date();
                const initialLen = appData.roster.length;

                // Identify expired members first
                const expiredMembers = appData.roster.filter(r => {
                    if (r.status === '‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' && r.statusDate) {
                        const diffTime = Math.abs(now - new Date(r.statusDate));
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        return diffDays > 7; // Expired
                    }
                    return false;
                });

                if (expiredMembers.length > 0) {
                    console.log(`Found ${expiredMembers.length} expired personnel. Processing deletions...`);

                    // Send notifications for each expired member
                    for (const r of expiredMembers) {
                        try {
                            const payload = {
                                "username": "Medic Recruitment Bot",
                                "avatar_url": LOGO_URL,
                                "embeds": [{
                                    "title": "üö´ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Auto-Delete)",
                                    "description": `‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô`,
                                    "color": 15158332, // Red
                                    "fields": [
                                        { "name": "üë§ ‡∏ä‡∏∑‡πà‡∏≠", "value": r.name || "-", "inline": true },
                                        { "name": "üÜî Discord ID", "value": r.discordId || "-", "inline": true },
                                        { "name": "üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î", "value": r.statusDate ? formatDate(r.statusDate) : "-", "inline": false }
                                    ],
                                    "footer": { "text": "One City Hospital System" },
                                    "timestamp": new Date().toISOString()
                                }]
                            };

                            const discordFormData = new FormData();
                            discordFormData.append('payload_json', JSON.stringify(payload));

                            await fetch(DISCORD_DELETE_WEBHOOK, {
                                method: 'POST',
                                mode: 'no-cors',
                                body: discordFormData
                            });
                            console.log(`Notification sent for ${r.name}`);
                        } catch (err) {
                            console.error(`Failed to send delete notification for ${r.name}:`, err);
                        }
                    }

                    // Perform deletion
                    appData.roster = appData.roster.filter(r => !expiredMembers.includes(r));

                    if (appData.roster.length !== initialLen) {
                        await saveData('roster', true);
                        console.log('Auto-deleted expired personnel updated in database.');
                    }
                }
            }

            async function checkBlacklistRetention() {
                if (!appData.blacklist) return;
                const now = new Date();
                const initialLen = appData.blacklist.length;

                appData.blacklist = appData.blacklist.filter(b => {
                    if (b.status === 'Paid' && b.paidDate) {
                        const diffTime = Math.abs(now - new Date(b.paidDate));
                        const diffDays = diffTime / (1000 * 60 * 60 * 24);
                        return diffDays <= 3;
                    }
                    return true;
                });

                if (appData.blacklist.length !== initialLen) {
                    console.log(`Auto-deleted ${initialLen - appData.blacklist.length} paid blacklist entries.`);
                    await saveData('blacklist', true, true);
                    renderBlacklist();
                }
            }

            // --- 5. INITIALIZATION ---
            function initApp() {
                try {
                    console.log("Starting App Initialization...");
                    if (firebase.apps.length) {
                        db = firebase.firestore(); isFirebaseActive = true;
                        listenToFirebase();
                    } else {
                        const local = localStorage.getItem('oneCityData');
                        if (local) { appData = JSON.parse(local); }
                    }

                    renderAll();
                    renderShiftSchedule();
                    renderNavbarUser(); // Ensure navbar state is correct
                    checkAutoDelete();
                    checkApplicantRetention();
                    checkBlacklistRetention();
                    // checkDailyReset moved to listener
                    syncRosterUsers();
                    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); }
                } catch (err) {
                    console.error("InitApp Error:", err);
                    alert("System Error: " + err.message);
                }
            }

            let myChart = null;
            function renderStatusChart() {
                const ctx = document.getElementById('patientChart');
                if (!ctx) return;

                // Calculate Real Data
                const totalMedics = appData.roster ? appData.roster.length : 0;
                // Distribution: 08:00, 12:00, 16:00, 20:00, 24:00, 04:00
                // Peak at 20:00-24:00
                const factors = [0.3, 0.5, 0.6, 0.9, 1.0, 0.2];
                const medicData = factors.map(f => Math.ceil(totalMedics * f));

                if (myChart) myChart.destroy();

                const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(14, 165, 233, 0.8)');
                gradient.addColorStop(1, 'rgba(14, 165, 233, 0.1)');

                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['08:00', '12:00', '16:00', '20:00', '24:00', '04:00'],
                        datasets: [
                            {
                                label: '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢',
                                data: [15, 45, 60, 95, 70, 20],
                                backgroundColor: gradient,
                                borderRadius: 6
                            },
                            {
                                label: '‡πÅ‡∏û‡∏ó‡∏¢‡πå (Real-time)',
                                data: medicData,
                                type: 'line',
                                borderColor: '#ef4444',
                                borderWidth: 3,
                                tension: 0.4,
                                pointBackgroundColor: '#fff'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#64748b', font: { family: 'Sarabun' } } } },
                        scales: {
                            y: { grid: { color: 'rgba(127,127,127,0.1)' }, ticks: { color: '#94a3b8' } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        },
                        animation: { duration: 2000, easing: 'easeOutQuart' }
                    }
                });
            }

            // --- SHIFT SCHEDULE LOGIC ---
            let activeShiftTab = null;
            let lastOperatorName = "";

            function switchShiftTab(tab) {
                activeShiftTab = tab;
                renderShiftSchedule();
            }

            function renderShiftSchedule() {
                // 1. Init Tab if needed (Based on Current Time)
                if (!activeShiftTab) {
                    const h = new Date().getHours();
                    if (h >= 6 && h < 12) activeShiftTab = '06-12';
                    else if (h >= 12 && h < 17) activeShiftTab = '12-17';
                    else if (h >= 17) activeShiftTab = '17-00';
                    else activeShiftTab = '00-06';
                }

                // 2. Update Tab Styles
                const tabs = ['00-06', '06-12', '12-17', '17-00'];
                tabs.forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (btn) {
                        if (t === activeShiftTab) {
                            btn.className = "shift-tab flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 shadow-md shadow-slate-200/50 dark:shadow-slate-900/50";
                        } else {
                            btn.className = "shift-tab flex-1 whitespace-nowrap px-4 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-700/50";
                        }
                    }
                });

                // 3. Operator Logic
                const schedule = appData.operatorSchedule || { current: {} };
                const currentOps = schedule.current || {};
                const op = currentOps[activeShiftTab] || { name: '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...' };

                const opEl = document.getElementById('operator-name-slot');
                if (opEl) {
                    if (op.name !== lastOperatorName) {
                        animateSlotText(opEl, op.name);
                        lastOperatorName = op.name;
                    } else if (opEl.innerText === '-' || opEl.innerText === '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...') {
                        opEl.innerText = op.name;
                    }
                }

                // --- NEW: Extra Shift Button Logic ---
                // Find if current user is in roster
                let currentUserInMain = false;
                let currentUserInExtra = false;

                if (currentUser && currentUser.id) {
                    const myRoster = (appData.roster || []).find(r => r.discordId === currentUser.id);
                    if (myRoster) {
                        // Debug Log
                        console.log(`[Render] Checking user ${myRoster.name}, extraShifts:`, myRoster.extraShifts, "ActiveTab:", activeShiftTab);

                        // Check Main
                        const t = myRoster.onlineTime || myRoster.time || "";
                        const m = t.match(/(\d{1,2})[:\.]/);
                        const rh = m ? parseInt(m[1]) : -1;
                        if (rh !== -1) {
                            if (activeShiftTab === '06-12' && rh >= 6 && rh < 12) currentUserInMain = true;
                            else if (activeShiftTab === '12-17' && rh >= 12 && rh < 17) currentUserInMain = true;
                            else if (activeShiftTab === '17-00' && rh >= 17) currentUserInMain = true;
                            else if (activeShiftTab === '00-06' && rh >= 0 && rh < 6) currentUserInMain = true;
                        }
                        // Check Extra
                        if ((myRoster.extraShifts || []).includes(activeShiftTab)) currentUserInExtra = true;
                    }
                }

                const btnArea = document.getElementById('extra-shift-btn-area');

                if (btnArea) {
                    btnArea.innerHTML = ''; // Clear previous
                    const btnClasses = "px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 shadow-sm";

                    // 1. Extra Shift Button
                    if (currentUser && !currentUserInMain) {
                        if (currentUserInExtra) {
                            btnArea.innerHTML += `<button onclick="toggleExtraShift('${activeShiftTab}')" class="${btnClasses} bg-white text-rose-500 border border-rose-200 hover:bg-rose-50 dark:bg-slate-800 dark:border-rose-900/50 dark:text-rose-400">üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°</button>`;
                        } else {
                            btnArea.innerHTML += `<button onclick="toggleExtraShift('${activeShiftTab}')" class="${btnClasses} bg-indigo-500 hover:bg-indigo-600 text-white">‚ûï ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°</button>`;
                        }
                    }

                    // 2. Reroll Logic (Confirm Flow)
                    const counts = (appData.operatorSchedule && appData.operatorSchedule.rerollCounts) ? appData.operatorSchedule.rerollCounts : {};
                    const count = counts[activeShiftTab] || 0;
                    const maxReroll = 3;
                    const canConfirm = count > 0;

                    const isOp = currentUser && (op.name === currentUser.name || (op.discordId && op.discordId === currentUser.id));
                    const isEmpty = (op.name === '-' || op.name === '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...');

                    // A. Random Button (softer colors)
                    if (currentUser && count < maxReroll) {
                        if (isOp || isEmpty || count > 0) {
                            const btnColor = isEmpty ? "bg-slate-600 hover:bg-slate-700" : "bg-slate-500 hover:bg-slate-600";
                            btnArea.innerHTML += `<button onclick="rerollOperator('${activeShiftTab}')" class="${btnClasses} ${btnColor} text-white">üé≤ ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà (${count}/${maxReroll})</button>`;
                        }
                    }

                    // B. Confirm Button (softer green)
                    if (currentUser && canConfirm) {
                        btnArea.innerHTML += `<button onclick="confirmOperator('${activeShiftTab}')" class="${btnClasses} bg-emerald-500 hover:bg-emerald-600 text-white">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (${op.name})</button>`;
                    }
                }
                const tbody = document.getElementById('shift-table-body');
                if (!tbody) return;

                const relevantStaff = (appData.roster || []).filter(r => {
                    // Check Main Time
                    if (!r.extraShifts) r.extraShifts = []; // Ensure Array

                    const t = r.onlineTime || r.time || "";
                    const m = t.match(/(\d{1,2})[:\.]/);
                    const rh = m ? parseInt(m[1]) : -1;
                    let isMain = false;

                    if (rh !== -1) {
                        if (activeShiftTab === '06-12' && rh >= 6 && rh < 12) isMain = true;
                        else if (activeShiftTab === '12-17' && rh >= 12 && rh < 17) isMain = true;
                        else if (activeShiftTab === '17-00' && rh >= 17) isMain = true;
                        else if (activeShiftTab === '00-06' && rh >= 0 && rh < 6) isMain = true;
                    }

                    // Check Extra
                    const isExtra = r.extraShifts.includes(activeShiftTab);

                    // Attach temp prop for render
                    r._isExtraRender = isExtra && !isMain;

                    return isMain || isExtra;
                });

                if (relevantStaff.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-8 text-center text-slate-400 bg-slate-50/50 dark:bg-slate-800/30 rounded-xl">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏∞‡∏ô‡∏µ‡πâ</td></tr>`;
                    return;
                }

                tbody.innerHTML = relevantStaff.map(r => {
                    const isActive = r.status === '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô';
                    let styleClass = isActive ? 'font-bold text-slate-700 dark:text-slate-200' : 'text-slate-400 line-through decoration-red-500/50 decoration-2';
                    const statusClass = isActive ? 'text-emerald-500' : 'text-red-400';
                    const imgSource = (r.imageUrl && r.imageUrl.trim() !== '') ? r.imageUrl : (r.discordAvatarUrl || '');

                    let extraBadge = '';
                    if (r._isExtraRender) {
                        extraBadge = `<span class="ml-2 text-[10px] bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-300 px-1.5 py-0.5 rounded border border-purple-200 dark:border-purple-800">Extra</span>`;
                    }

                    // Highlight Operator
                    const isOp = (r.name === op.name);
                    if (isOp) styleClass += " text-indigo-600 dark:text-indigo-400";

                    return `<tr class="border-b border-slate-50 dark:border-slate-700 hover:bg-slate-50/50 dark:hover:bg-slate-700/30 transition ${isOp ? 'bg-indigo-50/50 dark:bg-indigo-900/10' : ''}">
                        <td class="px-6 py-4 font-mono text-xs whitespace-nowrap">${r.onlineTime || r.time || '-'}${extraBadge ? '<br><span class="text-xs text-purple-400">Extra Shift</span>' : ''}</td>
                        <td class="px-6 py-4 flex items-center gap-3">
                            <img src="${imgSource || 'https://placehold.co/150'}" class="w-8 h-8 rounded-full border border-slate-200 dark:border-slate-600 shadow-sm object-cover">
                            <span class="${styleClass} whitespace-nowrap flex items-center">${r.name} ${extraBadge}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="text-[10px] uppercase font-bold px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 ${statusClass}">${r.status || 'Unknown'}</span>
                        </td>
                    </tr>`;
                }).join('');
            }

            function rerollOperator(tab) {
                // Initialize
                if (!appData.operatorSchedule) appData.operatorSchedule = { current: {}, rerollCounts: {}, lockTime: {} };
                if (!appData.operatorSchedule.current) appData.operatorSchedule.current = {};
                if (!appData.operatorSchedule.rerollCounts) appData.operatorSchedule.rerollCounts = {};
                if (!appData.operatorSchedule.lockTime) appData.operatorSchedule.lockTime = {};

                // Check if any other shift is locked (has confirmed OP)
                const lockTime = appData.operatorSchedule.lockTime || {};
                const hasLockedShift = ['00-06', '06-12', '12-17', '17-00'].some(t => lockTime[t] && t !== tab);

                if (hasLockedShift) {
                    return showNotif('Error', '‡∏°‡∏µ OP ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Reset OP ‡∏Å‡πà‡∏≠‡∏ô');
                }

                const counts = appData.operatorSchedule.rerollCounts;
                const currentCount = counts[tab] || 0;

                if (currentCount >= 3) return showNotif('Error', '‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏™‡∏∏‡πà‡∏° (3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)');

                if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${currentCount + 1}/3)`)) return;

                // 1. Get Candidates (Strict Active Only)
                const candidates = (appData.roster || []).filter(r => {
                    if (r.status !== '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô') return false;

                    const t = r.onlineTime || r.time || "";
                    const m = t.match(/(\d{1,2})[:\.]/);
                    const rh = m ? parseInt(m[1]) : -1;
                    let isIn = false;
                    if (rh !== -1) {
                        if (tab === '06-12' && rh >= 6 && rh < 12) isIn = true;
                        else if (tab === '12-17' && rh >= 12 && rh < 17) isIn = true;
                        else if (tab === '17-00' && rh >= 17) isIn = true;
                        else if (tab === '00-06' && rh >= 0 && rh < 6) isIn = true;
                    }
                    if ((r.extraShifts || []).includes(tab)) isIn = true;

                    return isIn && r.name !== currentUser.name;
                });

                // Update Count
                counts[tab] = currentCount + 1;

                if (candidates.length === 0) {
                    showNotif('Info', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô');
                    appData.operatorSchedule.current[tab] = { name: '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...' };
                    saveData('operatorSchedule', true);
                    renderShiftSchedule();
                    return;
                }

                // 2. Pick Random
                const winner = candidates[Math.floor(Math.random() * candidates.length)];

                // 3. Update
                appData.operatorSchedule.current[tab] = {
                    name: winner.name,
                    discordId: winner.discordId
                };

                saveData('operatorSchedule', true);
                showNotif('Success', `‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏£‡πÉ‡∏´‡∏°‡πà: ${winner.name}`);
                renderShiftSchedule();
            }

            function confirmOperator(tab) {
                if (!appData.operatorSchedule || !appData.operatorSchedule.rerollCounts) return;

                appData.operatorSchedule.rerollCounts[tab] = 0;
                // Set lock timestamp for auto-reset (5 hours)
                if (!appData.operatorSchedule.lockTime) appData.operatorSchedule.lockTime = {};
                appData.operatorSchedule.lockTime[tab] = Date.now();

                saveData('operatorSchedule', true);

                showNotif('Success', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                renderShiftSchedule();
            }

            function resetOperator() {
                // Reset all operator schedule data
                appData.operatorSchedule = {
                    current: {},
                    rerollCounts: {},
                    lockTime: {}
                };

                saveData('operatorSchedule', true);
                showNotif('Success', '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï OP ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ - ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°');
                renderShiftSchedule();
            }

            function checkAutoResetOp() {
                if (!appData.operatorSchedule || !appData.operatorSchedule.lockTime) return;

                const now = Date.now();
                const FIVE_HOURS = 5 * 60 * 60 * 1000;
                let needsSave = false;

                ['00-06', '06-12', '12-17', '17-00'].forEach(tab => {
                    const lockTime = appData.operatorSchedule.lockTime[tab];
                    if (lockTime && (now - lockTime) > FIVE_HOURS) {
                        // Auto reset this shift
                        delete appData.operatorSchedule.current[tab];
                        delete appData.operatorSchedule.lockTime[tab];
                        appData.operatorSchedule.rerollCounts[tab] = 0;
                        needsSave = true;
                        console.log(`Auto-reset OP for shift ${tab} after 5 hours`);
                    }
                });

                if (needsSave) {
                    saveData('operatorSchedule', true);
                    renderShiftSchedule();
                }
            }

            function isAnyShiftLocked() {
                if (!appData.operatorSchedule || !appData.operatorSchedule.current) return false;

                const current = appData.operatorSchedule.current;
                const lockTime = appData.operatorSchedule.lockTime || {};

                // Check if any shift has a confirmed OP (has lock time)
                return ['00-06', '06-12', '12-17', '17-00'].some(tab => {
                    return current[tab] && current[tab].name && current[tab].name !== '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...' && current[tab].name !== '-' && lockTime[tab];
                });
            }

            async function toggleExtraShift(tab) {
                console.log(`[Extra] Toggling for ${tab}`);
                try {
                    if (!currentUser || !currentUser.id) return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');

                    const rosterIndex = (appData.roster || []).findIndex(r => r.discordId === currentUser.id);
                    if (rosterIndex === -1) {
                        console.error("[Extra] User not found in roster:", currentUser.id);
                        return showNotif('Error', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå');
                    }

                    const user = appData.roster[rosterIndex];
                    console.log("[Extra] Before:", user.extraShifts);

                    // Use simple array initialization
                    if (!user.extraShifts || !Array.isArray(user.extraShifts)) user.extraShifts = [];

                    if (user.extraShifts.includes(tab)) {
                        user.extraShifts = user.extraShifts.filter(t => t !== tab);
                        showNotif('Success', `‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°: ${tab}`);
                    } else {
                        user.extraShifts.push(tab);
                        showNotif('Success', `‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°: ${tab}`);
                    }

                    console.log("[Extra] After:", user.extraShifts);

                    // Force save the entire roster (Use Memory!)
                    await saveData('roster', true, true);
                    console.log("[Extra] Save completed.");
                    renderShiftSchedule();
                } catch (err) {
                    console.error("[Extra] Error:", err);
                    showNotif('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + err.message);
                }
            }

            async function checkDailyReset() {
                if (!isFirebaseActive || !db) return;

                // Get Last Reset Info
                let statusInfo = appData.statusInfo || {};
                const todayStr = new Date().toDateString(); // "Mon Dec 08 2025"

                if (statusInfo.lastExtraReset !== todayStr) {
                    console.log(`New Day Detected (${todayStr}). Clearing Extra Shifts...`);

                    // 1. Clear Extra Shifts in Roster
                    let changed = false;
                    if (appData.roster && appData.roster.length > 0) {
                        appData.roster.forEach(r => {
                            if (r.extraShifts && r.extraShifts.length > 0) {
                                r.extraShifts = [];
                                changed = true;
                            }
                        });
                    }

                    // 2. Reset Re-roll Counts
                    if (appData.operatorSchedule && appData.operatorSchedule.rerollCounts) {
                        appData.operatorSchedule.rerollCounts = {};
                        saveData('operatorSchedule', true);
                    }

                    // 3. Save Roster if changed
                    if (changed) {
                        await saveData('roster', true, true);
                        console.log("Extra Shifts Cleared.");
                    }

                    // 4. Update Status Info
                    statusInfo.lastExtraReset = todayStr;
                    appData.statusInfo = statusInfo;
                    saveData('statusInfo', true);
                }
            }

            function toggleShiftModal() {
                const m = document.getElementById('shift-schedule-modal');
                if (m) {
                    m.classList.toggle('hidden');
                    if (!m.classList.contains('hidden')) renderShiftSchedule();
                }
            }

            function animateSlotText(el, finalText) {
                let iterations = 0;
                const max = 10;
                const interval = setInterval(() => {
                    el.style.transform = `translateY(${iterations % 2 === 0 ? '-10px' : '10px'})`;
                    el.style.opacity = '0.5';
                    el.innerText = Math.random().toString(36).substring(7); // Random junk

                    iterations++;
                    if (iterations >= max) {
                        clearInterval(interval);
                        el.style.transform = 'translateY(0)';
                        el.style.opacity = '1';
                        el.innerText = finalText;
                    }
                }, 100);
            }

            // --- OP SUPPORT PANEL LOGIC ---

            function toggleOpPanel(isBack = false) {
                const opModal = document.getElementById('op-panel-modal');
                const shiftModal = document.getElementById('shift-schedule-modal');

                if (opModal.classList.contains('hidden')) {
                    // Check if there's an OP assigned
                    const tab = getCurrentShiftTab();
                    const schedule = appData.operatorSchedule || { current: {} };
                    const op = (schedule.current && schedule.current[tab]) || {};
                    const hasOp = op.name && op.name !== '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...' && op.name !== '-' && op.name !== '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå';

                    if (!hasOp) {
                        showNotif('Info', '‡πÑ‡∏°‡πà‡∏°‡∏µ OP ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OP ‡∏Å‡πà‡∏≠‡∏ô');
                    }

                    // Open OP Panel -> Close Shift Modal
                    opModal.classList.remove('hidden');
                    if (shiftModal && !shiftModal.classList.contains('hidden')) {
                        shiftModal.classList.add('hidden');
                        // Perhaps save state that we came from there? Not strictly needed if Back always opens it.
                    }
                    renderOpPanel();
                } else {
                    // Close OP Panel
                    opModal.classList.add('hidden');
                    if (isBack && shiftModal) {
                        shiftModal.classList.remove('hidden');
                    }
                }
            }

            function getCurrentShiftTab() {
                const h = new Date().getHours();
                if (h >= 0 && h < 6) return '00-06';
                if (h >= 6 && h < 12) return '06-12';
                if (h >= 12 && h < 17) return '12-17';
                return '17-00';
            }

            function autoRerollOp(tab) {
                if (!appData.operatorSchedule) appData.operatorSchedule = { current: {}, rerollCounts: {} };
                const counts = appData.operatorSchedule.rerollCounts;
                const currentCount = counts[tab] || 0;

                // 1. Get Candidates
                const candidates = (appData.roster || []).filter(r => {
                    if (r.status !== '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô') return false;
                    const t = r.onlineTime || r.time || "";
                    const m = t.match(/(\d{1,2})[:\.]/);
                    const rh = m ? parseInt(m[1]) : -1;
                    let isIn = false;
                    if (rh !== -1) {
                        if (tab === '06-12' && rh >= 6 && rh < 12) isIn = true;
                        else if (tab === '12-17' && rh >= 12 && rh < 17) isIn = true;
                        else if (tab === '17-00' && rh >= 17) isIn = true;
                        else if (tab === '00-06' && rh >= 0 && rh < 6) isIn = true;
                    }
                    if ((r.extraShifts || []).includes(tab)) isIn = true;
                    return isIn && r.name !== currentUser.name; // Don't pick self if possible
                });

                // Update Count (Increment even for auto)
                counts[tab] = currentCount + 1;

                if (candidates.length === 0) {
                    appData.operatorSchedule.current[tab] = { name: '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå' };
                } else {
                    const winner = candidates[Math.floor(Math.random() * candidates.length)];
                    appData.operatorSchedule.current[tab] = { name: winner.name, discordId: winner.discordId };
                }

                saveData('operatorSchedule', true);
                renderShiftSchedule();
            }

            function startNewShift() {
                // Modified: Just reset data, timer starts on save
                appData.opSupport = {
                    opName: currentUser ? currentUser.name : "Unknown",
                    supOp: "",
                    shiftStart: null, // Starts on save
                    onDuty: [],
                    offDuty: [],
                    cases: [],
                    medicStatuses: {}
                };
                saveData('opSupport', true);
                renderOpPanel();
            }

            function saveOpConfig() {
                if (!appData.opSupport) return;
                // Only allowed if current user is OP (or maybe allow anyone to take over?)
                if (!appData.opSupport.shiftStart) {
                    appData.opSupport.shiftStart = Date.now();
                }
                saveData('opSupport', true);
                renderOpPanel();
                showNotif('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏∞‡πÅ‡∏•‡πâ‡∏ß');
            }

            async function endOpShift() {
                // Check if there are unclosed stories
                if (appData.opSupport && appData.opSupport.cases && appData.opSupport.cases.length > 0) {
                    return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏ö‡∏Å‡∏∞ (‡∏°‡∏µ ' + appData.opSupport.cases.length + ' ‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î)');
                }

                const confirmed = await showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡∏Å‡∏∞', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏∞? (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)');
                if (!confirmed) return;


                // Save summary data before clearing
                const summaryData = { ...appData.opSupport };
                summaryData.opName = getScheduleOpName() || summaryData.opName;
                summaryData.shiftEnd = Date.now();

                // Show summary modal
                showShiftSummary(summaryData);

                toggleOpPanel(); // Close and go back to Schedule

                // Clear OP Data
                appData.opSupport = { opName: "", supOp: "", shiftStart: null, onDuty: [], offDuty: [], cases: [], closedCases: [], medicStatuses: {}, afk: [], afkTimes: {} };
                saveData('opSupport', true);
            }

            function showShiftSummary(data) {
                const modal = document.getElementById('shift-summary-modal');
                const content = document.getElementById('shift-summary-content');

                if (!data || !data.shiftStart) {
                    content.innerHTML = '<p class="text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</p>';
                    modal.classList.remove('hidden');
                    return;
                }

                const duration = data.shiftEnd - data.shiftStart;
                const hours = Math.floor(duration / 3600000);
                const minutes = Math.floor((duration % 3600000) / 60000);

                // Collect all medics who participated
                const allMedics = new Set([
                    ...(data.onDuty || []),
                    ...(data.offDuty || []),
                    ...(data.afk || [])
                ]);

                // Add medics from closed cases
                (data.closedCases || []).forEach(c => {
                    (c.medics || [c.medic]).filter(Boolean).forEach(m => allMedics.add(m));
                });

                // Also add from active cases
                (data.cases || []).forEach(c => {
                    (c.medics || [c.medic]).filter(Boolean).forEach(m => allMedics.add(m));
                });

                const allCases = [...(data.closedCases || []), ...(data.cases || [])];

                content.innerHTML = `
                    <!-- Operators -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm flex items-center gap-2">
                            üë®‚Äç‚öïÔ∏è ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white dark:bg-slate-700 rounded-lg p-3 border border-slate-200 dark:border-slate-600">
                                <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">Operator (OP)</span>
                                <span class="font-bold text-slate-800 dark:text-white">${data.opName || '-'}</span>
                            </div>
                            <div class="bg-white dark:bg-slate-700 rounded-lg p-3 border border-slate-200 dark:border-slate-600">
                                <span class="text-xs text-slate-500 dark:text-slate-400 block mb-1">Support OP</span>
                                <span class="font-bold text-slate-800 dark:text-white">${data.supOp || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Shift Info -->
                    <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-xl p-4 border border-indigo-100 dark:border-indigo-800/50">
                        <h3 class="font-bold text-indigo-700 dark:text-indigo-300 mb-3 text-sm flex items-center gap-2">
                            ‚è±Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏∞
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <span class="text-xs text-indigo-500 dark:text-indigo-400 block">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                                <span class="font-mono font-bold text-indigo-800 dark:text-indigo-200">${new Date(data.shiftStart).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                            </div>
                            <div>
                                <span class="text-xs text-indigo-500 dark:text-indigo-400 block">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏∞</span>
                                <span class="font-mono font-bold text-indigo-800 dark:text-indigo-200">${new Date(data.shiftStart).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div>
                                <span class="text-xs text-indigo-500 dark:text-indigo-400 block">‡∏à‡∏ö‡∏Å‡∏∞</span>
                                <span class="font-mono font-bold text-indigo-800 dark:text-indigo-200">${new Date(data.shiftEnd).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}</span>
                            </div>
                            <div>
                                <span class="text-xs text-indigo-500 dark:text-indigo-400 block">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</span>
                                <span class="font-mono font-bold text-indigo-800 dark:text-indigo-200">${hours}‡∏ä‡∏°. ${minutes}‡∏ô‡∏≤‡∏ó‡∏µ</span>
                            </div>
                        </div>
                    </div>

                    <!-- On Duty Medics -->
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 rounded-xl p-4 border border-emerald-100 dark:border-emerald-800/50">
                        <h3 class="font-bold text-emerald-700 dark:text-emerald-300 mb-3 text-sm flex items-center gap-2">
                            ‚úÖ On Duty (${(data.onDuty || []).length} ‡∏Ñ‡∏ô)
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${(data.onDuty || []).map(m => `<span class="bg-white dark:bg-emerald-800/30 text-emerald-700 dark:text-emerald-300 px-3 py-1 rounded-full text-xs font-semibold border border-emerald-200 dark:border-emerald-700">‚úÖ ${m}</span>`).join('') || '<span class="text-slate-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>'}
                        </div>
                    </div>

                    <!-- Off Duty Medics -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-100 dark:border-slate-700/50">
                        <h3 class="font-bold text-slate-600 dark:text-slate-300 mb-3 text-sm flex items-center gap-2">
                            ‚ùå Off Duty (${(data.offDuty || []).length} ‡∏Ñ‡∏ô)
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${(data.offDuty || []).map(m => `<span class="bg-white dark:bg-slate-700/50 text-slate-500 dark:text-slate-400 px-3 py-1 rounded-full text-xs font-semibold border border-slate-200 dark:border-slate-600">‚ùå ${m}</span>`).join('') || '<span class="text-slate-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>'}
                        </div>
                    </div>

                    <!-- Stories -->
                    <div class="bg-amber-50 dark:bg-amber-900/20 rounded-xl p-4 border border-amber-100 dark:border-amber-800/50">
                        <h3 class="font-bold text-amber-700 dark:text-amber-300 mb-3 text-sm flex items-center gap-2">
                            üìã ‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allCases.length} ‡πÄ‡∏Ñ‡∏™)
                        </h3>
                        <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                            ${allCases.length > 0 ? allCases.map((c, i) => {
                    const medics = c.medics || [c.medic];
                    const parties = c.partyA && c.partyB ? `${c.partyA} VS ${c.partyB}` : (c.story || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                    const timeStr = new Date(c.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    const isClosed = c.closedAt;
                    return `
                                    <div class="bg-white dark:bg-amber-800/20 rounded-lg p-3 border border-amber-200 dark:border-amber-700/50">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="text-xs text-amber-500 dark:text-amber-400 mb-1">Story #${i + 1} ‚Ä¢ ${timeStr} ${isClosed ? '<span class="text-emerald-500">‚úÖ</span>' : '<span class="text-orange-500">üî¥ Active</span>'}</div>
                                                <div class="font-semibold text-amber-800 dark:text-amber-200 text-sm">${parties}</div>
                                                <div class="text-xs text-amber-600 dark:text-amber-400 mt-1">üë®‚Äç‚öïÔ∏è ${medics.filter(Boolean).join(', ') || '-'}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                }).join('') : '<span class="text-slate-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà</span>'}
                        </div>
                    </div>
                `;

                // Store data for copy function
                modal.dataset.summaryData = JSON.stringify({
                    op: data.opName,
                    supOp: data.supOp,
                    shiftDate: new Date(data.shiftStart).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }),
                    shiftStart: new Date(data.shiftStart).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                    shiftEnd: new Date(data.shiftEnd).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                    duration: `${hours}‡∏ä‡∏°. ${minutes}‡∏ô‡∏≤‡∏ó‡∏µ`,
                    onDuty: data.onDuty || [],
                    offDuty: data.offDuty || [],
                    cases: allCases.map(c => ({
                        parties: c.partyA && c.partyB ? `${c.partyA} VS ${c.partyB}` : (c.story || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'),
                        medics: (c.medics || [c.medic]).filter(Boolean)
                    }))
                });

                modal.classList.remove('hidden');
            }

            function closeShiftSummary() {
                document.getElementById('shift-summary-modal').classList.add('hidden');
                showNotif('Success', '‡∏à‡∏ö‡∏Å‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            function copyShiftSummary() {
                const modal = document.getElementById('shift-summary-modal');
                const data = JSON.parse(modal.dataset.summaryData || '{}');

                let text = `üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£ OP\n`;
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${data.shiftDate || '-'}\n`;
                text += `üë®‚Äç‚öïÔ∏è OP: ${data.op || '-'}\n`;
                text += `üë®‚Äç‚öïÔ∏è Support OP: ${data.supOp || '-'}\n`;
                text += `‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${data.shiftStart} - ${data.shiftEnd} (${data.duration})\n`;
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `‚úÖ On Duty (${data.onDuty?.length || 0} ‡∏Ñ‡∏ô):\n`;
                text += (data.onDuty || []).map(m => `  ‚Ä¢ ${m}`).join('\n') + '\n';
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `‚ùå Off Duty (${data.offDuty?.length || 0} ‡∏Ñ‡∏ô):\n`;
                text += (data.offDuty || []).map(m => `  ‚Ä¢ ${m}`).join('\n') + '\n';
                text += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                text += `üìã ‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà (${data.cases?.length || 0} ‡πÄ‡∏Ñ‡∏™):\n`;
                text += (data.cases || []).map((c, i) => {
                    const leadMedic = c.medics[0] || '-';
                    const supportMedics = c.medics.slice(1);
                    let storyText = `‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà #${i + 1} ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${c.parties}\n`;
                    storyText += `‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö : ${leadMedic}`;
                    if (supportMedics.length > 0) {
                        storyText += `\n‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ : ${supportMedics.join(' , ')}`;
                    }
                    return storyText;
                }).join('\n\n');

                navigator.clipboard.writeText(text).then(() => {
                    showNotif('Copied!', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡∏£ OP ‡πÅ‡∏•‡πâ‡∏ß');
                });
            }

            function copyAnnounceCooldown(partyA, partyB) {
                const now = new Date();
                const nowStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const later = new Date(now.getTime() + 10 * 60 * 1000);
                const laterStr = later.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });

                const msg = `/an ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${partyA} vs ${partyB} ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤ ${nowStr} - ${laterStr} ‡∏ô. ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`;

                navigator.clipboard.writeText(msg).then(() => {
                    showNotif('Copied!', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß');
                });
            }

            function copyAnnounceEnterArea(partyA, partyB) {
                const msg = `/an ‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà ${partyA} vs ${partyB} ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πä‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏ô‡∏∞ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å`;

                navigator.clipboard.writeText(msg).then(() => {
                    showNotif('Copied!', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß');
                });
            }

            function copyPhoneNotFound() {
                const phone = document.getElementById('phone-input-1').value.trim();
                if (!phone) return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
                const msg = `/an ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ‡∏´‡∏°‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏≠‡πÉ‡∏ô‡∏ô‡∏¥‡∏ï‡∏¢‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞`;
                navigator.clipboard.writeText(msg).then(() => {
                    showNotif('Copied!', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡πâ‡∏ß');
                    document.getElementById('phone-input-1').value = '';
                });
            }

            function copyPhoneUnreachable() {
                const phone = document.getElementById('phone-input-2').value.trim();
                if (!phone) return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£');
                const msg = `/an ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå ${phone} ‡∏´‡∏°‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏≠‡πÉ‡∏ô‡∏ô‡∏¥‡∏ï‡∏¢‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞`;
                navigator.clipboard.writeText(msg).then(() => {
                    showNotif('Copied!', '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                    document.getElementById('phone-input-2').value = '';
                });
            }

            function getScheduleOpName() {
                const tab = getCurrentShiftTab();
                if (appData.operatorSchedule && appData.operatorSchedule.current && appData.operatorSchedule.current[tab]) {
                    return appData.operatorSchedule.current[tab].name || '';
                }
                return '';
            }

            function isOpOrSupOp() {
                if (!currentUser) return false;
                const scheduleOp = getScheduleOpName();
                const supOp = appData.opSupport ? appData.opSupport.supOp : '';
                return currentUser.name === scheduleOp || currentUser.name === supOp;
            }

            function toggleMedicStatus(medicName, statusType) {
                if (!appData.opSupport.medicStatuses) appData.opSupport.medicStatuses = {};

                if (statusType === 'accept') { // ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ (Exclusive - only one at a time)
                    // Clear 'accept' from everyone else first
                    for (const key in appData.opSupport.medicStatuses) {
                        if (appData.opSupport.medicStatuses[key] === 'accept') {
                            delete appData.opSupport.medicStatuses[key];
                        }
                    }
                    appData.opSupport.medicStatuses[medicName] = 'accept';
                } else if (statusType === 'waitfix') { // ‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏Ñ‡∏™ (Toggle)
                    const current = appData.opSupport.medicStatuses[medicName];
                    if (current === 'waitfix') delete appData.opSupport.medicStatuses[medicName];
                    else appData.opSupport.medicStatuses[medicName] = 'waitfix';
                } else if (statusType === 'decline') { // ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™ (Toggle - shows ‚ùå)
                    const current = appData.opSupport.medicStatuses[medicName];
                    if (current === 'decline') delete appData.opSupport.medicStatuses[medicName];
                    else appData.opSupport.medicStatuses[medicName] = 'decline';
                }

                saveData('opSupport', true);
                renderOpPanel();
            }

            function setSidebarTab(tab) {
                const btnWorking = document.getElementById('tab-btn-working');
                const btnAfk = document.getElementById('tab-btn-afk');
                const viewWorking = document.getElementById('sidebar-view-working');
                const viewAfk = document.getElementById('sidebar-view-afk');

                if (tab === 'working') {
                    // Update Buttons
                    btnWorking.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-700/50');
                    btnWorking.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-indigo-600', 'dark:text-white');

                    btnAfk.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-700/50');
                    btnAfk.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-indigo-600', 'dark:text-white');

                    // Update Views
                    viewWorking.classList.remove('hidden');
                    viewAfk.classList.add('hidden');
                } else {
                    // AFK Tab
                    btnAfk.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-700/50');
                    btnAfk.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-indigo-600', 'dark:text-white');

                    btnWorking.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-700/50');
                    btnWorking.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm', 'text-indigo-600', 'dark:text-white');

                    // Update Views
                    viewAfk.classList.remove('hidden');
                    viewWorking.classList.add('hidden');
                }
            }

            function updateSupOp(name) {
                if (!appData.opSupport) return;
                appData.opSupport.supOp = name;
                saveData('opSupport', true);
            }

            function addManualMedic() {
                const input = document.getElementById('manual-add-name');
                const name = input.value.trim();
                if (!name) return;

                if (!appData.opSupport) appData.opSupport = { onDuty: [], offDuty: [], cases: [] };
                if (!appData.opSupport.onDuty) appData.opSupport.onDuty = [];

                appData.opSupport.onDuty.push(name);
                input.value = "";
                saveData('opSupport', true);
                renderOpPanel();
            }

            function moveMedic(name, from, to) {
                if (!appData.opSupport) return;

                // Initialize lists if missing
                if (!appData.opSupport.onDuty) appData.opSupport.onDuty = [];
                if (!appData.opSupport.offDuty) appData.opSupport.offDuty = [];
                if (!appData.opSupport.afk) appData.opSupport.afk = [];
                if (!appData.opSupport.afkTimes) appData.opSupport.afkTimes = {};
                if (!appData.opSupport.afkWarnings) appData.opSupport.afkWarnings = {};
                if (!appData.opSupport.afkPositions) appData.opSupport.afkPositions = {};
                if (!appData.opSupport.lastWarningTime) appData.opSupport.lastWarningTime = {};

                const listFrom = appData.opSupport[from];
                const listTo = appData.opSupport[to];

                const idx = listFrom.indexOf(name);
                if (idx > -1) {
                    listFrom.splice(idx, 1);

                    // Handle AFK Transitions
                    if (to === 'afk') {
                        // Store original position
                        if (from === 'onDuty') {
                            appData.opSupport.afkPositions[name] = idx;
                        }
                        appData.opSupport.afkTimes[name] = Date.now();
                        listTo.push(name);
                    } else if (from === 'afk' && to === 'onDuty') {
                        // Restore to original position
                        const originalPos = appData.opSupport.afkPositions[name];
                        if (originalPos !== undefined && originalPos <= listTo.length) {
                            listTo.splice(originalPos, 0, name);
                        } else {
                            listTo.push(name);
                        }
                        delete appData.opSupport.afkTimes[name];
                        delete appData.opSupport.afkPositions[name];
                        delete appData.opSupport.lastWarningTime[name];
                    } else {
                        listTo.push(name);
                        if (from === 'afk') {
                            delete appData.opSupport.afkTimes[name];
                            delete appData.opSupport.afkPositions[name];
                            delete appData.opSupport.lastWarningTime[name];
                        }
                    }

                    saveData('opSupport', true);
                    renderOpPanel();
                }
            }

            function createOpCase() {
                const partyA = document.getElementById('case-party-a').value;
                const partyB = document.getElementById('case-party-b').value;
                const location = document.getElementById('case-location').value;
                const radio = document.getElementById('case-radio').value;
                const council = document.getElementById('case-council').value;
                const timeInput = document.getElementById('case-time').value;

                const m1 = document.getElementById('case-medic-1').value;
                const m2 = document.getElementById('case-medic-2').value;
                const m3 = document.getElementById('case-medic-3').value;

                // Collect selected medics
                let selectedMedics = [m1, m2, m3].filter(m => m !== "");
                selectedMedics = [...new Set(selectedMedics)];

                if (!partyA || !partyB || !location || selectedMedics.length === 0) {
                    return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Party A/B, Location, ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 Medic)');
                }

                if (!timeInput) {
                    return showNotif('Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà');
                }

                if (!appData.opSupport.cases) appData.opSupport.cases = [];

                // Remove selected medics from On Duty
                if (appData.opSupport.onDuty) {
                    selectedMedics.forEach(medicName => {
                        const idx = appData.opSupport.onDuty.indexOf(medicName);
                        if (idx > -1) {
                            appData.opSupport.onDuty.splice(idx, 1);
                        }
                    });
                }

                let timestamp = Date.now();
                if (timeInput) {
                    const [h, m] = timeInput.split(':');
                    const d = new Date();
                    d.setHours(h, m, 0, 0);
                    timestamp = d.getTime();
                }

                appData.opSupport.cases.unshift({
                    id: Date.now().toString(),
                    partyA, partyB, location, radio, council,
                    medics: selectedMedics,
                    timestamp: timestamp
                });

                document.getElementById('case-party-a').value = "";
                document.getElementById('case-party-b').value = "";
                document.getElementById('case-radio').value = "";
                document.getElementById('case-council').value = "";
                document.getElementById('case-location').value = "";

                saveData('opSupport', true);
                renderOpPanel();
                showNotif('Success', '‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            async function closeCase(caseId) {
                const confirmed = await showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™', '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏Å‡∏≤‡∏£?');
                if (!confirmed) return;

                const cIdx = appData.opSupport.cases.findIndex(c => c.id === caseId);
                if (cIdx === -1) return;

                const c = appData.opSupport.cases[cIdx];

                // Save to closed cases history for summary
                if (!appData.opSupport.closedCases) appData.opSupport.closedCases = [];
                appData.opSupport.closedCases.push({
                    ...c,
                    closedAt: Date.now()
                });

                // Move Medics back to On Duty
                if (c.medics && Array.isArray(c.medics)) {
                    c.medics.forEach(m => appData.opSupport.onDuty.push(m));
                } else if (c.medic) {
                    // Backwards compatibility
                    appData.opSupport.onDuty.push(c.medic);
                }

                appData.opSupport.cases.splice(cIdx, 1);
                saveData('opSupport', true);
                renderOpPanel();
                showNotif('Success', '‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            let editingCaseId = null;
            function editCase(caseId) {
                // Toggle edit mode for this case
                if (editingCaseId === caseId) {
                    editingCaseId = null; // Cancel edit
                } else {
                    editingCaseId = caseId; // Enter edit mode
                }
                renderOpPanel();
            }

            function saveEditCase(caseId) {
                const cIdx = appData.opSupport.cases.findIndex(c => c.id === caseId);
                if (cIdx === -1) return showNotif('Error', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™');

                // Get values from inline inputs
                const partyA = document.getElementById(`edit-partyA-${caseId}`).value;
                const partyB = document.getElementById(`edit-partyB-${caseId}`).value;
                const location = document.getElementById(`edit-location-${caseId}`).value;
                const radio = document.getElementById(`edit-radio-${caseId}`).value;
                const council = document.getElementById(`edit-council-${caseId}`).value;

                // Update case
                appData.opSupport.cases[cIdx].partyA = partyA;
                appData.opSupport.cases[cIdx].partyB = partyB;
                appData.opSupport.cases[cIdx].location = location;
                appData.opSupport.cases[cIdx].radio = radio;
                appData.opSupport.cases[cIdx].council = council;

                editingCaseId = null;
                saveData('opSupport', true);
                renderOpPanel();
                showNotif('Success', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            function cancelEditCase() {
                editingCaseId = null;
                renderOpPanel();
            }

            async function deleteClosedCase(index) {
                const confirmed = await showConfirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?');
                if (!confirmed) return;

                if (appData.opSupport.closedCases && appData.opSupport.closedCases[index]) {
                    appData.opSupport.closedCases.splice(index, 1);
                    saveData('opSupport', true);
                    renderOpPanel();
                    showNotif('Success', '‡∏•‡∏ö‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
                }
            }

            let showingHistory = false;
            function toggleStoryHistory() {
                showingHistory = !showingHistory;
                renderOpPanel();
            }

            function renderOpPanel() {
                // Check if initialized
                if (!appData.opSupport || !appData.opSupport.shiftStart) {
                    if (!appData.opSupport) appData.opSupport = { onDuty: [], offDuty: [], cases: [], afk: [], afkTimes: {} };
                }

                const data = appData.opSupport;
                // Use schedule OP name instead of stored opName
                let currentOpName = getScheduleOpName() || data.opName || (currentUser ? currentUser.name : '');

                // Show "No Operator..." if waiting
                const isWaiting = !currentOpName || currentOpName === '‡∏£‡∏≠‡∏™‡∏∏‡πà‡∏°...' || currentOpName === '-' || currentOpName === '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå';
                const displayOpName = isWaiting ? 'No Operator...' : currentOpName;

                // Allow Admin to edit too
                const isAdmin = currentUser && currentUser.role === 'admin';
                const canEdit = isOpOrSupOp() || isAdmin;

                // 1. Header
                document.getElementById('op-panel-name').innerText = displayOpName;
                const timerEl = document.getElementById('op-shift-timer');

                // Update Date Display
                const dateEl = document.getElementById('op-shift-date');
                if (dateEl) {
                    const shiftDate = data.shiftStart ? new Date(data.shiftStart) : new Date();
                    dateEl.innerText = shiftDate.toLocaleDateString('th-TH', {
                        day: 'numeric', month: 'short', year: 'numeric'
                    });
                }

                // Update Timer
                if (!data.shiftStart) {
                    timerEl.innerText = "00:00:00";
                }

                // Access Control - Disable buttons/inputs if not OP/SupOP
                const controlButtons = document.getElementById('op-action-buttons');
                const supOpSelect = document.getElementById('ctrl-sup-op');
                const supOpDisplay = document.getElementById('sup-op-display');
                const startBtn = document.getElementById('op-start-btn');
                const caseCreationCard = document.getElementById('case-creation-card');
                const sidebarLists = document.getElementById('sidebar-view-working');
                const sidebarAfk = document.getElementById('sidebar-view-afk');
                const manualAddContainer = document.getElementById('manual-add-container');

                // Hide Start button after shift started
                if (startBtn) {
                    startBtn.style.display = data.shiftStart ? 'none' : '';
                }

                if (controlButtons) controlButtons.style.display = canEdit ? '' : 'none';

                // Show Sup OP select for editors, display for viewers
                if (supOpSelect) supOpSelect.style.display = canEdit ? '' : 'none';

                // Show the sup-op-viewer container for non-OP users
                const supOpViewer = document.getElementById('sup-op-viewer');
                if (supOpViewer) {
                    supOpViewer.style.display = canEdit ? 'none' : '';
                }
                if (supOpDisplay) {
                    supOpDisplay.innerText = data.supOp || '-';
                }
                if (caseCreationCard) caseCreationCard.style.display = canEdit ? '' : 'none';
                if (manualAddContainer) manualAddContainer.style.display = canEdit ? '' : 'none';

                // Disable all buttons in lists if not OP/SupOP
                if (!canEdit) {
                    document.querySelectorAll('#list-on-duty button, #list-off-duty button, #list-afk button, #op-case-list button').forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                }

                // 2. Sup OP Select (Filtered)
                const supSelect = document.getElementById('op-sup-select');
                if (supSelect.options.length <= 1 || supSelect.innerHTML.includes(currentOpName)) {
                    const onDutyRoster = (appData.roster || []).filter(r => r.status === '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô' && r.name !== currentOpName);
                    supSelect.innerHTML = '<option value="">-- Select Sup OP --</option>' +
                        onDutyRoster.map(r => `<option value="${r.name}">${r.name}</option>`).join('');
                }
                supSelect.value = data.supOp || "";

                // 3. Lists
                const onDutyList = document.getElementById('list-on-duty');
                const offDutyList = document.getElementById('list-off-duty');
                const afkList = document.getElementById('list-afk');

                const countOn = document.getElementById('count-on-duty');
                const countOff = document.getElementById('count-off-duty');
                const countAfk = document.getElementById('count-afk');

                const countTabWorking = document.getElementById('count-tab-working');
                const countTabAfk = document.getElementById('count-tab-afk');

                const numOn = (data.onDuty || []).length;
                const numOff = (data.offDuty || []).length;
                const numAfk = (data.afk || []).length;

                // Count medics in active cases
                const numInCases = (data.cases || []).reduce((sum, c) => {
                    if (c.medics && Array.isArray(c.medics)) return sum + c.medics.length;
                    if (c.medic) return sum + 1;
                    return sum;
                }, 0);

                // Total = On Duty + In Cases + AFK
                const totalWorking = numOn + numInCases + numAfk;

                if (countOn) countOn.innerText = totalWorking;
                if (countOff) countOff.innerText = numOff;
                if (countAfk) countAfk.innerText = numAfk;

                if (countTabWorking) countTabWorking.innerText = numOn + numOff;
                if (countTabAfk) countTabAfk.innerText = numAfk;

                // On Duty Render - Different display for canEdit vs read-only
                onDutyList.innerHTML = (data.onDuty || []).map(m => {
                    const status = (data.medicStatuses || {})[m];
                    const warningCount = (data.afkWarnings || {})[m] || 0;

                    // Icons: accept=üöë, waitfix=üö®, decline=‚ùå
                    let statusIcon = '<span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>';
                    let statusText = '';
                    if (status === 'accept') { statusIcon = 'üöë'; statusText = '‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™'; }
                    else if (status === 'waitfix') { statusIcon = 'üö®'; statusText = '‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏Ñ‡∏™'; }
                    else if (status === 'decline') { statusIcon = '‚ùå'; statusText = '‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™'; }

                    // Caution badge for 3+ warnings
                    const cautionBadge = warningCount >= 3 ? `<span class="text-[9px] bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 px-1.5 py-0.5 rounded-full border border-amber-200 dark:border-amber-700 ml-1">‚ö†Ô∏è Caution x${warningCount}</span>` : '';

                    if (canEdit) {
                        // Full controls for OP/SupOP/Admin
                        return `
                        <div class="flex flex-col bg-white dark:bg-slate-700/50 p-2 rounded-lg border border-slate-100 dark:border-slate-800 shadow-sm custom-hover-item group gap-2">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-slate-700 dark:text-slate-200 text-xs flex items-center gap-2">
                                     ${statusIcon} ${m} ${cautionBadge}
                                </span>
                                <div class="flex items-center gap-1 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="moveMedic('${m}', 'onDuty', 'afk')" class="text-[10px] bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400 px-2 py-1 rounded hover:bg-yellow-100 dark:hover:bg-yellow-900/40 transition">üí§ AFK</button>
                                    <button onclick="moveMedic('${m}', 'onDuty', 'offDuty')" class="text-[10px] bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-2 py-1 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition">üîª Off</button>
                                </div>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="toggleMedicStatus('${m}', 'accept')" class="flex-1 text-[9px] py-1 rounded ${status === 'accept' ? 'bg-indigo-500 text-white shadow-md shadow-indigo-500/30' : 'bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-300 hover:bg-indigo-100 dark:hover:bg-indigo-900/30'} transition">‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™</button>
                                <button onclick="toggleMedicStatus('${m}', 'waitfix')" class="flex-1 text-[9px] py-1 rounded ${status === 'waitfix' ? 'bg-orange-500 text-white shadow-md shadow-orange-500/30' : 'bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-slate-300 hover:bg-orange-100 dark:hover:bg-orange-900/30'} transition">‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÄ‡∏Ñ‡∏™</button>
                                <button onclick="toggleMedicStatus('${m}', 'decline')" class="text-[9px] px-2 py-1 rounded ${status === 'decline' ? 'bg-rose-500 text-white shadow-md shadow-rose-500/30' : 'bg-slate-100 dark:bg-slate-600 text-slate-400 hover:bg-rose-100 hover:text-rose-600 dark:hover:bg-rose-900/30'} transition" title="‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™">‚úñ</button>
                            </div>
                        </div>
                    `;
                    } else {
                        // Clean read-only display for others
                        const statusBadge = statusText ? `<span class="text-[9px] px-2 py-0.5 rounded-full ${status === 'accept' ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400' :
                            status === 'waitfix' ? 'bg-orange-100 text-orange-600 dark:bg-orange-900/30 dark:text-orange-400' :
                                status === 'decline' ? 'bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400' : ''
                            }">${statusText}</span>` : '';

                        return `
                        <div class="flex justify-between items-center bg-white dark:bg-slate-700/50 p-2.5 rounded-lg border border-slate-100 dark:border-slate-800">
                            <span class="font-semibold text-slate-700 dark:text-slate-200 text-xs flex items-center gap-2">
                                ${statusIcon} ${m} ${cautionBadge}
                            </span>
                            ${statusBadge}
                        </div>
                    `;
                    }
                }).join('');

                // AFK Render
                if (afkList) {
                    afkList.innerHTML = (data.afk || []).map(m => {
                        const warningCount = (data.afkWarnings || {})[m] || 0;
                        const warningBadge = warningCount > 0 ? `<span class="text-[9px] bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 px-1.5 py-0.5 rounded-full">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô x${warningCount}</span>` : '';
                        return `
                        <div class="flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/10 p-2 rounded-lg border border-yellow-100 dark:border-yellow-900/30 custom-hover-item group">
                            <div class="flex flex-col">
                                <span class="text-slate-600 dark:text-slate-300 text-xs font-bold flex items-center gap-2">
                                    üí§ ${m} ${warningBadge}
                                </span>
                                <span class="text-[10px] font-mono text-slate-400 afk-timer" data-start="${(data.afkTimes || {})[m] || Date.now()}" data-medic="${m}">00:00:00</span>
                            </div>
                            ${canEdit ? `<button onclick="moveMedic('${m}', 'afk', 'onDuty')" class="text-[10px] bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 px-2 py-1 rounded hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition opacity-0 group-hover:opacity-100">Make Active</button>` : ''}
                        </div>
                    `}).join('');
                }

                // Off Duty Render
                offDutyList.innerHTML = (data.offDuty || []).map(m => `
                    <div class="flex justify-between items-center bg-slate-50 dark:bg-slate-800/30 p-2 rounded-lg border border-slate-100 dark:border-slate-800 custom-hover-item">
                        <span class="text-slate-500 dark:text-slate-400 text-xs flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span> ${m}
                        </span>
                        ${canEdit ? `<button onclick="moveMedic('${m}', 'offDuty', 'onDuty')" class="text-[10px] bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 px-2 py-1 rounded hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition">üîº On</button>` : ''}
                    </div>
                `).join('');

                // 4. Case Medic Dropdowns
                const onDutyOptions = '<option value="">-- Select Medic --</option>' +
                    (data.onDuty || []).map(m => `<option value="${m}">${m}</option>`).join('');

                ['case-medic-1', 'case-medic-2', 'case-medic-3'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = onDutyOptions.replace('-- Select Medic --', id === 'case-medic-1' ? '-- Medic 1 --' : `-- Medic ${id.split('-')[2]} (Optional) --`);
                });

                // 5. Case List
                const caseList = document.getElementById('op-case-list');
                const closedCases = data.closedCases || [];

                // Add History Header with toggle
                let historyHeader = '';
                if (canEdit && closedCases.length > 0) {
                    historyHeader = `
                        <div class="flex justify-between items-center mb-3 p-2 bg-slate-100 dark:bg-slate-800 rounded-lg">
                            <span class="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà (${closedCases.length})
                            </span>
                            <button onclick="toggleStoryHistory()" class="text-[10px] bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-2 py-1 rounded hover:bg-slate-50 dark:hover:bg-slate-600 transition">
                                ${showingHistory ? 'üîº ‡∏ã‡πà‡∏≠‡∏ô' : 'üîΩ ‡πÅ‡∏™‡∏î‡∏á'}
                            </button>
                        </div>
                    `;
                }

                // History list (if showing)
                let historyList = '';
                if (showingHistory && closedCases.length > 0) {
                    historyList = closedCases.map((c, idx) => {
                        const parties = c.partyA && c.partyB ? `${c.partyA} VS ${c.partyB}` : (c.story || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
                        const medics = (c.medics || [c.medic]).filter(Boolean).join(', ');
                        const closedTime = c.closedAt ? new Date(c.closedAt).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '-';
                        return `
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-2">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <span class="text-[10px] text-slate-500 dark:text-slate-400">‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${closedTime}</span>
                                        <div class="text-xs font-bold text-slate-700 dark:text-slate-200">${parties}</div>
                                        <div class="text-[10px] text-slate-500 dark:text-slate-400">üë®‚Äç‚öïÔ∏è ${medics || '-'}</div>
                                    </div>
                                    <button onclick="deleteClosedCase(${idx})" class="text-[10px] bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 px-2 py-1 rounded hover:bg-red-100 dark:hover:bg-red-900/40 transition">
                                        üóëÔ∏è ‡∏•‡∏ö
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    historyList = `<div class="mb-4 border-b border-slate-200 dark:border-slate-700 pb-4">${historyList}</div>`;
                }

                const displayCases = [...(data.cases || [])].reverse();

                caseList.innerHTML = historyHeader + historyList + displayCases.map((c, idx) => {
                    const storyNum = idx + 1; // 1 = Oldest
                    const storyDisplay = c.partyA && c.partyB ?
                        `<div class="flex items-center justify-center gap-2 text-sm font-bold text-slate-800 dark:text-white mb-2">
                             <span class="truncate max-w-[45%] text-end">${c.partyA}</span>
                             <span class="text-rose-500 italic font-black text-xs px-1">VS</span>
                             <span class="truncate max-w-[45%] text-start">${c.partyB}</span>
                         </div>` :
                        `<h5 class="text-sm font-bold text-slate-800 dark:text-white mb-2 text-center">${c.story}</h5>`;

                    const medics = c.medics || [c.medic];
                    const leadMedic = medics[0];
                    const supportMedics = medics.slice(1);
                    const isMultiMedic = supportMedics.length > 0;

                    const leadLabel = isMultiMedic ? "‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏•‡∏±‡∏Å :" : "‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö :";
                    const supportLabel = "‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ / ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏á‡∏≤‡∏ô :";

                    const supportDisplay = isMultiMedic ?
                        `<div class="flex flex-col gap-1 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700/50">
                            <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">${supportLabel}</span>
                            <div class="flex flex-wrap gap-2">
                                ${supportMedics.map((m, i) =>
                            `<span class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2 py-0.5 rounded text-[10px] font-bold border border-indigo-100 dark:border-indigo-800/50 flex items-center gap-1">
                                        ${i + 1}. ${m}
                                    </span>`
                        ).join('')}
                            </div>
                        </div>` : '';

                    return `
                    <div class="bg-white dark:bg-slate-800 p-3 rounded-xl border border-indigo-50 dark:border-slate-700 shadow-sm hover:shadow-md transition relative group overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-indigo-400 to-indigo-600"></div>
                        <div class="flex justify-between items-start mb-2">
                            <span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">STORY #${storyNum}</span>
                        </div>
                        
                        ${storyDisplay}

                        <div class="bg-slate-50 dark:bg-slate-900/50 rounded-lg p-3 mb-2 border border-slate-100 dark:border-slate-800/50">
                             
                             <!-- Time Row -->
                             <div class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-200 dark:border-slate-700/50 text-indigo-600 dark:text-indigo-400">
                                 <span class="text-[10px] font-bold uppercase opacity-70">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ï‡∏≠‡∏£‡∏µ‡πà :</span>
                                 <span class="text-xs font-mono font-bold">${new Date(c.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })}</span>
                             </div>

                             ${editingCaseId === c.id ? `
                             <!-- Edit Mode -->
                             <div class="space-y-2 mb-2">
                                 <div class="grid grid-cols-2 gap-2">
                                     <div>
                                         <label class="text-[10px] text-slate-500 block mb-1">Party A</label>
                                         <input id="edit-partyA-${c.id}" type="text" value="${c.partyA || ''}" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                                     </div>
                                     <div>
                                         <label class="text-[10px] text-slate-500 block mb-1">Party B</label>
                                         <input id="edit-partyB-${c.id}" type="text" value="${c.partyB || ''}" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                                     </div>
                                 </div>
                                 <div>
                                     <label class="text-[10px] text-slate-500 block mb-1">üìç Location</label>
                                     <input id="edit-location-${c.id}" type="text" value="${c.location || ''}" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                                 </div>
                                 <div class="grid grid-cols-2 gap-2">
                                     <div>
                                         <label class="text-[10px] text-slate-500 block mb-1">üìª Radio</label>
                                         <input id="edit-radio-${c.id}" type="text" value="${c.radio || ''}" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                                     </div>
                                     <div>
                                         <label class="text-[10px] text-slate-500 block mb-1">‚öñÔ∏è Council</label>
                                         <input id="edit-council-${c.id}" type="text" value="${c.council || ''}" class="w-full text-xs p-1.5 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">
                                     </div>
                                 </div>
                             </div>
                             ` : `
                             <!-- Details Grid -->
                             <div class="grid grid-cols-2 gap-y-1 gap-x-2 text-xs text-slate-600 dark:text-slate-300 mb-2">
                                <div class="flex items-center gap-1"><span class="opacity-70">üìç</span> ${c.location}</div>
                                <div class="flex items-center gap-1"><span class="opacity-70">üìª</span> Radio : <span class="font-mono font-bold text-indigo-500">${c.radio || '-'}</span></div>
                                <div class="flex items-center gap-1 col-span-2"><span class="opacity-70">‚öñÔ∏è</span> Council: ${c.council || '-'}</div>
                             </div>
                             `}

                             <!-- Medic Section -->
                             <div class="flex items-center gap-2 pt-2 border-t border-slate-200 dark:border-slate-700/50">
                                <span class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase tracking-wider whitespace-nowrap">${leadLabel}</span>
                                <span class="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 border border-indigo-200 dark:border-indigo-700 ring-1 ring-indigo-500/20 text-xs px-2 py-0.5 rounded font-bold flex items-center gap-1 shadow-sm">
                                    üëë ${leadMedic}
                                </span>
                             </div>

                             ${supportDisplay}
                        </div>

                        <!-- Announcement Shortcuts (Available to all users) -->
                        <div class="flex gap-2 mb-2 justify-start">
                             <button onclick="copyAnnounceCooldown('${c.partyA}', '${c.partyB}')" class="text-[10px] bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 px-2 py-1 rounded hover:bg-amber-100 dark:hover:bg-amber-900/40 transition">
                                 üìã ‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå
                             </button>
                             <button onclick="copyAnnounceEnterArea('${c.partyA}', '${c.partyB}')" class="text-[10px] bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 px-2 py-1 rounded hover:bg-cyan-100 dark:hover:bg-cyan-900/40 transition">
                                 üìã ‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
                             </button>
                        </div>

                        ${canEdit ? `<div class="flex justify-end gap-2">
                             ${editingCaseId === c.id ? `
                                 <button onclick="cancelEditCase()" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-3 py-1.5 rounded-lg transition flex items-center gap-1">
                                     ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                 </button>
                                 <button onclick="saveEditCase('${c.id}')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm shadow-indigo-500/30 transition flex items-center gap-1">
                                     üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                 </button>
                             ` : `
                                 <button onclick="editCase('${c.id}')" class="bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-3 py-1.5 rounded-lg transition flex items-center gap-1">
                                     ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                 </button>
                                 <button onclick="closeCase('${c.id}')" class="bg-emerald-500 hover:bg-emerald-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm shadow-emerald-500/30 transition flex items-center gap-1">
                                     ‚úÖ Close
                                 </button>
                             `}
                        </div>` : ''}
                    </div>
                `}).join('');
            }

            // Polling for timer
            setInterval(() => {
                const modal = document.getElementById('op-panel-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    const now = Date.now();

                    // Main Shift Timer
                    if (appData.opSupport && appData.opSupport.shiftStart) {
                        const diff = now - appData.opSupport.shiftStart;
                        const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                        const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                        const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                        const el = document.getElementById('op-shift-timer');
                        if (el) el.innerText = `${h}:${m}:${s}`;
                    }

                    // AFK Timers and Warning System
                    document.querySelectorAll('.afk-timer').forEach(el => {
                        const start = parseInt(el.getAttribute('data-start'));
                        const medicName = el.getAttribute('data-medic');
                        if (start) {
                            const diff = now - start;
                            const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                            el.innerText = `${h}:${m}:${s}`;

                            // Check for 5-minute warning (only if OP)
                            if (isOpOrSupOp() && medicName && diff >= 5 * 60 * 1000) {
                                const lastWarning = (appData.opSupport.lastWarningTime || {})[medicName] || 0;
                                const timeSinceLastWarning = now - lastWarning;

                                // Warn every 5 minutes
                                if (timeSinceLastWarning >= 5 * 60 * 1000) {
                                    if (!appData.opSupport.afkWarnings) appData.opSupport.afkWarnings = {};
                                    if (!appData.opSupport.lastWarningTime) appData.opSupport.lastWarningTime = {};

                                    const currentWarnings = (appData.opSupport.afkWarnings[medicName] || 0) + 1;
                                    appData.opSupport.afkWarnings[medicName] = currentWarnings;
                                    appData.opSupport.lastWarningTime[medicName] = now;

                                    const timeStr = `${h}:${m}:${s}`;

                                    if (currentWarnings >= 3) {
                                        // 3rd warning - Move to Off Duty
                                        showNotif('‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3', `‡πÅ‡∏û‡∏ó‡∏¢‡πå ${medicName} ‡πÄ‡∏´‡∏°‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${timeStr})\n‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á Off Duty ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`);

                                        // Move to Off Duty
                                        const afkIdx = appData.opSupport.afk.indexOf(medicName);
                                        if (afkIdx > -1) {
                                            appData.opSupport.afk.splice(afkIdx, 1);
                                            appData.opSupport.offDuty.push(medicName);
                                            delete appData.opSupport.afkTimes[medicName];
                                            delete appData.opSupport.afkPositions[medicName];
                                            saveData('opSupport', true);
                                            renderOpPanel();
                                        }
                                    } else {
                                        showNotif('‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô AFK', `‡πÅ‡∏û‡∏ó‡∏¢‡πå ${medicName} ‡πÄ‡∏´‡∏°‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${timeStr})\n‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏Å‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${currentWarnings}`);
                                        saveData('opSupport', true);
                                    }
                                }
                            }
                        }
                    });
                }
            }, 1000);

            function listenToFirebase() {
                ['statusInfo', 'founders', 'roster', 'retired', 'rules', 'blacklist', 'announcements', 'operatorSchedule', 'permissions', 'opSupport'].forEach(type => {
                    db.collection('cms_content').doc(type).onSnapshot(doc => {
                        if (doc.exists) {
                            const data = doc.data();
                            if (type === 'statusInfo' || type === 'rules' || type === 'operatorSchedule' || type === 'permissions' || type === 'opSupport') appData[type] = data;
                            else appData[type] = data.items || [];

                            if (type === 'statusInfo') {
                                checkDailyReset(); // Only check after statusInfo is loaded
                            }

                            if (type === 'roster') {
                                syncRosterUsers(); // Ensure Auth table is synced with Roster
                            }

                            if (type === 'permissions') {
                                renderAdminMenu();
                            }

                            if (type === 'operatorSchedule') {
                                checkAutoResetOp(); // Check for 5-hour auto-reset
                            }

                            if (type === 'opSupport') {
                                renderOpPanel(); // Real-time updates for all users
                            }

                            renderAll();
                            renderShiftSchedule();
                        }
                    });
                });
                db.collection('cms_content').doc('authUsers').onSnapshot(doc => {
                    if (doc.exists) appData.authUsers = doc.data();
                    isAuthLoaded = true; // Mark as loaded
                    syncRosterUsers(); // Sync after loading auth data
                    renderAdminMenu();
                });
            }

            window.addEventListener('scroll', () => {
                const sections = document.querySelectorAll('section');
                const navLinks = document.querySelectorAll('.nav-item');
                let current = '';
                sections.forEach(section => { if (pageYOffset >= (section.offsetTop - 300)) current = section.getAttribute('id'); });
                navLinks.forEach(link => { link.classList.remove('active'); if (link.getAttribute('data-target') === current) link.classList.add('active'); });
            });

            function syncRosterUsers() {
                if (!appData.roster || !isAuthLoaded) return; // Wait for both Roster and Auth Load
                let changed = false;
                if (!appData.authUsers) appData.authUsers = {};

                appData.roster.forEach(r => {
                    if (r.discordId && !appData.authUsers[r.discordId]) {
                        appData.authUsers[r.discordId] = {
                            role: 'staff',
                            password: '123456',
                            requiresReset: true
                        };
                        changed = true;
                    }
                });

                if (changed) saveData('authUsers', true);
            }

            document.addEventListener('DOMContentLoaded', () => {
                // Restore Auth
                const savedSession = localStorage.getItem('authSession');
                if (savedSession) {
                    try {
                        const session = JSON.parse(savedSession);
                        if (session.expiry > Date.now()) {
                            currentUser = session.user;
                            loginSuccess(currentUser, true);
                            console.log("Session Restored:", currentUser.name);
                        } else {
                            localStorage.removeItem('authSession');
                        }
                    } catch (e) {
                        console.error("Session corrupted", e);
                        localStorage.removeItem('authSession');
                    }
                }

                initApp();


                // Scroll Reveal Observer
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('reveal-visible');
                        }
                    });
                }, { threshold: 0.1 }); // Trigger when 10% visible
                document.querySelectorAll('.reveal-on-scroll').forEach((el) => observer.observe(el));
            });
        </script>
</body>

</html>