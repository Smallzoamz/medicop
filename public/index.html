<!DOCTYPE html>
<html lang="th" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏥 .:: Medical OP Systems ::. v.1.6.1 by Bonchon-Studio</title>
    <link id="dynamic-favicon" rel="icon" type="image/png" href="">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <!-- PeerJS for WebRTC Voice Calls - CALL_FEATURE -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Prompt', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        /* Custom Title Bar for Electron */
        .electron-title-bar {
            height: 32px;
            background: linear-gradient(90deg, #0f172a 0%, #1e293b 100%);
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            -webkit-app-region: drag;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
        }

        .title-bar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .title-bar-icon {
            width: 16px;
            height: 16px;
        }

        .title-bar-text {
            font-size: 12px;
            color: #06b6d4;
            font-weight: 500;
        }

        .title-bar-controls {
            display: flex;
            gap: 0;
            -webkit-app-region: no-drag;
        }

        /* Windows 11 Style Buttons */
        .title-bar-btn {
            width: 46px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .title-bar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .title-bar-btn:active {
            background: rgba(255, 255, 255, 0.05);
        }

        .title-bar-btn.close:hover {
            background: #e81123;
            color: #ffffff;
        }

        .title-bar-btn.close:active {
            background: #f1707a;
        }

        .title-bar-btn svg {
            width: 10px;
            height: 10px;
        }

        /* Adjust body when title bar is present */
        body.has-title-bar {
            padding-top: 32px;
            height: 100vh;
            overflow: hidden;
        }

        body.has-title-bar #app-container,
        body.has-title-bar .min-h-screen {
            min-height: calc(100vh - 32px) !important;
            height: calc(100vh - 32px) !important;
            overflow-y: auto;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        /* Global scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b5cf6 0%, #6366f1 50%, #3b82f6 100%);
            border-radius: 4px;
            border: 2px solid rgba(15, 23, 42, 0.8);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #a78bfa 0%, #818cf8 50%, #60a5fa 100%);
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.08);
        }

        .inp-pretty {
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: 0.875rem;
            border-radius: 0.625rem;
            border: 1px solid rgba(100, 116, 139, 0.5);
            background: rgba(15, 23, 42, 0.6);
            color: white;
            transition: all 0.2s;
        }

        .inp-pretty:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .inp-pretty::placeholder {
            color: rgba(148, 163, 184, 0.6);
        }

        .animate-zoom-in {
            animation: zoomIn 0.2s ease;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Lo-Fi Radio Marquee */
        .lofi-marquee {
            display: inline-block;
            animation: lofiScroll 12s linear infinite;
        }

        @keyframes lofiScroll {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        /* Event Card Responsive Layout */
        .event-cards-responsive {
            display: flex;
            flex-wrap: nowrap;
        }

        /* Portrait: Horizontal scroll */
        @media (orientation: portrait) {
            .event-cards-responsive {
                flex-direction: row;
                overflow-x: auto;
                max-height: 180px;
            }

            .event-cards-responsive>div {
                min-width: 200px;
                flex-shrink: 0;
            }
        }

        /* Landscape: 2 cards side by side */
        @media (orientation: landscape) {
            .event-cards-responsive {
                flex-direction: row;
                flex-wrap: wrap;
                overflow-y: auto;
                max-height: 250px;
            }

            .event-cards-responsive>div {
                width: 48%;
                flex-shrink: 0;
            }
        }

        /* Event countdown animation */
        @keyframes eventPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .event-countdown-pulse {
            animation: eventPulse 1s infinite;
        }

        .checkmark {
            width: 44px;
            height: 44px;
            margin: 10px auto;
        }

        .checkmark-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke: #10b981;
            fill: none;
            animation: stroke 0.5s ease forwards;
        }

        .checkmark-check {
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke: #10b981;
            animation: stroke 0.3s ease 0.5s forwards;
        }

        .cross-icon {
            width: 44px;
            height: 44px;
            margin: 10px auto;
        }

        .cross-circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke: #ef4444;
            fill: none;
            animation: stroke 0.5s ease forwards;
        }

        .cross-line {
            stroke-dasharray: 30;
            stroke-dashoffset: 30;
            stroke: #ef4444;
            animation: stroke 0.3s ease 0.5s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        .inp-primary {
            font-size: 0.75rem;
            border-radius: 0.5rem;
            border-color: rgb(51 65 85);
            background-color: rgb(15 23 42 / 0.5);
            padding: 0.5rem;
            color: white;
        }

        .inp-primary:focus {
            --tw-ring-color: rgb(99 102 241);
            border-color: rgb(99 102 241);
        }

        @keyframes breathing-red {

            0%,
            100% {
                background-color: rgba(239, 68, 68, 0.2);
            }

            50% {
                background-color: rgba(239, 68, 68, 0.5);
            }
        }

        .umae-urgent {
            animation: breathing-red 1.5s ease-in-out infinite;
        }

        /* Welcome Animation Overlay (Electron Only) */
        .welcome-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .welcome-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            animation: welcome-logo-anim 1s ease-out forwards;
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.5);
        }

        @keyframes welcome-logo-anim {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }

            60% {
                transform: scale(1.2) rotate(10deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .welcome-text {
            margin-top: 24px;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #c084fc, #818cf8, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            opacity: 0;
            animation: welcome-text-anim 0.8s ease-out 0.5s forwards;
        }

        @keyframes welcome-text-anim {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .welcome-subtext {
            margin-top: 8px;
            font-size: 14px;
            color: #94a3b8;
            opacity: 0;
            animation: welcome-text-anim 0.8s ease-out 0.8s forwards;
        }

        .welcome-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .welcome-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            border-radius: 50%;
            animation: particle-float 3s ease-in-out infinite;
        }

        @keyframes particle-float {

            0%,
            100% {
                transform: translateY(0) scale(1);
                opacity: 0.6;
            }

            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
        }

        /* Queue Warning Popup Animation */
        @keyframes queueWarningPop {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }

            100% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .queue-warning-popup {
            animation: queueWarningPop 0.2s ease-out;
        }
    </style>
</head>

<body class="text-white">
    <!-- Custom Title Bar (Electron Only) -->
    <div id="electron-title-bar" class="electron-title-bar hidden">
        <div class="title-bar-left">
            <img src="logo.jpg" alt="Logo" class="title-bar-icon" style="border-radius: 3px;">
            <span class="title-bar-text">Medical OP Systems v.1.6.1</span>
        </div>
        <div class="title-bar-controls">
            <button class="title-bar-btn minimize" id="btn-minimize" title="ย่อ">
                <svg viewBox="0 0 10 1" fill="currentColor">
                    <rect width="10" height="1"></rect>
                </svg>
            </button>
            <button class="title-bar-btn maximize" id="btn-maximize" title="ขยาย">
                <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1">
                    <rect x="0.5" y="0.5" width="9" height="9"></rect>
                </svg>
            </button>
            <button class="title-bar-btn close" id="btn-close" title="ปิด">
                <svg viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1.2">
                    <line x1="0" y1="0" x2="10" y2="10"></line>
                    <line x1="10" y1="0" x2="0" y2="10"></line>
                </svg>
            </button>
        </div>
    </div>

    <!-- Welcome Animation Overlay (Electron Only) -->
    <div id="welcome-overlay" class="welcome-overlay hidden">
        <div class="welcome-particles" id="welcome-particles"></div>
        <img src="logo.jpg" alt="Logo" class="welcome-logo" id="welcome-logo">
        <h1 class="welcome-text" id="welcome-greeting">ยินดีต้อนรับ</h1>
        <p class="welcome-subtext" id="welcome-username"></p>
    </div>

    <!-- Notification Modal -->
    <div id="notification"
        class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-xs w-full mx-4 text-center animate-zoom-in">
            <div id="notif-icon" class="mb-3"></div>
            <h3 id="notif-title" class="text-base font-semibold text-white mb-1"></h3>
            <p id="notif-msg" class="text-sm text-slate-400 mb-4"></p>
            <button onclick="closeNotif()"
                class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ตกลง</button>
        </div>
    </div>
    <!-- Confirm Modal -->
    <div id="confirm-modal"
        class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-xs w-full mx-4 text-center animate-zoom-in">
            <div class="text-3xl mb-3 opacity-60">❓</div>
            <h3 id="confirm-title" class="text-base font-semibold text-white mb-1"></h3>
            <p id="confirm-msg" class="text-sm text-slate-400 mb-4"></p>
            <div class="flex gap-2">
                <button id="confirm-no-btn"
                    class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ยกเลิก</button>
                <button id="confirm-yes-btn"
                    class="flex-1 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium rounded-lg transition">ตกลง</button>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal"
        class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="glass rounded-2xl p-6 max-w-lg w-full mx-4 animate-zoom-in max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2">🔄 อัปเดตระบบ</h3>
                <button onclick="closeChangelogModal()" class="text-slate-400 hover:text-white text-xl">✕</button>
            </div>
            <div id="changelog-content" class="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2">
                <div class="bg-gradient-to-r from-cyan-900/50 to-transparent rounded-xl p-4 border-l-4 border-cyan-500">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-cyan-400 font-bold text-sm">v1.6.1</span>
                        <span class="text-[10px] bg-cyan-500 text-white px-2 py-0.5 rounded-full">Latest</span>
                        <span class="text-[10px] text-slate-500">15 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 📞 Discord Bot แสดงเบอร์ IC ต่อท้ายชื่อ OP/Sup OP/On Duty</li>
                        <li>• 🎮 Badge "กำลังเล่น" สำหรับสตอรี่ที่เริ่มแล้ว</li>
                        <li>• ✅ จบกะได้โดยไม่ต้องปิดสตอรี่ (เก็บต่อถ้ายังมีที่ไม่จบ)</li>
                        <li>• 🔧 แก้ไข Discord โพสต์ซ้ำเมื่อดูประวัติกะ</li>
                        <li>• ⚡ Version Display อัพเดทอัตโนมัติจาก APP_VERSION</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.5.7</span>
                        <span class="text-[10px] text-slate-500">14 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 💬 DM Chat ลิงค์คลิกได้ + ตัดบรรทัดอัตโนมัติ</li>
                        <li>• 🔗 ปุ่มเชื่อมต่อ Discord ในฟอร์มสมัครสมาชิก (EXE)</li>
                        <li>• ✖️ ปุ่มปิดโปรแกรม + Confirm Dialog (EXE)</li>
                        <li>• 👋 หน้า Goodbye เมื่อ Logout (EXE)</li>
                        <li>• 🌙 หน้า Goodbye เมื่อปิดโปรแกรม (EXE)</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.5.5</span>
                        <span class="text-[10px] text-slate-500">14 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🔗 Discord Account Linking (OAuth2)</li>
                        <li>• 📌 Discord Mention สำหรับ OP/Story (ถ้า Linked)</li>
                        <li>• 🤖 Discord Bot แสดง Story ของวันนี้เท่านั้น</li>
                        <li>• 📝 Autocomplete สำหรับชื่อ On Duty</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.5.0</span>
                        <span class="text-[10px] text-slate-500">13 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🖥️ EXE Desktop App (Windows)</li>
                        <li>• 🔄 Auto Update สำหรับ EXE</li>
                        <li>• 🎵 Music Player ในแอป</li>
                        <li>• 🎨 Custom Title Bar</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.4.0</span>
                        <span class="text-[10px] text-slate-500">12 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🎯 Custom Cursor สำหรับ User/Server</li>
                        <li>• 💬 Group Chat สำหรับทีมแพทย์</li>
                        <li>• 💌 DM Chat Bubble แบบ Facebook</li>
                        <li>• ✅ Read Receipt (อ่านแล้ว)</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.3.8</span>
                        <span class="text-[10px] text-slate-500">13 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🔄 Version หน้า Login โหลดจาก Firebase อัตโนมัติ</li>
                        <li>• 🐛 แก้ไข Event Settings (เข้าร่วม/Restart) ไม่บันทึก</li>
                        <li>• 🐛 แก้ไข Version ลดลงเมื่อมีคนใช้โค้ดเก่า</li>
                        <li>• 🐛 แก้ไข Music Player ปุ่มไม่ทำงานตอน Login ครั้งแรก</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.3.3</span>
                        <span class="text-[10px] text-slate-500">13 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• ⏱️ เพิ่มระบบเวลาเข้าร่วม Event</li>
                        <li>• 🎮 2-Phase Countdown: "เข้าร่วม" → "กำลังเล่น"</li>
                        <li>• 🔒 บล็อกการ Assign หลังหมดเวลาเข้าร่วม</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.3.2</span>
                        <span class="text-[10px] text-slate-500">13 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🔄 ระบบ Force Refresh ใหม่ - Pop-up กลางจอ นับถอยหลัง 30 วินาที</li>
                        <li>• ⚡ Real-time Listener - ตรวจจับเวอร์ชั่นใหม่ทันที (ไม่ต้องรอ Owner)</li>
                        <li>• 🚀 ผู้ใช้คนใดก็ได้ สามารถ Trigger การอัปเดตแจ้งเตือนให้คนอื่น</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.3.1</span>
                        <span class="text-[10px] text-slate-500">13 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🚨 บังคับปิดกะ (Force End Shift) - ปิดสตอรี่ที่เริ่มแล้วอัตโนมัติ</li>
                        <li>• 🔁 Server Restart - ปิดสตอรี่ที่เริ่มแล้วอัตโนมัติก่อนจบกะ</li>
                        <li>• 📝 บันทึก Log เมื่อบังคับปิดสตอรี่</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.3.0</span>
                        <span class="text-[10px] text-slate-500">12 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🟢 แจ้งเตือน Online/Offline สำหรับ Owner เมื่อมีคน Login/Logout</li>
                        <li>• 💬 ปรับปรุง DM Chat - เพิ่มปุ่มล้างแชท, ปุ่มปิด Bubble</li>
                        <li>• 🔔 เสียงแจ้งเตือน Online/Offline นุ่มๆ ฟังสบาย</li>
                        <li>• ⚡ แก้ไข DM Auto Bubble - แจ้งเตือนเมื่อมีข้อความใหม่</li>
                        <li>• 📴 แก้ไข Offline Status - แสดงสถานะ Offline ทันทีเมื่อ Logout</li>
                        <li>• 👥 แก้ไขรายชื่อ Offline ไม่แสดง</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.2.0</span>
                        <span class="text-[10px] text-slate-500">11 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• 🖼️ กดที่รูปโปรไฟล์ OP / On Duty เพื่อดูรูปใหญ่ได้</li>
                        <li>• 💰 เปลี่ยน Tag ในสตอรี่เป็น Emoji (💰x2, 💰x5, 🚫💊)</li>
                        <li>• 📋 เพิ่ม Dropdown โทษเพิ่มเติมใน Blacklist</li>
                        <li>• 📞 รวม Input คำสั่งโทรศัพท์ให้กระชับขึ้น</li>
                        <li>• ⏱️ ย้าย Shift Timer มาข้างชื่อ OP</li>
                        <li>• 💊 รวมค่ารักษาชุบสตอรี่เข้าในการ์ดเคสสุ่มเสี่ยง</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.1.3</span>
                        <span class="text-[10px] text-slate-500">11 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• ✅ แก้ไข Confirm Modal ให้แสดงหน้าสุด</li>
                        <li>• ✅ ปุ่มออกกะ เคลียร์รายชื่อ On Duty, Off Duty, AFK</li>
                        <li>• ✅ โทษx5 อัปเดต Real-time เมื่อ Blacklist เปลี่ยน</li>
                        <li>• ✅ ปรับ Spacing การ์ดค่ารักษาพยาบาล</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.1.2</span>
                        <span class="text-[10px] text-slate-500">11 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• แก้ไข Error classList ใน switchMainTab</li>
                        <li>• ปรับ styling โทษx5 ให้เล็กลง</li>
                        <li>• เพิ่มการ์ด ชุบสตอรี่ + หมายเหตุในเคสสุ่มเสี่ยง</li>
                        <li>• เพิ่มระบบ Changelog Popup</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.1.1</span>
                        <span class="text-[10px] text-slate-500">10 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• เพิ่ม Badge โทษx5 บน Story Cards</li>
                        <li>• เพิ่มการ์ดค่ารักษา (เคสปกติ/เคสสุ่มเสี่ยง)</li>
                        <li>• เพิ่มระบบ Blacklist Menu</li>
                        <li>• เพิ่ม Badge ห้ามฉีดยา (ถึงวันสตอรี่)</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-slate-300 font-bold text-sm">v1.1.0</span>
                        <span class="text-[10px] text-slate-500">9 ธ.ค. 2567</span>
                    </div>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>• เพิ่มระบบกำหนดแพทย์สำหรับแต่ละเคส</li>
                        <li>• ปรับปรุง Shift Summary</li>
                        <li>• ปรับปรุง Real-time Updates</li>
                        <li>• เพิ่มระบบ Handover OP อัตโนมัติ</li>
                    </ul>
                </div>
            </div>
            <div class="pt-4 shrink-0">
                <button onclick="closeChangelogModal()"
                    class="w-full py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium rounded-lg transition">รับทราบ
                    👍</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal"
        class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/80 backdrop-blur-md"
        onclick="closeImagePreview()">
        <div class="relative max-w-md w-full mx-4 animate-zoom-in" onclick="event.stopPropagation()">
            <button onclick="closeImagePreview()"
                class="absolute -top-10 right-0 text-white text-2xl hover:text-rose-400 transition">✕</button>
            <img id="preview-image-src" src="" alt="Preview" class="w-full h-auto rounded-2xl shadow-2xl">
            <p id="preview-image-name" class="text-center text-white text-sm font-medium mt-3"></p>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-md w-full mx-4 animate-zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-semibold text-white">แก้ไขข้อมูลส่วนตัว</h3>
                <button onclick="closeProfileModal()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div class="flex justify-center mb-4">
                <img id="profile-preview" src="https://ui-avatars.com/api/?name=U&background=6366f1&color=fff&size=80"
                    class="w-20 h-20 rounded-full border-4 border-indigo-500/50"
                    onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=U&background=6366f1&color=fff&size=80';">
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-slate-400 mb-1.5 block font-medium">ชื่อ</label>
                        <input type="text" id="profile-firstname" class="inp-pretty">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 mb-1.5 block font-medium">นามสกุล</label>
                        <input type="text" id="profile-lastname" class="inp-pretty">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 mb-1.5 block font-medium">รูปโปรไฟล์</label>
                    <div class="flex items-center gap-3">
                        <label
                            class="flex-1 py-2.5 bg-indigo-500/20 hover:bg-indigo-500/30 border border-indigo-500/30 rounded-lg cursor-pointer transition text-center">
                            <span class="text-xs text-indigo-300">📷 เลือกรูป</span>
                            <input type="file" id="profile-avatar-file" accept="image/*" class="hidden"
                                onchange="previewProfileImage(this)">
                        </label>
                        <span id="profile-upload-status" class="text-xs text-slate-500"></span>
                    </div>
                    <input type="hidden" id="profile-avatar" value="">
                </div>
                <div>
                    <label class="text-xs text-slate-400 mb-1.5 block font-medium">เบอร์โทร IC</label>
                    <input type="text" id="profile-ic-phone" class="inp-pretty" placeholder="เบอร์โทร In-Character">
                </div>
                <div>
                    <label class="text-xs text-slate-400 mb-1.5 block font-medium">ช่วงเวลาที่สะดวก</label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="time" id="profile-shift-start" class="inp-pretty text-center">
                        <input type="time" id="profile-shift-end" class="inp-pretty text-center">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-slate-400 mb-1.5 block font-medium">สถานะการทำงาน</label>
                    <select id="profile-work-status" class="inp-pretty">
                        <option value="ทำงาน">🟢 ทำงาน</option>
                        <option value="ลางาน">🔴 ลางาน</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-400 mb-1.5 block font-medium">📊 ประวัติกะ OP (สูงสุด 3 กะ /
                        ลบภายใน 24 ชม.)</label>
                    <div id="profile-shift-history" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar">
                        <p class="text-slate-500 text-xs text-center py-2">ไม่มีประวัติกะ</p>
                    </div>
                </div>
                <div>
                    <button type="button" onclick="togglePasswordChange()"
                        class="w-full text-xs text-indigo-400 hover:text-indigo-300 border border-indigo-500/30 rounded-lg py-2 px-3 bg-indigo-500/10 hover:bg-indigo-500/20 transition">🔐
                        เปลี่ยนรหัสผ่าน</button>
                    <div id="password-change-section" class="hidden mt-2 space-y-2">
                        <input type="password" id="profile-current-password" class="inp-pretty"
                            placeholder="รหัสผ่านปัจจุบัน">
                        <input type="password" id="profile-new-password" class="inp-pretty" placeholder="รหัสผ่านใหม่">
                        <input type="password" id="profile-confirm-password" class="inp-pretty"
                            placeholder="ยืนยันรหัสผ่านใหม่">
                        <button type="button" onclick="changePassword()"
                            class="w-full py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium rounded-lg transition">เปลี่ยนรหัสผ่าน</button>
                    </div>
                </div>
                <!-- Discord Link Section -->
                <div>
                    <label class="text-xs text-slate-400 mb-1.5 block font-medium">🔗 เชื่อมต่อ Discord</label>
                    <div id="discord-link-container">
                        <!-- Not linked state -->
                        <div id="discord-not-linked" class="flex items-center gap-3">
                            <button type="button" onclick="linkDiscordOAuth()"
                                class="flex-1 text-xs text-indigo-400 hover:text-white border border-indigo-500/50 rounded-lg py-2.5 px-3 bg-indigo-500/10 hover:bg-indigo-500/30 transition flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z" />
                                </svg>
                                <span>เชื่อมต่อ Discord</span>
                            </button>
                        </div>
                        <!-- Linked state -->
                        <div id="discord-linked" class="hidden">
                            <div
                                class="flex items-center gap-3 p-2.5 rounded-lg bg-emerald-500/10 border border-emerald-500/30">
                                <img id="discord-linked-avatar" src="" alt="" class="w-8 h-8 rounded-full bg-slate-700">
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs text-emerald-400 font-medium">✅ เชื่อมต่อแล้ว</div>
                                    <div id="discord-linked-username" class="text-sm text-white truncate"></div>
                                </div>
                                <button type="button" onclick="unlinkDiscord()"
                                    class="text-xs text-rose-400 hover:text-rose-300 px-2 py-1 rounded hover:bg-rose-500/20 transition">
                                    ยกเลิก
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeProfileModal()"
                        class="flex-1 py-2.5 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-xl transition">ยกเลิก</button>
                    <button onclick="saveProfile()"
                        class="flex-1 py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium rounded-xl transition shadow-lg shadow-indigo-500/20">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Blacklist Modal -->
    <div id="blacklist-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="glass rounded-2xl p-6 max-w-md w-full mx-4 animate-zoom-in max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-base font-semibold text-rose-400 flex items-center gap-2">🚫 รายการ Blacklist</h3>
                <button onclick="closeBlacklistModal()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <!-- Search Form -->
            <div class="mb-4 shrink-0">
                <input type="text" id="blacklist-search" placeholder="🔍 ค้นหาแก๊ง/ครอบครัว/เบอร์..."
                    class="w-full text-xs rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white"
                    oninput="filterBlacklistModal()">
            </div>
            <!-- Blacklist List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2" id="blacklist-list">
                <p class="text-xs text-slate-500 text-center py-4">ไม่มีรายการ Blacklist</p>
            </div>
            <!-- Info -->
            <div class="mt-4 pt-3 border-t border-slate-700/50 text-[10px] text-slate-500 shrink-0">
                💡 แก๊งที่ตรงกับ Party A ในสตอรี่จะแสดง <span class="text-rose-400">"โทษx5"</span> หน้าชื่อ<br>
                💡 แก๊งที่ตรงกับ Party B จะแสดง <span class="text-rose-400">"โทษx5"</span> หลังชื่อ
            </div>
        </div>
    </div>

    <!-- Admin Settings Modal (Owner Only) -->
    <div id="admin-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-md w-full mx-4 animate-zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-semibold text-amber-400 flex items-center gap-2">⚙️ ตั้งค่า Server</h3>
                <button onclick="closeAdminModal()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 mb-1 block">ชื่อ Server</label>
                    <input type="text" id="admin-server-name"
                        class="w-full text-sm rounded-lg border-slate-700 bg-slate-900/50 p-3 text-white font-bold"
                        placeholder="ONE CITY">
                </div>
                <div class="text-xs text-slate-500 bg-slate-800/50 rounded-lg p-3">
                    <p class="text-amber-400 mb-1">⚠️ สำหรับ Owner เท่านั้น</p>
                    <p>ชื่อ Server จะแสดงที่ Navbar ด้านบน</p>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeAdminModal()"
                        class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ยกเลิก</button>
                    <button onclick="saveServerSettings()"
                        class="flex-1 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request OP Modal -->
    <div id="request-op-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-md w-full mx-4 animate-zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-semibold text-cyan-400 flex items-center gap-2">📋 Request เป็น OP</h3>
                <button onclick="closeRequestOPModal()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-400 mb-1 block">ต้องการเริ่มเป็น OP เมื่อไหร่?</label>
                    <input type="time" id="request-op-time"
                        class="w-full text-sm rounded-lg border-slate-700 bg-slate-900/50 p-3 text-white font-bold">
                </div>
                <div class="text-xs text-slate-500 bg-slate-800/50 rounded-lg p-3">
                    <p class="text-cyan-400 mb-1">ℹ️ ข้อมูล</p>
                    <p>OP ปัจจุบันจะได้รับแจ้งเตือน และเมื่อยืนยัน จะมีเวลาเตรียมตัว 30 นาทีก่อนเปลี่ยน OP</p>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="closeRequestOPModal()"
                        class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ยกเลิก</button>
                    <button onclick="submitOPRequest()"
                        class="flex-1 py-2 bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium rounded-lg transition">ส่ง
                        Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OP Request Approval Modal (for current OP) -->
    <div id="op-approve-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-md w-full mx-4 animate-zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-semibold text-amber-400 flex items-center gap-2">🔔 มีคนขอเป็น OP</h3>
                <button onclick="closeApproveModal()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-4">
                <div class="text-center py-4">
                    <div class="text-3xl mb-2">👤</div>
                    <div id="approve-requester-name" class="text-lg font-bold text-white">-</div>
                    <div class="text-sm text-slate-400 mt-1">ต้องการเป็น OP เวลา <span id="approve-wanted-time"
                            class="text-cyan-400">-</span></div>
                </div>
                <div class="text-xs text-slate-500 bg-amber-900/20 rounded-lg p-3 border border-amber-500/20">
                    <p class="text-amber-400 mb-1">⚠️ หากยืนยัน</p>
                    <p>คุณจะมีเวลา 30 นาทีในการเคลียงานก่อนส่งต่อให้ OP คนใหม่</p>
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="rejectOPRequest()"
                        class="flex-1 py-2 bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium rounded-lg transition">❌
                        ปฏิเสธ</button>
                    <button onclick="approveOPRequest()"
                        class="flex-1 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition">✅
                        ยืนยัน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shift Summary Modal -->
    <div id="shift-summary-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-6 max-w-lg w-full mx-4 animate-zoom-in max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-base font-semibold text-cyan-400 flex items-center gap-2">📊 สรุปกะ</h3>
                <button onclick="closeShiftSummary()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div id="shift-summary-content" class="space-y-4 text-sm">
                <!-- Generated by JS -->
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="copyShiftSummary()"
                    class="flex-1 py-2 bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium rounded-lg transition">📋
                    คัดลอกสรุปกะ</button>
                <button onclick="closeShiftSummary()"
                    class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Command Announcement Modal -->
    <div id="command-modal"
        class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="glass rounded-2xl p-6 max-w-3xl w-full mx-4 animate-zoom-in max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2">📋 รวมคำสั่งประกาศ</h3>
                <button onclick="closeCommandModal()" class="text-slate-400 hover:text-white text-xl">✕</button>
            </div>
            <p class="text-sm text-slate-400 mb-4 shrink-0">คำสั่ง /an ที่ใช้บ่อยสำหรับ OP - คลิกที่หัวข้อเพื่อขยาย</p>

            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
                <!-- Custom Command Setting Display -->
                <div
                    class="bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/30 rounded-xl p-3 mb-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-slate-300">คำสั่งประกาศ:</span>
                        <span id="cmd-prefix-display" class="text-sm font-mono text-cyan-400">/an</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1">*เปลี่ยนได้ที่ตั้งค่าเซิร์ฟเวอร์</p>
                </div>

                <!-- 1. ประกาศจากโรงพยาบาล -->
                <div class="glass-light rounded-xl overflow-hidden">
                    <button onclick="toggleCmdSection('hospital')"
                        class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition">
                        <span class="text-sm font-bold text-emerald-400 flex items-center gap-2">🏥
                            ประกาศจากโรงพยาบาล <span id="cmd-server-name"
                                class="text-slate-400 font-normal text-xs"></span></span>
                        <span id="cmd-toggle-hospital" class="text-slate-400">▼</span>
                    </button>
                    <div id="cmd-section-hospital" class="hidden px-4 pb-4 space-y-4">
                        <!-- หัวข้อย่อย: เปิด/ปิด โรงพยาบาล -->
                        <div>
                            <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                                ประกาศเปิด / ปิดโรงพยาบาล
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="copyCmd('hospital-open')"
                                        class="py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-medium rounded-lg transition">🟢
                                        เปิดทำการ</button>
                                    <button onclick="copyCmd('hospital-close')"
                                        class="py-2 bg-rose-600 hover:bg-rose-500 text-white text-xs font-medium rounded-lg transition">🔴
                                        ปิดทำการ</button>
                                </div>
                                <div class="text-[10px] text-slate-500 pt-1">⏰ ปิดในอีก... (แจ้งเตือนล่วงหน้า)</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <button onclick="copyCmd('hospital-close-5')"
                                        class="py-1.5 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded-lg transition">5
                                        นาที</button>
                                    <button onclick="copyCmd('hospital-close-10')"
                                        class="py-1.5 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded-lg transition">10
                                        นาที</button>
                                    <button onclick="copyCmd('hospital-close-15')"
                                        class="py-1.5 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded-lg transition">15
                                        นาที</button>
                                </div>
                            </div>
                        </div>

                        <!-- หัวข้อย่อย: การแต่งกายพิเศษ -->
                        <div>
                            <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-pink-400"></span>
                                ประกาศการแต่งกายพิเศษ
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 space-y-3">
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">👕 Freeday (ศุกร์-เสาร์-อาทิตย์)</div>
                                    <button onclick="copyCmd('dress-freeday')"
                                        class="w-full py-2 bg-pink-600 hover:bg-pink-500 text-white text-xs font-medium rounded-lg transition">📋
                                        Copy ประกาศ Freeday</button>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">🎉 Event (กิจกรรมพิเศษ)</div>
                                    <input type="text" id="cmd-event-msg" placeholder="พิมพ์รายละเอียดกิจกรรม..."
                                        class="inp-pretty text-xs mb-2">
                                    <button onclick="copyCmd('dress-event')"
                                        class="w-full py-2 bg-pink-600 hover:bg-pink-500 text-white text-xs font-medium rounded-lg transition">📋
                                        Copy ประกาศ Event</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ประกาศเกี่ยวกับการทำงาน -->
                <div class="glass-light rounded-xl overflow-hidden">
                    <button onclick="toggleCmdSection('work')"
                        class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition">
                        <span class="text-sm font-bold text-amber-400 flex items-center gap-2">⚠️
                            ประกาศเกี่ยวกับการทำงาน</span>
                        <span id="cmd-toggle-work" class="text-slate-400">▼</span>
                    </button>
                    <div id="cmd-section-work" class="hidden px-4 pb-4 space-y-4">
                        <!-- หัวข้อย่อย: Safezone -->
                        <div>
                            <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                                ประกาศเพิ่มเติมเกี่ยวกับเขต Safezone
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 space-y-2">
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">🚨 แก๊งที่มีสตอรี่</div>
                                    <button onclick="copyCmd('safezone-story')"
                                        class="w-full py-2 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded-lg transition">📋
                                        Copy ประกาศ</button>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">🏥 แก๊ง/ครอบครัว ใช้งานเสร็จแล้ว</div>
                                    <button onclick="copyCmd('safezone-done')"
                                        class="w-full py-2 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded-lg transition">📋
                                        Copy ประกาศ</button>
                                </div>
                            </div>
                        </div>

                        <!-- หัวข้อย่อย: เข้าพื้นที่ -->
                        <div>
                            <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-rose-400"></span>
                                ประกาศการเข้าพื้นที่ (เพิ่มเติม)
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 space-y-2">
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">💀 พื้นที่เรเบล</div>
                                    <button onclick="copyCmd('enter-rebel')"
                                        class="w-full py-2 bg-rose-600 hover:bg-rose-500 text-white text-xs font-medium rounded-lg transition">📋
                                        Copy ประกาศเข้าเรเบล</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. ประกาศเกี่ยวกับการ Blacklist / บทลงโทษ -->
                <div class="glass-light rounded-xl overflow-hidden">
                    <button onclick="toggleCmdSection('blacklist')"
                        class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition">
                        <span class="text-sm font-bold text-rose-400 flex items-center gap-2">🚫
                            ประกาศ Blacklist / บทลงโทษ</span>
                        <span id="cmd-toggle-blacklist" class="text-slate-400">▼</span>
                    </button>
                    <div id="cmd-section-blacklist" class="hidden px-4 pb-4 space-y-4">
                        <!-- หัวข้อย่อย: ประกาศ Blacklist -->
                        <div>
                            <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-rose-400"></span>
                                ประกาศ Blacklist
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 space-y-3">
                                <!-- ประเภท -->
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">ประเภท</div>
                                    <select id="cmd-bl-type" class="inp-pretty text-xs w-full"
                                        onchange="updateBlTypeLabel()">
                                        <option value="patient">คนไข้ทั่วไป</option>
                                        <option value="citizen">ประชาชน</option>
                                        <option value="gang">แก๊ง</option>
                                        <option value="family">ครอบครัว</option>
                                    </select>
                                </div>
                                <!-- ชื่อ/เบอร์ -->
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1" id="cmd-bl-name-label">เบอร์ หรือ ชื่อ
                                        ที่ต้องการ Blacklist</div>
                                    <input type="text" id="cmd-bl-name" placeholder="กรอกเบอร์/ชื่อ..."
                                        class="inp-pretty text-xs">
                                </div>
                                <!-- สาเหตุ -->
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">สาเหตุ</div>
                                    <select id="cmd-bl-reason" class="inp-pretty text-xs w-full">
                                        <option value="ทำร้ายร่างกายในพื้นที่ Safe Zone">ทำร้ายร่างกายในพื้นที่ Safe
                                            Zone</option>
                                        <option value="ควักอาวุธในเขตพื้นที่โรงพยาบาล">ควักอาวุธในเขตพื้นที่โรงพยาบาล
                                        </option>
                                        <option value="ขโมยยานพาหนะในเขตพื้นที่โรงพยาบาล">
                                            ขโมยยานพาหนะในเขตพื้นที่โรงพยาบาล</option>
                                        <option value="สวมอุปกรณ์ปกปิดใบหน้าในเขตพื้นที่โรงพยาบาล">
                                            สวมอุปกรณ์ปกปิดใบหน้าในเขตพื้นที่โรงพยาบาล</option>
                                        <option value="ขัดขวางการทำงานของแพทย์">ขัดขวางการทำงานของแพทย์</option>
                                        <option value="ทำร้ายแพทย์ขณะอยู่ในเครื่องแบบ หรือ กำลังปฏิบัติหน้าที่">
                                            ทำร้ายแพทย์ขณะอยู่ในเครื่องแบบ หรือ กำลังปฏิบัติหน้าที่</option>
                                        <option value="ขโมยยานพาหนะของหน่วยงาน">ขโมยยานพาหนะของหน่วยงาน</option>
                                        <option value="ทำการเคลื่อนย้ายศพ ไปจากจุดที่มีการกดเรียกเคส">ทำการเคลื่อนย้ายศพ
                                            ไปจากจุดที่มีการกดเรียกเคส</option>
                                        <option value="ฝ่าฝืนคำสั่งเชิญออกจากพื้นที่โรงพยาบาล">
                                            ฝ่าฝืนคำสั่งเชิญออกจากพื้นที่โรงพยาบาล</option>
                                        <option value="กระทำความผิดจริงตามหลักฐาน">กระทำความผิดจริงตามหลักฐาน</option>
                                        <option value="ทำร้ายร่างกายแพทย์ในพื้นที่เรเบล">
                                            ทำร้ายร่างกายแพทย์ในพื้นที่เรเบล</option>
                                    </select>
                                </div>
                                <!-- ค่าปรับ -->
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">ค่าปรับ (One-Dollars)</div>
                                    <input type="number" id="cmd-bl-fine" placeholder="จำนวนเงิน..."
                                        class="inp-pretty text-xs" min="0">
                                </div>
                                <!-- โทษเพิ่มเติม -->
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">โทษเพิ่มเติม</div>
                                    <select id="cmd-bl-penalty" class="inp-pretty text-xs w-full">
                                        <option value="">ไม่มีโทษเพิ่มเติม</option>
                                        <option value="x2">โทษค่ารักษา x2</option>
                                        <option value="x5">โทษค่ารักษา x5</option>
                                        <option value="no-treat">ไม่ทำการรักษา</option>
                                    </select>
                                </div>
                                <button onclick="copyBlacklistAnnounce()"
                                    class="w-full py-2 bg-rose-600 hover:bg-rose-500 text-white text-xs font-medium rounded-lg transition">📋
                                    Copy ประกาศ + บันทึก Blacklist</button>
                            </div>
                        </div>

                        <!-- หัวข้อย่อย: ประกาศปลด Blacklist -->
                        <div>
                            <div class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                                ประกาศปลด Blacklist
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50 space-y-3">
                                <!-- เลือกจากรายการ -->
                                <div>
                                    <div class="text-[10px] text-slate-400 mb-1">เลือกรายการ Blacklist ที่จะปลด</div>
                                    <select id="cmd-unbl-select" class="inp-pretty text-xs w-full">
                                        <option value="">-- เลือกรายการ --</option>
                                    </select>
                                </div>
                                <button onclick="copyUnblacklistAnnounce()"
                                    class="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-medium rounded-lg transition">📋
                                    Copy ประกาศปลด + ลบ Blacklist</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. ประกาศอื่นๆ (Custom) -->
                <div class="glass-light rounded-xl overflow-hidden">
                    <button onclick="toggleCmdSection('other')"
                        class="w-full px-4 py-3 flex justify-between items-center hover:bg-white/5 transition">
                        <span class="text-sm font-bold text-purple-400 flex items-center gap-2">📝 ประกาศอื่นๆ
                            (Custom)</span>
                        <span id="cmd-toggle-other" class="text-slate-400">▼</span>
                    </button>
                    <div id="cmd-section-other" class="hidden px-4 pb-4 space-y-3">
                        <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700/50">
                            <div class="text-xs text-slate-300 mb-2">📝 ประกาศทั่วไป (พิมพ์เอง)</div>
                            <textarea id="cmd-other-msg" placeholder="พิมพ์ข้อความประกาศ..."
                                class="inp-pretty text-xs mb-2 h-20 resize-none"></textarea>
                            <button onclick="copyCmd('other')"
                                class="w-full py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-medium rounded-lg transition">📋
                                Copy คำสั่ง</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-white/10 mt-4 shrink-0">
                <button onclick="closeCommandModal()"
                    class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Music Settings Modal -->
    <div id="music-settings-modal"
        class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-5 max-w-md w-full mx-4 animate-zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-pink-400 flex items-center gap-2">🎵 ค้นหาเพลง</h3>
                <button onclick="closeMusicSettingsModal()" class="text-slate-400 hover:text-white text-xl">✕</button>
            </div>
            <div class="space-y-4">
                <!-- Search Input -->
                <div class="flex gap-2">
                    <input type="text" id="music-search-input" placeholder="ค้นหาเพลง..."
                        class="flex-1 inp-pretty text-xs" onkeypress="if(event.key==='Enter') searchMusic()">
                    <button onclick="searchMusic()"
                        class="px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white text-xs font-medium rounded-lg transition">🔍</button>
                </div>
                <!-- Search Results -->
                <div id="music-search-results" class="max-h-48 overflow-y-auto custom-scrollbar space-y-2">
                    <div class="text-center text-slate-500 text-xs py-4">พิมพ์ชื่อเพลงแล้วกด 🔍</div>
                </div>
                <!-- Currently Selected -->
                <div id="music-selected-song"
                    class="hidden text-xs text-pink-300 bg-pink-900/30 rounded-lg p-2 border border-pink-400/20">
                    <span class="text-slate-400">🎵 เลือก:</span> <span id="music-selected-title">-</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="confirmMusicSelection()"
                        class="py-2 bg-pink-600 hover:bg-pink-500 text-white text-xs font-medium rounded-lg transition">▶️
                        เล่นเพลง</button>
                    <button onclick="addToPlaylist()"
                        class="py-2 bg-purple-600 hover:bg-purple-500 text-white text-xs font-medium rounded-lg transition">➕
                        เพิ่ม Playlist</button>
                </div>

                <!-- Playlist Section -->
                <div class="mt-4 pt-4 border-t border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold text-pink-400">📜 Playlist ของฉัน</span>
                        <div class="flex gap-1">
                            <button id="playlist-mode-btn" onclick="cyclePlaylistMode()"
                                class="px-2 py-1 bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-medium rounded transition"
                                title="โหมดเล่น">🔁 Auto</button>
                            <button onclick="resetToLoFi()"
                                class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-medium rounded transition">🔄
                                Lo-Fi</button>
                        </div>
                    </div>
                    <div id="music-playlist" class="max-h-32 overflow-y-auto custom-scrollbar space-y-1">
                        <div class="text-center text-slate-500 text-[10px] py-2">ยังไม่มีเพลงใน Playlist</div>
                    </div>
                </div>
            </div>
            <!-- Hidden YouTube Player Container (for API volume control) -->
            <div id="music-youtube-player" class="hidden" style="width:1px;height:1px;overflow:hidden;"></div>
        </div>
    </div>

    <!-- Event Settings Modal (Owner only) -->
    <div id="event-settings-modal"
        class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-5 max-w-lg w-full mx-4 animate-zoom-in max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold text-cyan-400 flex items-center gap-2">🎯 ตั้งค่า Event</h3>
                <button onclick="closeEventSettingsModal()" class="text-slate-400 hover:text-white text-xl">✕</button>
            </div>
            <!-- Server Restart Times Section -->
            <div class="bg-rose-900/30 rounded-xl p-3 border border-rose-500/30 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">🔁</span>
                    <span class="font-bold text-rose-300 text-sm">เวลา Restart Server</span>
                    <span class="text-[9px] text-rose-400">(จบกะอัตโนมัติ 30 นาทีก่อน)</span>
                </div>
                <div id="restart-times-list" class="flex flex-wrap gap-1 mb-2">
                    <!-- Times will be rendered here -->
                </div>
                <div class="flex gap-2">
                    <input type="time" id="new-restart-time" class="inp-pretty text-xs flex-1">
                    <button onclick="addRestartTime()"
                        class="px-3 py-1 bg-rose-600 hover:bg-rose-500 text-white text-xs rounded transition">
                        + เพิ่ม
                    </button>
                </div>
            </div>
            <div class="text-xs font-bold text-cyan-400 uppercase tracking-wider mb-2">🎯 ตั้งค่า Event Times</div>
            <div id="event-settings-list" class="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                <!-- Events will be rendered here -->
            </div>
            <div class="pt-4 border-t border-white/10 mt-4 shrink-0 flex gap-2">
                <button onclick="saveEventSettings()"
                    class="flex-1 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg transition">💾
                    บันทึก</button>
                <button onclick="closeEventSettingsModal()"
                    class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Reschedule Story Modal -->
    <div id="reschedule-modal"
        class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="glass rounded-2xl p-5 max-w-xs w-full mx-4 animate-zoom-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-amber-400 flex items-center gap-2">📅 เลื่อนสตอรี่</h3>
                <button onclick="closeRescheduleModal()" class="text-slate-400 hover:text-white text-xl">✕</button>
            </div>
            <div class="space-y-4">
                <div id="reschedule-story-info" class="text-xs text-slate-300 bg-slate-800/50 rounded-lg p-2"></div>
                <div>
                    <label class="text-xs text-slate-300 mb-1 block">📅 วันที่ใหม่</label>
                    <input type="date" id="reschedule-date" class="inp-pretty text-xs w-full">
                </div>
                <div>
                    <label class="text-xs text-slate-300 mb-1 block">🕐 เวลาใหม่</label>
                    <input type="time" id="reschedule-time" class="inp-pretty text-xs w-full">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="closeRescheduleModal()"
                        class="py-2 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium rounded-lg transition">❌
                        ยกเลิก</button>
                    <button onclick="confirmReschedule()"
                        class="py-2 bg-amber-600 hover:bg-amber-500 text-white text-xs font-medium rounded-lg transition">✅
                        ยืนยัน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- How To Modal -->
    <div id="how-to-modal"
        class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="glass rounded-2xl p-6 max-w-2xl w-full mx-4 animate-zoom-in max-h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-lg font-bold text-amber-400 flex items-center gap-2">📚 How To - คู่มือการใช้งาน
                </h3>
                <button onclick="closeHowToModal()" class="text-slate-400 hover:text-white text-xl">✕</button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-2">
                <!-- OP Control -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-cyan-400 mb-2 flex items-center gap-2">🎯 การจัดการ OP & กะ</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• <span class="text-white font-medium">เข้ากะ</span> - กดเพื่อตั้งตัวเองเป็น OP</li>
                        <li>• <span class="text-white font-medium">Sup OP</span> - เลือกผู้ช่วย OP มีสิทธิ์เหมือน OP
                        </li>
                        <li>• <span class="text-white font-medium">▶ เริ่มกะ / ⏹️ จบกะ</span> - เริ่มนับเวลา
                            และแสดงสรุปกะเมื่อจบ</li>
                        <li>• <span class="text-white font-medium">⏰ Handover</span> - ระบบส่งต่อเวร OP อัตโนมัติ</li>
                        <li>• <span class="text-rose-300">🚫 บังคับปิดกะ</span> - ใช้เฉพาะกรณีฉุกเฉิน
                            (ปิดสตอรี่อัตโนมัติ)</li>
                    </ul>
                </div>

                <!-- On Duty & AFK -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-emerald-400 mb-2 flex items-center gap-2">✅ On Duty / AFK / Off
                        Duty</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• <span class="text-white font-medium">Add Name...</span> - พิมพ์ชื่อเพื่อเพิ่มแพทย์ (มี
                            Autocomplete!</li>
                        <li>• <span class="text-cyan-300">✓ รับเคส</span> / <span class="text-amber-300">⏳
                                รอเคสแก้</span> / <span class="text-rose-300">❌ ไม่รับ</span> - สถานะพร้อมรับงาน</li>
                        <li>• <span class="text-yellow-300">💤 AFK</span> - ย้ายไป AFK พร้อมนับเวลา (Warning 5+ นาที)
                        </li>
                        <li>• <span class="text-emerald-300">🔄 คืนตำแหน่ง</span> - กลับจาก AFK จะอยู่ตำแหน่งเดิม</li>
                    </ul>
                </div>

                <!-- Story Management -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-blue-400 mb-2 flex items-center gap-2">⚡ สร้าง & จัดการสตอรี่</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• กรอก <span class="text-white">วันที่, เวลา, Party A vs B</span> แล้วกด <span
                                class="text-emerald-400">+ สร้าง</span></li>
                        <li>• <span class="text-white font-medium">👨‍⚕️ กำหนดแพทย์</span> - เลือกแพทย์ 1-3 คน
                            (ย้ายออกจาก On Duty อัตโนมัติ)</li>
                        <li>• <span class="text-amber-300">⏳ รอเริ่ม</span> เมื่อยังไม่ถึงเวลา / <span
                                class="text-cyan-300">🎮 กำลังเล่น</span> เมื่อเริ่มแล้ว <span
                                class="text-[10px] bg-cyan-500/30 text-cyan-300 px-1 rounded">ใหม่!</span></li>
                        <li>• <span class="text-rose-300">🚫 ห้ามฉีดยา</span> เมื่อถึงวันแล้ว / <span
                                class="text-rose-300">💰x5</span> - แก๊ง Blacklist</li>
                        <li>• <span class="text-emerald-300">✅ จบกะได้เลย</span> ถ้ายังมีสตอรี่ไม่จบ
                            ระบบจะเก็บต่อให้กะหน้า <span
                                class="text-[10px] bg-cyan-500/30 text-cyan-300 px-1 rounded">ใหม่!</span></li>
                        <li>• สตอรี่ที่จบหมดทั้งหมดจะถูกลบอัตโนมัติเมื่อจบกะ</li>
                    </ul>
                </div>

                <!-- Medical Fees & Blacklist -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-emerald-400 mb-2 flex items-center gap-2">💊 ค่ารักษา & 🚫
                        Blacklist</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• <span class="text-white font-medium">ค่ารักษา</span> - ชุบ/ฉีด แยกตามเขต (ในเมือง,
                            ทะเลทราย, เมืองบน, เข้าถึงยาก)</li>
                        <li>• <span class="text-white font-medium">เคสสุ่มเสี่ยง/สตอรี่</span> -
                            ราคาชุบสำหรับพื้นที่พิเศษ</li>
                        <li>• <span class="text-white font-medium">Blacklist</span> - เพิ่ม/ลบแก๊ง → แสดง 💰x5 บน Story
                            Card อัตโนมัติ</li>
                        <li>• ข้อมูลอัปเดต Real-time ให้ทุกคนเห็นทันที</li>
                    </ul>
                </div>

                <!-- Chat & Communication -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-purple-400 mb-2 flex items-center gap-2">💬 ระบบแชท & สื่อสาร</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• <span class="text-white font-medium">Group Chat</span> - แชทรวมสำหรับทีมแพทย์ (กดปุ่ม 💬
                            ด้านล่างขวา)</li>
                        <li>• <span class="text-white font-medium">DM Chat</span> - แชทส่วนตัวแบบ Bubble
                            กดที่รายชื่อออนไลน์</li>
                        <li>• <span class="text-cyan-300">🔗 ลิงค์คลิกได้</span> - URL
                            ในแชทจะกลายเป็นลิงค์คลิกได้อัตโนมัติ ใหม่!</li>
                        <li>• <span class="text-emerald-300">✓ อ่านแล้ว</span> - แสดงเมื่อคู่สนทนาอ่านข้อความแล้ว</li>
                        <li>• <span class="text-slate-300">🗑️ ล้างแชท</span> - ล้างประวัติแชทส่วนตัว</li>
                    </ul>
                </div>

                <!-- Discord Integration -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-indigo-400 mb-2 flex items-center gap-2">🔗 Discord Integration
                        ใหม่!</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• <span class="text-white font-medium">เชื่อมต่อ Discord</span> - กดที่โปรไฟล์ → "🔗
                            เชื่อมต่อ Discord"</li>
                        <li>• <span class="text-cyan-300">📌 Discord Mention</span> - เมื่อถูก Assign เป็น OP จะ Tag ใน
                            Discord อัตโนมัติ</li>
                        <li>• <span class="text-cyan-300">📌 Story Mention</span> - เมื่อถูกกำหนดแพทย์ในสตอรี่จะ Tag ใน
                            Discord</li>
                        <li>• ดู Discord ID ที่เชื่อมต่อได้ในหน้าโปรไฟล์</li>
                    </ul>
                </div>

                <!-- Commands -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-teal-400 mb-2 flex items-center gap-2">📋 รวมคำสั่งประกาศ</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• กดปุ่ม <span class="text-white font-medium">📋 รวมคำสั่ง</span> ที่แถบเมนู</li>
                        <li>• <span class="text-cyan-300">🏥 ประกาศโรงพยาบาล</span> / <span class="text-purple-300">🚪
                                เชิญออกพื้นที่</span> / <span class="text-blue-300">📞 ตามตัว</span></li>
                        <li>• <span class="text-rose-300">🚫 Blacklist</span> / <span class="text-red-300">🚨
                                ฉุกเฉิน</span> / <span class="text-purple-300">📝 อื่นๆ</span></li>
                        <li>• คลิกหัวข้อเพื่อขยาย/ยุบ → คัดลอกคำสั่งได้ทันที</li>
                    </ul>
                </div>

                <!-- Personalization -->
                <div class="bg-slate-800/50 rounded-xl p-4">
                    <h4 class="text-sm font-bold text-pink-400 mb-2 flex items-center gap-2">🎨 ปรับแต่งส่วนตัว</h4>
                    <ul class="text-xs text-slate-300 space-y-1.5">
                        <li>• <span class="text-white font-medium">รูปโปรไฟล์</span> - อัปโหลดรูปที่โปรไฟล์
                            กดรูปเพื่อดูขนาดใหญ่</li>
                        <li>• <span class="text-white font-medium">🎵 Music Player</span> - เล่นเพลง Lo-Fi หรือใส่
                            YouTube URL</li>
                        <li>• <span class="text-white font-medium">⚙️ Theme</span> - Owner ปรับ Theme สีและ Logo ได้
                        </li>
                    </ul>
                </div>

                <!-- Tips - OP Benefits -->
                <div
                    class="bg-gradient-to-r from-amber-900/40 to-transparent rounded-xl p-4 border-l-4 border-amber-500">
                    <h4 class="text-sm font-bold text-amber-300 mb-3 flex items-center gap-2">🌟 ทำไมต้องใช้ระบบนี้?
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <div class="text-[10px] font-bold text-amber-400 uppercase">📡 Real-time</div>
                            <ul class="text-[10px] text-amber-200/80 space-y-0.5">
                                <li>• ข้อมูลอัพเดททันที ไม่ต้อง Refresh</li>
                                <li>• ทุกคนเห็นข้อมูลเดียวกันพร้อมกัน</li>
                            </ul>
                        </div>
                        <div class="space-y-1">
                            <div class="text-[10px] font-bold text-amber-400 uppercase">💬 สื่อสาร</div>
                            <ul class="text-[10px] text-amber-200/80 space-y-0.5">
                                <li>• Group Chat / DM แบบ Bubble</li>
                                <li>• Discord Mention อัตโนมัติ</li>
                            </ul>
                        </div>
                        <div class="space-y-1">
                            <div class="text-[10px] font-bold text-amber-400 uppercase">📊 บริหารจัดการ</div>
                            <ul class="text-[10px] text-amber-200/80 space-y-0.5">
                                <li>• สรุปกะอัตโนมัติ / Handover</li>
                                <li>• Request OP ล่วงหน้า</li>
                            </ul>
                        </div>
                        <div class="space-y-1">
                            <div class="text-[10px] font-bold text-amber-400 uppercase">🎯 สะดวก</div>
                            <ul class="text-[10px] text-amber-200/80 space-y-0.5">
                                <li>• คำสั่งสำเร็จรูป / เบอร์ IC</li>
                                <li>• EXE App สำหรับ Windows</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pt-4 shrink-0">
                <button onclick="closeHowToModal()"
                    class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium rounded-lg transition">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Staff Admin Modal -->
    <div id="staff-admin-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div
            class="glass rounded-2xl p-6 max-w-2xl w-full mx-4 animate-zoom-in max-h-[80vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-base font-semibold text-purple-400 flex items-center gap-2">🛠️ แอดมินแผง</h3>
                <button onclick="closeStaffAdminModal()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-4 shrink-0">
                <button onclick="switchAdminTab('users')" id="admin-tab-users"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium bg-purple-600 text-white">👥 จัดการยศ</button>
                <button onclick="switchAdminTab('logs')" id="admin-tab-logs"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">📋
                    Log ระบบ</button>
                <button onclick="switchAdminTab('notifications')" id="admin-tab-notifications"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">🔔
                    แจ้งเตือน</button>
                <button onclick="switchAdminTab('settings')" id="admin-tab-settings"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600"
                    data-owner-tab>⚙️
                    ตั้งค่า Server</button>
                <button onclick="switchAdminTab('actions')" id="admin-tab-actions"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600">⚡
                    การกระทำ</button>
                <button onclick="switchAdminTab('announcements')" id="admin-tab-announcements"
                    class="px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600"
                    data-owner-tab>📢
                    ข่าวสาร</button>
            </div>
            <!-- User Management Tab -->
            <div id="admin-tab-content-users" class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="text-xs text-slate-400 mb-2">เปลี่ยนยศผู้ใช้ (Admin จัดการได้แค่ Staff/Member)</div>
                <div id="admin-user-list" class="space-y-2">
                    <!-- Dynamic user list -->
                </div>
            </div>
            <!-- Logs Tab -->
            <div id="admin-tab-content-logs" class="hidden flex-1 overflow-y-auto custom-scrollbar">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs text-slate-400">Log ระบบ OP (ล้างอัตโนมัติทุก 3 วัน)</div>
                    <button onclick="clearAllLogs()"
                        class="text-[10px] px-2 py-1 bg-rose-600 hover:bg-rose-700 text-white rounded"
                        data-owner-only>🗑️ ล้างทั้งหมด</button>
                </div>
                <div id="admin-logs-list" class="space-y-1 text-xs">
                    <!-- Dynamic logs -->
                </div>
            </div>
            <!-- Actions Tab -->
            <div id="admin-tab-content-actions" class="hidden flex-1">
                <div class="space-y-4">
                    <div class="glass-light rounded-xl p-4">
                        <h4 class="text-sm font-bold text-rose-400 mb-2">⚠️ บังคับปิดกะ OP</h4>
                        <p class="text-xs text-slate-400 mb-3">ปิดกะทันทีโดยไม่ต้องรอ OP ปัจจุบัน
                            (ใช้เฉพาะกรณีฉุกเฉิน)
                        </p>
                        <button onclick="forceEndShift()"
                            class="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white text-sm font-medium rounded-lg transition">🚨
                            บังคับปิดกะ</button>
                    </div>
                </div>
            </div>
            <!-- Notifications Tab (Admin+) -->
            <div id="admin-tab-content-notifications" class="hidden flex-1 overflow-y-auto custom-scrollbar">
                <div class="text-xs text-slate-400 mb-2">แจ้งเตือนทั้งหมด (เห็นได้เฉพาะ Admin+)</div>
                <div id="admin-all-notifications" class="space-y-1 text-xs">
                    <!-- Dynamic notifications -->
                </div>
            </div>
            <!-- Server Settings Tab (Owner) -->
            <div id="admin-tab-content-settings" class="hidden flex-1 overflow-y-auto custom-scrollbar">
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">ชื่อ Server</label>
                        <input type="text" id="staff-admin-server-name"
                            class="w-full text-sm rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white"
                            placeholder="ONE CITY">
                    </div>
                    <!-- Icon Logo Upload Gallery -->
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">🖼️ Logo Icon (ใช้ใน OP Panel &amp;
                            Navbar)</label>
                        <div class="flex items-center gap-2 mb-2">
                            <label
                                class="px-3 py-2 bg-cyan-600/30 hover:bg-cyan-600/50 border border-cyan-500/30 rounded-lg cursor-pointer transition text-center">
                                <span class="text-xs text-cyan-300">📷 Upload รูปใหม่</span>
                                <input type="file" accept="image/*" class="hidden"
                                    onchange="uploadServerLogo('icon', this)">
                            </label>
                            <span id="icon-logo-upload-status" class="text-xs text-slate-500"></span>
                        </div>
                        <div id="icon-logo-gallery"
                            class="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Gallery items will be rendered by JS -->
                        </div>
                        <input type="hidden" id="staff-admin-icon-logo" value="">
                    </div>
                    <!-- Login Logo Upload Gallery -->
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">🏞️ Logo หน้า Login (ใหญ่)</label>
                        <div class="flex items-center gap-2 mb-2">
                            <label
                                class="px-3 py-2 bg-purple-600/30 hover:bg-purple-600/50 border border-purple-500/30 rounded-lg cursor-pointer transition text-center">
                                <span class="text-xs text-purple-300">📷 Upload รูปใหม่</span>
                                <input type="file" accept="image/*" class="hidden"
                                    onchange="uploadServerLogo('login', this)">
                            </label>
                            <span id="login-logo-upload-status" class="text-xs text-slate-500"></span>
                        </div>
                        <div id="login-logo-gallery"
                            class="grid grid-cols-4 gap-2 max-h-32 overflow-y-auto custom-scrollbar">
                            <!-- Gallery items will be rendered by JS -->
                        </div>
                        <input type="hidden" id="staff-admin-login-logo" value="">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">🎨 สีธีม (Accent Color)</label>
                        <div class="flex gap-2 items-center">
                            <input type="color" id="staff-admin-theme-color"
                                class="w-12 h-10 rounded-lg cursor-pointer bg-slate-900 border-slate-700"
                                value="#06b6d4">
                            <span class="text-xs text-slate-500">ใช้เปลี่ยนสีหลักของเว็บ</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">⏱️ นาทีนับถอยหลังก่อน Handover</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="staff-admin-countdown-minutes"
                                class="w-24 text-sm rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white text-center"
                                placeholder="30" min="1" max="60" value="30">
                            <span class="text-xs text-slate-500">นาที (ค่าเริ่มต้น: 30)</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">📢 คำสั่งประกาศ (Announce Command)</label>
                        <div class="flex gap-2 items-center">
                            <input type="text" id="staff-admin-announce-cmd"
                                class="w-32 text-sm rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white text-center font-mono"
                                placeholder="/an" value="/an">
                            <span class="text-xs text-slate-500">ค่าเริ่มต้น: /an</span>
                        </div>
                    </div>
                    <button onclick="saveStaffAdminSettings()"
                        class="w-full py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition">💾
                        บันทึกการตั้งค่า</button>
                </div>
            </div>
            <!-- Announcements Tab (Owner) -->
            <div id="admin-tab-content-announcements" class="hidden flex-1 overflow-y-auto custom-scrollbar">
                <div class="space-y-4">
                    <!-- Add New Announcement -->
                    <div class="glass-light rounded-xl p-4">
                        <h4 class="text-sm font-bold text-cyan-400 mb-3">➕ เพิ่มข่าวสารใหม่</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-slate-400 mb-1 block">หัวข้อ</label>
                                    <input type="text" id="announce-title"
                                        class="w-full text-sm rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white"
                                        placeholder="หัวข้อข่าว">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400 mb-1 block">ประเภท</label>
                                    <select id="announce-type"
                                        class="w-full text-sm rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white">
                                        <option value="news">📰 ข่าวสาร</option>
                                        <option value="update">🆕 อัพเดท</option>
                                        <option value="event">🎉 กิจกรรม</option>
                                        <option value="maintenance">🔧 ปิดซ่อมบำรุง</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 mb-1 block">เนื้อหา</label>
                                <textarea id="announce-content"
                                    class="w-full text-sm rounded-lg border-slate-700 bg-slate-900/50 p-2.5 text-white h-20 resize-none"
                                    placeholder="รายละเอียดข่าวสาร..."></textarea>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
                                    <input type="checkbox" id="announce-pinned" class="w-4 h-4 rounded accent-rose-500">
                                    📌 ปักหมุดข่าวนี้
                                </label>
                                <button onclick="addAnnouncement()"
                                    class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium rounded-lg transition">
                                    📢 เผยแพร่ข่าว
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Existing Announcements -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-bold text-slate-300">📜 ข่าวสารที่มีอยู่</h4>
                            <button onclick="loadAdminAnnouncements()"
                                class="text-xs text-slate-500 hover:text-cyan-400">🔄 รีเฟรช</button>
                        </div>
                        <div id="admin-announcements-list" class="space-y-2">
                            <p class="text-slate-500 text-xs text-center py-4">กำลังโหลด...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Popup Modal -->
    <div id="image-popup-modal" class="fixed inset-0 z-[500] hidden flex items-center justify-center bg-black/90"
        onclick="closeImagePopup(event)">
        <div class="absolute top-4 right-4 flex gap-3">
            <a id="image-popup-download" href="" download
                class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg flex items-center gap-2 transition shadow-lg">
                <span>📥</span> ดาวน์โหลด
            </a>
            <button onclick="closeImagePopup()"
                class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition">✕ ปิด</button>
        </div>
        <img id="image-popup-img" src="" class="max-w-[90vw] max-h-[85vh] object-contain rounded-lg shadow-2xl"
            onclick="event.stopPropagation()">
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Login Logo (Animated) - Top Center -->
        <div class="text-center mb-6">
            <img id="login-logo" src="" alt="Logo" class="w-48 h-48 mx-auto object-contain animate-pulse hidden">
        </div>

        <!-- Login + Side Cards Row -->
        <div class="flex flex-col lg:flex-row gap-6 items-start justify-center">
            <!-- Login Form Card -->
            <div class="w-full lg:w-[380px] flex-shrink-0">
                <div class="glass rounded-2xl w-full overflow-hidden animate-zoom-in">
                    <div class="px-5 py-3 border-b border-white/10 flex justify-between items-center">
                        <span class="text-sm text-slate-300 flex items-center gap-2"><span
                                class="w-2 h-2 rounded-full bg-cyan-500"></span> Operator Systems Login</span>
                        <span id="login-version-display" class="text-xs text-slate-500 font-mono">v.1.6.1</span>
                    </div>
                    <div class="flex border-b border-white/10">
                        <button onclick="showAuthTab('login')" id="tab-login"
                            class="flex-1 py-2.5 text-center text-sm font-medium text-indigo-400 border-b-2 border-indigo-400">เข้าสู่ระบบ</button>
                        <button onclick="showAuthTab('register')" id="tab-register"
                            class="flex-1 py-2.5 text-center text-sm font-medium text-slate-500 border-b-2 border-transparent hover:text-slate-300">สมัครสมาชิก</button>
                    </div>
                    <div id="login-form" class="p-5 space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 mb-1.5 block font-medium">Username</label>
                            <input type="text" id="login-username" class="inp-pretty" placeholder="ชื่อผู้ใช้">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 mb-1.5 block font-medium">Password</label>
                            <input type="password" id="login-password" class="inp-pretty" placeholder="รหัสผ่าน">
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="login-remember" class="rounded bg-slate-800 border-slate-600">
                            <label for="login-remember" class="text-xs text-slate-400">จดจำการเข้าสู่ระบบ 7 วัน</label>
                        </div>
                        <button onclick="handleLogin()"
                            class="w-full py-2.5 bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold rounded-lg transition">เข้าสู่ระบบ</button>
                    </div>
                    <div id="register-form" class="p-5 space-y-4 hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-400 mb-1.5 block font-medium">Username</label>
                                <input type="text" id="reg-username" class="inp-pretty" placeholder="ชื่อผู้ใช้">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 mb-1.5 block font-medium">Password</label>
                                <input type="password" id="reg-password" class="inp-pretty" placeholder="รหัสผ่าน">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-slate-400 mb-1.5 block font-medium">ชื่อ</label>
                                <input type="text" id="reg-firstname" class="inp-pretty" placeholder="ชื่อ">
                            </div>
                            <div>
                                <label class="text-xs text-slate-400 mb-1.5 block font-medium">นามสกุล</label>
                                <input type="text" id="reg-lastname" class="inp-pretty" placeholder="นามสกุล">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 mb-1.5 block font-medium">รูปโปรไฟล์ (URL)</label>
                            <input type="text" id="reg-avatar" class="inp-pretty"
                                placeholder="https://example.com/avatar.png">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 mb-1.5 block font-medium">เบอร์โทร IC</label>
                            <input type="text" id="reg-ic-phone" class="inp-pretty" placeholder="เบอร์โทร In-Character">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 mb-1.5 block font-medium">ช่วงเวลาที่สะดวก</label>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="time" id="reg-shift-start" class="inp-pretty text-center">
                                <input type="time" id="reg-shift-end" class="inp-pretty text-center">
                            </div>
                        </div>
                        <button onclick="handleRegister()"
                            class="w-full py-3 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-semibold rounded-xl transition shadow-lg shadow-emerald-500/20">สมัครสมาชิก</button>
                    </div>
                </div>
            </div>

            <!-- Side Cards (Guest & Download) -->
            <div class="w-full lg:w-auto flex flex-col gap-3 animate-zoom-in" style="animation-delay: 0.1s;">
                <!-- Guest Card -->
                <div class="glass rounded-xl p-4 hover:bg-white/10 transition cursor-pointer group"
                    onclick="enterAsGuest()">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center text-lg group-hover:scale-110 transition">
                            👁️
                        </div>
                        <div>
                            <h3 class="text-white font-bold text-xs mb-0.5">เข้าดูแบบ Guest</h3>
                            <p class="text-slate-400 text-[10px]">ดูสถานะ OP ได้อย่างเดียว</p>
                        </div>
                    </div>
                </div>

                <!-- Download Desktop Card -->
                <a href="https://github.com/Smallzoamz/medicop/releases/download/v1.6.1-build.4/Medical-OP-Systems-Setup-1.6.1-build.4.exe"
                    class="glass rounded-xl p-4 hover:bg-cyan-500/10 transition group block">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-lg group-hover:scale-110 transition">
                            💻
                        </div>
                        <div>
                            <h3 class="text-white font-bold text-xs mb-0.5">ดาวน์โหลด Desktop OP</h3>
                            <p class="text-slate-400 text-[10px]">แอปสำหรับ Windows (Auto Patch)</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        <!-- Full Width Navbar -->
        <nav
            class="w-full bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-cyan-500/20 px-6 py-2 flex items-center justify-between sticky top-0 z-50">
            <!-- Left: Logo -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center overflow-hidden">
                    <img id="nav-icon-logo" src="" alt="" class="w-full h-full object-contain hidden">
                    <span id="nav-icon-emoji" class="text-xl">🏥</span>
                </div>
                <div class="flex flex-col">
                    <span id="server-name-display"
                        class="text-sm font-bold tracking-wide bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent animate-pulse">ONE
                        CITY</span>
                    <span class="text-[9px] text-slate-400 uppercase tracking-widest">Operator Systems</span>
                </div>
            </div>
            <!-- Center: Menu Items -->
            <div class="hidden md:flex items-center gap-1">
                <button id="tab-op-btn" onclick="switchMainTab('op')"
                    class="px-4 py-2 text-sm font-medium text-cyan-400 hover:text-white hover:bg-cyan-500/10 rounded-lg transition flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-cyan-400"></span> หน้าจัดการ OP
                </button>
                <button id="tab-cmd-btn" onclick="showCommandModal()"
                    class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition flex items-center gap-2">
                    📋 รวมคำสั่งประกาศ
                </button>
                <button onclick="showBlacklistModal()"
                    class="px-4 py-2 text-sm font-medium text-rose-400 hover:text-white hover:bg-rose-500/10 rounded-lg transition flex items-center gap-2">
                    🚫 รายการ Blacklist
                </button>
                <button id="staff-admin-btn" onclick="showStaffAdminModal()"
                    class="hidden px-4 py-2 text-sm font-medium text-purple-400 hover:text-white hover:bg-purple-500/10 rounded-lg transition flex items-center gap-2">
                    🛠️ แอดมิน
                </button>
            </div>
            <!-- Right: Buttons & Profile -->
            <div class="flex items-center gap-3">
                <button onclick="handleLogout()"
                    class="px-4 py-2 text-sm font-medium text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    ออกจากระบบ
                </button>
                <div class="w-px h-6 bg-slate-700"></div>
                <!-- Notification Bell -->
                <div class="relative">
                    <button onclick="toggleNotifPanel()"
                        class="relative p-2 text-slate-400 hover:text-white hover:bg-white/5 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                            </path>
                        </svg>
                        <span id="notif-badge"
                            class="hidden absolute -top-0.5 -right-0.5 w-4 h-4 bg-rose-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">0</span>
                    </button>
                    <!-- Notification Dropdown -->
                    <div id="notif-panel"
                        class="hidden absolute right-0 top-12 w-72 glass rounded-xl shadow-2xl border border-slate-700/50 overflow-hidden z-50">
                        <div
                            class="px-4 py-2 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/50">
                            <span class="text-sm font-bold text-white">🔔 แจ้งเตือน</span>
                            <button onclick="clearNotifPanel()"
                                class="text-[10px] text-slate-400 hover:text-white">ล้างทั้งหมด</button>
                        </div>
                        <div id="notif-list" class="max-h-64 overflow-y-auto">
                            <p class="text-xs text-slate-500 text-center py-4">ไม่มีแจ้งเตือน</p>
                        </div>
                    </div>
                </div>
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=U&background=06b6d4&color=fff&size=40"
                    class="w-10 h-10 rounded-full border-2 border-cyan-500/50 cursor-pointer hover:border-cyan-400 transition shadow-lg"
                    onclick="showProfileModal()"
                    onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=U&background=06b6d4&color=fff&size=40';">
                <!-- Guest Badge (shown when user is Guest) -->
                <div id="guest-badge"
                    class="hidden flex items-center gap-2 px-3 py-1.5 bg-slate-700/80 rounded-full border border-slate-600">
                    <span class="text-lg">👁️</span>
                    <span class="text-xs text-slate-300 font-medium">Guest Mode</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="flex-1 flex items-center justify-center p-4 overflow-hidden">
            <div
                class="glass rounded-2xl w-full max-w-7xl h-[calc(100vh-80px)] flex flex-col overflow-hidden animate-zoom-in shadow-2xl">
                <!-- Layout Grid -->
                <div class="flex-1 overflow-hidden grid grid-cols-12 gap-0">
                    <!-- Sidebar -->
                    <div
                        class="col-span-12 lg:col-span-3 bg-black/20 border-r border-white/5 flex flex-col overflow-hidden">
                        <!-- Control Panel -->
                        <div class="p-4 space-y-3 border-b border-white/5">
                            <div class="flex items-center justify-between mb-1">
                                <label
                                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Operator</label>
                                <div class="flex items-center gap-2">
                                    <!-- Guest Count (Owner only) -->
                                    <div id="guest-count-display"
                                        class="hidden flex items-center gap-0.5 px-1.5 py-0.5 bg-slate-700/40 rounded text-[10px]"
                                        data-owner-only></div>
                                    <button onclick="showHowToModal()"
                                        class="text-[10px] font-medium text-amber-400 hover:text-amber-300 flex items-center gap-1">
                                        📚 How To
                                    </button>
                                </div>
                            </div>
                            <div id="op-status-display">
                                <!-- Dynamic content rendered by JS -->
                            </div>
                        </div>
                        <div id="op-sup-section" class="px-4 pb-4">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Support
                                OP</label>
                            <select id="op-sup-select" data-op-only
                                class="mt-1 w-full text-xs rounded-lg border-slate-700 bg-slate-900/50 focus:ring-indigo-500 p-2 text-white">
                                <option value="">-- Select --</option>
                            </select>
                            <div id="sup-op-display"
                                class="hidden mt-2 flex items-center justify-between bg-slate-800/50 rounded-lg px-3 py-2 border border-slate-700/50">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-slate-400">👨‍⚕️</span>
                                    <span id="sup-op-name" class="text-sm text-white font-medium"></span>
                                </div>
                                <button onclick="removeSupOP()"
                                    class="text-[10px] px-2 py-1 bg-rose-600/50 hover:bg-rose-600 text-white rounded transition"
                                    title="ลบ Sup OP">❌</button>
                            </div>
                        </div>
                        <div id="op-control-buttons" class="px-4 pb-3 space-y-2">
                            <!-- Dynamic buttons rendered by JS -->
                        </div>
                        <!-- Pending OP Requests (for current OP) -->
                        <div id="op-pending-requests" class="hidden space-y-2">
                            <label class="text-[10px] font-bold text-amber-400 uppercase tracking-wider">📋
                                Request
                                OP Queue</label>
                            <div id="op-pending-list" class="space-y-1"></div>
                        </div>
                        <!-- Handover Countdown -->
                        <div id="op-handover-countdown" class="hidden bg-amber-900/30 rounded-lg p-3 text-center">
                            <div class="text-[10px] text-amber-400 uppercase font-bold mb-1">เปลี่ยน OP ใน</div>
                            <div id="handover-timer" class="text-xl font-bold text-amber-300 font-mono">30:00
                            </div>
                            <div id="handover-next-op" class="text-xs text-slate-400 mt-1"></div>
                        </div>
                        <!-- Personnel Lists -->
                        <div id="personnel-lists-section"
                            class="flex-1 overflow-hidden flex flex-col p-3 gap-3 h-full min-h-0">
                            <!-- Tabs -->
                            <div class="bg-slate-800/50 p-1 rounded-lg flex gap-1 shrink-0">
                                <button onclick="setSidebarTab('working')" id="tab-btn-working"
                                    class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all bg-slate-700 shadow-sm text-white flex items-center justify-center gap-1">Working
                                    <span id="count-tab-working"
                                        class="bg-indigo-900 text-indigo-300 px-1.5 rounded-full text-[9px]">0</span></button>
                                <button onclick="setSidebarTab('afk')" id="tab-btn-afk"
                                    class="flex-1 py-1.5 text-[10px] font-bold rounded-md transition-all text-slate-400 hover:bg-slate-700/50 flex items-center justify-center gap-1">AFK
                                    💤 <span id="count-tab-afk"
                                        class="bg-slate-700 text-slate-400 px-1.5 rounded-full text-[9px]">0</span></button>
                            </div>
                            <!-- Tab View: Working -->
                            <div id="sidebar-view-working" class="flex-1 flex flex-col gap-3 overflow-hidden">
                                <!-- On Duty -->
                                <div class="flex-1 glass-light rounded-xl flex flex-col overflow-hidden min-h-[150px]">
                                    <div
                                        class="px-3 py-2 border-b border-white/10 flex justify-between items-center bg-emerald-500/5 shrink-0">
                                        <span class="text-xs font-bold text-emerald-400 flex items-center gap-1">🟢
                                            On
                                            Duty</span>
                                        <span class="text-[10px] font-bold opacity-60 flex items-center gap-1">👤
                                            <span id="count-on-duty">0</span></span>
                                    </div>
                                    <div class="p-2 border-b border-white/10 shrink-0">
                                        <div class="flex gap-1">
                                            <input id="manual-add-name" data-op-only
                                                class="flex-1 text-[10px] rounded bg-slate-900/50 border-slate-700 p-1.5 text-white"
                                                placeholder="Add Name..."
                                                onkeypress="if(event.key==='Enter') addManualMedic()">
                                            <button onclick="addManualMedic()" data-op-only
                                                class="bg-emerald-500 text-white px-2 rounded hover:bg-emerald-600">+</button>
                                        </div>
                                    </div>
                                    <div id="list-on-duty"
                                        class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                    </div>
                                </div>
                                <!-- Off Duty -->
                                <div class="h-[140px] shrink-0 glass-light rounded-xl flex flex-col overflow-hidden">
                                    <div
                                        class="px-3 py-2 border-b border-white/10 flex justify-between items-center bg-slate-500/5 shrink-0">
                                        <span class="text-xs font-bold text-slate-400 flex items-center gap-1">🔴
                                            Off
                                            Duty</span>
                                        <span class="text-[10px] font-bold opacity-60 flex items-center gap-1">👤
                                            <span id="count-off-duty">0</span></span>
                                    </div>
                                    <div id="list-off-duty"
                                        class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                    </div>
                                </div>
                            </div>
                            <!-- Tab View: AFK -->
                            <div id="sidebar-view-afk"
                                class="hidden flex-1 bg-yellow-900/10 rounded-xl border border-yellow-900/20 flex flex-col overflow-hidden min-h-0">
                                <div
                                    class="px-3 py-2 border-b border-yellow-900/20 flex justify-between items-center bg-yellow-500/5 shrink-0">
                                    <span class="text-xs font-bold text-yellow-400 flex items-center gap-1">💤 AFK
                                        List</span>
                                    <span class="text-[10px] font-bold opacity-60 flex items-center gap-1">👤 <span
                                            id="count-afk">0</span></span>
                                </div>
                                <div id="list-afk" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div
                        class="col-span-12 lg:col-span-9 bg-black/30 flex flex-col p-6 gap-4 overflow-y-auto custom-scrollbar">
                        <!-- Phone Commands -->
                        <div class="glass rounded-2xl p-4 shrink-0">
                            <div class="flex flex-wrap items-center gap-2">
                                <h4 class="font-bold text-white flex items-center gap-2 text-sm shrink-0"><span
                                        class="p-1.5 bg-emerald-900/50 text-emerald-400 rounded-lg">📞</span>
                                    คำสั่งโทรศัพท์
                                </h4>
                                <input type="text" id="phone-input-1" placeholder="เบอร์โทร..."
                                    class="w-28 text-xs rounded-lg border-slate-700 bg-slate-900/50 p-2 text-white">
                                <button onclick="copyPhoneNotFound()"
                                    class="text-xs bg-slate-600 hover:bg-slate-500 text-white px-2 py-1.5 rounded-lg transition whitespace-nowrap">ไม่พบ</button>
                                <button onclick="copyPhoneUnreachable()"
                                    class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1.5 rounded-lg transition whitespace-nowrap">เข้าไม่ถึง</button>
                                <!-- Music Player - Cute Theme Style -->
                                <div id="music-player-container"
                                    class="ml-auto flex items-center gap-2 px-2.5 py-1.5 rounded-xl"
                                    style="background: linear-gradient(135deg, rgba(236,72,153,0.25) 0%, rgba(168,85,247,0.3) 50%, rgba(59,130,246,0.25) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.25); box-shadow: 0 4px 15px rgba(168,85,247,0.2);">
                                    <!-- Album Art / Icon -->
                                    <div class="w-9 h-9 rounded-lg flex items-center justify-center shadow-md cursor-pointer"
                                        style="background: linear-gradient(135deg, #ec4899 0%, #a855f7 50%, #3b82f6 100%);"
                                        onclick="showMusicSettingsModal()">
                                        <span class="text-white text-sm drop-shadow">🎵</span>
                                    </div>
                                    <!-- Song Info + Progress -->
                                    <div class="flex flex-col gap-0.5 w-20">
                                        <div class="overflow-hidden cursor-pointer" onclick="showMusicSettingsModal()">
                                            <div id="music-marquee"
                                                class="lofi-marquee text-[9px] font-semibold text-white whitespace-nowrap drop-shadow">
                                                ✨ Lo-Fi Radio ✨ Lo-Fi Radio
                                            </div>
                                        </div>
                                        <!-- Mini Progress Bar -->
                                        <div class="h-1 bg-white/20 rounded-full overflow-hidden">
                                            <div
                                                class="h-full w-1/3 bg-gradient-to-r from-pink-400 via-purple-400 to-blue-400 rounded-full">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Controls -->
                                    <div class="flex items-center gap-0.5">
                                        <button onclick="playPreviousTrack()"
                                            class="w-5 h-5 flex items-center justify-center text-white/80 hover:text-white hover:scale-110 transition text-[10px]"
                                            title="ก่อนหน้า">⏮</button>
                                        <button id="music-play-btn" onclick="toggleMusicPlayer()"
                                            class="w-7 h-7 flex items-center justify-center text-white rounded-full transition-all shadow-lg hover:scale-110"
                                            style="background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);">
                                            <span id="music-play-icon" class="text-xs">▶</span>
                                        </button>
                                        <button onclick="playNextTrack()"
                                            class="w-5 h-5 flex items-center justify-center text-white/80 hover:text-white hover:scale-110 transition text-[10px]"
                                            title="ถัดไป">⏭</button>
                                    </div>
                                    <!-- Volume -->
                                    <div class="flex items-center gap-1">
                                        <button onclick="toggleMusicMute()" id="music-mute-btn"
                                            class="text-white/80 hover:text-white transition text-[10px]">🔉</button>
                                        <input type="range" id="music-volume" min="0" max="100" value="1"
                                            class="w-8 h-1 accent-pink-400 cursor-pointer"
                                            oninput="setMusicVolume(this.value)">
                                    </div>
                                    <!-- Settings -->
                                    <button onclick="showMusicSettingsModal()"
                                        class="text-white/80 hover:text-white transition text-[10px]"
                                        title="ตั้งค่า">⚙️</button>
                                    <!-- Refresh Music Player -->
                                    <button onclick="refreshMusicPlayerUI()"
                                        class="text-white/80 hover:text-white transition text-[10px]"
                                        title="Refresh Music Player">🔄</button>
                                </div>
                            </div>
                        </div>

                        <!-- Medical Fee Cards -->
                        <div class="grid grid-cols-2 gap-3 mt-1">
                            <!-- Normal Case Card -->
                            <div class="glass rounded-xl p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="text-xs font-bold text-emerald-400 flex items-center gap-1">
                                        <span class="p-0.5 bg-emerald-900/50 rounded">💊</span> เคสปกติ
                                    </h5>
                                    <button id="fee-normal-edit-btn" onclick="toggleFeeEdit('normal')"
                                        class="text-[9px] bg-slate-600 hover:bg-slate-500 text-white px-2 py-0.5 rounded transition">✏️
                                        แก้ไข</button>
                                </div>
                                <table class="w-full text-[10px]">
                                    <thead>
                                        <tr class="text-slate-400">
                                            <th class="text-left py-1">เขต</th>
                                            <th class="text-center py-1">ชุบ</th>
                                            <th class="text-center py-1">ฉีด</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fee-normal-body" class="text-white">
                                        <tr>
                                            <td class="py-0.5">🏙️ ในเมือง</td>
                                            <td class="text-center"><span id="fee-normal-city-chub">-</span></td>
                                            <td class="text-center"><span id="fee-normal-city-chit">-</span></td>
                                        </tr>
                                        <tr>
                                            <td class="py-0.5">🏜️ ทะเลทราย</td>
                                            <td class="text-center"><span id="fee-normal-desert-chub">-</span></td>
                                            <td class="text-center"><span id="fee-normal-desert-chit">-</span></td>
                                        </tr>
                                        <tr>
                                            <td class="py-0.5">⛰️ เมืองบน</td>
                                            <td class="text-center"><span id="fee-normal-upper-chub">-</span></td>
                                            <td class="text-center"><span id="fee-normal-upper-chit">-</span></td>
                                        </tr>
                                        <tr>
                                            <td class="py-0.5">🚧 พื้นที่เข้าถึงยาก</td>
                                            <td class="text-center"><span id="fee-normal-hard-chub">-</span></td>
                                            <td class="text-center"><span id="fee-normal-hard-chit">-</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="mt-2 p-2 bg-amber-900/20 rounded-lg border border-amber-500/30">
                                    <div class="text-[11px] text-amber-300 font-bold mb-1">📝 หมายเหตุ :</div>
                                    <div class="text-[10px] text-amber-200/80">• หากโดนเรียกไปชุบที่ สน.
                                        ให้ชุบได้อย่างเดียว ห้ามฉีดยา</div>
                                </div>
                                <!-- Edit Form (hidden by default) -->
                                <div id="fee-normal-form" class="hidden mt-2 space-y-1 text-[9px]">
                                    <div class="grid grid-cols-3 gap-1 text-slate-400 font-bold"><span></span><span
                                            class="text-center">ชุบ</span><span class="text-center">ฉีด</span></div>
                                    <div class="grid grid-cols-3 gap-1 items-center"><span
                                            class="text-slate-400">ในเมือง</span><input type="text"
                                            id="fee-normal-city-chub-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center"><input
                                            type="text" id="fee-normal-city-chit-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-1 items-center"><span
                                            class="text-slate-400">ทะเลทราย</span><input type="text"
                                            id="fee-normal-desert-chub-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center"><input
                                            type="text" id="fee-normal-desert-chit-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-1 items-center"><span
                                            class="text-slate-400">เมืองบน</span><input type="text"
                                            id="fee-normal-upper-chub-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center"><input
                                            type="text" id="fee-normal-upper-chit-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center">
                                    </div>
                                    <div class="grid grid-cols-3 gap-1 items-center"><span
                                            class="text-slate-400">เข้าถึงยาก</span><input type="text"
                                            id="fee-normal-hard-chub-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center"><input
                                            type="text" id="fee-normal-hard-chit-input"
                                            class="text-[10px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white text-center">
                                    </div>
                                    <button onclick="saveMedicalFees('normal')"
                                        class="w-full mt-1 text-[10px] bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-1 rounded transition">💾
                                        บันทึก</button>
                                </div>
                            </div>
                            <!-- Risky Case Card (Simplified) -->
                            <div class="glass rounded-xl p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="text-xs font-bold text-amber-400 flex items-center gap-1">
                                        <span class="p-0.5 bg-amber-900/50 rounded">⚠️</span> เคสสุ่มเสี่ยง / สตอรี่
                                    </h5>
                                    <button id="fee-risky-edit-btn" onclick="toggleFeeEdit('risky')"
                                        class="text-[9px] bg-slate-600 hover:bg-slate-500 text-white px-2 py-0.5 rounded transition">✏️
                                        แก้ไข</button>
                                </div>
                                <table class="w-full text-[10px]">
                                    <thead>
                                        <tr class="text-slate-400">
                                            <th class="text-left py-1">เขต</th>
                                            <th class="text-center py-1">ชุบ</th>
                                            <th class="text-center py-1">ฉีด</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fee-risky-body" class="text-white">
                                        <tr>
                                            <td class="py-0.5">⚠️ พื้นที่สุ่มเสี่ยง</td>
                                            <td class="text-center"><span id="fee-risky-area-chub">-</span></td>
                                            <td class="text-center text-slate-500">ไม่ฉีดยา</td>
                                        </tr>
                                        <tr>
                                            <td class="py-0.5">🎬 ชุบพื้นที่สตอรี่</td>
                                            <td class="text-center"><span id="fee-story-area-chub">-</span></td>
                                            <td class="text-center text-slate-500">ไม่ฉีดยา</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="mt-2 p-2 bg-amber-900/20 rounded-lg border border-amber-500/30">
                                    <div class="text-[11px] text-amber-300 font-bold mb-1">📝 หมายเหตุ :</div>
                                    <div class="text-[10px] text-amber-200/80 space-y-0.5">
                                        <div>• เคสเรเบล ➜ นำกลับมาชุบโรงพยาบาลที่ใกล้ที่สุด</div>
                                        <div>• เคสงานผิดกฏหมาย ➜ นำกลับไปชุบที่สถานีตำรวจ</div>
                                    </div>
                                </div>
                                <!-- Edit Form (hidden by default) -->
                                <div id="fee-risky-form" class="hidden mt-2 space-y-1 text-[9px]">
                                    <div class="flex items-center gap-2">
                                        <span class="text-slate-400 w-20">พื้นที่สุ่มเสี่ยง</span>
                                        <input type="text" id="fee-risky-area-chub-input"
                                            class="flex-1 text-[10px] bg-slate-800 border border-slate-600 rounded px-2 py-0.5 text-white text-center"
                                            placeholder="ราคาชุบ">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-slate-400 w-20">ชุบสตอรี่</span>
                                        <input type="text" id="fee-story-area-chub-input"
                                            class="flex-1 text-[10px] bg-slate-800 border border-slate-600 rounded px-2 py-0.5 text-white text-center"
                                            placeholder="ราคาชุบ">
                                    </div>
                                    <button onclick="saveMedicalFees('risky')"
                                        class="w-full mt-1 text-[10px] bg-amber-600 hover:bg-amber-500 text-white px-2 py-1 rounded transition">💾
                                        บันทึก</button>
                                </div>
                            </div>
                        </div>

                        <!-- Story Case Card with Tabs -->
                        <div class="glass rounded-2xl flex-1 flex flex-col min-h-0 overflow-hidden">
                            <div class="px-4 pt-4 pb-2 border-b border-white/10 shrink-0">
                                <h4 class="font-bold text-white flex items-center gap-2 text-sm mb-3"><span
                                        class="p-1 bg-indigo-900/50 text-indigo-400 rounded">⚔️</span> เคสสตอรี่
                                </h4>
                                <!-- Tab Buttons -->
                                <div class="flex gap-1 bg-slate-800/50 p-1 rounded-lg">
                                    <button onclick="setStoryTab('fight')" id="story-tab-fight"
                                        class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all bg-indigo-600 text-white">🔥
                                        นับไฟท์</button>
                                    <button onclick="setStoryTab('umae')" id="story-tab-umae"
                                        class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all text-slate-400 hover:bg-slate-700/50">💀
                                        อุ้มเอ๋อ(ห่อศพ)</button>
                                </div>
                            </div>

                            <!-- Tab Content: Fight -->
                            <div id="story-view-fight" class="flex-1 flex flex-col p-4 gap-3 overflow-hidden">
                                <!-- Create Case Form -->
                                <div id="fight-create-form" class="space-y-2 shrink-0" data-op-only>
                                    <!-- Row 1: Date + Time + Parties -->
                                    <div class="flex gap-2 items-center">
                                        <input type="date" id="case-date" data-op-only
                                            class="w-32 text-xs rounded-lg border-slate-700 bg-slate-900/50 p-1.5 text-white"
                                            title="วันที่">
                                        <input type="time" id="case-time" data-op-only
                                            class="w-24 text-xs rounded-lg border-slate-700 bg-slate-900/50 p-1.5 text-white"
                                            title="เวลาเริ่ม">
                                        <div
                                            class="flex-1 flex items-center gap-1 bg-slate-900/50 p-1.5 rounded-lg border border-slate-700/50">
                                            <input id="case-party-a" placeholder="Party A" data-op-only
                                                class="w-full bg-transparent border-0 text-right text-xs focus:ring-0 text-white placeholder-slate-500">
                                            <span
                                                class="text-rose-500 font-black text-[9px] px-1.5 py-0.5 bg-rose-900/30 rounded shrink-0">VS</span>
                                            <input id="case-party-b" placeholder="Party B" data-op-only
                                                class="w-full bg-transparent border-0 text-left text-xs focus:ring-0 text-white placeholder-slate-500">
                                        </div>
                                        <!-- Row 2: Create Button -->
                                        <div class="flex gap-1.5 items-center justify-end">
                                            <button onclick="createOpCase()" data-op-only
                                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs shadow transition">+
                                                สร้างสตอรี่</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Story List (visible to all users) -->
                                <div class="flex-1 flex flex-col min-h-0 border-t border-white/10 pt-3">
                                    <div class="flex justify-between items-center mb-2 shrink-0">
                                        <span
                                            class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                            <span class="w-1 h-3 bg-indigo-500 rounded"></span> รายการสตอรี่
                                        </span>
                                        <button onclick="toggleHistory()"
                                            class="text-xs text-slate-500 hover:text-white transition">📜 ประวัติ
                                            <span id="history-count">(0)</span></button>
                                    </div>
                                    <div id="op-case-list"
                                        class="flex flex-wrap gap-2 overflow-y-auto custom-scrollbar pr-1 content-start">
                                    </div>
                                    <div id="history-section" class="hidden mt-4 bg-slate-800/50 rounded-xl p-3">
                                        <h4 class="text-xs font-bold text-slate-400 mb-2">📜 ประวัติสตอรี่ที่ปิดแล้ว
                                        </h4>
                                        <div id="history-list"
                                            class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                                        </div>
                                    </div>
                                </div>

                                <!-- Event Card Section (Responsive) -->
                                <div id="event-card-section" class="hidden mt-3 shrink-0">
                                    <div class="flex justify-between items-center mb-2">
                                        <span onclick="toggleEventCollapse()"
                                            class="cursor-pointer text-xs font-bold text-cyan-400 uppercase tracking-wider flex items-center gap-2">
                                            <span class="w-1 h-3 bg-cyan-500 rounded"></span> 🎯 กิจกรรม
                                            <span id="event-active-count"
                                                class="bg-cyan-900 text-cyan-300 px-1.5 rounded-full text-[9px]">0</span>
                                            <span id="event-collapse-icon" class="text-slate-400">▼</span>
                                        </span>
                                        <div class="flex gap-1">
                                            <button id="event-settings-btn"
                                                onclick="event.stopPropagation(); showEventSettingsModal()"
                                                class="hidden text-[9px] bg-slate-600/80 hover:bg-slate-600 text-white px-2 py-1 rounded transition">
                                                ⚙️ ตั้งค่า
                                            </button>
                                            <button id="test-event-btn"
                                                onclick="event.stopPropagation(); createTestEvent()"
                                                class="hidden text-[9px] bg-amber-600/80 hover:bg-amber-600 text-white px-2 py-1 rounded transition">
                                                🧪 Test
                                            </button>
                                        </div>
                                    </div>
                                    <div id="event-cards-container"
                                        class="event-cards-responsive gap-2 overflow-auto custom-scrollbar">
                                        <!-- Event cards will be rendered here -->
                                    </div>
                                </div>

                                <!-- Non-OP Umae Viewer (appears when OP enables) -->
                                <div id="nonop-umae-section"
                                    class="hidden shrink-0 mt-3 border-t border-purple-500/30 pt-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span
                                            class="text-[10px] font-bold text-purple-400 uppercase tracking-wider flex items-center gap-1">
                                            💀 เคสอุ้มห่อ
                                            <span id="nonop-umae-count"
                                                class="bg-purple-900 text-purple-300 px-1 rounded-full text-[8px]">0</span>
                                        </span>
                                    </div>
                                    <!-- Medics on Umae -->
                                    <div id="nonop-umae-medic-section"
                                        class="hidden mb-2 bg-purple-900/20 rounded p-1.5 border border-purple-500/20">
                                        <span class="text-[9px] text-purple-300">👨‍⚕️ แพทย์ในสตอรี่อุ้มห่อ: </span>
                                        <span id="nonop-umae-medic-list"
                                            class="text-[9px] text-white font-medium"></span>
                                    </div>
                                    <div id="nonop-umae-list"
                                        class="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                                        <div class="text-center text-slate-500 text-[10px] py-2">ยังไม่มีเคส</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Umae -->
                            <div id="story-view-umae" class="hidden flex-1 flex flex-col p-4 gap-3 overflow-hidden">
                                <!-- Add Case Section -->
                                <div id="umae-add-form" class="space-y-2 shrink-0" data-op-only>
                                    <div class="flex gap-2 items-center">
                                        <input type="tel" id="umae-phone-input" placeholder="📞 เบอร์โทร..."
                                            class="flex-1 text-xs rounded-lg border-slate-700 bg-slate-900/50 p-2 text-white"
                                            onkeypress="if(event.key==='Enter') addUmaeCase()">
                                        <div
                                            class="flex items-center gap-1 bg-slate-900/50 px-2 py-1 rounded-lg border border-slate-700">
                                            <input type="number" id="umae-countdown-mins" value="15" min="1" max="60"
                                                class="w-12 text-xs bg-transparent border-0 text-white text-center focus:ring-0">
                                            <span class="text-[10px] text-slate-400">นาที</span>
                                        </div>
                                        <button onclick="addUmaeCase()"
                                            class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow transition">
                                            + เพิ่มเบอร์</button>
                                    </div>
                                    <!-- Search -->
                                    <input type="text" id="umae-search" placeholder="🔍 ค้นหาเบอร์..."
                                        class="w-full text-xs rounded-lg border-slate-700 bg-slate-900/50 p-2 text-white"
                                        oninput="renderUmaeTab()">
                                </div>

                                <!-- Active Cases -->
                                <div class="flex-1 flex flex-col min-h-0 border-t border-white/10 pt-2">
                                    <div class="flex justify-between items-center mb-1 shrink-0">
                                        <span
                                            class="text-[10px] font-bold text-purple-400 uppercase tracking-wider flex items-center gap-1">
                                            <span class="w-1 h-2 bg-purple-500 rounded"></span> เบอร์ที่ถูกห่อ
                                            <span id="umae-active-count"
                                                class="bg-purple-900 text-purple-300 px-1 rounded-full text-[8px]">0</span>
                                        </span>
                                        <div class="flex items-center gap-2">
                                            <span id="umae-medic-limit" class="text-[9px] text-slate-500">👨‍⚕️
                                                Limit:
                                                1</span>
                                            <button id="umae-toggle-btn" onclick="toggleUmaeVisibility()"
                                                class="text-[9px] px-2 py-0.5 rounded bg-slate-700 text-slate-400 hover:bg-slate-600 transition">
                                                👁️ เปิด/ปิดให้คนอื่นเห็น
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Medics on Umae -->
                                    <div id="umae-medic-section"
                                        class="mb-1 bg-purple-900/20 rounded p-1.5 border border-purple-500/20">
                                        <div class="flex items-center justify-between gap-2">
                                            <div class="flex items-center gap-1 flex-wrap flex-1">
                                                <span class="text-[9px] text-purple-300">👨‍⚕️ แพทย์อุ้มห่อ</span>
                                                <span id="umae-medic-limit"
                                                    class="text-[9px] text-purple-400 bg-purple-900/50 px-1 rounded">(0/0)</span>
                                                <span class="text-[9px] text-purple-300">:</span>
                                                <span id="umae-medic-list"
                                                    class="text-[9px] text-white font-medium"></span>
                                            </div>
                                            <button id="umae-assign-btn" onclick="showUmaeAssignDropdown()"
                                                class="text-[9px] bg-purple-600 hover:bg-purple-500 text-white px-2 py-0.5 rounded font-medium transition"
                                                data-op-only>
                                                + Assign Medic
                                            </button>
                                        </div>
                                        <!-- Hidden Assign Section -->
                                        <div id="umae-assign-section"
                                            class="hidden mt-1.5 pt-1.5 border-t border-purple-500/30">
                                            <div class="flex items-center gap-1.5">
                                                <select id="umae-add-medic-select"
                                                    class="flex-1 text-[9px] bg-slate-800 border-slate-600 rounded px-1.5 py-1 text-slate-300">
                                                    <option value="">-- เลือกแพทย์ --</option>
                                                </select>
                                                <button onclick="acceptUmaeMedic()"
                                                    class="text-[9px] bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-0.5 rounded font-medium">✅
                                                    Accept</button>
                                                <button onclick="hideUmaeAssignDropdown()"
                                                    class="text-[9px] bg-slate-700 hover:bg-slate-600 text-white px-2 py-0.5 rounded">❌</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="umae-active-list"
                                        class="space-y-1 flex-1 overflow-y-auto custom-scrollbar pr-1">
                                        <div class="text-center text-slate-500 text-xs py-4">ยังไม่มีเคส</div>
                                    </div>
                                </div>

                                <!-- Expired Section -->
                                <div id="umae-expired-section" class="hidden shrink-0 border-t border-rose-500/30 pt-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span
                                            class="text-xs font-bold text-rose-400 uppercase tracking-wider flex items-center gap-2">
                                            💀 เบอร์ที่เอ๋อ
                                            <span id="umae-expired-count"
                                                class="bg-rose-900 text-rose-300 px-1.5 rounded-full text-[9px]">0</span>
                                        </span>
                                        <button onclick="clearExpiredUmae()"
                                            class="text-[10px] text-rose-400 hover:text-rose-300 px-2 py-0.5 bg-rose-900/30 rounded">🗑️
                                            Clear</button>
                                    </div>
                                    <div id="umae-expired-list"
                                        class="space-y-1 max-h-24 overflow-y-auto custom-scrollbar">
                                    </div>
                                </div>

                                <!-- History Section -->
                                <div id="umae-history-section"
                                    class="hidden shrink-0 border-t border-emerald-500/30 pt-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span
                                            class="text-xs font-bold text-emerald-400 uppercase tracking-wider flex items-center gap-2">
                                            ✅ ช่วยเหลือแล้ว
                                            <span id="umae-helped-count"
                                                class="bg-emerald-900 text-emerald-300 px-1.5 rounded-full text-[9px]">0</span>
                                        </span>
                                    </div>
                                    <div id="umae-history-list"
                                        class="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Command View (Tab 2) -->
        <div id="cmd-view" class="hidden flex-1 flex items-center justify-center p-4 overflow-hidden">
            <div
                class="glass rounded-2xl w-full max-w-4xl max-h-[calc(100vh-80px)] overflow-y-auto p-6 animate-zoom-in shadow-2xl">
                <h1 class="text-xl font-bold text-white mb-2 flex items-center gap-2">📋 รวมคำสั่งประกาศ</h1>
                <p class="text-sm text-slate-400 mb-6">คำสั่ง /an ที่ใช้บ่อยสำหรับ OP</p>

                <!-- Phone Commands -->
                <div class="glass rounded-xl p-5 mb-4">
                    <h2 class="text-base font-bold text-cyan-400 mb-4 flex items-center gap-2">
                        <span>📱</span> คำสั่งเกี่ยวกับโทรศัพท์
                    </h2>
                    <div class="text-center py-6">
                        <span class="text-3xl mb-2 block">🚧</span>
                        <p class="text-slate-400 text-sm">รอการ Update</p>
                    </div>
                </div>

                <!-- Story Commands -->
                <div class="glass rounded-xl p-5">
                    <h2 class="text-base font-bold text-indigo-400 mb-4 flex items-center gap-2">
                        <span>⚔️</span> คำสั่งสตอรี่
                    </h2>
                    <div class="space-y-4">
                        <!-- Cooldown -->
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-slate-300">⏱️ คูลดาวน์สตอรี่</span>
                                <span class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded">10
                                    นาที</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <input type="text" id="cmd-cooldown-a" placeholder="Party A" class="inp-pretty">
                                <input type="text" id="cmd-cooldown-b" placeholder="Party B" class="inp-pretty">
                            </div>
                            <button onclick="copyCmdCooldown()"
                                class="w-full py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium rounded-lg transition flex items-center justify-center gap-2">📋
                                Copy คำสั่งคูลดาวน์</button>
                            <p class="text-[11px] text-slate-500 mt-2">ประกาศคูลดาวน์สตอรี่ระหว่าง [A] vs [B]
                                เป็นเวลา
                                10 นาที...</p>
                        </div>
                        <!-- Enter Area -->
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-slate-300">🚑 เข้าพื้นที่สตอรี่</span>
                                <span class="text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded">2
                                    นาที</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <input type="text" id="cmd-enter-a" placeholder="Party A" class="inp-pretty">
                                <input type="text" id="cmd-enter-b" placeholder="Party B" class="inp-pretty">
                            </div>
                            <button onclick="copyCmdEnterArea()"
                                class="w-full py-2.5 bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-medium rounded-lg transition flex items-center justify-center gap-2">📋
                                Copy คำสั่งเข้าพื้นที่</button>
                            <p class="text-[11px] text-slate-500 mt-2">แพทย์กำลังเข้าพื้นที่สตอรี่ [A] vs [B]
                                ขอให้แก๊งที่ชนะออกจากพื้นที่...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Chat Box Widget - Single Button -->
        <div id="chat-widget" class="fixed bottom-4 right-4 z-[200] flex flex-col items-end gap-2">
            <!-- Main Chat Button (Circular) -->
            <button id="chat-main-btn" onclick="toggleChatList()"
                class="w-14 h-14 flex items-center justify-center text-white rounded-full transition-all duration-300 hover:scale-110 relative shadow-xl"
                style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #3b82f6 100%); box-shadow: 0 6px 25px rgba(99,102,241,0.4), inset 0 1px 0 rgba(255,255,255,0.2);">
                <svg id="chat-main-icon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                    </path>
                </svg>
                <span id="chat-total-unread"
                    class="hidden absolute -top-1 -right-1 bg-rose-500 text-white text-[10px] font-bold min-w-5 h-5 px-1 rounded-full flex items-center justify-center animate-pulse">0</span>
            </button>

            <!-- Chat Window (Windows 11 Style) -->
            <div id="chat-window"
                class="hidden fixed bottom-20 right-4 w-80 sm:w-96 rounded-2xl shadow-2xl overflow-hidden animate-zoom-in z-[199]"
                style="max-height: calc(100vh - 120px); background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(51,65,85,0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);">
                <!-- Header (Windows 11 Title Bar) -->
                <div class="px-4 py-3 flex items-center justify-between"
                    style="background: linear-gradient(180deg, rgba(59,130,246,0.3) 0%, rgba(59,130,246,0.1) 100%); border-bottom: 1px solid rgba(255,255,255,0.08);">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                            <span class="text-lg">💬</span>
                        </div>
                        <div>
                            <h4 class="text-white font-semibold text-sm">แชทกลุ่ม OP</h4>
                            <button onclick="toggleOnlineUsersPanel()" id="chat-online-count"
                                class="text-[10px] text-blue-300 hover:text-white transition cursor-pointer">0
                                คนออนไลน์</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="toggleOnlineUsersPanel()"
                            class="w-8 h-8 text-white/60 hover:text-white hover:bg-white/10 rounded-lg flex items-center justify-center transition text-sm"
                            title="ดูรายชื่อออนไลน์">👥</button>
                        <button id="chat-sound-btn" onclick="toggleChatSound()"
                            class="w-8 h-8 text-white/60 hover:text-white hover:bg-white/10 rounded-lg flex items-center justify-center transition text-sm"
                            title="เปิด/ปิดเสียงแจ้งเตือน">🔔</button>
                        <button id="chat-clear-btn" onclick="clearAllChat()"
                            class="hidden w-8 h-8 text-white/60 hover:text-white hover:bg-white/10 rounded-lg flex items-center justify-center transition text-sm"
                            title="ล้างประวัติแชท">🗑️</button>
                        <button onclick="toggleChatBox()"
                            class="w-8 h-8 text-white/60 hover:text-white hover:bg-red-500/50 rounded-lg flex items-center justify-center transition text-sm">✕</button>
                    </div>
                </div>

                <!-- Online Users Panel - Now separate floating bubble -->
                <!-- This is just a placeholder, real panel is outside chat box -->
                <div id="chat-online-panel-placeholder" class="hidden"></div>

                <!-- DM Chat Panel -->
                <div id="dm-panel" class="hidden absolute inset-0 bg-slate-900 z-20 flex flex-col animate-zoom-in">
                    <div
                        class="bg-gradient-to-r from-purple-600 to-purple-700 px-4 py-3 flex items-center justify-between shrink-0">
                        <div class="flex items-center gap-2">
                            <img id="dm-recipient-avatar" src="" class="w-8 h-8 rounded-full">
                            <div>
                                <h4 id="dm-recipient-name" class="text-white font-bold text-sm">-</h4>
                                <span id="dm-typing-indicator"
                                    class="hidden text-[10px] text-purple-200 animate-pulse">กำลังพิมพ์...</span>
                                <span id="dm-status-text" class="text-[10px] text-purple-200">แชทส่วนตัว</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="clearDM()" class="text-white/70 hover:text-white text-lg"
                                title="ล้างแชท">🗑️</button>
                            <button onclick="closeDM()" class="text-white/70 hover:text-white text-lg">✕</button>
                        </div>
                    </div>
                    <div id="dm-messages" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar bg-slate-800/50"
                        ondragover="event.preventDefault(); this.classList.add('ring-2', 'ring-purple-400');"
                        ondragleave="this.classList.remove('ring-2', 'ring-purple-400');"
                        ondrop="handleDMImageDrop(event); this.classList.remove('ring-2', 'ring-purple-400');">
                        <div class="text-center text-slate-500 text-xs py-4">เริ่มสนทนา...</div>
                    </div>
                    <div class="p-3 bg-slate-800 border-t border-slate-700 shrink-0">
                        <!-- DM Image Preview -->
                        <div id="dm-image-preview" class="hidden mb-2 relative">
                            <img id="dm-image-preview-img" class="max-h-32 rounded-lg" src="">
                            <button onclick="cancelDMImageUpload()"
                                class="absolute top-1 right-1 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs">✕</button>
                        </div>
                        <!-- DM Typing Indicator (above input) -->
                        <div id="dm-typing-bar" class="hidden text-xs text-purple-300 animate-pulse mb-2 px-2">
                            <span id="dm-typing-name"></span> กำลังพิมพ์...
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleDMEmojiPicker()"
                                class="w-10 h-10 hover:bg-slate-700 text-slate-400 hover:text-white rounded-full flex items-center justify-center transition"
                                title="Emoji">😊</button>
                            <label
                                class="w-10 h-10 hover:bg-slate-700 text-slate-400 hover:text-white rounded-full flex items-center justify-center transition cursor-pointer"
                                title="แนบรูป">
                                ➕
                                <input type="file" id="dm-image-input" accept="image/*" class="hidden"
                                    onchange="previewDMImage(this)">
                            </label>
                            <input type="text" id="dm-input" placeholder="พิมพ์ข้อความ..."
                                class="flex-1 bg-slate-700 border border-slate-600 rounded-full px-4 py-2 text-sm text-white placeholder-slate-400 focus:border-purple-500 focus:outline-none transition"
                                onkeypress="if(event.key==='Enter') sendDM()" oninput="updateDMTyping()"
                                onpaste="handleDMImagePaste(event)">
                            <button onclick="sendDM()"
                                class="w-10 h-10 bg-purple-500 hover:bg-purple-600 text-white rounded-full flex items-center justify-center transition">
                                <span class="text-lg">📤</span>
                            </button>
                        </div>
                        <!-- DM Emoji Picker -->
                        <div id="dm-emoji-picker"
                            class="hidden mt-2 bg-slate-700 rounded-lg p-2 max-h-32 overflow-y-auto grid grid-cols-10 gap-1 text-lg">
                        </div>
                    </div>
                </div>

                <!-- Messages Container (Windows 11 Style) -->
                <div id="chat-messages" class="h-64 sm:h-80 overflow-y-auto p-4 space-y-3 custom-scrollbar"
                    style="background: rgba(15,23,42,0.6);"
                    ondragover="event.preventDefault(); this.classList.add('ring-2', 'ring-blue-400/50');"
                    ondragleave="this.classList.remove('ring-2', 'ring-blue-400/50');"
                    ondrop="handleChatImageDrop(event); this.classList.remove('ring-2', 'ring-blue-400/50');">
                    <div class="text-center text-slate-500 text-xs py-4">กำลังโหลดข้อความ...</div>
                </div>

                <!-- Input Area (Windows 11 Style) -->
                <div class="p-3" style="background: rgba(30,41,59,0.8); border-top: 1px solid rgba(255,255,255,0.05);">
                    <!-- Group Chat Typing Indicator -->
                    <div id="chat-typing-bar"
                        class="hidden text-xs text-blue-300 animate-pulse mb-2 px-2 flex items-center gap-2">
                        <span class="flex gap-1"><span class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"
                                style="animation-delay: 0ms;"></span><span
                                class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"
                                style="animation-delay: 150ms;"></span><span
                                class="w-1.5 h-1.5 bg-blue-400 rounded-full animate-bounce"
                                style="animation-delay: 300ms;"></span></span>
                        <span id="chat-typing-name"></span> กำลังพิมพ์...
                    </div>
                    <!-- Image Preview -->
                    <div id="chat-image-preview" class="hidden mb-2 relative">
                        <img id="chat-image-preview-img" class="max-h-32 rounded-xl" src="">
                        <button onclick="cancelImageUpload()"
                            class="absolute top-1 right-1 w-6 h-6 bg-red-500/80 hover:bg-red-500 text-white rounded-full text-xs backdrop-blur-sm">✕</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleInputEmojiPicker()"
                            class="w-9 h-9 hover:bg-white/10 text-slate-400 hover:text-white rounded-xl flex items-center justify-center transition"
                            title="Emoji">😊</button>
                        <label
                            class="w-9 h-9 hover:bg-white/10 text-slate-400 hover:text-white rounded-xl flex items-center justify-center transition cursor-pointer"
                            title="แนบรูป">
                            ➕
                            <input type="file" id="chat-image-input" accept="image/*" class="hidden"
                                onchange="previewChatImage(this)">
                        </label>
                        <input type="text" id="chat-input" placeholder="พิมพ์ข้อความ... (@ชื่อ เพื่อเมนชั่น)"
                            class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm text-white placeholder-slate-400 focus:border-blue-500/50 focus:bg-white/10 focus:outline-none transition"
                            onkeypress="if(event.key==='Enter') sendChatMessage()"
                            oninput="updateChatTyping(); checkMention(this)" onpaste="handleChatImagePaste(event)"
                            onkeydown="handleMentionKeydown(event)">
                        <button onclick="sendChatMessage()"
                            class="w-9 h-9 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-400 hover:to-blue-500 text-white rounded-xl flex items-center justify-center transition shadow-lg shadow-blue-500/25">
                            <span class="text-sm">📤</span>
                        </button>
                    </div>
                    <!-- @mention dropdown -->
                    <div id="mention-dropdown"
                        class="hidden absolute bottom-14 left-2 right-2 bg-slate-800/95 backdrop-blur-sm rounded-xl border border-cyan-500/20 shadow-2xl max-h-40 overflow-y-auto z-50">
                    </div>
                    <div id="input-emoji-picker"
                        class="hidden mt-2 bg-slate-700/80 backdrop-blur-sm rounded-xl p-2 flex flex-wrap gap-1 justify-center border border-white/5">
                    </div>
                </div>
            </div>
        </div>

        <!-- DM Bubbles Container - Minimized bubbles above main button -->
        <div id="dm-bubbles-container" class="fixed bottom-20 right-4 z-[180] flex flex-col items-end gap-2">
            <!-- DM bubbles will be dynamically added here -->
        </div>

        <!-- Expanded DM Chats Container - To the LEFT of main button -->
        <div id="dm-expanded-container" class="fixed bottom-4 right-24 z-[180] flex flex-row-reverse items-end gap-2">
            <!-- Expanded DM chats will be rendered here -->
        </div>

        <!-- Chat List Panel (replaces member list) -->
        <div id="chat-list-panel" class="hidden fixed bottom-20 right-4 z-[190] animate-zoom-in">
            <div class="w-80 h-[28rem] rounded-2xl shadow-2xl overflow-hidden"
                style="background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(139,92,246,0.3);">
                <div class="bg-gradient-to-r from-violet-600 to-indigo-600 px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                            </path>
                        </svg>
                        <h4 class="text-white font-bold text-sm">Chat List</h4>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Status Dropdown -->
                        <select id="status-dropdown" onchange="setOnlineStatusFromDropdown(this.value)"
                            class="bg-white/20 text-white text-[10px] rounded-lg px-1.5 py-1 border border-white/30 cursor-pointer outline-none">
                            <option value="online" class="bg-slate-800 text-white">🟢</option>
                            <option value="dnd" class="bg-slate-800 text-white">🔴</option>
                            <option value="away" class="bg-slate-800 text-white">🟠</option>
                        </select>
                        <button onclick="toggleChatList()" class="text-white/70 hover:text-white text-lg">✕</button>
                    </div>
                </div>
                <div id="chat-list-content" class="h-[calc(100%-52px)] overflow-y-auto custom-scrollbar">
                    <div class="text-center text-slate-500 text-xs py-8">กำลังโหลด...</div>
                </div>
            </div>
        </div>

        <script>
            // Firebase Config
            const firebaseConfig = { apiKey: "AIzaSyD_CBHVb_IzcH-gH8nO24dei4jRf3M6gQU", authDomain: "medic-op.firebaseapp.com", projectId: "medic-op", storageBucket: "medic-op.firebasestorage.app", messagingSenderId: "286285926222", appId: "1:286285926222:web:f63fd5455c431ab0de581f" };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const storage = firebase.storage();

            // Development Mode Detection - Localhost uses separate database
            const isDevMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const getDocId = (baseName) => isDevMode ? `${baseName}_dev` : baseName;
            if (isDevMode) console.log('%c🔧 DEV MODE: Using separate database (changes won\'t affect production)', 'background: #f59e0b; color: #000; padding: 4px 8px; border-radius: 4px; font-weight: bold;');
            let currentUser = null;
            let appData = { shiftStart: null, currentOP: null, supOP: null, onDuty: [], offDuty: [], afk: [], afkTimes: {}, cases: [], closedCases: [], medicStatuses: {}, opPendingRequests: [], opHandoverAt: null, handoverNextOP: null, activeEvents: [] };
            let editingCaseId = null;
            let showingHistory = false;

            // Event System Configuration - Default values (will be overwritten from Firebase)
            // These defaults are only used if Firebase has no data
            let EVENT_CONFIG = [
                { id: 'speed-inferno', name: 'SPEED INFERNO', times: [], countsAsOnDuty: false, emoji: '🔥', joinDuration: 10 },
                { id: 'bumper-battle', name: 'BUMPER BATTLE', times: [], countsAsOnDuty: false, emoji: '🚗', joinDuration: 10 },
                { id: 'airdrop', name: 'AIRDROP', times: [], countsAsOnDuty: false, emoji: '📦', joinDuration: 10 },
                { id: 'blue-box', name: 'BLUE BOX', times: [], countsAsOnDuty: true, emoji: '📦', joinDuration: 10 },
                { id: 'battle-strike', name: 'BATTLE STRIKE', times: [], countsAsOnDuty: false, emoji: '⚔️', joinDuration: 10 },
                { id: 'onlyup', name: 'ONLYUP', times: [], countsAsOnDuty: false, emoji: '🧗', joinDuration: 10 }
            ];
            const EVENT_DURATION_MS = 45 * 60 * 1000; // 45 minutes event duration
            const EVENT_JOIN_DURATION_DEFAULT = 10; // Default 10 minutes join window

            // Chat System
            let chatOpen = false;
            let chatMessages = [];
            let chatUnsubscribe = null;
            let lastSeenMessageId = localStorage.getItem('chat_last_seen') || '';
            let chatSoundEnabled = localStorage.getItem('chat_sound_enabled') !== 'false'; // default true
            const chatNotifSound = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3'); // soft ding
            const onlineNotifSound = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1137-eventually.mp3'); // soft gentle chime
            let chatOnlineUnsubscribe = null;
            let replyingTo = null; // For reply feature

            // Music Player - Per User with YouTube Support
            let musicAudio = null;
            let musicPlaying = false;
            let musicMuted = false;
            let musicVolume = 1; // Default 1%
            let musicSettings = { source: 'lofi', youtubeUrl: '', songTitle: 'Lo-Fi Radio' };
            const LOFI_STREAM_URL = 'https://streams.ilovemusic.de/iloveradio17.mp3';

            // YouTube IFrame Player API
            let ytPlayer = null;
            let ytApiLoaded = false;

            function loadYoutubeAPI() {
                if (ytApiLoaded) return;
                const tag = document.createElement('script');
                tag.src = 'https://www.youtube.com/iframe_api';
                document.head.appendChild(tag);
                ytApiLoaded = true;
            }

            function onYouTubeIframeAPIReady() {
                console.log('YouTube IFrame API Ready');
            }

            function getMusicStorageKey() {
                return `music_settings_${currentUser?.username || 'guest'}`;
            }

            function loadMusicSettings() {
                try {
                    const saved = localStorage.getItem(getMusicStorageKey());
                    if (saved) musicSettings = JSON.parse(saved);
                    updateMusicMarquee();
                } catch (e) { }
            }

            function saveMusicSettingsToStorage() {
                try {
                    localStorage.setItem(getMusicStorageKey(), JSON.stringify(musicSettings));
                } catch (e) { }
            }

            // Save/restore music playing state for F5 persistence
            function saveMusicPlayingState() {
                sessionStorage.setItem('music_playing', musicPlaying ? '1' : '0');
            }

            function restoreMusicPlayingState() {
                const wasPlaying = sessionStorage.getItem('music_playing') === '1';
                if (wasPlaying && currentUser) {
                    setTimeout(() => {
                        toggleMusicPlayer(); // Resume playing
                    }, 1000);
                }
            }

            // Stop music completely
            function stopMusic() {
                const playIcon = document.getElementById('music-play-icon');

                // Stop YouTube player
                if (ytPlayer && ytPlayer.stopVideo) {
                    ytPlayer.stopVideo();
                }

                // Stop regular audio
                if (musicAudio) {
                    musicAudio.pause();
                    musicAudio.currentTime = 0;
                }

                musicPlaying = false;
                if (playIcon) playIcon.textContent = '▶';
                sessionStorage.removeItem('music_playing');
            }

            function initMusicPlayer() {
                if (musicSettings.source === 'youtube' && musicSettings.youtubeUrl) {
                    // For YouTube, we'll use iframe embed
                    return;
                }
                if (!musicAudio) {
                    musicAudio = new Audio(LOFI_STREAM_URL);
                    musicAudio.loop = true;
                    musicAudio.volume = musicVolume / 100;
                }
            }

            function extractYoutubeVideoId(url) {
                const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                return match ? match[1] : null;
            }

            function toggleMusicPlayer() {
                const playIcon = document.getElementById('music-play-icon');
                const playBtn = document.getElementById('music-play-btn');
                if (!playIcon) return; // Early return if element not found

                if (musicSettings.source === 'youtube' && musicSettings.youtubeUrl) {
                    const videoId = extractYoutubeVideoId(musicSettings.youtubeUrl);
                    if (videoId) {
                        if (musicPlaying) {
                            // Stop YouTube
                            if (ytPlayer && ytPlayer.stopVideo) {
                                ytPlayer.stopVideo();
                            }
                            playIcon.textContent = '▶';
                        } else {
                            // Load YouTube API if needed
                            loadYoutubeAPI();

                            // Create or update player
                            const createPlayer = () => {
                                if (ytPlayer) {
                                    ytPlayer.loadVideoById(videoId);
                                    ytPlayer.setVolume(musicVolume);
                                } else {
                                    ytPlayer = new YT.Player('music-youtube-player', {
                                        height: '1',
                                        width: '1',
                                        videoId: videoId,
                                        playerVars: {
                                            autoplay: 1
                                        },
                                        events: {
                                            onReady: (e) => {
                                                e.target.setVolume(musicVolume);
                                                if (musicMuted) e.target.mute();
                                            },
                                            onStateChange: onYoutubePlayerStateChange
                                        }
                                    });
                                }
                            };

                            // Wait for API or create immediately
                            if (typeof YT !== 'undefined' && YT.Player) {
                                createPlayer();
                            } else {
                                window.onYouTubeIframeAPIReady = createPlayer;
                            }
                            playIcon.textContent = '⏸';
                        }
                        musicPlaying = !musicPlaying;
                        saveMusicPlayingState();
                        return;
                    }
                }
                // Lo-Fi radio fallback
                initMusicPlayer();
                if (musicPlaying) {
                    if (musicAudio) musicAudio.pause();
                    playIcon.textContent = '▶';
                } else {
                    if (musicAudio) musicAudio.play().catch(e => console.log('Audio play blocked'));
                    playIcon.textContent = '⏸';
                }
                musicPlaying = !musicPlaying;
                saveMusicPlayingState();
            }

            function setMusicVolume(val) {
                musicVolume = Math.min(100, Math.max(0, parseInt(val) || 0));
                if (musicAudio) musicAudio.volume = musicVolume / 100;
                if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(musicVolume);
                const inputEl = document.getElementById('music-volume-input');
                if (inputEl) inputEl.value = musicVolume;
                updateMusicMuteIcon();
            }

            function setMusicVolumeFromInput(val) {
                musicVolume = Math.min(100, Math.max(0, parseInt(val) || 0));
                if (musicAudio) musicAudio.volume = musicVolume / 100;
                if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(musicVolume);
                const sliderEl = document.getElementById('music-volume');
                if (sliderEl) sliderEl.value = musicVolume;
                const inputEl = document.getElementById('music-volume-input');
                if (inputEl) inputEl.value = musicVolume;
                updateMusicMuteIcon();
            }

            function toggleMusicMute() {
                musicMuted = !musicMuted;
                if (musicAudio) musicAudio.muted = musicMuted;
                if (ytPlayer) {
                    if (musicMuted && ytPlayer.mute) ytPlayer.mute();
                    else if (ytPlayer.unMute) ytPlayer.unMute();
                }
                updateMusicMuteIcon();
            }

            function updateMusicMuteIcon() {
                const btn = document.getElementById('music-mute-btn');
                if (!btn) return;
                if (musicMuted || musicVolume === 0) btn.textContent = '🔇';
                else if (musicVolume < 50) btn.textContent = '🔉';
                else btn.textContent = '🔊';
            }

            function updateMusicMarquee() {
                const marquee = document.getElementById('music-marquee');
                if (!marquee) return;
                const title = musicSettings.songTitle || 'Lo-Fi Radio';
                marquee.innerHTML = `🎧 Now Playing... .:: ${title} ::. ✨ 🎧 Now Playing... .:: ${title} ::. ✨`;
            }

            function showMusicSettingsModal() {
                // Reset search state
                document.getElementById('music-search-input').value = '';
                document.getElementById('music-search-results').innerHTML = '<div class="text-center text-slate-500 text-xs py-4">พิมพ์ชื่อเพลงแล้วกด 🔍</div>';

                // Show currently playing if any
                const selectedBox = document.getElementById('music-selected-song');
                const selectedTitle = document.getElementById('music-selected-title');
                if (musicSettings.songTitle && musicSettings.songTitle !== 'Lo-Fi Radio') {
                    selectedBox.classList.remove('hidden');
                    selectedTitle.textContent = musicSettings.songTitle;
                } else {
                    selectedBox.classList.add('hidden');
                }
                selectedMusicItem = null;
                renderPlaylist(); // Render saved playlist
                document.getElementById('music-settings-modal').classList.remove('hidden');
            }

            function closeMusicSettingsModal() {
                document.getElementById('music-settings-modal').classList.add('hidden');
            }

            let selectedMusicItem = null;

            async function searchMusic() {
                const query = document.getElementById('music-search-input').value.trim();
                if (!query) return;

                // Check if user pasted a YouTube URL directly
                const videoId = extractYoutubeVideoId(query);
                if (videoId) {
                    // User pasted a YouTube URL - fetch title and select it
                    try {
                        const title = await fetchYoutubeTitle(query) || 'YouTube Music';
                        selectMusicResult(videoId, title);
                        showNotif('Success', '🎵 ตรวจพบ YouTube URL');
                    } catch (e) {
                        selectMusicResult(videoId, 'YouTube Music');
                    }
                    return;
                }

                const results = document.getElementById('music-search-results');
                results.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">🔍 กำลังค้นหา...</div>';

                // List of Invidious instances to try with CORS proxy
                const instances = [
                    'https://vid.puffyan.us',
                    'https://invidious.fdn.fr',
                    'https://y.com.sb',
                    'https://invidious.nerdvpn.de'
                ];

                for (const instance of instances) {
                    try {
                        // Use corsproxy.io to bypass CORS
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(instance + '/api/v1/search?q=' + encodeURIComponent(query) + '&type=video')}`;
                        const response = await fetch(proxyUrl);
                        const data = await response.json();

                        if (data && data.length > 0) {
                            results.innerHTML = data.slice(0, 8).map(item => `
                            <div class="flex gap-2 p-2 bg-slate-800/50 rounded-lg hover:bg-slate-700/50 cursor-pointer transition" onclick="selectMusicResult('${item.videoId}', '${escapeHtml(item.title.replace(/'/g, "\\'"))}')">
                                <img src="https://img.youtube.com/vi/${item.videoId}/default.jpg" class="w-16 h-12 rounded object-cover shrink-0">
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs text-white truncate">${escapeHtml(item.title)}</div>
                                    <div class="text-[10px] text-slate-400">${item.author || ''}</div>
                                </div>
                            </div>
                        `).join('');
                            return; // Success, exit
                        }
                    } catch (e) {
                        console.log('Search failed for', instance, e);
                        continue; // Try next instance
                    }
                }

                // All instances failed - show error with URL paste option
                results.innerHTML = `
                <div class="text-center text-xs py-4">
                    <div class="text-amber-400 mb-2">⚠️ ค้นหาไม่สำเร็จ</div>
                    <div class="text-slate-500">ลองวาง YouTube URL โดยตรง<br>หรือลองค้นหาอีกครั้ง</div>
                </div>
            `;
            }

            function selectMusicResult(videoId, title) {
                selectedMusicItem = { videoId, title };
                document.getElementById('music-selected-title').textContent = title;
                document.getElementById('music-selected-song').classList.remove('hidden');
            }

            function confirmMusicSelection() {
                if (!selectedMusicItem) {
                    showNotif('Error', 'กรุณาเลือกเพลงก่อน');
                    return;
                }

                const url = `https://www.youtube.com/watch?v=${selectedMusicItem.videoId}`;
                musicSettings.source = 'youtube';
                musicSettings.youtubeUrl = url;
                musicSettings.songTitle = selectedMusicItem.title;

                // Stop current playback
                if (musicPlaying) {
                    musicPlaying = true;
                    toggleMusicPlayer();
                }

                saveMusicSettingsToStorage();
                updateMusicMarquee();
                closeMusicSettingsModal();

                // Auto play the selected song
                if (!musicPlaying) toggleMusicPlayer();

                showNotif('Success', `🎵 เล่น: ${selectedMusicItem.title.substring(0, 30)}...`);
                selectedMusicItem = null;
            }

            // Playlist functions
            function getMusicPlaylist() {
                try {
                    const key = `music_playlist_${currentUser?.username || 'guest'}`;
                    return JSON.parse(localStorage.getItem(key)) || [];
                } catch (e) { return []; }
            }

            function saveMusicPlaylist(playlist) {
                const key = `music_playlist_${currentUser?.username || 'guest'}`;
                localStorage.setItem(key, JSON.stringify(playlist));
            }

            function addToPlaylist() {
                if (!selectedMusicItem) {
                    showNotif('Error', 'กรุณาเลือกเพลงก่อน');
                    return;
                }

                const playlist = getMusicPlaylist();
                // Check if already exists
                if (playlist.some(p => p.videoId === selectedMusicItem.videoId)) {
                    showNotif('Info', 'เพลงนี้อยู่ใน Playlist แล้ว');
                    return;
                }

                playlist.push({
                    videoId: selectedMusicItem.videoId,
                    title: selectedMusicItem.title
                });

                saveMusicPlaylist(playlist);
                renderPlaylist();
                showNotif('Success', `➕ เพิ่มใน Playlist: ${selectedMusicItem.title.substring(0, 25)}...`);
            }

            function removeFromPlaylist(videoId) {
                let playlist = getMusicPlaylist();
                playlist = playlist.filter(p => p.videoId !== videoId);
                saveMusicPlaylist(playlist);
                renderPlaylist();
                showNotif('Success', '🗑️ ลบออกจาก Playlist แล้ว');
            }

            function playFromPlaylist(videoId, title) {
                selectedMusicItem = { videoId, title };
                confirmMusicSelection();
            }

            function renderPlaylist() {
                const container = document.getElementById('music-playlist');
                if (!container) return;

                const playlist = getMusicPlaylist();

                if (playlist.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-500 text-[10px] py-2">ยังไม่มีเพลงใน Playlist</div>';
                    return;
                }

                container.innerHTML = playlist.map(p => `
                <div class="flex items-center gap-2 p-1.5 bg-slate-800/50 rounded-lg hover:bg-slate-700/50 transition group">
                    <button onclick="playFromPlaylist('${p.videoId}', '${escapeHtml(p.title.replace(/'/g, "\\'"))}')" class="text-[10px] text-pink-400 hover:text-pink-300">▶️</button>
                    <div class="flex-1 text-[10px] text-slate-300 truncate">${escapeHtml(p.title)}</div>
                    <button onclick="removeFromPlaylist('${p.videoId}')" class="opacity-0 group-hover:opacity-100 text-[10px] text-red-400 hover:text-red-300 transition">🗑️</button>
                </div>
            `).join('');
            }

            let fetchTitleTimeout = null;
            async function fetchYoutubeTitle(url) {
                const videoId = extractYoutubeVideoId(url);
                if (!videoId) return null;
                try {
                    const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                    const data = await response.json();
                    return data.title || null;
                } catch (e) {
                    console.log('Failed to fetch YouTube title', e);
                    return null;
                }
            }

            function onYoutubeUrlChange() {
                const url = document.getElementById('music-youtube-url').value.trim();
                const titleBox = document.getElementById('music-detected-title');
                const titleText = document.getElementById('music-title-text');

                if (fetchTitleTimeout) clearTimeout(fetchTitleTimeout);

                if (!url || !extractYoutubeVideoId(url)) {
                    titleBox.classList.add('hidden');
                    return;
                }

                titleText.textContent = '⏳ กำลังดึงชื่อ...';
                titleBox.classList.remove('hidden');

                fetchTitleTimeout = setTimeout(async () => {
                    const title = await fetchYoutubeTitle(url);
                    if (title) {
                        titleText.textContent = title;
                        musicSettings.songTitle = title;
                    } else {
                        titleText.textContent = '❌ ไม่สามารถดึงชื่อได้';
                    }
                }, 500);
            }

            async function saveMusicSettings() {
                const url = document.getElementById('music-youtube-url').value.trim();

                if (url && extractYoutubeVideoId(url)) {
                    musicSettings.source = 'youtube';
                    musicSettings.youtubeUrl = url;
                    // Fetch title if not already fetched
                    if (!musicSettings.songTitle || musicSettings.songTitle === 'Lo-Fi Radio') {
                        const title = await fetchYoutubeTitle(url);
                        musicSettings.songTitle = title || 'YouTube Music';
                    }
                } else if (url) {
                    showNotif('Error', 'YouTube URL ไม่ถูกต้อง');
                    return;
                } else {
                    musicSettings.source = 'lofi';
                    musicSettings.youtubeUrl = '';
                    musicSettings.songTitle = 'Lo-Fi Radio';
                }

                // Stop current playback
                if (musicPlaying) {
                    musicPlaying = true;
                    toggleMusicPlayer();
                }

                saveMusicSettingsToStorage();
                updateMusicMarquee();
                closeMusicSettingsModal();
                showNotif('Success', '💾 บันทึกการตั้งค่าเพลงแล้ว');
            }

            function resetToLoFi() {
                musicSettings = { source: 'lofi', youtubeUrl: '', songTitle: 'Lo-Fi Radio' };

                // Safely reset elements (some may not exist in new modal)
                const urlInput = document.getElementById('music-youtube-url');
                if (urlInput) urlInput.value = '';
                const titleEl = document.getElementById('music-detected-title');
                if (titleEl) titleEl.classList.add('hidden');
                const selectedSong = document.getElementById('music-selected-song');
                if (selectedSong) selectedSong.classList.add('hidden');
                selectedMusicItem = null;

                // Stop YouTube if playing
                if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();

                if (musicPlaying) {
                    musicPlaying = true;
                    toggleMusicPlayer();
                }

                saveMusicSettingsToStorage();
                updateMusicMarquee();
                closeMusicSettingsModal();
                showNotif('Success', '🔄 รีเซ็ตเป็น Lo-Fi Radio');
            }

            // Playlist Playback Modes
            let playlistMode = 'auto'; // auto, shuffle, loop
            let currentPlaylistIndex = -1;

            function cyclePlaylistMode() {
                const modes = ['auto', 'shuffle', 'loop'];
                const currentIdx = modes.indexOf(playlistMode);
                playlistMode = modes[(currentIdx + 1) % modes.length];
                updatePlaylistModeBtn();

                const labels = { auto: '🔁 Auto', shuffle: '🔀 Shuffle', loop: '🔂 Loop' };
                showNotif('Info', `โหมดเล่น: ${labels[playlistMode]}`);
            }

            function updatePlaylistModeBtn() {
                const btn = document.getElementById('playlist-mode-btn');
                if (!btn) return;
                const labels = { auto: '🔁 Auto', shuffle: '🔀 Shuffle', loop: '🔂 Loop' };
                btn.textContent = labels[playlistMode];
            }

            function playNextFromPlaylist() {
                const playlist = getMusicPlaylist();
                if (playlist.length === 0) return;

                if (playlistMode === 'loop') {
                    // Replay current song
                    if (currentPlaylistIndex >= 0 && currentPlaylistIndex < playlist.length) {
                        const item = playlist[currentPlaylistIndex];
                        selectedMusicItem = { videoId: item.videoId, title: item.title };
                        confirmMusicSelection();
                    }
                } else if (playlistMode === 'shuffle') {
                    // Random song
                    const randomIdx = Math.floor(Math.random() * playlist.length);
                    currentPlaylistIndex = randomIdx;
                    const item = playlist[randomIdx];
                    selectedMusicItem = { videoId: item.videoId, title: item.title };
                    confirmMusicSelection();
                } else { // auto
                    // Next song in order
                    currentPlaylistIndex = (currentPlaylistIndex + 1) % playlist.length;
                    const item = playlist[currentPlaylistIndex];
                    selectedMusicItem = { videoId: item.videoId, title: item.title };
                    confirmMusicSelection();
                }
            }

            // Play Next Track button handler
            function playNextTrack() {
                const playlist = getMusicPlaylist();
                if (playlist.length === 0) {
                    showNotif('Info', '📜 ยังไม่มีเพลงใน Playlist');
                    return;
                }
                currentPlaylistIndex = (currentPlaylistIndex + 1) % playlist.length;
                const item = playlist[currentPlaylistIndex];
                selectedMusicItem = { videoId: item.videoId, title: item.title };
                confirmMusicSelection();
            }

            // Play Previous Track button handler
            function playPreviousTrack() {
                const playlist = getMusicPlaylist();
                if (playlist.length === 0) {
                    showNotif('Info', '📜 ยังไม่มีเพลงใน Playlist');
                    return;
                }
                currentPlaylistIndex = (currentPlaylistIndex - 1 + playlist.length) % playlist.length;
                const item = playlist[currentPlaylistIndex];
                selectedMusicItem = { videoId: item.videoId, title: item.title };
                confirmMusicSelection();
            }

            // Hook into YouTube player to detect song end
            function onYoutubePlayerStateChange(event) {
                if (event.data === YT.PlayerState.ENDED) {
                    playNextFromPlaylist();
                }
            }

            // ==================== CHAT SYSTEM ====================
            function toggleChatBox() {
                chatOpen = !chatOpen;
                const window = document.getElementById('chat-window');
                const icon = document.getElementById('chat-icon');
                const label = document.getElementById('chat-label');
                const unread = document.getElementById('chat-unread');
                const memberPanel = document.getElementById('chat-online-panel');

                if (chatOpen) {
                    // Close member list if open to prevent overlap
                    if (memberPanel && !memberPanel.classList.contains('hidden')) {
                        memberPanel.classList.add('hidden');
                    }

                    // Close chat list if open
                    const chatListPanel = document.getElementById('chat-list-panel');
                    if (chatListPanel && !chatListPanel.classList.contains('hidden')) {
                        chatListPanel.classList.add('hidden');
                        chatListOpen = false;
                    }

                    if (window) window.classList.remove('hidden');
                    if (icon) icon.textContent = '✕';
                    if (label) label.textContent = 'ปิด';
                    // Mark as seen
                    if (chatMessages.length > 0) {
                        lastSeenMessageId = chatMessages[chatMessages.length - 1].id;
                        localStorage.setItem('chat_last_seen', lastSeenMessageId);
                    }
                    if (unread) unread.classList.add('hidden');
                    // Focus input
                    setTimeout(() => {
                        const input = document.getElementById('chat-input');
                        if (input) input.focus();
                    }, 100);
                    // Scroll to bottom
                    const container = document.getElementById('chat-messages');
                    if (container) container.scrollTop = container.scrollHeight;
                    // Mark group chat as read
                    markGroupChatAsRead();
                } else {
                    if (window) window.classList.add('hidden');
                    if (icon) icon.textContent = '💬';
                    if (label) label.textContent = 'แชท';
                }
            }

            // Group Chat Read Status System
            let groupChatReadStatus = {}; // { messageId: { userName: timestamp, ... } }
            let groupChatReadUnsubscribe = null;

            // Mark group chat messages as read
            function markGroupChatAsRead() {
                if (!currentUser || isGuest() || chatMessages.length === 0) return;
                const myName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || '';
                const now = firebase.firestore.FieldValue.serverTimestamp();

                // Mark ALL messages from others as read
                chatMessages.forEach(msg => {
                    if (msg.sender !== myName) {
                        // Only mark if not already marked by me
                        const readData = groupChatReadStatus[msg.id] || {};
                        if (!readData[myName]) {
                            db.collection('group_chat_read').doc(msg.id).set({
                                [myName]: now
                            }, { merge: true }).catch(() => { });
                        }
                    }
                });
            }

            // Listen to group chat read status
            function listenGroupChatReadStatus() {
                if (groupChatReadUnsubscribe) groupChatReadUnsubscribe();

                groupChatReadUnsubscribe = db.collection('group_chat_read').onSnapshot(snap => {
                    groupChatReadStatus = {};
                    snap.docs.forEach(doc => {
                        groupChatReadStatus[doc.id] = doc.data();
                    });
                    // Update read count display
                    updateGroupChatReadCounts();
                });
            }

            // Update read count display on messages
            function updateGroupChatReadCounts() {
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                chatMessages.forEach(m => {
                    if (m.sender === myName) {
                        const readData = groupChatReadStatus[m.id] || {};
                        const readers = Object.keys(readData).filter(name => name !== myName);
                        const countEl = document.getElementById(`read-count-${m.id}`);
                        if (countEl) {
                            if (readers.length > 0) {
                                countEl.textContent = `✓ อ่านแล้ว ${readers.length} คน`;
                                countEl.classList.remove('hidden');
                            } else {
                                countEl.classList.add('hidden');
                            }
                        }
                    }
                });
            }

            async function sendChatMessage() {
                if (!currentUser || isGuest()) return showNotif('Error', 'กรุณาเข้าสู่ระบบเพื่อแชท');
                const input = document.getElementById('chat-input');
                const message = input.value.trim();

                // Need either message or image
                if (!message && !chatImageData) return;

                try {
                    const firstName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || currentUser.username;
                    const msgData = {
                        text: message,
                        sender: firstName,
                        senderAvatar: currentUser.avatar || '',
                        senderRole: currentUser.role || 'Member',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Include reply info if replying
                    if (replyingTo) {
                        msgData.replyTo = {
                            id: replyingTo.id,
                            sender: replyingTo.sender,
                            text: replyingTo.text
                        };
                    }

                    // Include image if attached
                    if (chatImageData) {
                        msgData.image = chatImageData;
                    }

                    await db.collection('chat').add(msgData);
                    input.value = '';
                    cancelReply(); // Clear reply after sending
                    cancelImageUpload(); // Clear image after sending
                } catch (e) {
                    showNotif('Error', 'ส่งข้อความไม่สำเร็จ');
                }
            }

            // @Mention System
            let mentionIndex = -1;
            let mentionList = [];

            function checkMention(input) {
                const text = input.value;
                const match = text.match(/@(\w*)$/);
                const dropdown = document.getElementById('mention-dropdown');

                if (match) {
                    const query = match[1].toLowerCase();
                    // Get all users from allUsers
                    mentionList = allUsers
                        .map(u => u.firstName || u.fullName?.split(' ')[0] || u.id)
                        .filter(name => name.toLowerCase().includes(query))
                        .slice(0, 8);

                    if (mentionList.length > 0) {
                        mentionIndex = 0;
                        renderMentionDropdown();
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.classList.add('hidden');
                    }
                } else {
                    dropdown.classList.add('hidden');
                    mentionList = [];
                }
            }

            function renderMentionDropdown() {
                const dropdown = document.getElementById('mention-dropdown');
                dropdown.innerHTML = mentionList.map((name, i) => `
                <div class="px-3 py-2 text-sm cursor-pointer transition ${i === mentionIndex ? 'bg-cyan-500/30 text-white' : 'text-slate-300 hover:bg-slate-700'}"
                    onclick="selectMention('${escapeHtml(name)}')">
                    @${escapeHtml(name)}
                </div>
            `).join('');
            }

            function handleMentionKeydown(e) {
                const dropdown = document.getElementById('mention-dropdown');
                if (dropdown.classList.contains('hidden')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    mentionIndex = Math.min(mentionIndex + 1, mentionList.length - 1);
                    renderMentionDropdown();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    mentionIndex = Math.max(mentionIndex - 1, 0);
                    renderMentionDropdown();
                } else if (e.key === 'Enter' && mentionList.length > 0) {
                    e.preventDefault();
                    selectMention(mentionList[mentionIndex]);
                } else if (e.key === 'Escape') {
                    dropdown.classList.add('hidden');
                }
            }

            function selectMention(name) {
                const input = document.getElementById('chat-input');
                input.value = input.value.replace(/@\w*$/, `@${name} `);
                document.getElementById('mention-dropdown').classList.add('hidden');
                input.focus();
            }
            function loadChatMessages() {
                if (chatUnsubscribe) chatUnsubscribe();

                // Listen for messages from last 7 days
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                chatUnsubscribe = db.collection('chat')
                    .where('timestamp', '>', oneWeekAgo)
                    .orderBy('timestamp', 'asc')
                    .limitToLast(100)
                    .onSnapshot(snap => {
                        const prevLength = chatMessages.length;
                        chatMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderChatMessages();
                        updateGroupChatReadCounts(); // Update read counts after render

                        // Update unread count and play sound
                        if (!chatOpen && chatMessages.length > prevLength) {
                            updateChatUnread();
                            // Play notification sound if enabled and message is from others
                            const lastMsg = chatMessages[chatMessages.length - 1];
                            const myFirstName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                            if (chatSoundEnabled && lastMsg && lastMsg.sender !== myFirstName) {
                                chatNotifSound.volume = 0.5;
                                chatNotifSound.play().catch(() => { });
                            }
                        }

                        // Show Owner clear button
                        const clearBtn = document.getElementById('chat-clear-btn');
                        if (clearBtn && currentUser?.role === 'Owner') {
                            clearBtn.classList.remove('hidden');
                        }

                        // Update sound button icon
                        updateChatSoundBtn();
                    });

                // Track online presence
                updateChatPresence();
                loadOnlineUsers();
                loadGuestCount(); // Load guest count for Owner

                // Initialize PeerJS for voice calls - CALL_FEATURE
                initPeer();

                // Listen for typing indicators
                listenChatTyping();

                // Load user settings for blocking
                loadUserSettings();

                // Listen for group chat read status
                listenGroupChatReadStatus();
            }

            async function updateChatPresence() {
                if (!currentUser || isGuest()) return;
                const firstName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || currentUser.username;
                try {
                    await db.collection('chat_presence').doc(firstName).set({
                        name: firstName,
                        avatar: currentUser.avatar || '',
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) { }
            }

            // Track previous online users for detecting new logins
            let previousOnlineNames = [];
            let guestCountUnsubscribe = null;

            // Guest presence tracking
            async function updateGuestPresence() {
                if (!currentUser?.guestId) return;
                try {
                    await db.collection('guest_presence').doc(currentUser.guestId).set({
                        guestId: currentUser.guestId,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) { }
            }

            function removeGuestPresence() {
                if (!currentUser?.guestId) return;
                try {
                    db.collection('guest_presence').doc(currentUser.guestId).delete();
                } catch (e) { }
            }

            // Load guest count for Owner
            function loadGuestCount() {
                if (guestCountUnsubscribe) guestCountUnsubscribe();
                if (currentUser?.role !== 'Owner') return;

                const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000);
                guestCountUnsubscribe = db.collection('guest_presence')
                    .where('lastActive', '>', fiveMinAgo)
                    .onSnapshot(snap => {
                        const guestCount = snap.docs.length;
                        const guestCountEl = document.getElementById('guest-count-display');
                        if (guestCountEl) {
                            if (guestCount > 0) {
                                guestCountEl.classList.remove('hidden');
                                guestCountEl.innerHTML = `<span class="text-[10px]">👁️</span><span class="text-[10px] text-slate-400">${guestCount}</span>`;
                            } else {
                                guestCountEl.classList.add('hidden');
                            }
                        }
                    });
            }

            function loadOnlineUsers() {
                if (chatOnlineUnsubscribe) chatOnlineUnsubscribe();
                // Consider users active within last 5 minutes
                const fiveMinAgo = new Date(Date.now() - 5 * 60 * 1000);

                chatOnlineUnsubscribe = db.collection('chat_presence')
                    .where('lastActive', '>', fiveMinAgo)
                    .onSnapshot(snap => {
                        const onlineUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        const onlineCount = onlineUsers.length;
                        const countEl = document.getElementById('chat-online-count');
                        if (countEl) countEl.textContent = `${onlineCount} คนออนไลน์`;

                        // Detect new online/offline users (Owner only)
                        if (currentUser?.role === 'Owner') {
                            const currentOnlineNames = onlineUsers.map(u => u.name);
                            const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';

                            // Get session notified users
                            const notifiedOnline = JSON.parse(sessionStorage.getItem('notified_online') || '[]');
                            const notifiedOffline = JSON.parse(sessionStorage.getItem('notified_offline') || '[]');

                            // Find newly online users (not previously online, not myself, not already notified this session)
                            const newlyOnline = currentOnlineNames.filter(name =>
                                !previousOnlineNames.includes(name) && name !== myName && !notifiedOnline.includes(name)
                            );

                            // Find newly offline users (was online but not anymore, not myself, not already notified this session)
                            const newlyOffline = previousOnlineNames.filter(name =>
                                !currentOnlineNames.includes(name) && name !== myName && !notifiedOffline.includes(name)
                            );

                            // Show notification for each new online user
                            newlyOnline.forEach(name => {
                                showOnlineNotification(name);
                                notifiedOnline.push(name);
                            });

                            // Show notification for each offline user
                            newlyOffline.forEach(name => {
                                showOfflineNotification(name);
                                notifiedOffline.push(name);
                                // Remove from notifiedOnline so they can be notified again when they come back
                                const idx = notifiedOnline.indexOf(name);
                                if (idx > -1) notifiedOnline.splice(idx, 1);
                            });

                            // Save to sessionStorage
                            sessionStorage.setItem('notified_online', JSON.stringify(notifiedOnline));
                            sessionStorage.setItem('notified_offline', JSON.stringify(notifiedOffline));

                            previousOnlineNames = currentOnlineNames;
                        }

                        // Store for rendering list
                        window.chatOnlineUsers = onlineUsers;
                        renderOnlineUsersList();
                    });
            }

            // Show brief online notification toast (Owner only)
            function showOnlineNotification(userName) {
                // Play soft notification sound
                try {
                    onlineNotifSound.currentTime = 0;
                    onlineNotifSound.volume = 0.2; // soft volume
                    onlineNotifSound.play().catch(e => { });
                } catch (e) { }

                // Create or get notification container
                let container = document.getElementById('presence-notif-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'presence-notif-container';
                    container.className = 'fixed bottom-4 left-4 z-[300] flex flex-col-reverse gap-2';
                    document.body.appendChild(container);
                }

                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'animate-zoom-in transition-all duration-300';
                toast.innerHTML = `
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg shadow-2xl border border-emerald-500/30"
                    style="background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(6,182,212,0.15) 100%); backdrop-filter: blur(16px);">
                    <div class="w-2.5 h-2.5 bg-emerald-400 rounded-full animate-pulse"></div>
                    <span class="text-sm text-white"><span class="font-semibold text-emerald-300">${escapeHtml(userName)}</span> ออนไลน์แล้ว</span>
                </div>
            `;
                container.appendChild(toast);

                // Remove after 7 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-100px)';
                    setTimeout(() => {
                        toast.remove();
                        // Remove container if empty
                        if (container.children.length === 0) container.remove();
                    }, 300);
                }, 7000);
            }

            // Show brief offline notification toast (Owner only)
            function showOfflineNotification(userName) {
                // Play soft notification sound (same sound, slightly different feel)
                try {
                    onlineNotifSound.currentTime = 0;
                    onlineNotifSound.volume = 0.15; // slightly softer for offline
                    onlineNotifSound.play().catch(e => { });
                } catch (e) { }

                // Create or get notification container
                let container = document.getElementById('presence-notif-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'presence-notif-container';
                    container.className = 'fixed bottom-4 left-4 z-[300] flex flex-col-reverse gap-2';
                    document.body.appendChild(container);
                }

                // Create toast element (gray/slate theme for offline)
                const toast = document.createElement('div');
                toast.className = 'animate-zoom-in transition-all duration-300';
                toast.innerHTML = `
                <div class="flex items-center gap-2 px-4 py-2.5 rounded-lg shadow-2xl border border-slate-500/30"
                    style="background: linear-gradient(135deg, rgba(100,116,139,0.2) 0%, rgba(71,85,105,0.15) 100%); backdrop-filter: blur(16px);">
                    <div class="w-2.5 h-2.5 bg-slate-400 rounded-full"></div>
                    <span class="text-sm text-white"><span class="font-semibold text-slate-300">${escapeHtml(userName)}</span> ออฟไลน์แล้ว</span>
                </div>
            `;
                container.appendChild(toast);

                // Remove after 7 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-100px)';
                    setTimeout(() => {
                        toast.remove();
                        // Remove container if empty
                        if (container.children.length === 0) container.remove();
                    }, 300);
                }, 7000);
            }


            function toggleOnlineUsersPanel() {
                const panel = document.getElementById('chat-online-panel');
                if (!panel) return;

                const isOpening = panel.classList.contains('hidden');

                // If opening member list, close chat to prevent overlap
                if (isOpening && chatOpen) {
                    toggleChatBox();
                }

                panel.classList.toggle('hidden');
            }

            // Chat List state
            let chatListOpen = false;

            // Toggle Chat List panel
            function toggleChatList() {
                const panel = document.getElementById('chat-list-panel');
                if (!panel) return;

                chatListOpen = !chatListOpen;

                if (chatListOpen) {
                    // Close any open DM chats when opening chat list
                    Object.keys(openDMBubbles).forEach(name => {
                        if (!openDMBubbles[name].minimized) {
                            openDMBubbles[name].minimized = true;
                        }
                    });
                    renderDMBubbles();

                    panel.classList.remove('hidden');
                    renderChatList();
                } else {
                    panel.classList.add('hidden');
                }
            }

            // Cache user settings for blocking check
            let cachedUserSettings = {};

            function loadUserSettings() {
                db.collection('user_settings').onSnapshot(snap => {
                    snap.docs.forEach(doc => {
                        cachedUserSettings[doc.id] = doc.data();
                    });
                    if (chatListOpen) renderChatList();
                });
            }

            // Store last messages for chat list
            let lastDMMessages = {};

            // Render Chat List with Group Chat + Online/Offline sections
            function renderChatList() {
                const container = document.getElementById('chat-list-content');
                if (!container) return;

                const registeredUsers = allUsers || [];
                const onlineUsers = window.chatOnlineUsers || [];
                const onlineNames = onlineUsers.map(u => u.name);
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';

                // Filter out self
                const otherUsers = registeredUsers.filter(u => {
                    const uName = u.firstName || u.fullName?.split(' ')[0];
                    return uName && uName !== myName;
                });

                let html = '';

                // ===== GROUP CHAT SECTION =====
                const groupUnread = chatOpen ? 0 : (chatMessages.length - (chatMessages.findIndex(m => m.id === lastSeenMessageId) + 1));
                const lastGroupMsg = chatMessages.length > 0 ? chatMessages[chatMessages.length - 1] : null;
                const lastGroupMsgText = lastGroupMsg ? (lastGroupMsg.text || (lastGroupMsg.image ? '📷 รูปภาพ' : '')) : 'ยังไม่มีข้อความ';
                const lastGroupMsgTime = lastGroupMsg?.timestamp?.toDate?.() ? new Date(lastGroupMsg.timestamp.toDate()).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';

                html += `
                <div class="flex items-center gap-3 px-3 py-3 hover:bg-white/5 transition cursor-pointer border-b border-white/10 bg-gradient-to-r from-blue-500/10 to-transparent"
                    onclick="openGroupChatFromList()">
                    <div class="w-11 h-11 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg shrink-0">
                        <span class="text-xl">💬</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-white text-sm font-bold">แชทกลุ่ม OP</span>
                            <span class="text-blue-400 text-[10px]">${onlineNames.length} ออนไลน์</span>
                            ${groupUnread > 0 ? `<span class="bg-rose-500 text-white text-[10px] font-bold min-w-4 h-4 px-1 rounded-full flex items-center justify-center">${groupUnread > 99 ? '99+' : groupUnread}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-slate-400 text-xs truncate flex-1">${escapeHtml(lastGroupMsgText.slice(0, 28))}${lastGroupMsgText.length > 28 ? '...' : ''}</span>
                            ${lastGroupMsgTime ? `<span class="text-slate-500 text-[10px] shrink-0">${lastGroupMsgTime}</span>` : ''}
                        </div>
                    </div>
                    <div class="w-8 h-8 bg-blue-500/20 text-blue-400 rounded-lg flex items-center justify-center text-sm shrink-0">→</div>
                </div>
            `;

                // Helper to get last message timestamp for sorting
                const getLastMsgTime = (user) => {
                    const name = user.firstName || user.fullName?.split(' ')[0];
                    const chatId = getDMChatId(myName, name);
                    const lastMsg = lastDMMessages[chatId];
                    return lastMsg?.timestamp?.toDate?.()?.getTime() || 0;
                };

                // ===== ONLINE USERS SECTION =====
                const onlineOtherUsers = otherUsers.filter(u => {
                    const uName = u.firstName || u.fullName?.split(' ')[0];
                    return onlineNames.includes(uName);
                });

                // Sort by most recent chat first
                onlineOtherUsers.sort((a, b) => getLastMsgTime(b) - getLastMsgTime(a));

                if (onlineOtherUsers.length > 0) {
                    html += `<div class="flex items-center gap-2 px-3 py-2 bg-slate-800/50">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-green-400 text-xs font-bold">ออนไลน์ (${onlineOtherUsers.length})</span>
                </div>`;

                    onlineOtherUsers.forEach(user => {
                        html += renderChatListItem(user, myName, true);
                    });
                }

                // ===== OFFLINE USERS SECTION =====
                const offlineUsers = otherUsers.filter(u => {
                    const uName = u.firstName || u.fullName?.split(' ')[0];
                    return !onlineNames.includes(uName);
                });

                // Sort by most recent chat first
                offlineUsers.sort((a, b) => getLastMsgTime(b) - getLastMsgTime(a));

                if (offlineUsers.length > 0) {
                    html += `<div class="flex items-center gap-2 px-3 py-2 bg-slate-800/50 mt-1">
                    <span class="w-2 h-2 bg-slate-500 rounded-full"></span>
                    <span class="text-slate-400 text-xs font-bold">ออฟไลน์ (${offlineUsers.length})</span>
                </div>`;

                    offlineUsers.forEach(user => {
                        html += renderChatListItem(user, myName, false);
                    });
                }

                if (otherUsers.length === 0) {
                    html += '<div class="text-center text-slate-500 text-xs py-8">ไม่มีสมาชิกอื่น</div>';
                }

                container.innerHTML = html;
            }

            // Helper to render a single chat list item
            function renderChatListItem(user, myName, isOnline) {
                const name = user.firstName || user.fullName?.split(' ')[0];
                const avatar = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=8b5cf6&color=fff&size=48`;

                // Get user status (DND/Away)
                const userSettings = cachedUserSettings[name] || {};
                const status = userSettings.onlineStatus || 'online';
                let statusColor = isOnline ? 'bg-green-500' : 'bg-slate-500';
                if (isOnline && status === 'dnd') statusColor = 'bg-red-500';
                if (isOnline && status === 'away') statusColor = 'bg-amber-500';

                // Get last message
                const chatId = getDMChatId(myName, name);
                const lastMsg = lastDMMessages[chatId];
                const lastMsgText = lastMsg ? (lastMsg.text || (lastMsg.image ? '📷 รูปภาพ' : '')) : 'เริ่มสนทนา...';
                const lastMsgTime = lastMsg?.timestamp?.toDate?.() ? new Date(lastMsg.timestamp.toDate()).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';

                // Unread count
                const bubbleData = openDMBubbles[name];
                const unreadCount = bubbleData?.unread || 0;

                return `
                <div class="flex items-center gap-3 px-3 py-2.5 hover:bg-white/5 transition cursor-pointer border-b border-white/5 ${!isOnline ? 'opacity-60' : ''}"
                    onclick="openDMFromChatList('${escapeHtml(name)}', '${escapeHtml(avatar)}')">
                    <div class="relative shrink-0">
                        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover" 
                            onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=8b5cf6&color=fff&size=48';">
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 ${statusColor} rounded-full border-2 border-slate-800"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="text-white text-sm font-medium truncate">${escapeHtml(name)}</span>
                            ${unreadCount > 0 ? `<span class="bg-rose-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center">${unreadCount > 9 ? '9+' : unreadCount}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-slate-400 text-[11px] truncate flex-1">${escapeHtml(lastMsgText.slice(0, 25))}${lastMsgText.length > 25 ? '...' : ''}</span>
                            ${lastMsgTime ? `<span class="text-slate-500 text-[10px] shrink-0">${lastMsgTime}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); openDMFromChatList('${escapeHtml(name)}', '${escapeHtml(avatar)}')"
                        class="w-8 h-8 bg-violet-500/20 hover:bg-violet-500/40 text-violet-400 rounded-lg flex items-center justify-center transition text-sm shrink-0">
                        💬
                    </button>
                </div>
            `;
            }

            // Open Group Chat from Chat List
            function openGroupChatFromList() {
                // Close chat list
                chatListOpen = false;
                document.getElementById('chat-list-panel')?.classList.add('hidden');

                // Open group chat window
                if (!chatOpen) toggleChatBox();
            }

            // Open DM from Chat List
            function openDMFromChatList(name, avatar) {
                // Close chat list
                chatListOpen = false;
                document.getElementById('chat-list-panel')?.classList.add('hidden');

                // Close all other DM bubbles (only show one at a time)
                Object.keys(openDMBubbles).forEach(n => {
                    if (n !== name) {
                        openDMBubbles[n].minimized = true;
                    }
                });

                // Create or expand this bubble
                if (!openDMBubbles[name]) {
                    createDMBubble(name, avatar, false); // false = start expanded
                } else {
                    openDMBubbles[name].minimized = false;
                }

                renderDMBubbles();
            }

            // Listen to last messages for all users
            function listenToLastMessages() {
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const registeredUsers = allUsers || [];

                registeredUsers.forEach(user => {
                    const name = user.firstName || user.fullName?.split(' ')[0];
                    if (!name || name === myName) return;

                    const chatId = getDMChatId(myName, name);
                    db.collection('dm_chats').doc(chatId).collection('messages')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .onSnapshot(snap => {
                            if (snap.docs.length > 0) {
                                lastDMMessages[chatId] = snap.docs[0].data();
                                if (chatListOpen) renderChatList();
                            }
                        });
                });
            }

            function renderOnlineUsersList() {
                const container = document.getElementById('chat-online-list');
                if (!container) return;

                const onlineUsers = window.chatOnlineUsers || [];
                const onlineNames = onlineUsers.map(u => u.name);
                // Use allUsers for offline list (contains all registered users from op_users collection)
                const registeredUsers = allUsers || [];
                const themeHex = (serverSettings?.themeColor || '#06b6d4').replace('#', '');
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';

                console.log('renderOnlineUsersList - registeredUsers:', registeredUsers.length, 'onlineUsers:', onlineUsers.length);

                // Windows 11 style - Online section
                let html = `<div class="flex items-center gap-2 mb-3">
        <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
        <span class="text-xs font-semibold text-emerald-400 uppercase tracking-wide">ออนไลน์</span>
        <span class="text-[10px] text-slate-500">(${onlineUsers.length})</span>
    </div>`;

                if (onlineUsers.length === 0) {
                    html += '<div class="text-xs text-slate-500 py-3 text-center" style="background: rgba(255,255,255,0.02); border-radius: 12px;">ไม่มีใครออนไลน์</div>';
                } else {
                    html += onlineUsers.map(u => {
                        const isMe = u.name === myName;
                        const userSettings = cachedUserSettings[u.name] || {};
                        // Get online status (default to online for backward compatibility)
                        const status = userSettings.onlineStatus || 'online';
                        const canCall = status === 'online'; // Only online allows calls

                        // Status colors and labels
                        const statusColors = { online: 'bg-emerald-500', dnd: 'bg-red-500', away: 'bg-orange-500' };
                        const statusLabels = { online: 'ออนไลน์', dnd: 'ห้ามรบกวน', away: 'ไม่อยู่' };
                        const dotColor = statusColors[status] || 'bg-emerald-500';
                        const statusLabel = statusLabels[status] || 'ออนไลน์';

                        // Avatar src
                        const avatarSrc = (u.avatar && u.avatar !== '---' && u.avatar !== '-')
                            ? u.avatar
                            : `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=${themeHex}&color=fff&size=40`;

                        return `
            <div class="flex items-center gap-3 p-2.5 mb-1.5 group transition-all cursor-pointer hover:scale-[1.02]" 
                style="background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%); border-radius: 12px; border: 1px solid rgba(16,185,129,0.15);"
                onclick="${!isMe ? `showProfileMenu(event, '${escapeHtml(u.name)}', '${u.avatar || ''}')` : ''}">
                <div class="relative">
                    <img src="${avatarSrc}" 
                        class="w-10 h-10 rounded-xl border border-white/10 shadow-lg"
                        onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=${themeHex}&color=fff&size=40'">
                    <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 ${dotColor} rounded-full border-2 border-slate-900 shadow-lg"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm text-white font-medium truncate">${escapeHtml(u.name)}${isMe ? ' <span class="text-emerald-400 text-[10px]">(คุณ)</span>' : ''}</div>
                    <div class="text-[10px] ${status === 'online' ? 'text-emerald-300/70' : status === 'dnd' ? 'text-red-300/70' : 'text-orange-300/70'}">${statusLabel}</div>
                </div>
                ${!isMe ? `
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="event.stopPropagation(); openDM('${escapeHtml(u.name)}', '${u.avatar || ''}')" 
                            class="w-8 h-8 bg-blue-500/20 hover:bg-blue-500/40 text-blue-300 rounded-lg flex items-center justify-center text-sm transition" 
                            title="แชทส่วนตัว">💬</button>
                        <button onclick="event.stopPropagation(); ${canCall ? `initiateCall('${escapeHtml(u.name)}')` : `showDNDCallPopup('${escapeHtml(u.name)}')`}" 
                            class="w-8 h-8 ${canCall ? 'bg-green-500/20 hover:bg-green-500/40 text-green-300' : 'bg-slate-600/20 text-slate-500'} rounded-lg flex items-center justify-center text-sm transition" 
                            title="${canCall ? 'โทร' : 'ไม่สามารถโทรได้'}">📞</button>
                    </div>
                ` : ''}
            </div>
        `}).join('');
                }

                // Windows 11 style - Offline section (use registeredUsers from allUsers)
                const offlineUsers = registeredUsers.filter(r => !onlineNames.includes(r.firstName || r.fullName?.split(' ')[0]));
                if (offlineUsers.length > 0) {
                    html += `<div class="flex items-center gap-2 mt-5 mb-3">
            <div class="w-2 h-2 rounded-full bg-slate-500"></div>
            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">ออฟไลน์</span>
            <span class="text-[10px] text-slate-600">(${offlineUsers.length})</span>
        </div>`;

                    html += offlineUsers.slice(0, 30).map(r => {
                        const name = r.firstName || r.fullName?.split(' ')[0] || 'Unknown';

                        // --- แก้ไขจุดที่ 2: ตรวจสอบ URL รูปภาพ และเพิ่ม onerror (สำหรับ Offline) ---
                        const offlineAvatarSrc = (r.avatar && r.avatar !== '---' && r.avatar !== '-')
                            ? r.avatar
                            : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=475569&color=fff&size=40`;

                        return `
                <div class="flex items-center gap-3 p-2.5 mb-1.5 opacity-50 hover:opacity-70 transition cursor-pointer"
                    style="background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03);"
                    onclick="showProfileMenu(event, '${escapeHtml(name)}', '${r.avatar || ''}')">
                    <div class="relative">
                        <img src="${offlineAvatarSrc}" 
                            class="w-10 h-10 rounded-xl border border-white/5 grayscale"
                            onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=475569&color=fff&size=40'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-slate-400 font-medium truncate">${escapeHtml(name)}</div>
                        <div class="text-[10px] text-slate-500">ออฟไลน์</div>
                    </div>
                </div>
            `;
                    }).join('');
                }

                container.innerHTML = html;
            }

            // Play chat notification sound helper
            function playChatNotifSound() {
                if (!chatSoundEnabled) return;
                try {
                    chatNotifSound.currentTime = 0;
                    chatNotifSound.volume = 0.3;
                    chatNotifSound.play().catch(e => console.log('Sound error:', e));
                } catch (e) { }
            }

            // Group Chat Typing Indicator
            let chatTypingTimeout = null;

            function updateChatTyping() {
                if (!currentUser) return;
                const myName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || '';

                db.collection('chat_typing').doc('status').set({
                    [myName]: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                clearTimeout(chatTypingTimeout);
                chatTypingTimeout = setTimeout(() => clearChatTyping(), 3000);
            }

            function clearChatTyping() {
                if (!currentUser) return;
                const myName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || '';

                db.collection('chat_typing').doc('status').set({
                    [myName]: null
                }, { merge: true });
            }

            function listenChatTyping() {
                if (!currentUser) return;
                const myName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || '';

                db.collection('chat_typing').doc('status').onSnapshot(snap => {
                    const data = snap.data() || {};
                    const typingBar = document.getElementById('chat-typing-bar');
                    const typingName = document.getElementById('chat-typing-name');

                    // Find someone who is typing (not me)
                    const typers = Object.keys(data).filter(name => {
                        if (name === myName || !data[name]) return false;
                        const typingTime = data[name]?.toDate?.() || new Date(0);
                        return (Date.now() - typingTime.getTime()) < 5000;
                    });

                    if (typers.length > 0) {
                        if (typingBar) typingBar.classList.remove('hidden');
                        if (typingName) typingName.textContent = typers.join(', ');
                    } else {
                        if (typingBar) typingBar.classList.add('hidden');
                    }
                });
            }

            function toggleChatSound() {
                chatSoundEnabled = !chatSoundEnabled;
                showNotif('Info', chatSoundEnabled ? '🔔 เปิดเสียงแจ้งเตือน' : '🔕 ปิดเสียงแจ้งเตือน');
            }

            // DM (Direct Message) System
            let currentDMRecipient = null;
            let dmMessages = [];
            let dmUnsubscribe = null;

            // DM Bubble System (Messenger Style)
            let openDMBubbles = {}; // { name: { minimized: bool, unread: 0, avatar: '', listener: unsubscribe } }

            // DM Read Status System
            let dmReadStatus = {}; // { chatId: { userName: lastReadTimestamp } }

            // Mark DM as read in Firestore
            function markDMAsRead(chatId, myName) {
                try {
                    db.collection('dm_read_status').doc(chatId).set({
                        [myName]: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (e) { console.log('markDMAsRead error:', e); }
            }

            // Listen for read status changes - smooth update without full re-render
            let readStatusUpdateTimer = {};
            function listenDMReadStatus(chatId, otherName) {
                db.collection('dm_read_status').doc(chatId).onSnapshot(snap => {
                    const data = snap.data();
                    if (data) {
                        const prevOtherReadTime = dmReadStatus[chatId]?.[otherName]?.seconds;
                        const newOtherReadTime = data[otherName]?.seconds;

                        dmReadStatus[chatId] = data;

                        // Only update if OTHER person's read status changed (they read my message)
                        if (newOtherReadTime && newOtherReadTime !== prevOtherReadTime) {
                            // Clear existing timer
                            if (readStatusUpdateTimer[chatId]) clearTimeout(readStatusUpdateTimer[chatId]);
                            // Delay update to prevent flicker
                            readStatusUpdateTimer[chatId] = setTimeout(() => {
                                updateReadIndicatorsOnly(otherName, data[otherName]);
                            }, 500);
                        }
                    }
                }, err => { /* Ignore errors */ });
            }

            // Update only read indicators without full re-render
            function updateReadIndicatorsOnly(recipientName, readTimestamp) {
                const safeName = recipientName.replace(/[^a-zA-Z0-9]/g, '_');
                const msgContainer = document.getElementById(`dm-bubble-msgs-${safeName}`);
                if (!msgContainer) return;

                // Find all my messages' time divs and add read indicator
                const readTime = readTimestamp?.toDate?.() || null;
                if (!readTime) return;

                const myMsgDivs = msgContainer.querySelectorAll('.flex.justify-end .text-\\[9px\\]');
                myMsgDivs.forEach(div => {
                    // Only add if not already there
                    if (!div.innerHTML.includes('อ่านแล้ว')) {
                        div.innerHTML = div.innerHTML + '<span class="text-emerald-400 ml-1">✓ อ่านแล้ว</span>';
                    }
                });
            }

            // Mark DM as read when clicking on chat area (debounced, no re-render)
            let lastMarkReadTime = {};
            function markDMAsReadOnClick(name) {
                const now = Date.now();
                // Debounce - only mark as read once per 3 seconds per chat
                if (lastMarkReadTime[name] && now - lastMarkReadTime[name] < 3000) return;
                lastMarkReadTime[name] = now;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, name);
                markDMAsRead(chatId, myName);
                if (window.saveLastReadTimestamp) window.saveLastReadTimestamp(chatId);
                if (openDMBubbles[name]) {
                    openDMBubbles[name].unread = 0;
                }
            }

            // Save DM bubble state to localStorage
            function saveDMBubbleState() {
                const state = {};
                Object.keys(openDMBubbles).forEach(name => {
                    state[name] = {
                        minimized: true, // Always save as minimized on refresh
                        avatar: openDMBubbles[name].avatar,
                        unread: openDMBubbles[name].unread || 0
                    };
                });
                localStorage.setItem('dm_bubbles_state', JSON.stringify(state));
            }

            // Load DM bubble state from localStorage
            function loadDMBubbleState() {
                try {
                    const saved = localStorage.getItem('dm_bubbles_state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        Object.keys(state).forEach(name => {
                            if (!openDMBubbles[name]) {
                                createDMBubble(name, state[name].avatar, true); // true = start minimized
                                if (openDMBubbles[name]) {
                                    openDMBubbles[name].unread = state[name].unread || 0;
                                }
                            }
                        });
                    }
                } catch (e) { console.log('Load DM state error:', e); }
            }

            // Save state before page unload
            window.addEventListener('beforeunload', saveDMBubbleState);

            // Global incoming DM listener - watches for new messages directed to current user
            let incomingDMListeners = {}; // Store listeners per chat partner
            let incomingDMCheckInterval = null;

            function startIncomingDMListener() {
                if (!currentUser) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                if (!myName) return;

                // Clear any existing listeners
                stopIncomingDMListener();

                // Get last read timestamps for all DMs
                const getLastReadTimestamp = (chatId) => {
                    try {
                        const key = `dm_last_read_${chatId}`;
                        const saved = localStorage.getItem(key);
                        return saved ? new Date(parseInt(saved)) : null;
                    } catch (e) { return null; }
                };

                // Save last read timestamp
                window.saveLastReadTimestamp = (chatId) => {
                    try {
                        const key = `dm_last_read_${chatId}`;
                        localStorage.setItem(key, Date.now().toString());
                    } catch (e) { }
                };

                // For each registered user, set up a listener for potential DMs
                const setupListenerForUser = (userName) => {
                    if (userName === myName) return; // Skip self
                    if (incomingDMListeners[userName]) return; // Already listening

                    const chatId = getDMChatId(myName, userName);
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                    let prevMsgCount = 0;
                    let initialized = false;
                    const lastReadTime = getLastReadTimestamp(chatId);

                    incomingDMListeners[userName] = db.collection('dm_chats').doc(chatId).collection('messages')
                        .where('timestamp', '>', oneWeekAgo)
                        .orderBy('timestamp', 'desc')
                        .limit(10)
                        .onSnapshot(snap => {
                            if (!currentUser) return;

                            const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                            // On initial load, check for unread messages (sent while offline)
                            if (!initialized) {
                                initialized = true;
                                prevMsgCount = msgs.length;

                                // Check for unread messages sent while we were offline
                                if (msgs.length > 0 && lastReadTime) {
                                    const unreadMsgs = msgs.filter(m => {
                                        const msgTime = m.timestamp?.toDate?.() || new Date(0);
                                        return msgTime > lastReadTime && m.sender !== myName;
                                    });

                                    if (unreadMsgs.length > 0) {
                                        // Show bubble with unread count
                                        const latestUnread = unreadMsgs[0];
                                        if (!openDMBubbles[userName]) {
                                            const senderUser = allUsers.find(u => (u.firstName || u.fullName?.split(' ')[0]) === userName);
                                            createDMBubble(userName, senderUser?.avatar || '', true);
                                            if (openDMBubbles[userName]) {
                                                openDMBubbles[userName].unread = unreadMsgs.length;
                                                renderDMBubbles();
                                            }
                                        }
                                    }
                                }
                                return;
                            }

                            // Check for new messages
                            if (msgs.length > prevMsgCount) {
                                const latestMsg = msgs[0]; // Most recent
                                if (latestMsg && latestMsg.sender !== myName) {
                                    // New message from this user!
                                    if (!openDMBubbles[userName]) {
                                        // Create new bubble
                                        const senderUser = allUsers.find(u => (u.firstName || u.fullName?.split(' ')[0]) === userName);
                                        showDMNotification(userName, latestMsg.text || '[รูปภาพ]');
                                    } else if (openDMBubbles[userName].minimized) {
                                        // Bubble exists but minimized
                                        openDMBubbles[userName].unread++;
                                        playChatNotifSound();
                                        renderDMBubbles();
                                    }
                                }
                            }
                            prevMsgCount = msgs.length;
                        }, err => {
                            // Silently ignore - chat might not exist yet
                        });
                };

                // Set up listeners for all registered users
                (allUsers || []).forEach(user => {
                    const userName = user.firstName || user.fullName?.split(' ')[0];
                    if (userName) setupListenerForUser(userName);
                });

                // Also check online users
                (window.chatOnlineUsers || []).forEach(u => {
                    if (u.name) setupListenerForUser(u.name);
                });

                console.log('Incoming DM listeners started for', Object.keys(incomingDMListeners).length, 'users');
            }

            function stopIncomingDMListener() {
                Object.values(incomingDMListeners).forEach(unsub => {
                    if (typeof unsub === 'function') unsub();
                });
                incomingDMListeners = {};
            }

            function createDMBubble(name, avatar, startMinimized = false) {
                if (openDMBubbles[name]) {
                    // Already exists, just expand it and minimize others
                    Object.keys(openDMBubbles).forEach(n => {
                        if (n !== name) openDMBubbles[n].minimized = true;
                    });
                    openDMBubbles[name].minimized = false;
                    openDMBubbles[name].unread = 0;
                    // Save last read timestamp when expanding
                    const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                    const chatId = getDMChatId(myName, name);
                    if (window.saveLastReadTimestamp) window.saveLastReadTimestamp(chatId);
                    // Mark as read in Firestore for sender to see
                    markDMAsRead(chatId, myName);
                    renderDMBubbles();
                    return;
                }

                // Minimize all other expanded bubbles
                Object.keys(openDMBubbles).forEach(n => {
                    openDMBubbles[n].minimized = true;
                });

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, name);

                // Create bubble state
                openDMBubbles[name] = {
                    minimized: startMinimized,
                    unread: 0,
                    avatar: avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=8b5cf6&color=fff&size=40`,
                    messages: [],
                    listener: null
                };

                // Subscribe to messages
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                openDMBubbles[name].listener = db.collection('dm_chats').doc(chatId).collection('messages')
                    .where('timestamp', '>', oneWeekAgo)
                    .orderBy('timestamp', 'asc')
                    .limitToLast(50)
                    .onSnapshot(snap => {
                        const prevLen = openDMBubbles[name]?.messages?.length || 0;
                        const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                        if (openDMBubbles[name]) {
                            // Check for new messages while minimized
                            if (openDMBubbles[name].minimized && msgs.length > prevLen) {
                                const lastMsg = msgs[msgs.length - 1];
                                if (lastMsg.sender !== myName) {
                                    openDMBubbles[name].unread++;
                                    playChatNotifSound();
                                }
                            }

                            const hadMessages = openDMBubbles[name].messages.length > 0;
                            openDMBubbles[name].messages = msgs;

                            // If expanded and we have new messages, append smoothly instead of full re-render
                            if (!openDMBubbles[name].minimized && hadMessages && msgs.length > prevLen) {
                                appendNewDMMessage(name, msgs.slice(prevLen));
                            } else {
                                renderDMBubbles();
                            }
                        }
                    });

                // Listen for typing
                listenDMTypingForBubble(chatId, name);

                // Listen for read status
                listenDMReadStatus(chatId, name);

                renderDMBubbles();
            }

            // Append new messages smoothly without full re-render
            function appendNewDMMessage(recipientName, newMsgs) {
                const safeName = recipientName.replace(/[^a-zA-Z0-9]/g, '_');
                const msgContainer = document.getElementById(`dm-bubble-msgs-${safeName}`);
                if (!msgContainer || !newMsgs.length) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const themeHex = (serverSettings?.themeColor || '#06b6d4').replace('#', '');

                // Get recipient avatar
                const recipientUserData = (allUsers || []).find(u => (u.firstName || u.fullName?.split(' ')[0]) === recipientName);
                const recipientAvatar = recipientUserData?.avatar || openDMBubbles[recipientName]?.avatar;
                const fallbackAvatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(recipientName)}&background=8b5cf6&color=fff&size=40`;

                newMsgs.forEach(m => {
                    const isMe = m.sender === myName;
                    const imageHtml = m.image ? `<img src="${m.image}" class="max-w-full rounded-lg mt-1 max-h-40 cursor-pointer" onclick="showImagePopup('${m.image}')" onerror="this.onerror=null;this.src='https://placehold.co/400x300?text=Image+Expired';">` : '';
                    const textHtml = m.text ? linkifyText(escapeHtml(m.text)) : '';
                    const msgTime = m.timestamp?.toDate?.() || null;
                    const time = msgTime ? new Date(msgTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';

                    const msgHtml = isMe ?
                        `<div class="flex justify-end mb-1">
                        <div class="max-w-[80%]">
                            <div class="bg-purple-500 text-white px-3 py-1.5 rounded-2xl rounded-br-md text-xs break-all">${textHtml}${imageHtml}</div>
                            <div class="text-[9px] text-slate-500 text-right mt-0.5">${time}</div>
                        </div>
                    </div>` :
                        `<div class="flex gap-1.5 mb-1">
                        <img src="${recipientAvatar || fallbackAvatarUrl}" class="w-6 h-6 rounded-full mt-1" onerror="this.onerror=null;this.src='${fallbackAvatarUrl}';">
                        <div class="max-w-[75%]">
                            <div class="bg-slate-600 text-white px-3 py-1.5 rounded-2xl rounded-bl-md text-xs break-all">${textHtml}${imageHtml}</div>
                            <div class="text-[9px] text-slate-500 mt-0.5">${time}</div>
                        </div>
                    </div>`;

                    // Remove "เริ่มสนทนา..." placeholder if exists
                    const placeholder = msgContainer.querySelector('.text-center');
                    if (placeholder && placeholder.textContent.includes('เริ่มสนทนา')) {
                        placeholder.remove();
                    }

                    msgContainer.insertAdjacentHTML('beforeend', msgHtml);
                });

                // Scroll to bottom smoothly
                msgContainer.scrollTop = msgContainer.scrollHeight;
            }

            function closeDMBubble(name) {
                if (openDMBubbles[name]?.listener) {
                    openDMBubbles[name].listener();
                }
                delete openDMBubbles[name];
                renderDMBubbles();
            }

            function toggleDMBubble(name) {
                if (openDMBubbles[name]) {
                    openDMBubbles[name].minimized = !openDMBubbles[name].minimized;
                    if (!openDMBubbles[name].minimized) {
                        openDMBubbles[name].unread = 0;
                        // Save last read timestamp
                        const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                        const chatId = getDMChatId(myName, name);
                        if (window.saveLastReadTimestamp) window.saveLastReadTimestamp(chatId);
                        // Mark as read in Firestore
                        markDMAsRead(chatId, myName);
                    }
                    renderDMBubbles();
                }
            }

            function renderDMBubbles() {
                const bubbleContainer = document.getElementById('dm-bubbles-container');
                const expandedContainer = document.getElementById('dm-expanded-container');
                if (!bubbleContainer || !expandedContainer) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const themeHex = (serverSettings?.themeColor || '#06b6d4').replace('#', '');

                const bubbleNames = Object.keys(openDMBubbles);
                if (bubbleNames.length === 0) {
                    bubbleContainer.innerHTML = '';
                    expandedContainer.innerHTML = '';
                    return;
                }

                const minimized = bubbleNames.filter(n => openDMBubbles[n].minimized);
                const expanded = bubbleNames.filter(n => !openDMBubbles[n].minimized);

                let minimizedHtml = '';
                let expandedHtml = '';

                minimized.forEach(name => {
                    const b = openDMBubbles[name];
                    const encodedName = encodeURIComponent(name);
                    const fallbackUrl = 'https://ui-avatars.com/api/?name=' + encodedName + '&background=8b5cf6&color=fff&size=48';
                    minimizedHtml += `
                    <div class="relative group">
                        <img src="${b.avatar}" class="w-12 h-12 rounded-full shadow-lg border-2 border-purple-500 hover:scale-110 transition cursor-pointer" onclick="toggleDMBubble('${escapeHtml(name)}')" onerror="this.onerror=null;this.src='${fallbackUrl}';">
                        ${b.unread > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold">${b.unread > 9 ? '9+' : b.unread}</span>` : ''}
                        <button onclick="closeDMBubble('${escapeHtml(name)}')" class="absolute -top-1 -left-1 w-5 h-5 bg-slate-700 hover:bg-red-500 text-white text-[10px] rounded-full items-center justify-center hidden group-hover:flex transition">✕</button>
                    </div>
                `;
                });

                expanded.forEach(name => {
                    const b = openDMBubbles[name];
                    const safeName = name.replace(/[^a-zA-Z0-9]/g, '_');
                    const msgs = b.messages || [];
                    // Fetch fresh avatar from allUsers (op_users)
                    const recipientUserData = (allUsers || []).find(u => (u.firstName || u.fullName?.split(' ')[0]) === name);
                    const recipientAvatar = recipientUserData?.avatar || b.avatar;
                    const encodedName = encodeURIComponent(name);
                    const fallbackAvatarUrl = `https://ui-avatars.com/api/?name=${encodedName}&background=8b5cf6&color=fff&size=40`;

                    // Get read status for this chat
                    const chatId = getDMChatId(myName, name);
                    const readStatusData = dmReadStatus[chatId] || {};
                    const recipientReadTime = readStatusData[name]?.toDate?.() || null;

                    const chatHtml = msgs.slice(-30).map((m, index, arr) => {
                        const isMe = m.sender === myName;

                        // Image with popup viewer
                        const imageHtml = m.image ? `<img src="${m.image}" class="max-w-full rounded-lg mt-1 max-h-40 cursor-pointer" onclick="showImagePopup('${m.image}')" onerror="this.onerror=null;this.src='https://placehold.co/400x300?text=Image+Expired';this.alt='รูปภาพหมดอายุ';">` : '';

                        const textHtml = m.text ? linkifyText(escapeHtml(m.text)) : '';
                        const msgTime = m.timestamp?.toDate?.() || null;
                        const time = msgTime ? new Date(msgTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';

                        // Check if this is my message and recipient has read it
                        let readIndicator = '';
                        if (isMe && recipientReadTime && msgTime && recipientReadTime >= msgTime) {
                            // Check if this is the last message I sent before recipient read
                            readIndicator = '<span class="text-emerald-400 ml-1">✓ อ่านแล้ว</span>';
                        }

                        return isMe ?
                            `<div class="flex justify-end mb-1">
                            <div class="max-w-[80%]">
                                <div class="bg-purple-500 text-white px-3 py-1.5 rounded-2xl rounded-br-md text-xs break-all">${textHtml}${imageHtml}</div>
                                <div class="text-[9px] text-slate-500 text-right mt-0.5">${time}${readIndicator}</div>
                            </div>
                        </div>` :
                            `<div class="flex gap-1.5 mb-1">
                            <img src="${recipientAvatar || fallbackAvatarUrl}" class="w-6 h-6 rounded-full mt-1" onerror="this.onerror=null;this.src='${fallbackAvatarUrl}';">
                            <div class="max-w-[75%]">
                                <div class="bg-slate-600 text-white px-3 py-1.5 rounded-2xl rounded-bl-md text-xs break-all">${textHtml}${imageHtml}</div>
                                <div class="text-[9px] text-slate-500 mt-0.5">${time}</div>
                            </div>
                        </div>`;
                    }).join('');

                    const hasImage = b.imageData ? 'flex' : 'hidden';

                    expandedHtml += `
                    <div class="w-80 rounded-2xl shadow-2xl overflow-hidden animate-zoom-in" style="background: linear-gradient(135deg, rgba(30,41,59,0.95) 0%, rgba(51,65,85,0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(168,85,247,0.2);">
                        <div class="px-3 py-2.5 flex items-center justify-between" style="background: linear-gradient(180deg, rgba(168,85,247,0.25) 0%, rgba(168,85,247,0.08) 100%); border-bottom: 1px solid rgba(255,255,255,0.08);">
                            <div class="flex items-center gap-2">
                                <div class="relative">
                                    <img src="${recipientAvatar || fallbackAvatarUrl}" class="w-9 h-9 rounded-xl border border-white/20 cursor-pointer hover:scale-105 transition shadow-lg" onclick="showProfileMenu(event, '${escapeHtml(name)}', '${recipientAvatar || fallbackAvatarUrl}')" title="ดูโปรไฟล์" onerror="this.onerror=null;this.src='${fallbackAvatarUrl}';">
                                    ${(() => {
                            const onlineUsers = window.chatOnlineUsers || [];
                            const isOnline = onlineUsers.some(u => u.name === name);
                            if (!isOnline) {
                                return `<div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-slate-500 rounded-full border-2 border-slate-800"></div>`;
                            }
                            const recipientSettings = cachedUserSettings[name] || {};
                            const recipientStatus = recipientSettings.onlineStatus || 'online';
                            const statusColors = { online: 'bg-emerald-500', dnd: 'bg-red-500', away: 'bg-orange-500' };
                            return `<div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 ${statusColors[recipientStatus]} rounded-full border-2 border-slate-800"></div>`;
                        })()}
                                </div>
                                <div class="cursor-pointer" onclick="toggleDMBubble('${escapeHtml(name)}')">
                                    <div class="text-white font-semibold text-sm">${escapeHtml(name)}</div>
                                    ${(() => {
                            const onlineUsers = window.chatOnlineUsers || [];
                            const isOnline = onlineUsers.some(u => u.name === name);
                            if (!isOnline) {
                                return `<div class="text-[10px] text-slate-400">⚫ ออฟไลน์</div>`;
                            }
                            const recipientSettings = cachedUserSettings[name] || {};
                            const recipientStatus = recipientSettings.onlineStatus || 'online';
                            const statusLabels = { online: '🟢 ออนไลน์', dnd: '🔴 ห้ามรบกวน', away: '🟠 ไม่อยู่' };
                            return `<div class="text-[10px] text-purple-300">${statusLabels[recipientStatus]}</div>`;
                        })()}
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                ${(() => {
                            const recipientSettings = cachedUserSettings[name] || {};
                            const recipientStatus = recipientSettings.onlineStatus || 'online';
                            const canCall = recipientStatus === 'online';
                            return canCall
                                ? `<button onclick="initiateCall('${escapeHtml(name)}')" class="w-7 h-7 text-white/60 hover:text-white hover:bg-green-500/30 rounded-lg flex items-center justify-center text-sm transition" title="โทร">📞</button>`
                                : `<button onclick="showDNDCallPopup('${escapeHtml(name)}')" class="w-7 h-7 text-white/30 hover:text-white/50 hover:bg-red-500/20 rounded-lg flex items-center justify-center text-sm transition" title="ไม่สามารถโทรได้">📞</button>`;
                        })()}
                                <button onclick="clearBubbleDM('${escapeHtml(name)}')" class="w-7 h-7 text-white/60 hover:text-white hover:bg-red-500/30 rounded-lg flex items-center justify-center text-sm transition" title="ล้างแชท">🗑️</button>
                                <button onclick="toggleDMBubble('${escapeHtml(name)}')" class="w-7 h-7 text-white/60 hover:text-white hover:bg-white/10 rounded-lg flex items-center justify-center text-sm transition" title="Minimize">➖</button>
                                <button onclick="toggleDMBubble('${escapeHtml(name)}')" class="w-7 h-7 text-white/60 hover:text-white hover:bg-red-500/30 rounded-lg flex items-center justify-center text-sm transition" title="ย่อ">✕</button>
                            </div>
                        </div>
                        <div id="dm-bubble-msgs-${safeName}" class="h-64 overflow-y-auto p-3 space-y-2 custom-scrollbar" style="background: rgba(15,23,42,0.5);"
                            onclick="markDMAsReadOnClick('${escapeHtml(name)}')"
                            ondragover="event.preventDefault(); this.classList.add('ring-2', 'ring-purple-400/50');"
                            ondragleave="this.classList.remove('ring-2', 'ring-purple-400/50');"
                            ondrop="handleBubbleImageDrop(event, '${escapeHtml(name)}'); this.classList.remove('ring-2', 'ring-purple-400/50');">
                            ${chatHtml || '<div class="text-center text-slate-500 text-xs py-8">เริ่มสนทนา... 💬</div>'}
                        </div>
                        <div id="dm-bubble-typing-${safeName}" class="hidden px-3 py-1.5 text-[10px] text-purple-300 flex items-center gap-2" style="background: rgba(30,41,59,0.8); border-top: 1px solid rgba(255,255,255,0.05);">
                            <span class="flex gap-1"><span class="w-1 h-1 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></span><span class="w-1 h-1 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></span><span class="w-1 h-1 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></span></span>
                            ${escapeHtml(name)} กำลังพิมพ์...
                        </div>
                        <div id="dm-bubble-preview-${safeName}" class="${hasImage} mb-0 px-3 py-2 relative" style="background: rgba(30,41,59,0.8); border-top: 1px solid rgba(255,255,255,0.05);">
                            <img id="dm-bubble-preview-img-${safeName}" class="max-h-24 rounded-xl" src="${b.imageData || ''}">
                            <button onclick="cancelBubbleImage('${escapeHtml(name)}')" class="absolute top-1 right-4 w-5 h-5 bg-red-500/80 hover:bg-red-500 text-white rounded-lg text-xs flex items-center justify-center backdrop-blur-sm">✕</button>
                        </div>
                        <div class="p-2" style="background: rgba(30,41,59,0.8); border-top: 1px solid rgba(255,255,255,0.05);">
                            <div class="flex items-center gap-1">
                                <button onclick="toggleBubbleEmoji('${escapeHtml(name)}')" class="w-7 h-7 hover:bg-white/10 text-slate-400 hover:text-white rounded-lg flex items-center justify-center transition text-sm" title="Emoji">😊</button>
                                <label class="w-7 h-7 hover:bg-white/10 text-slate-400 hover:text-white rounded-lg flex items-center justify-center transition cursor-pointer text-sm" title="แนบรูป">
                                    ➕
                                    <input type="file" accept="image/*" class="hidden" onchange="previewBubbleImage(this, '${escapeHtml(name)}')">
                                </label>
                                <input type="text" id="dm-bubble-input-${safeName}" placeholder="พิมพ์ข้อความ..."
                                    class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-1.5 text-xs text-white focus:border-purple-500/50 focus:bg-white/10 focus:outline-none transition"
                                    onkeypress="if(event.key==='Enter') sendBubbleDM('${escapeHtml(name)}')"
                                    oninput="updateBubbleTyping('${escapeHtml(name)}')"
                                    onpaste="handleBubbleImagePaste(event, '${escapeHtml(name)}')">
                                <button onclick="sendBubbleDM('${escapeHtml(name)}')" class="w-7 h-7 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-400 hover:to-purple-500 text-white rounded-xl flex items-center justify-center text-sm transition shadow-lg shadow-purple-500/25">📤</button>
                            </div>
                            <div id="dm-bubble-emoji-${safeName}" class="hidden mt-2 bg-slate-700/80 backdrop-blur-sm rounded-xl p-2 grid grid-cols-10 gap-1 text-sm max-h-24 overflow-y-auto border border-white/5"></div>
                        </div>
                    </div>
                `;
                });

                bubbleContainer.innerHTML = minimizedHtml;
                expandedContainer.innerHTML = expandedHtml;

                expanded.forEach(name => {
                    const msgContainer = document.getElementById(`dm-bubble-msgs-${name.replace(/[^a-zA-Z0-9]/g, '_')}`);
                    if (msgContainer) msgContainer.scrollTop = msgContainer.scrollHeight;
                });
            }

            async function sendBubbleDM(name) {
                const safeName = name.replace(/[^a-zA-Z0-9]/g, '_');
                const input = document.getElementById(`dm-bubble-input-${safeName}`);
                if (!input) return;

                const text = input.value.trim();
                const imageData = openDMBubbles[name]?.imageData || null;

                // Need either text or image
                if (!text && !imageData) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, name);

                try {
                    const msgData = {
                        text,
                        sender: myName,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (imageData) {
                        msgData.image = imageData;
                    }

                    await db.collection('dm_chats').doc(chatId).collection('messages').add(msgData);
                    input.value = '';
                    // Clear image after sending - hide preview without full re-render
                    if (openDMBubbles[name]) {
                        openDMBubbles[name].imageData = null;
                        // Just hide the preview element instead of full re-render
                        const previewEl = document.getElementById(`dm-bubble-preview-${safeName}`);
                        if (previewEl) previewEl.classList.add('hidden');
                    }
                } catch (e) {
                    showNotif('Error', 'ส่งข้อความไม่สำเร็จ');
                }
            }

            // Clear all messages in a DM bubble
            async function clearBubbleDM(name) {
                const confirmed = await showConfirm('ยืนยันลบแชท', `ต้องการล้างแชทกับ ${name} หรือไม่?`);
                if (!confirmed) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, name);

                try {
                    const snap = await db.collection('dm_chats').doc(chatId).collection('messages').get();
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();

                    // Clear local messages
                    if (openDMBubbles[name]) {
                        openDMBubbles[name].messages = [];
                        renderDMBubbles();
                    }
                    showNotif('Success', '🗑️ ล้างแชทแล้ว');
                } catch (e) {
                    showNotif('Error', 'ล้างแชทไม่สำเร็จ');
                }
            }

            // Close and remove a DM bubble completely
            function closeDMBubble(name) {
                if (openDMBubbles[name]) {
                    // Unsubscribe from listener if exists
                    if (openDMBubbles[name].listener) {
                        openDMBubbles[name].listener();
                    }
                    delete openDMBubbles[name];
                    saveDMBubbleState();
                    renderDMBubbles();
                }
            }

            function updateBubbleTyping(name) {
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, name);
                db.collection('dm_typing').doc(chatId).set({
                    [myName]: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }

            function listenDMTypingForBubble(chatId, name) {
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                let wasTyping = false;

                db.collection('dm_typing').doc(chatId).onSnapshot(snap => {
                    const data = snap.data();
                    const typingEl = document.getElementById(`dm-bubble-typing-${name.replace(/[^a-zA-Z0-9]/g, '_')}`);

                    if (data && data[name]) {
                        const typingTime = data[name]?.toDate?.() || new Date(0);
                        if ((Date.now() - typingTime.getTime()) < 5000) {
                            if (typingEl) typingEl.classList.remove('hidden');
                            // Play typing sound when someone starts typing
                            if (!wasTyping && chatSoundEnabled) {
                                playTypingSound();
                            }
                            wasTyping = true;
                        } else {
                            if (typingEl) typingEl.classList.add('hidden');
                            wasTyping = false;
                        }
                    } else {
                        if (typingEl) typingEl.classList.add('hidden');
                        wasTyping = false;
                    }
                });
            }

            // Typing indicator sound - DISABLED (user feedback: sounds weird)
            function playTypingSound() {
                // Disabled - no sound for typing indicator
            }

            function stopTypingSound() {
                // Disabled
            }

            // Profile menu for avatar/name clicks
            function showProfileMenu(event, name, avatar) {
                event.stopPropagation();

                // Remove existing menu
                const existing = document.getElementById('profile-context-menu');
                if (existing) existing.remove();

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                if (name === myName) return; // Don't show menu for self

                const menu = document.createElement('div');
                menu.id = 'profile-context-menu';
                menu.className = 'fixed z-[250] bg-slate-800 border border-slate-600 rounded-xl shadow-2xl p-2 min-w-[140px] animate-zoom-in';
                menu.style.left = `${event.clientX}px`;
                menu.style.top = `${event.clientY}px`;

                // Ensure menu doesn't go off screen
                setTimeout(() => {
                    const rect = menu.getBoundingClientRect();
                    if (rect.right > window.innerWidth) {
                        menu.style.left = `${window.innerWidth - rect.width - 10}px`;
                    }
                    if (rect.bottom > window.innerHeight) {
                        menu.style.top = `${window.innerHeight - rect.height - 10}px`;
                    }
                }, 0);

                menu.innerHTML = `
                <div class="flex items-center gap-2 px-2 py-1 mb-1 border-b border-slate-700">
                    <img src="${avatar}" class="w-8 h-8 rounded-full">
                    <span class="text-white font-bold text-sm">${escapeHtml(name)}</span>
                </div>
                <button onclick="openDM('${escapeHtml(name)}', '${avatar}'); closeProfileMenu();" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-purple-500/30 rounded-lg transition flex items-center gap-2">
                    💬 ส่งข้อความ
                </button>
                <button onclick="initiateCall('${escapeHtml(name)}'); closeProfileMenu();" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-green-500/30 rounded-lg transition flex items-center gap-2">
                    📞 โทร
                </button>
                <button onclick="viewUserProfile('${escapeHtml(name)}', '${avatar}'); closeProfileMenu();" class="w-full text-left px-3 py-2 text-sm text-white hover:bg-blue-500/30 rounded-lg transition flex items-center gap-2">
                    👤 ดูโปรไฟล์
                </button>
            `;

                document.body.appendChild(menu);

                // Close on click outside
                setTimeout(() => {
                    document.addEventListener('click', closeProfileMenu, { once: true });
                }, 0);
            }

            function closeProfileMenu() {
                const menu = document.getElementById('profile-context-menu');
                if (menu) menu.remove();
            }

            function viewUserProfile(name, avatar) {
                // Find user in roster AND allUsers for more data
                const roster = appData?.roster || [];
                const rosterUser = roster.find(r => (r.firstName || (r.fullName?.split(' ')[0])) === name);
                const fullUser = allUsers.find(u => (u.firstName || (u.fullName?.split(' ')[0])) === name);
                const user = fullUser || rosterUser;
                const userSettings = cachedUserSettings[name] || {};

                // Get settings info
                const allowDM = userSettings.allowDM !== false ? '✅ เปิด' : '❌ ปิด';
                const allowCalls = userSettings.allowCalls !== false ? '✅ เปิด' : '❌ ปิด';

                // Get work status
                const workStatus = user?.workStatus || 'ทำงาน';
                const workStatusIcon = workStatus === 'ทำงาน' ? '🟢' : workStatus === 'ไม่ว่าง' ? '🟡' : '🔴';

                // Get availability times
                const availStart = user?.availStart || '-';
                const availEnd = user?.availEnd || '-';
                const availText = availStart !== '-' && availEnd !== '-' ? `${availStart} - ${availEnd}` : '-';

                // Create profile modal
                const existing = document.getElementById('user-profile-modal');
                if (existing) existing.remove();

                const avatarUrl = user?.avatar || avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=8b5cf6&color=fff&size=80`;
                const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=8b5cf6&color=fff&size=80`;

                const modal = document.createElement('div');
                modal.id = 'user-profile-modal';
                modal.className = 'fixed inset-0 z-[600] flex items-center justify-center p-4';
                modal.style.background = 'rgba(0,0,0,0.6)';
                modal.style.backdropFilter = 'blur(8px)';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                <div class="w-80 rounded-2xl overflow-hidden animate-zoom-in" style="background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.95) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);">
                    <!-- Header with gradient (reduced height) -->
                    <div class="h-12 relative" style="background: linear-gradient(135deg, rgba(168,85,247,0.4) 0%, rgba(59,130,246,0.3) 100%);">
                        <button onclick="this.closest('#user-profile-modal').remove()" class="absolute top-2 right-2 w-8 h-8 text-white/60 hover:text-white hover:bg-white/10 rounded-lg flex items-center justify-center transition">✕</button>
                    </div>
                    
                    <!-- Avatar (adjusted margin) -->
                    <div class="flex justify-center -mt-8">
                        <img src="${avatarUrl}" class="w-16 h-16 rounded-2xl border-4 border-slate-800 shadow-xl" onerror="this.onerror=null;this.src='${fallbackUrl}';">
                    </div>
                    
                    <!-- Info -->
                    <div class="p-4 text-center">
                        <h3 class="text-lg font-bold text-white mb-1">${escapeHtml(name)}</h3>
                        <p class="text-sm text-slate-400 mb-1">${user?.role || 'สมาชิก'}</p>
                        <p class="text-xs mb-3">${workStatusIcon} <span class="${workStatus === 'ทำงาน' ? 'text-emerald-400' : workStatus === 'ไม่ว่าง' ? 'text-yellow-400' : 'text-red-400'}">${escapeHtml(workStatus)}</span></p>
                        
                        <!-- Stats -->
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="p-2.5 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);">
                                <div class="text-[10px] text-slate-500 mb-0.5">รับ DM</div>
                                <div class="text-xs font-medium ${userSettings.allowDM !== false ? 'text-emerald-400' : 'text-red-400'}">${allowDM}</div>
                            </div>
                            <div class="p-2.5 rounded-xl" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);">
                                <div class="text-[10px] text-slate-500 mb-0.5">รับสาย</div>
                                <div class="text-xs font-medium ${userSettings.allowCalls !== false ? 'text-emerald-400' : 'text-red-400'}">${allowCalls}</div>
                            </div>
                        </div>
                        
                        <!-- User Details -->
                        <div class="text-left space-y-1.5 p-3 rounded-xl mb-3" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);">
                            ${user?.fullName ? `
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">ชื่อ-นามสกุล</span>
                                <span class="text-white">${escapeHtml(user.fullName)}</span>
                            </div>
                            ` : ''}
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">เบอร์โทร IC</span>
                                <span class="text-cyan-400 font-mono">${escapeHtml(user?.icPhone || '-')}</span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">ช่วงเวลาที่สะดวก</span>
                                <span class="text-white">${escapeHtml(availText)}</span>
                            </div>
                            ${user?.discordId ? `
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Discord</span>
                                <span class="text-white">${escapeHtml(user.discordId)}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex gap-2">
                            <button onclick="this.closest('#user-profile-modal').remove(); openDM('${escapeHtml(name)}', '${avatarUrl}')" 
                                class="flex-1 py-2.5 rounded-xl bg-purple-500/20 hover:bg-purple-500/40 text-purple-300 text-sm font-medium transition flex items-center justify-center gap-2">
                                💬 ส่งข้อความ
                            </button>
                            <button onclick="this.closest('#user-profile-modal').remove(); initiateCall('${escapeHtml(name)}')" 
                                class="flex-1 py-2.5 rounded-xl bg-green-500/20 hover:bg-green-500/40 text-green-300 text-sm font-medium transition flex items-center justify-center gap-2">
                                📞 โทร
                            </button>
                        </div>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);
            }

            function handleBubbleImagePaste(e, name) {
                const items = e.clipboardData?.items;
                if (!items) return;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file.size > 500 * 1024) {
                            showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            if (openDMBubbles[name]) {
                                openDMBubbles[name].imageData = ev.target.result;
                                renderDMBubbles();
                            }
                        };
                        reader.readAsDataURL(file);
                        break;
                    }
                }
            }

            function handleBubbleImageDrop(e, name) {
                e.preventDefault();
                const file = e.dataTransfer?.files?.[0];
                if (!file || !file.type.startsWith('image/')) return;
                if (file.size > 500 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    if (openDMBubbles[name]) {
                        openDMBubbles[name].imageData = ev.target.result;
                        renderDMBubbles();
                    }
                };
                reader.readAsDataURL(file);
            }

            function previewBubbleImage(input, name) {
                const file = input.files[0];
                if (!file) return;
                if (file.size > 500 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (openDMBubbles[name]) {
                        openDMBubbles[name].imageData = e.target.result;
                        renderDMBubbles();
                    }
                };
                reader.readAsDataURL(file);
            }

            function cancelBubbleImage(name) {
                if (openDMBubbles[name]) {
                    openDMBubbles[name].imageData = null;
                    renderDMBubbles();
                }
            }

            const bubbleEmojis = ['😀', '😂', '🥹', '😍', '🥰', '😘', '😎', '🤔', '😢', '😭', '😡', '👍', '👎', '❤️', '💔', '🔥', '✨', '🎉', '💬', '✅', '👋', '🙏', '💯', '😮', '👏'];

            function toggleBubbleEmoji(name) {
                const safeName = name.replace(/[^a-zA-Z0-9]/g, '_');
                const picker = document.getElementById(`dm-bubble-emoji-${safeName}`);
                if (!picker) return;

                if (picker.classList.contains('hidden')) {
                    picker.innerHTML = bubbleEmojis.map(e => `<span class="cursor-pointer hover:scale-125 transition" onclick="insertBubbleEmoji('${name}', '${e}')">${e}</span>`).join('');
                    picker.classList.remove('hidden');
                } else {
                    picker.classList.add('hidden');
                }
            }

            function insertBubbleEmoji(name, emoji) {
                const safeName = name.replace(/[^a-zA-Z0-9]/g, '_');
                const input = document.getElementById(`dm-bubble-input-${safeName}`);
                if (input) {
                    input.value += emoji;
                    input.focus();
                }
            }

            function getDMChatId(user1, user2) {
                // Create consistent chat ID regardless of who initiates
                const sorted = [user1, user2].sort();
                return `dm_${sorted[0]}_${sorted[1]}`;
            }

            function openDM(recipientName, recipientAvatar) {
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                if (!myName || myName === recipientName) return;

                // Use bubble system instead of panel
                createDMBubble(recipientName, recipientAvatar);

                // Close the online panel
                document.getElementById('chat-online-panel').classList.add('hidden');
            }

            function closeDM() {
                if (dmUnsubscribe) { dmUnsubscribe(); dmUnsubscribe = null; }
                currentDMRecipient = null;
                dmMessages = [];
                document.getElementById('dm-panel').classList.add('hidden');
            }

            function loadDMMessages(myName, recipientName) {
                if (dmUnsubscribe) dmUnsubscribe();

                const chatId = getDMChatId(myName, recipientName);
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                let prevDMCount = 0;

                // Listen for typing indicator
                listenDMTyping(chatId, recipientName);

                dmUnsubscribe = db.collection('dm_chats').doc(chatId).collection('messages')
                    .where('timestamp', '>', oneWeekAgo)
                    .orderBy('timestamp', 'asc')
                    .limitToLast(50)
                    .onSnapshot(snap => {
                        const newMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));

                        // Show notification if new message from other person (only if DM panel is closed)
                        const dmPanelOpen = !document.getElementById('dm-panel')?.classList.contains('hidden');
                        if (newMessages.length > prevDMCount && prevDMCount > 0) {
                            const lastMsg = newMessages[newMessages.length - 1];
                            if (lastMsg.sender !== myName && chatSoundEnabled && !dmPanelOpen) {
                                showDMNotification(lastMsg.sender, lastMsg.text || '[รูปภาพ]');
                            }
                        }

                        prevDMCount = newMessages.length;
                        dmMessages = newMessages;
                        renderDMMessages();
                    });
            }

            function renderDMMessages() {
                const container = document.getElementById('dm-messages');
                if (!container) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const themeHex = (serverSettings?.themeColor || '#06b6d4').replace('#', '');

                if (dmMessages.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-500 text-xs py-8">เริ่มสนทนา... 💬</div>';
                    return;
                }

                container.innerHTML = dmMessages.map(m => {
                    const isMe = m.sender === myName;
                    const time = m.timestamp ? new Date(m.timestamp.toDate()).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';

                    // Image with popup viewer
                    const imageHtml = m.image ? `<img src="${m.image}" class="max-w-full rounded-lg mt-1 cursor-pointer" onclick="showImagePopup('${m.image}')" onerror="this.onerror=null;this.src='https://placehold.co/400x300?text=Image+Expired';this.alt='รูปภาพหมดอายุ';">` : '';

                    const textHtml = m.text ? linkifyText(escapeHtml(m.text)) : '';

                    return isMe ? `
                    <div class="flex justify-end">
                        <div class="max-w-[75%]">
                            <div class="bg-purple-500 text-white px-3 py-2 rounded-2xl rounded-br-md text-sm">${textHtml}${imageHtml}</div>
                            <div class="text-[10px] text-slate-500 text-right mt-0.5">${time}</div>
                        </div>
                    </div>
                ` : `
                    <div class="flex gap-2">
                        <img src="${currentDMRecipient?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(m.sender)}&background=${themeHex}&color=fff&size=32`}" class="w-8 h-8 rounded-full shrink-0 mt-1">
                        <div class="max-w-[75%]">
                            <div class="bg-slate-700 text-white px-3 py-2 rounded-2xl rounded-bl-md text-sm">${textHtml}${imageHtml}</div>
                            <div class="text-[10px] text-slate-500 mt-0.5">${time}</div>
                        </div>
                    </div>
                `;
                }).join('');

                container.scrollTop = container.scrollHeight;
            }

            // DM Image Data
            let dmImageData = null;

            function previewDMImage(input) {
                const file = input.files[0];
                if (!file) return;
                if (file.size > 500 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    dmImageData = e.target.result;
                    document.getElementById('dm-image-preview-img').src = dmImageData;
                    document.getElementById('dm-image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            function cancelDMImageUpload() {
                dmImageData = null;
                document.getElementById('dm-image-preview').classList.add('hidden');
                document.getElementById('dm-image-input').value = '';
            }

            function handleDMImagePaste(e) {
                const items = e.clipboardData?.items;
                if (!items) return;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file.size > 500 * 1024) {
                            showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            dmImageData = ev.target.result;
                            document.getElementById('dm-image-preview-img').src = dmImageData;
                            document.getElementById('dm-image-preview').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        break;
                    }
                }
            }

            function handleDMImageDrop(e) {
                e.preventDefault();
                const file = e.dataTransfer?.files?.[0];
                if (!file || !file.type.startsWith('image/')) return;
                if (file.size > 500 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    dmImageData = ev.target.result;
                    document.getElementById('dm-image-preview-img').src = dmImageData;
                    document.getElementById('dm-image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            // DM Emoji Picker
            const dmEmojis = ['😀', '😂', '🥹', '😍', '🥰', '😘', '😎', '🤔', '😢', '😭', '😡', '👍', '👎', '❤️', '💔', '🔥', '✨', '🎉', '💬', '✅'];

            function toggleDMEmojiPicker() {
                const picker = document.getElementById('dm-emoji-picker');
                if (picker.classList.contains('hidden')) {
                    picker.innerHTML = dmEmojis.map(e => `<span class="cursor-pointer hover:scale-125 transition" onclick="insertDMEmoji('${e}')">${e}</span>`).join('');
                    picker.classList.remove('hidden');
                } else {
                    picker.classList.add('hidden');
                }
            }

            function insertDMEmoji(emoji) {
                const input = document.getElementById('dm-input');
                input.value += emoji;
                input.focus();
            }

            async function sendDM() {
                if (!currentUser || !currentDMRecipient) return;
                const input = document.getElementById('dm-input');
                const text = input.value.trim();

                // Need either text or image
                if (!text && !dmImageData) return;

                const myName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || currentUser.username;
                const chatId = getDMChatId(myName, currentDMRecipient.name);

                try {
                    const msgData = {
                        text,
                        sender: myName,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (dmImageData) {
                        msgData.image = dmImageData;
                    }

                    await db.collection('dm_chats').doc(chatId).collection('messages').add(msgData);
                    input.value = '';
                    cancelDMImageUpload();
                    // Clear typing status
                    clearDMTyping();
                } catch (e) {
                    showNotif('Error', 'ส่งข้อความไม่สำเร็จ');
                }
            }

            // DM Typing Indicator
            let dmTypingTimeout = null;

            function updateDMTyping() {
                if (!currentDMRecipient) return;
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, currentDMRecipient.name);

                // Set typing status in Firestore
                db.collection('dm_typing').doc(chatId).set({
                    [myName]: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                // Clear after 3 seconds of no typing
                clearTimeout(dmTypingTimeout);
                dmTypingTimeout = setTimeout(() => clearDMTyping(), 3000);
            }

            function clearDMTyping() {
                if (!currentDMRecipient) return;
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, currentDMRecipient.name);

                db.collection('dm_typing').doc(chatId).set({
                    [myName]: null
                }, { merge: true });
            }

            function listenDMTyping(chatId, otherName) {
                db.collection('dm_typing').doc(chatId).onSnapshot(snap => {
                    const data = snap.data();
                    const typingBar = document.getElementById('dm-typing-bar');
                    const typingName = document.getElementById('dm-typing-name');

                    if (data && data[otherName]) {
                        const typingTime = data[otherName]?.toDate?.() || new Date(0);
                        const ago = Date.now() - typingTime.getTime();

                        if (ago < 5000) {
                            if (typingBar) typingBar.classList.remove('hidden');
                            if (typingName) typingName.textContent = otherName;
                        } else {
                            if (typingBar) typingBar.classList.add('hidden');
                        }
                    } else {
                        if (typingBar) typingBar.classList.add('hidden');
                    }
                });
            }

            function showDMNotification(senderName, text) {
                // Create a minimized bubble with unread count instead of popup
                if (!openDMBubbles[senderName]) {
                    // Create new minimized bubble
                    createDMBubble(senderName, '');
                    openDMBubbles[senderName].minimized = true;
                    openDMBubbles[senderName].unread = 1;
                } else if (openDMBubbles[senderName].minimized) {
                    // Already exists and minimized, just increment unread
                    openDMBubbles[senderName].unread++;
                }

                // Only play sound if user is online (not DND or Away)
                if (onlineStatus === 'online') {
                    playChatNotifSound();
                }
                renderDMBubbles();
            }

            // Online Status System (replaces allowDM/allowCalls)
            // Status: 'online' | 'dnd' | 'away'
            // online = green, normal behavior
            // dnd = red, DM works but no notif, no calls
            // away = orange, auto after 15 min inactivity or manual
            let onlineStatus = 'online';
            let manualAwaySet = false;
            let lastActivityTime = Date.now();
            let activityCheckInterval = null;

            function loadOnlineStatus() {
                try {
                    const saved = localStorage.getItem(`online_status_${currentUser?.username || 'guest'}`);
                    if (saved) onlineStatus = saved;
                } catch (e) { }
                startActivityTracking();
                // Update UI to show saved status
                setTimeout(() => {
                    updateStatusDropdown();
                    updateStatusIndicator();
                }, 500);
            }

            function saveOnlineStatus() {
                localStorage.setItem(`online_status_${currentUser?.username || 'guest'}`, onlineStatus);
                // Save to Firestore for other users to see
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                if (myName) {
                    db.collection('user_settings').doc(myName).set({
                        onlineStatus: onlineStatus
                    }, { merge: true });
                }
                updateChatPresence();
                updateStatusIndicator();
            }

            function setOnlineStatus(status) {
                onlineStatus = status;
                if (status === 'away') {
                    manualAwaySet = true;
                } else {
                    manualAwaySet = false;
                }
                saveOnlineStatus();
                const labels = { online: 'ออนไลน์', dnd: 'ห้ามรบกวน', away: 'ไม่อยู่' };
                showNotif('Info', `เปลี่ยนสถานะเป็น: ${labels[status]} เรียบร้อยแล้ว`);
                renderOnlineUsersList();
                updateStatusDropdown();
            }

            // Handler for dropdown change
            function setOnlineStatusFromDropdown(status) {
                onlineStatus = status;
                if (status === 'away') {
                    manualAwaySet = true;
                } else {
                    manualAwaySet = false;
                }
                saveOnlineStatus();
                const labels = { online: 'ออนไลน์', dnd: 'ห้ามรบกวน', away: 'ไม่อยู่' };
                showNotif('Info', `เปลี่ยนสถานะเป็น: ${labels[status]} เรียบร้อยแล้ว`);
                renderOnlineUsersList();
            }

            // Update dropdown to match current status
            function updateStatusDropdown() {
                const dropdown = document.getElementById('status-dropdown');
                if (dropdown) dropdown.value = onlineStatus;
            }

            function showStatusSelector() {
                // Remove existing
                const existing = document.getElementById('status-selector-modal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'status-selector-modal';
                modal.className = 'fixed inset-0 z-[500] flex items-center justify-center p-4';
                modal.style.background = 'rgba(0,0,0,0.6)';
                modal.style.backdropFilter = 'blur(8px)';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                <div class="w-72 rounded-2xl p-5 animate-zoom-in" style="background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.95) 100%); border: 1px solid rgba(255,255,255,0.1);">
                    <h3 class="text-lg font-bold text-white mb-4 text-center">🎭 ตั้งค่าสถานะ</h3>
                    <div class="space-y-2">
                        <button onclick="setOnlineStatus('online'); document.getElementById('status-selector-modal').remove();" 
                            class="w-full py-3 rounded-xl flex items-center justify-center gap-2 transition ${onlineStatus === 'online' ? 'bg-emerald-600 text-white' : 'bg-slate-700 hover:bg-emerald-600/50 text-slate-300'}">
                            🟢 ออนไลน์
                        </button>
                        <button onclick="setOnlineStatus('dnd'); document.getElementById('status-selector-modal').remove();"
                            class="w-full py-3 rounded-xl flex items-center justify-center gap-2 transition ${onlineStatus === 'dnd' ? 'bg-red-600 text-white' : 'bg-slate-700 hover:bg-red-600/50 text-slate-300'}">
                            🔴 ห้ามรบกวน
                        </button>
                        <button onclick="setOnlineStatus('away'); document.getElementById('status-selector-modal').remove();"
                            class="w-full py-3 rounded-xl flex items-center justify-center gap-2 transition ${onlineStatus === 'away' ? 'bg-orange-600 text-white' : 'bg-slate-700 hover:bg-orange-600/50 text-slate-300'}">
                            🟠 ไม่อยู่
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-500 text-center mt-3">ห้ามรบกวน = สามารถ DM ได้ แต่ไม่แจ้งเตือน และไม่รับสาย</p>
                </div>
            `;
                document.body.appendChild(modal);
            }

            // Activity tracking for auto-away
            function startActivityTracking() {
                // Track activity
                const trackActivity = () => {
                    const wasAway = onlineStatus === 'away' && !manualAwaySet;
                    lastActivityTime = Date.now();
                    // If auto-away, return to online
                    if (wasAway) {
                        onlineStatus = 'online';
                        saveOnlineStatus();
                        renderOnlineUsersList();
                    }
                };

                document.addEventListener('mousemove', trackActivity);
                document.addEventListener('keypress', trackActivity);
                document.addEventListener('click', trackActivity);
                document.addEventListener('scroll', trackActivity);

                // Check inactivity every minute
                if (activityCheckInterval) clearInterval(activityCheckInterval);
                activityCheckInterval = setInterval(() => {
                    const inactiveMinutes = (Date.now() - lastActivityTime) / 60000;
                    // Auto-away after 15 minutes (only if not already away or dnd)
                    if (inactiveMinutes >= 15 && onlineStatus === 'online') {
                        manualAwaySet = false;
                        onlineStatus = 'away';
                        saveOnlineStatus();
                        renderOnlineUsersList();
                    }
                }, 60000);
            }

            // Legacy compatibility - replace old functions
            function toggleDMAllow() { showStatusSelector(); }
            function toggleCallAllow() { showStatusSelector(); }

            // Show DND call popup when trying to call someone in DND/Away mode
            function showDNDCallPopup(recipientName) {
                const modal = document.createElement('div');
                modal.id = 'dnd-call-popup';
                modal.className = 'fixed inset-0 z-[500] flex items-center justify-center p-4';
                modal.style.background = 'rgba(0,0,0,0.6)';
                modal.style.backdropFilter = 'blur(8px)';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

                modal.innerHTML = `
                <div class="w-80 rounded-2xl p-6 text-center animate-zoom-in" style="background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.95) 100%); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="text-5xl mb-4">🚫📞</div>
                    <h3 class="text-lg font-bold text-white mb-2">ไม่สามารถโทรหาได้ในขณะนี้</h3>
                    <p class="text-sm text-slate-400 mb-4">เนื่องจาก <span class="text-red-400 font-medium">${escapeHtml(recipientName)}</span> อยู่ในสถานะ<br><span class="text-red-400">🔴 ห้ามรบกวน</span></p>
                    <button onclick="document.getElementById('dnd-call-popup').remove()" 
                        class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition">
                        ตกลง
                    </button>
                </div>
            `;
                document.body.appendChild(modal);
            }

            // Update status indicator in header
            function updateStatusIndicator() {
                const icon = document.getElementById('status-indicator-icon');
                if (!icon) return;
                const icons = { online: '🟢', dnd: '🔴', away: '🟠' };
                icon.textContent = icons[onlineStatus] || '🟢';
            }

            async function clearDM() {
                if (!currentDMRecipient) return;
                const confirmed = await showConfirm('ยืนยันลบแชท', 'ต้องการล้างแชทนี้หรือไม่?');
                if (!confirmed) return;

                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const chatId = getDMChatId(myName, currentDMRecipient.name);

                try {
                    const snap = await db.collection('dm_chats').doc(chatId).collection('messages').get();
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showNotif('Success', '🗑️ ล้างแชทแล้ว');
                } catch (e) {
                    showNotif('Error', 'ล้างแชทไม่สำเร็จ');
                }
            }

            /* ========== CALL_FEATURE_START - Voice Call with WebRTC ========== */
            // Call Settings and State
            let callSettings = { allowCalls: true };
            let activeCall = null;
            let callUnsubscribe = null;
            let peerConnection = null;
            let localStream = null;
            let remoteAudio = null;
            let callTimer = null;
            let callSeconds = 0;
            let ringtoneAudio = null;
            let callMicVolume = 100;
            let callSpeakerVolume = 100;

            // Soft ringtone sound (gentle chime)
            const RINGTONE_URL = 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3';

            function playRingtone() {
                if (ringtoneAudio) return;
                ringtoneAudio = new Audio(RINGTONE_URL);
                ringtoneAudio.loop = true;
                ringtoneAudio.volume = 0.3; // Soft volume
                ringtoneAudio.play().catch(e => console.log('Ringtone error:', e));
            }

            function stopRingtone() {
                if (ringtoneAudio) {
                    ringtoneAudio.pause();
                    ringtoneAudio = null;
                }
            }

            function setCallMicVolume(val) {
                callMicVolume = Math.min(100, Math.max(0, parseInt(val) || 0));
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    // Note: Web Audio API would be needed for real gain control
                    // This is a simplified version
                }
            }

            function setCallSpeakerVolume(val) {
                callSpeakerVolume = Math.min(100, Math.max(0, parseInt(val) || 0));
                if (remoteAudio) {
                    remoteAudio.volume = callSpeakerVolume / 100;
                }
            }

            function loadCallSettings() {
                try {
                    const saved = localStorage.getItem(`call_settings_${currentUser?.username || 'guest'}`);
                    if (saved) callSettings = JSON.parse(saved);
                } catch (e) { }
            }

            function saveCallSettings() {
                localStorage.setItem(`call_settings_${currentUser?.username || 'guest'}`, JSON.stringify(callSettings));
            }

            function toggleCallAllow() {
                callSettings.allowCalls = !callSettings.allowCalls;
                saveCallSettings();
                showNotif('Info', callSettings.allowCalls ? '📞 อนุญาตให้โทรหาได้' : '🔇 ปิดรับสาย');
            }

            function getPeerId(name) {
                return `medic_op_${name.replace(/[^a-zA-Z0-9]/g, '_')}`;
            }

            function initPeer() {
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                if (!myName || peerConnection) return;

                const peerId = getPeerId(myName);
                peerConnection = new Peer(peerId, {
                    debug: 0
                });

                peerConnection.on('open', id => {
                    console.log('Peer ID:', id);
                });

                peerConnection.on('call', async (call) => {
                    if (!callSettings.allowCalls || activeCall) {
                        call.close();
                        return;
                    }

                    // Incoming call - get caller name from metadata
                    const callerName = call.metadata?.caller || 'Unknown';
                    activeCall = { call, isOutgoing: false, otherPerson: callerName };
                    playRingtone();
                    showCallUI('ringing', callerName, false);
                });

                peerConnection.on('error', err => {
                    console.log('Peer error:', err);
                    if (err.type === 'unavailable-id') {
                        // ID already taken, try with timestamp
                        setTimeout(() => {
                            peerConnection = null;
                            initPeer();
                        }, 2000);
                    }
                });
            }

            async function initiateCall(recipientName) {
                if (!currentUser || !peerConnection) {
                    initPeer();
                    setTimeout(() => initiateCall(recipientName), 1000);
                    return;
                }

                const myName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || '';
                if (myName === recipientName) return;
                if (activeCall) {
                    showNotif('Warning', 'มีสายอยู่แล้ว');
                    return;
                }

                try {
                    // Get microphone access
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

                    const recipientPeerId = getPeerId(recipientName);
                    const call = peerConnection.call(recipientPeerId, localStream, {
                        metadata: { caller: myName }
                    });

                    activeCall = { call, isOutgoing: true, otherPerson: recipientName };
                    showCallUI('ringing', recipientName, true);

                    call.on('stream', remoteStream => {
                        playRemoteAudio(remoteStream);
                        startCallTimer();
                        showCallUI('connected', recipientName, true);
                    });

                    call.on('close', () => {
                        endCall();
                    });

                    call.on('error', err => {
                        console.log('Call error:', err);
                        endCall();
                        showNotif('Error', 'ไม่สามารถเชื่อมต่อได้');
                    });

                    // Auto-end after 30 seconds if no answer
                    setTimeout(() => {
                        if (activeCall && activeCall.call === call && !remoteAudio) {
                            endCall();
                            showNotif('Info', 'ไม่มีผู้รับสาย');
                        }
                    }, 30000);

                } catch (err) {
                    console.log('Call error:', err);
                    showNotif('Error', 'ไม่สามารถเข้าถึงไมโครโฟน');
                }
            }

            async function answerCall() {
                if (!activeCall || !activeCall.call) return;
                stopRingtone();

                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    activeCall.call.answer(localStream);

                    activeCall.call.on('stream', remoteStream => {
                        playRemoteAudio(remoteStream);
                        startCallTimer();
                        showCallUI('connected', activeCall.otherPerson, false);
                    });

                    activeCall.call.on('close', () => {
                        endCall();
                    });

                } catch (err) {
                    console.log('Answer error:', err);
                    showNotif('Error', 'ไม่สามารถเข้าถึงไมโครโฟน');
                    endCall();
                }
            }

            function rejectCall() {
                if (activeCall?.call) {
                    activeCall.call.close();
                }
                endCall();
            }

            function endCall() {
                stopRingtone();
                if (activeCall?.call) {
                    activeCall.call.close();
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                if (remoteAudio) {
                    remoteAudio.pause();
                    remoteAudio.srcObject = null;
                    remoteAudio = null;
                }
                if (callTimer) {
                    clearInterval(callTimer);
                    callTimer = null;
                }
                callSeconds = 0;
                activeCall = null;
                hideCallUI();
            }

            function playRemoteAudio(stream) {
                remoteAudio = new Audio();
                remoteAudio.srcObject = stream;
                remoteAudio.play().catch(e => console.log('Audio play error:', e));
            }

            function startCallTimer() {
                callSeconds = 0;
                callTimer = setInterval(() => {
                    callSeconds++;
                    const mins = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                    const secs = (callSeconds % 60).toString().padStart(2, '0');
                    const timerEl = document.getElementById('call-timer');
                    if (timerEl) timerEl.textContent = `${mins}:${secs}`;
                }, 1000);
            }

            function toggleMute() {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        const muteBtn = document.getElementById('call-mute-btn');
                        if (muteBtn) muteBtn.textContent = audioTrack.enabled ? '🎤' : '🔇';
                    }
                }
            }

            function showCallUI(status, otherPerson, isOutgoing) {
                let ui = document.getElementById('call-overlay');
                if (!ui) {
                    ui = document.createElement('div');
                    ui.id = 'call-overlay';
                    ui.className = 'fixed inset-0 z-[200] bg-black/80 flex items-center justify-center';
                    document.body.appendChild(ui);
                }

                const statusText = status === 'ringing'
                    ? (isOutgoing ? '📞 กำลังโทร...' : '📞 มีสายเรียกเข้า')
                    : '🟢 กำลังคุย';

                ui.innerHTML = `
                <div class="bg-slate-800 rounded-2xl p-6 text-center max-w-xs w-full mx-4">
                    <div class="text-5xl mb-3">${status === 'connected' ? '🎧' : '📞'}</div>
                    <div class="text-xl text-white font-bold mb-1">${escapeHtml(otherPerson)}</div>
                    <div class="text-sm text-slate-400 mb-2">${statusText}</div>
                    ${status === 'connected' ? `
                        <div id="call-timer" class="text-lg text-emerald-400 font-mono mb-3">00:00</div>
                        <div class="mb-4 px-2">
                            <div class="flex items-center gap-2 text-xs text-slate-400">
                                <span>🔊</span>
                                <input type="range" min="0" max="100" value="${callSpeakerVolume}" 
                                    onchange="setCallSpeakerVolume(this.value)" 
                                    class="flex-1 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                                <span class="w-6">${callSpeakerVolume}%</span>
                            </div>
                        </div>
                    ` : '<div class="mb-4"></div>'}
                    <div class="flex gap-3 justify-center">
                        ${status === 'ringing' && !isOutgoing ? `
                            <button onclick="answerCall()" class="w-14 h-14 bg-green-500 hover:bg-green-600 rounded-full text-2xl transition">📞</button>
                            <button onclick="rejectCall()" class="w-14 h-14 bg-red-500 hover:bg-red-600 rounded-full text-2xl transition">❌</button>
                        ` : status === 'connected' ? `
                            <button id="call-mute-btn" onclick="toggleMute()" class="w-12 h-12 bg-slate-600 hover:bg-slate-500 rounded-full text-xl transition">🎤</button>
                            <button onclick="endCall()" class="w-14 h-14 bg-red-500 hover:bg-red-600 rounded-full text-2xl transition">📵</button>
                        ` : `
                            <button onclick="endCall()" class="w-14 h-14 bg-red-500 hover:bg-red-600 rounded-full text-2xl transition">📵</button>
                        `}
                    </div>
                </div>
            `;
                ui.classList.remove('hidden');
            }

            function hideCallUI() {
                const ui = document.getElementById('call-overlay');
                if (ui) ui.remove();
            }
            /* ========== CALL_FEATURE_END ========== */

            // Update presence every 2 minutes
            setInterval(() => {
                if (currentUser && !isGuest()) updateChatPresence();
            }, 120000);

            // Update guest presence every 1 minute (for active guests)
            setInterval(() => {
                if (isGuest() && currentUser?.guestId) updateGuestPresence();
            }, 60000);

            // Refresh guest count every 30 seconds for real-time updates (Owner only)
            setInterval(() => {
                if (currentUser?.role === 'Owner') loadGuestCount();
            }, 30000);

            function renderChatMessages() {
                const container = document.getElementById('chat-messages');
                if (!container) return;

                if (chatMessages.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-500 text-xs py-8">ยังไม่มีข้อความ<br>เริ่มสนทนาเลย! 💬</div>';
                    return;
                }

                const myFirstName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                const themeHex = (serverSettings?.themeColor || '#06b6d4').replace('#', '');

                container.innerHTML = chatMessages.map(m => {
                    const isMe = m.sender === myFirstName;
                    const time = m.timestamp ? new Date(m.timestamp.toDate()).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '';
                    const senderFirst = (m.sender || 'U').split(' ')[0];
                    // Fetch avatar from allUsers (op_users) instead of stored m.senderAvatar
                    const senderUserData = (allUsers || []).find(u => (u.firstName || u.fullName?.split(' ')[0]) === senderFirst);
                    const avatar = senderUserData?.avatar || m.senderAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(senderFirst)}&background=${themeHex}&color=fff&size=32`;
                    const roleColor = m.senderRole === 'Owner' ? 'text-amber-400' : m.senderRole === 'Admin' ? 'text-rose-400' : 'text-slate-400';
                    const replyPreview = m.replyTo ? `<div class="text-[10px] text-slate-400 bg-slate-800/50 px-2 py-1 rounded mb-1 border-l-2 border-blue-400">↩️ ${escapeHtml(m.replyTo.text?.substring(0, 30))}${m.replyTo.text?.length > 30 ? '...' : ''}</div>` : '';
                    const linkedText = m.text ? linkifyText(escapeHtml(m.text)) : '';
                    const reactionsHtml = renderMessageReactions(m);

                    // Image with popup viewer
                    const imageHtml = m.image ? `<img src="${m.image}" class="max-w-full max-h-48 rounded-lg mb-1 cursor-pointer" onclick="showImagePopup('${m.image}')" onerror="this.onerror=null;this.src='https://placehold.co/400x300?text=Image+Expired';this.alt='รูปภาพหมดอายุ';">` : '';

                    return isMe ? `
                    <div class="flex justify-end gap-1 group">
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="deleteChatMessage('${m.id}')" class="w-7 h-7 rounded-full bg-red-500/50 hover:bg-red-500 text-sm flex items-center justify-center transition" title="ลบข้อความ">🗑️</button>
                            <button onclick="showEmojiPicker('${m.id}')" class="w-7 h-7 rounded-full bg-slate-700/50 hover:bg-slate-600 text-sm flex items-center justify-center transition" title="เพิ่ม Emoji">😊</button>
                            <button onclick="setReplyTo('${m.id}', '${escapeHtml(senderFirst)}', '${escapeHtml(m.text?.substring(0, 50) || '[รูปภาพ]')}')" class="w-7 h-7 rounded-full bg-slate-700/50 hover:bg-slate-600 text-sm flex items-center justify-center transition" title="ตอบกลับ">↩️</button>
                        </div>
                        <div class="max-w-[70%]">
                            ${replyPreview}
                            ${imageHtml}
                            ${linkedText ? `<div class="bg-blue-500 text-white px-3 py-2 rounded-2xl rounded-br-md text-sm break-words">${linkedText}</div>` : ''}
                            ${reactionsHtml}
                            <div class="flex items-center justify-end gap-2 mt-0.5">
                                <span class="text-[10px] text-slate-500">${time}</span>
                                <span id="read-count-${m.id}" class="hidden text-[10px] text-emerald-400"></span>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="flex gap-2 group">
                        <img src="${avatar}" class="w-8 h-8 rounded-full shrink-0 mt-1 cursor-pointer hover:ring-2 hover:ring-purple-400 transition" onclick="showProfileMenu(event, '${escapeHtml(senderFirst)}', '${avatar}')" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(senderFirst)}&background=${themeHex}&color=fff&size=32'">
                        <div class="max-w-[70%]">
                            <div class="text-[10px] ${roleColor} font-medium mb-0.5 cursor-pointer hover:text-white transition" onclick="showProfileMenu(event, '${escapeHtml(senderFirst)}', '${avatar}')">${senderFirst}</div>
                            ${replyPreview}
                            ${imageHtml}
                            ${linkedText ? `<div class="bg-slate-700 text-white px-3 py-2 rounded-2xl rounded-bl-md text-sm break-words">${linkedText}</div>` : ''}
                            ${reactionsHtml}
                            <div class="text-[10px] text-slate-500 mt-0.5">${time}</div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="setReplyTo('${m.id}', '${escapeHtml(senderFirst)}', '${escapeHtml(m.text?.substring(0, 50) || '[รูปภาพ]')}')" class="w-7 h-7 rounded-full bg-slate-700/50 hover:bg-slate-600 text-sm flex items-center justify-center transition" title="ตอบกลับ">↩️</button>
                            <button onclick="showEmojiPicker('${m.id}')" class="w-7 h-7 rounded-full bg-slate-700/50 hover:bg-slate-600 text-sm flex items-center justify-center transition" title="เพิ่ม Emoji">😊</button>
                        </div>
                    </div>
                `;
                }).join('');

                if (chatOpen) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            function escapeHtml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }

            function linkifyText(text) {
                const urlRegex = /(https?:\/\/[^\s<]+)/g;
                const mentionRegex = /@(\w+)/g;
                // First linkify URLs
                let result = text.replace(urlRegex, '<a href="$1" target="_blank" class="text-cyan-300 hover:text-cyan-200 underline break-all">$1</a>');
                // Then highlight @mentions
                result = result.replace(mentionRegex, '<span class="bg-cyan-500/30 text-cyan-300 px-1 rounded">@$1</span>');
                return result;
            }

            function renderMessageReactions(msg) {
                if (!msg.reactions || Object.keys(msg.reactions).length === 0) return '';
                const reactionCounts = {};
                Object.values(msg.reactions).forEach(emoji => {
                    reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                });
                return `<div class="flex gap-1 mt-1 flex-wrap">${Object.entries(reactionCounts).map(([emoji, count]) =>
                    `<span class="bg-slate-600/50 px-1.5 py-0.5 rounded-full text-[10px] cursor-pointer hover:bg-slate-500/50" onclick="addReaction('${msg.id}', '${emoji}')">${emoji}${count > 1 ? ' ' + count : ''}</span>`
                ).join('')}</div>`;
            }

            let emojiPickerMsgId = null;
            const quickEmojis = ['👍', '❤️', '😂', '😮', '😢', '🔥', '👏', '🎉'];

            function showEmojiPicker(msgId) {
                // Remove existing picker
                const existing = document.getElementById('chat-emoji-picker');
                if (existing) existing.remove();

                if (emojiPickerMsgId === msgId) {
                    emojiPickerMsgId = null;
                    return;
                }
                emojiPickerMsgId = msgId;

                const picker = document.createElement('div');
                picker.id = 'chat-emoji-picker';
                picker.className = 'absolute bg-slate-800 border border-slate-600 rounded-xl p-2 shadow-xl z-50 flex gap-1';
                picker.innerHTML = quickEmojis.map(e =>
                    `<button onclick="addReaction('${msgId}', '${e}')" class="w-8 h-8 hover:bg-slate-700 rounded-lg text-lg transition">${e}</button>`
                ).join('');

                const container = document.getElementById('chat-messages');
                container.appendChild(picker);
                picker.style.bottom = '10px';
                picker.style.right = '10px';
            }

            async function addReaction(msgId, emoji) {
                if (!currentUser || isGuest()) return;
                const firstName = currentUser.firstName || (currentUser.fullName?.split(' ')[0]) || 'User';

                try {
                    const docRef = db.collection('chat').doc(msgId);
                    const doc = await docRef.get();
                    if (!doc.exists) return;

                    const reactions = doc.data().reactions || {};
                    // Toggle reaction
                    if (reactions[firstName] === emoji) {
                        delete reactions[firstName];
                    } else {
                        reactions[firstName] = emoji;
                    }

                    await docRef.update({ reactions });

                    // Remove picker
                    const picker = document.getElementById('chat-emoji-picker');
                    if (picker) picker.remove();
                    emojiPickerMsgId = null;
                } catch (e) { }
            }

            async function deleteChatMessage(msgId) {
                if (!currentUser) return;
                if (!confirm('ต้องการลบข้อความนี้หรือไม่?')) return;

                try {
                    await db.collection('chat').doc(msgId).delete();
                    showNotif('Success', '🗑️ ลบข้อความแล้ว');
                } catch (e) {
                    showNotif('Error', 'ลบข้อความไม่สำเร็จ');
                }
            }

            const inputEmojis = ['😊', '😂', '❤️', '👍', '👎', '🔥', '🎉', '👏', '😮', '😢', '😡', '🤔', '👋', '🙏', '💯', '✨'];

            function toggleInputEmojiPicker() {
                const picker = document.getElementById('input-emoji-picker');
                if (!picker) return;

                if (picker.classList.contains('hidden')) {
                    picker.innerHTML = inputEmojis.map(e =>
                        `<button onclick="insertEmoji('${e}')" class="w-8 h-8 hover:bg-slate-600 rounded-lg text-lg transition">${e}</button>`
                    ).join('');
                    picker.classList.remove('hidden');
                } else {
                    picker.classList.add('hidden');
                }
            }

            function insertEmoji(emoji) {
                const input = document.getElementById('chat-input');
                if (input) {
                    input.value += emoji;
                    input.focus();
                }
            }

            // Image Popup Viewer
            function showImagePopup(src) {
                const modal = document.getElementById('image-popup-modal');
                const img = document.getElementById('image-popup-img');
                const downloadBtn = document.getElementById('image-popup-download');
                if (!modal || !img) return;
                img.src = src;
                downloadBtn.href = src;
                // Extract original file extension from URL
                const extensionMatch = src.match(/\.(jpg|jpeg|png|gif|webp|bmp)/i);
                const extension = extensionMatch ? extensionMatch[0].toLowerCase() : '.png';
                const filename = `image_${Date.now()}${extension}`;
                downloadBtn.download = filename;
                modal.classList.remove('hidden');
            }

            function closeImagePopup(e) {
                if (e && e.target.id !== 'image-popup-modal') return;
                document.getElementById('image-popup-modal').classList.add('hidden');
            }

            let chatImageData = null;

            function previewChatImage(input) {
                const file = input.files[0];
                if (!file) return;

                // Check file size (max 500KB for base64)
                if (file.size > 500 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    chatImageData = e.target.result;
                    document.getElementById('chat-image-preview-img').src = chatImageData;
                    document.getElementById('chat-image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            function cancelImageUpload() {
                chatImageData = null;
                document.getElementById('chat-image-preview').classList.add('hidden');
                document.getElementById('chat-image-input').value = '';
            }

            function handleChatImagePaste(e) {
                const items = e.clipboardData?.items;
                if (!items) return;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (file.size > 500 * 1024) {
                            showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            chatImageData = ev.target.result;
                            document.getElementById('chat-image-preview-img').src = chatImageData;
                            document.getElementById('chat-image-preview').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        break;
                    }
                }
            }

            function handleChatImageDrop(e) {
                e.preventDefault();
                const file = e.dataTransfer?.files?.[0];
                if (!file || !file.type.startsWith('image/')) return;
                if (file.size > 500 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    chatImageData = ev.target.result;
                    document.getElementById('chat-image-preview-img').src = chatImageData;
                    document.getElementById('chat-image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            function updateChatUnread() {
                const seenIdx = chatMessages.findIndex(m => m.id === lastSeenMessageId);
                const unreadCount = seenIdx === -1 ? chatMessages.length : chatMessages.length - seenIdx - 1;
                const badge = document.getElementById('chat-unread');
                if (badge && unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.classList.remove('hidden');
                } else if (badge) {
                    badge.classList.add('hidden');
                }
            }

            function setReplyTo(msgId, senderName, text) {
                replyingTo = { id: msgId, sender: senderName, text: text };
                updateReplyPreview();
                document.getElementById('chat-input').focus();
            }

            function cancelReply() {
                replyingTo = null;
                updateReplyPreview();
            }

            function updateReplyPreview() {
                let preview = document.getElementById('chat-reply-preview');
                if (!preview) {
                    const inputArea = document.querySelector('#chat-window .p-3.bg-slate-800');
                    if (!inputArea) return;
                    const div = document.createElement('div');
                    div.id = 'chat-reply-preview';
                    div.className = 'hidden mb-2 bg-slate-700/50 rounded-lg px-3 py-2 flex items-center justify-between';
                    inputArea.insertBefore(div, inputArea.firstChild);
                    preview = div;
                }

                if (replyingTo) {
                    preview.innerHTML = `
                    <div class="flex items-center gap-2 text-xs text-slate-300 overflow-hidden">
                        <span class="text-blue-400">↩️</span>
                        <span class="font-medium">${replyingTo.sender}:</span>
                        <span class="truncate opacity-70">${replyingTo.text}</span>
                    </div>
                    <button onclick="cancelReply()" class="text-slate-400 hover:text-white text-sm ml-2">✕</button>
                `;
                    preview.classList.remove('hidden');
                } else {
                    preview.classList.add('hidden');
                }
            }

            function toggleChatSound() {
                chatSoundEnabled = !chatSoundEnabled;
                localStorage.setItem('chat_sound_enabled', chatSoundEnabled);
                const btn = document.getElementById('chat-sound-btn');
                if (btn) btn.textContent = chatSoundEnabled ? '🔔' : '🔕';
                showNotif('Info', chatSoundEnabled ? '🔔 เปิดเสียงแจ้งเตือนแชท' : '🔕 ปิดเสียงแจ้งเตือนแชท');
            }

            function updateChatSoundBtn() {
                const btn = document.getElementById('chat-sound-btn');
                if (btn) btn.textContent = chatSoundEnabled ? '🔔' : '🔕';
            }

            async function clearAllChat() {
                if (currentUser?.role !== 'Owner') return showNotif('Error', 'เฉพาะ Owner เท่านั้น');
                const c = await showConfirm('ล้างประวัติแชท', 'ข้อความทั้งหมดจะถูกลบ ดำเนินการต่อ?');
                if (!c) return;

                try {
                    const snap = await db.collection('chat').get();
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showNotif('Success', '🗑️ ล้างประวัติแชทเรียบร้อย');
                } catch (e) {
                    showNotif('Error', 'ล้างประวัติไม่สำเร็จ');
                }
            }

            // Auto-clean old messages (older than 1 week)
            async function cleanOldChatMessages() {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                try {
                    const snap = await db.collection('chat').where('timestamp', '<', oneWeekAgo).get();
                    if (snap.empty) return;
                    const batch = db.batch();
                    snap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    console.log(`Cleaned ${snap.docs.length} old chat messages`);
                } catch (e) { }
            }
            // ==================== END CHAT SYSTEM ====================

            function showNotif(t, m, type = null) { const modal = document.getElementById('notification'); document.getElementById('notif-title').textContent = t; document.getElementById('notif-msg').textContent = m; const iconEl = document.getElementById('notif-icon'); if (!type) { if (/Success|สำเร็จ|เรียบร้อย/.test(t)) type = 'success'; else if (/Error|ผิดพลาด/.test(t)) type = 'error'; } if (type === 'success') iconEl.innerHTML = `<svg class="checkmark" viewBox="0 0 52 52"><circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" stroke-width="2"/><path class="checkmark-check" fill="none" stroke-width="2" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg>`; else if (type === 'error') iconEl.innerHTML = `<svg class="cross-icon" viewBox="0 0 52 52"><circle class="cross-circle" cx="26" cy="26" r="25" fill="none" stroke-width="2"/><path class="cross-line" fill="none" stroke-width="2" d="M16 16 36 36 M36 16 16 36"/></svg>`; else iconEl.innerHTML = '<div class="text-3xl opacity-60">ℹ️</div>'; modal.classList.remove('hidden'); if (type === 'success') setTimeout(() => modal.classList.add('hidden'), 1500); }
            function closeNotif() { document.getElementById('notification').classList.add('hidden'); }
            function showConfirm(t, m) { return new Promise(r => { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-msg').textContent = m; const modal = document.getElementById('confirm-modal'); modal.classList.remove('hidden'); document.getElementById('confirm-yes-btn').onclick = () => { modal.classList.add('hidden'); r(true); }; document.getElementById('confirm-no-btn').onclick = () => { modal.classList.add('hidden'); r(false); }; }); }

            function showAuthTab(tab) { const lf = document.getElementById('login-form'), rf = document.getElementById('register-form'), tl = document.getElementById('tab-login'), tr = document.getElementById('tab-register'); if (tab === 'login') { lf.classList.remove('hidden'); rf.classList.add('hidden'); tl.classList.add('text-indigo-400', 'border-indigo-400'); tl.classList.remove('text-slate-500', 'border-transparent'); tr.classList.remove('text-indigo-400', 'border-indigo-400'); tr.classList.add('text-slate-500', 'border-transparent'); } else { lf.classList.add('hidden'); rf.classList.remove('hidden'); tr.classList.add('text-indigo-400', 'border-indigo-400'); tr.classList.remove('text-slate-500', 'border-transparent'); tl.classList.remove('text-indigo-400', 'border-indigo-400'); tl.classList.add('text-slate-500', 'border-transparent'); } }
            async function handleLogin() { const u = document.getElementById('login-username').value.trim(), p = document.getElementById('login-password').value, r = document.getElementById('login-remember').checked; if (!u || !p) return showNotif('Error', 'กรุณากรอกข้อมูลให้ครบ'); try { const doc = await db.collection('op_users').doc(u).get(); if (!doc.exists) return showNotif('Error', 'ไม่พบผู้ใช้'); const user = doc.data(); if (user.password !== p) return showNotif('Error', 'รหัสผ่านไม่ถูกต้อง'); currentUser = { username: u, ...user }; sessionStorage.setItem('op_session_current', JSON.stringify(currentUser)); if (r) localStorage.setItem('op_session', JSON.stringify({ user: currentUser, expiry: Date.now() + 7 * 24 * 60 * 60 * 1000 })); loginSuccess(); } catch (e) { console.error('Login error:', e); showNotif('Error', 'เกิดข้อผิดพลาด: ' + e.message); } }
            async function handleRegister() { const u = document.getElementById('reg-username').value.trim(), p = document.getElementById('reg-password').value, fn = document.getElementById('reg-firstname').value.trim(), ln = document.getElementById('reg-lastname').value.trim(), av = document.getElementById('reg-avatar').value.trim(), icPhone = document.getElementById('reg-ic-phone').value.trim(), ss = document.getElementById('reg-shift-start').value, se = document.getElementById('reg-shift-end').value; if (!u || !p || !fn || !ln) return showNotif('Error', 'กรุณากรอกข้อมูลให้ครบ'); try { const ex = await db.collection('op_users').doc(u).get(); if (ex.exists) return showNotif('Error', 'Username นี้มีผู้ใช้แล้ว'); await db.collection('op_users').doc(u).set({ password: p, firstName: fn, lastName: ln, fullName: `${fn} ${ln}`, avatar: av || '', icPhone: icPhone || '', shiftStart: ss, shiftEnd: se, workStatus: 'ทำงาน', role: 'Member', createdAt: Date.now() }); document.getElementById('reg-username').value = ''; document.getElementById('reg-password').value = ''; document.getElementById('reg-firstname').value = ''; document.getElementById('reg-lastname').value = ''; document.getElementById('reg-avatar').value = ''; document.getElementById('reg-ic-phone').value = ''; document.getElementById('reg-shift-start').value = ''; document.getElementById('reg-shift-end').value = ''; showNotif('Success', 'สมัครสมาชิกสำเร็จ!'); showAuthTab('login'); } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); } }
            // App Version & Changelog
            // Version format: X.Y.Z - Update Z by +1 each deploy. When Z=9, next is Y+1 with Z=0
            // Example: 1.3.9 -> 1.4.0 -> 1.4.1 -> ... -> 1.4.9 -> 1.5.0
            const APP_VERSION = '1.6.1-build.14';

            // Update all version displays from APP_VERSION (single source of truth)
            function updateVersionDisplays() {
                const verStr = `v.${APP_VERSION}`;
                // Title
                document.title = `🏥 .:: Medical OP Systems ::. ${verStr} by Bonchon-Studio`;
                // Title bar (Electron)
                const titleBar = document.querySelector('.title-bar-text');
                if (titleBar) titleBar.textContent = `Medical OP Systems ${verStr}`;
                // Login version
                const loginVer = document.getElementById('login-version-display');
                if (loginVer) loginVer.textContent = verStr;
            }
            // Update on DOM ready
            document.addEventListener('DOMContentLoaded', updateVersionDisplays);

            function showChangelogModal() { document.getElementById('changelog-modal').classList.remove('hidden'); }
            function closeChangelogModal() { document.getElementById('changelog-modal').classList.add('hidden'); localStorage.setItem('op_last_seen_version', APP_VERSION); }
            function checkShowChangelog() { const lastSeen = localStorage.getItem('op_last_seen_version'); if (lastSeen !== APP_VERSION) { setTimeout(() => showChangelogModal(), 500); } }

            // Welcome Animation (Electron Only)
            function showWelcomeAnimation() {
                // Only show in Electron app (check both methods)
                const isElectron = window.isElectronApp || window.electronEnv?.isElectron;
                if (!isElectron) return;

                const overlay = document.getElementById('welcome-overlay');
                const particlesContainer = document.getElementById('welcome-particles');
                const greetingEl = document.getElementById('welcome-greeting');
                const usernameEl = document.getElementById('welcome-username');

                if (!overlay) return;

                // Set greeting based on time
                const hour = new Date().getHours();
                let greeting = 'ยินดีต้อนรับ';
                if (hour >= 5 && hour < 12) greeting = 'สวัสดีตอนเช้า';
                else if (hour >= 12 && hour < 17) greeting = 'สวัสดีตอนบ่าย';
                else if (hour >= 17 && hour < 21) greeting = 'สวัสดีตอนเย็น';
                else greeting = 'สวัสดีตอนกลางคืน';

                greetingEl.textContent = greeting;
                usernameEl.textContent = currentUser?.firstName || currentUser?.fullName || 'User';

                // Create particles
                particlesContainer.innerHTML = '';
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'welcome-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 2 + 's';
                    particle.style.opacity = Math.random() * 0.5 + 0.3;
                    particlesContainer.appendChild(particle);
                }

                // Show overlay
                overlay.classList.remove('hidden');

                // Auto hide after 2.5 seconds
                setTimeout(() => {
                    overlay.classList.add('fade-out');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('fade-out');
                    }, 500);
                }, 2500);
            }

            function loginSuccess(showWelcome = true) { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); loadOpData(); loadServerSettings(); loadOnlineStatus(); loadMedicalFees(); loadBlacklist(); loadMusicSettings(); loadChatMessages(); cleanOldChatMessages(); updateHeader(); updateUserAvatar(); if (['Owner', 'Admin', 'Staff'].includes(currentUser?.role)) document.getElementById('staff-admin-btn').classList.remove('hidden'); clearOldLogs(); applyRoleRestrictions(); if (showWelcome) { showWelcomeAnimation(); } checkShowChangelog(); if (currentUser?.role === 'Owner') { db.collection('op_settings').doc('server').set({ version: APP_VERSION, updatedAt: Date.now(), updatedBy: 'System (Post-Deploy)' }, { merge: true }).catch(e => console.log('Version update failed:', e)); } setTimeout(() => { const dmBubblesContainer = document.getElementById('dm-bubbles-container'); const dmExpandedContainer = document.getElementById('dm-expanded-container'); if (dmBubblesContainer) dmBubblesContainer.classList.remove('hidden'); if (dmExpandedContainer) dmExpandedContainer.classList.remove('hidden'); loadDMBubbleState(); listenToLastMessages(); }, 1000); }
            function isOP() { if (!appData.currentOP) return false; return currentUser?.fullName === appData.supOP || currentUser?.fullName === appData.currentOP; }
            function isCurrentOPorSupOP() { return currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP; }
            function isGuest() { return currentUser?.isGuest === true || currentUser?.role === 'Guest'; }
            function enterAsGuest() {
                // Generate unique guest ID for this session
                const guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                currentUser = {
                    username: 'guest',
                    fullName: 'Guest User',
                    firstName: 'Guest',
                    lastName: 'User',
                    role: 'Guest',
                    isGuest: true,
                    guestId: guestId
                };
                // Don't save to session/localStorage for Guest
                loginSuccess(false);
                showNotif('Info', '👁️ เข้าระบบแบบ Guest - ดูได้อย่างเดียว');

                // Track guest presence
                updateGuestPresence();

                // Clean up guest on page unload
                window.addEventListener('beforeunload', removeGuestPresence);
            }
            function applyRoleRestrictions() {
                const hasOP = !!appData.currentOP;
                const isOPUser = isOP();
                const isStaffPlus = currentUser?.role && ['Staff', 'Admin', 'Owner'].includes(currentUser.role);
                // Guest can NEVER edit - view only mode
                // Can edit if: NOT Guest AND (OP/SupOP when on duty, OR Staff+ when no OP)
                const canEdit = !isGuest() && (hasOP ? isOPUser : isStaffPlus);

                // Hide navbar items for Guest
                const cmdBtn = document.getElementById('tab-cmd-btn');
                if (cmdBtn) cmdBtn.classList.toggle('hidden', isGuest());

                // Hide profile avatar click for Guest (replace with Guest badge)
                const userAvatar = document.getElementById('user-avatar');
                const guestBadge = document.getElementById('guest-badge');
                if (userAvatar && guestBadge) {
                    userAvatar.classList.toggle('hidden', isGuest());
                    guestBadge.classList.toggle('hidden', !isGuest());
                }

                // Hide Sup OP section for Guest
                const supSection = document.getElementById('op-sup-section');
                if (supSection) supSection.classList.toggle('hidden', isGuest());

                // Disable Personnel Lists (On Duty, Off Duty, AFK) for Guest - view only
                const personnelSection = document.getElementById('personnel-lists-section');
                if (personnelSection) {
                    if (isGuest()) {
                        personnelSection.classList.add('pointer-events-none');
                        personnelSection.querySelectorAll('button, input').forEach(el => {
                            el.disabled = true;
                            el.classList.add('opacity-50', 'cursor-not-allowed');
                        });
                    } else {
                        personnelSection.classList.remove('pointer-events-none');
                    }
                }

                // Hide chat widget for Guest
                const chatWidget = document.getElementById('chat-widget');
                if (chatWidget) chatWidget.classList.toggle('hidden', isGuest());

                document.querySelectorAll('[data-op-only]').forEach(el => {
                    if (!canEdit) {
                        el.disabled = true;
                        el.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    } else {
                        el.disabled = false;
                        el.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    }
                });
                document.querySelectorAll('[data-op-only-view]').forEach(el => {
                    if (!canEdit) el.classList.add('hidden');
                    else el.classList.remove('hidden');
                });
                document.querySelectorAll('.medic-action-btn').forEach(el => {
                    if (!canEdit) {
                        el.disabled = true;
                        el.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    } else {
                        el.disabled = false;
                        el.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    }
                });
                const supSelect = document.getElementById('op-sup-select');
                if (supSelect && currentUser?.fullName === appData.supOP) {
                    supSelect.disabled = true;
                    supSelect.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
            function handleLogout() {
                // Clear chat presence immediately so other users see us offline
                const myName = currentUser?.firstName || (currentUser?.fullName?.split(' ')[0]) || '';
                if (myName) {
                    db.collection('chat_presence').doc(myName).delete().catch(() => { });
                }

                sessionStorage.removeItem('op_session_current');
                localStorage.removeItem('op_session');
                currentUser = null;

                // In Electron, go back to separate login window
                if (window.windowControls && window.windowControls.logout) {
                    window.windowControls.logout();
                    return;
                }

                // Web version: show embedded login form
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('staff-admin-btn').classList.add('hidden');
                // Hide and reset chat
                const chatWidget = document.getElementById('chat-widget');
                if (chatWidget) chatWidget.classList.add('hidden');
                const chatWindow = document.getElementById('chat-window');
                if (chatWindow) chatWindow.classList.add('hidden');
                chatOpen = false;
                if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
                if (chatOnlineUnsubscribe) { chatOnlineUnsubscribe(); chatOnlineUnsubscribe = null; }
                // Hide DM containers (but keep state for when user logs back in)
                const dmBubblesContainer = document.getElementById('dm-bubbles-container');
                const dmExpandedContainer = document.getElementById('dm-expanded-container');
                if (dmBubblesContainer) dmBubblesContainer.classList.add('hidden');
                if (dmExpandedContainer) dmExpandedContainer.classList.add('hidden');
                // Save DM state and stop incoming listener
                saveDMBubbleState();
                stopIncomingDMListener();
                // Stop music
                if (musicAudio) { musicAudio.pause(); musicAudio = null; }
                if (ytPlayer && ytPlayer.stopVideo) { ytPlayer.stopVideo(); }
                musicPlaying = false;
                const playBtn = document.getElementById('music-play-btn');
                if (playBtn) playBtn.textContent = '▶️';
            }
            function updateUserAvatar() { if (currentUser) { const themeHex = (serverSettings.themeColor || '#06b6d4').replace('#', ''); const av = currentUser.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.fullName || 'U')}&background=${themeHex}&color=fff&size=40`; document.getElementById('user-avatar').src = av; } }
            function showProfileModal() { if (!currentUser) return; document.getElementById('profile-firstname').value = currentUser.firstName || (currentUser.fullName?.split(' ')[0] || ''); document.getElementById('profile-lastname').value = currentUser.lastName || (currentUser.fullName?.split(' ').slice(1).join(' ') || ''); document.getElementById('profile-avatar').value = currentUser.avatar || ''; document.getElementById('profile-ic-phone').value = currentUser.icPhone || ''; document.getElementById('profile-shift-start').value = currentUser.shiftStart || ''; document.getElementById('profile-shift-end').value = currentUser.shiftEnd || ''; document.getElementById('profile-work-status').value = currentUser.workStatus || 'ทำงาน'; updateProfilePreview(); renderShiftHistoryInProfile(); updateDiscordLinkUI(); document.getElementById('profile-modal').classList.remove('hidden'); }
            function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); document.getElementById('password-change-section').classList.add('hidden'); document.getElementById('profile-current-password').value = ''; document.getElementById('profile-new-password').value = ''; document.getElementById('profile-confirm-password').value = ''; }
            function togglePasswordChange() { document.getElementById('password-change-section').classList.toggle('hidden'); }
            async function changePassword() { const curr = document.getElementById('profile-current-password').value, newP = document.getElementById('profile-new-password').value, conf = document.getElementById('profile-confirm-password').value; if (!curr || !newP || !conf) return showNotif('Error', 'กรุณากรอกข้อมูลให้ครบ'); if (newP !== conf) return showNotif('Error', 'รหัสผ่านใหม่ไม่ตรงกัน'); if (newP.length < 4) return showNotif('Error', 'รหัสผ่านต้องมีอย่างน้อย 4 ตัวอักษร'); if (curr !== currentUser.password) return showNotif('Error', 'รหัสผ่านปัจจุบันไม่ถูกต้อง'); try { await db.collection('op_users').doc(currentUser.username).update({ password: newP }); currentUser.password = newP; sessionStorage.setItem('op_session_current', JSON.stringify(currentUser)); const sess = localStorage.getItem('op_session'); if (sess) { const s = JSON.parse(sess); s.user.password = newP; localStorage.setItem('op_session', JSON.stringify(s)); } document.getElementById('profile-current-password').value = ''; document.getElementById('profile-new-password').value = ''; document.getElementById('profile-confirm-password').value = ''; document.getElementById('password-change-section').classList.add('hidden'); showNotif('Success', 'เปลี่ยนรหัสผ่านสำเร็จ'); } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); } }
            function updateProfilePreview() { const url = document.getElementById('profile-avatar').value.trim(); const name = currentUser?.fullName || 'U'; document.getElementById('profile-preview').src = url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6366f1&color=fff&size=80`; }

            // Profile image upload
            let pendingProfileImage = null;

            function previewProfileImage(input) {
                const file = input.files[0];
                if (!file) return;
                if (file.size > 2 * 1024 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 2MB');
                    input.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profile-preview').src = e.target.result;
                    document.getElementById('profile-upload-status').textContent = '✓ พร้อม Upload';
                    pendingProfileImage = file;
                };
                reader.readAsDataURL(file);
            }

            async function uploadProfileImage(file) {
                const userId = currentUser?.username;
                if (!userId || !file) return null;

                const timestamp = Date.now();
                const ext = file.name.split('.').pop();
                const path = `avatars/${userId}_${timestamp}.${ext}`;

                try {
                    const ref = storage.ref(path);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();
                    return { url, path };
                } catch (e) {
                    console.error('Upload error:', e);
                    return null;
                }
            }

            async function deleteOldProfileImage(oldPath) {
                if (!oldPath || !oldPath.startsWith('avatars/')) return;
                try {
                    await storage.ref(oldPath).delete();
                } catch (e) { }
            }


            async function saveProfile() {
                if (!currentUser) return;
                const fn = document.getElementById('profile-firstname').value.trim(),
                    ln = document.getElementById('profile-lastname').value.trim(),
                    icPhone = document.getElementById('profile-ic-phone').value.trim(),
                    ss = document.getElementById('profile-shift-start').value,
                    se = document.getElementById('profile-shift-end').value,
                    ws = document.getElementById('profile-work-status').value;
                if (!fn || !ln) return showNotif('Error', 'กรุณากรอกชื่อและนามสกุล');

                try {
                    let av = document.getElementById('profile-avatar').value.trim();
                    let avatarPath = currentUser.avatarPath || '';

                    // Upload new avatar if pending
                    if (pendingProfileImage) {
                        document.getElementById('profile-upload-status').textContent = '⏳ กำลัง Upload...';
                        const result = await uploadProfileImage(pendingProfileImage);
                        if (result) {
                            if (avatarPath) await deleteOldProfileImage(avatarPath);
                            av = result.url;
                            avatarPath = result.path;
                        }
                        pendingProfileImage = null;
                    }

                    const fullName = `${fn} ${ln}`;
                    await db.collection('op_users').doc(currentUser.username).update({
                        firstName: fn, lastName: ln, fullName, avatar: av, avatarPath, icPhone, shiftStart: ss, shiftEnd: se, workStatus: ws
                    });
                    currentUser.firstName = fn; currentUser.lastName = ln; currentUser.fullName = fullName;
                    currentUser.avatar = av; currentUser.avatarPath = avatarPath;
                    currentUser.icPhone = icPhone; currentUser.shiftStart = ss; currentUser.shiftEnd = se; currentUser.workStatus = ws;
                    sessionStorage.setItem('op_session_current', JSON.stringify(currentUser));
                    const sess = localStorage.getItem('op_session');
                    if (sess) { const s = JSON.parse(sess); s.user = currentUser; localStorage.setItem('op_session', JSON.stringify(s)); }
                    updateUserAvatar(); closeProfileModal(); showNotif('Success', 'บันทึกข้อมูลเรียบร้อย');
                } catch (e) {
                    console.error('Save profile error:', e);
                    showNotif('Error', 'เกิดข้อผิดพลาด');
                }
            }

            // Medic Status Functions (รับเคส/ไม่รับเคส/รอเคสแก้)
            function toggleMedicStatus(name, status) {
                if (!appData.medicStatuses) appData.medicStatuses = {};
                hideQueueWarning();

                if (!status) {
                    delete appData.medicStatuses[name];
                } else if (appData.medicStatuses[name] === status) {
                    delete appData.medicStatuses[name];
                } else if (status === 'accept') {
                    // WARNING 1: If this medic has 'decline' status, show warning
                    if (appData.medicStatuses[name] === 'decline') {
                        showQueueWarning(name, '⚠️ ยกเลิกไม่รับเคสก่อน', true);
                        return;
                    }
                    // WARNING 2: If someone else has 'waitfix', must run their case first
                    const waitfixMedic = Object.keys(appData.medicStatuses).find(k => appData.medicStatuses[k] === 'waitfix');
                    if (waitfixMedic && waitfixMedic !== name) {
                        showQueueWarning(waitfixMedic, `⚠️ กรุณารันเคสแก้ก่อน`);
                        return;
                    }
                    // Clear accept from others first
                    for (const k in appData.medicStatuses) {
                        if (appData.medicStatuses[k] === 'accept') delete appData.medicStatuses[k];
                    }
                    appData.medicStatuses[name] = 'accept';
                } else {
                    appData.medicStatuses[name] = status;
                }
                saveOpData();
            }

            // Show queue warning popup above the medic's Accept button
            function showQueueWarning(medicName, message, isDecline = false) {
                hideQueueWarning();
                const listOnDuty = document.getElementById('list-on-duty');
                if (!listOnDuty) return;

                // Find the medic container by name
                const containers = listOnDuty.querySelectorAll('.flex.flex-col');
                let medicContainer = null;
                containers.forEach(c => {
                    if (c.textContent.includes(medicName.split(' ')[0])) medicContainer = c;
                });
                if (!medicContainer) return;

                // Find the button row (second child div with flex-wrap)
                const buttonRow = medicContainer.querySelector('.flex.items-center.gap-1.flex-wrap');
                if (!buttonRow) return;

                const popup = document.createElement('div');
                popup.id = 'queue-warning-popup';
                const bgColor = isDecline ? 'bg-rose-500' : 'bg-amber-500';
                popup.className = `queue-warning-popup absolute z-50 ${bgColor} text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg whitespace-nowrap`;
                popup.innerHTML = message;
                popup.style.cssText = 'bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 1px;';

                buttonRow.style.position = 'relative';
                buttonRow.appendChild(popup);
                setTimeout(hideQueueWarning, 3000);
            }

            function hideQueueWarning() {
                const popup = document.getElementById('queue-warning-popup');
                if (popup) popup.remove();
            }

            // Notification Panel Functions
            let notifications = [];
            function playNotifSound() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.type = 'sine'; osc.connect(gain); gain.connect(ctx.destination); osc.frequency.value = 440; gain.gain.value = 0.15; osc.start(); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5); osc.stop(ctx.currentTime + 0.5); } catch (e) { } }
            function toggleNotifPanel() { const panel = document.getElementById('notif-panel'); panel.classList.toggle('hidden'); if (!panel.classList.contains('hidden')) { document.getElementById('notif-badge').classList.add('hidden'); } }
            function addNotification(msg, type = 'info', actions = null) { const notif = { id: Date.now(), msg, type, actions, time: new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) }; notifications.unshift(notif); if (notifications.length > 20) notifications.pop(); renderNotifList(); playNotifSound(); }
            function renderNotifList() { const list = document.getElementById('notif-list'); const badge = document.getElementById('notif-badge'); if (notifications.length === 0) { list.innerHTML = '<p class="text-xs text-slate-500 text-center py-4">ไม่มีแจ้งเตือน</p>'; badge.classList.add('hidden'); } else { list.innerHTML = notifications.map((n, i) => { const actionsHTML = n.actions ? `<div class="flex gap-1 mt-1">${n.actions.map(a => `<button onclick="${a.action}" class="px-2 py-0.5 rounded text-[10px] ${a.color} text-white">${a.label}</button>`).join('')}</div>` : ''; return `<div class="px-4 py-2 border-b border-slate-700/30 hover:bg-slate-800/50"><div class="flex items-start gap-2"><span class="text-sm ${n.type === 'warning' ? 'text-amber-400' : n.type === 'error' ? 'text-rose-400' : n.type === 'success' ? 'text-emerald-400' : 'text-cyan-400'}">${n.type === 'warning' ? '⚠️' : n.type === 'error' ? '❌' : n.type === 'success' ? '✅' : 'ℹ️'}</span><div class="flex-1"><p class="text-xs text-white">${n.msg}</p>${actionsHTML}<p class="text-[10px] text-slate-500 mt-0.5">${n.time}</p></div><button onclick="removeNotif(${i})" class="text-slate-500 hover:text-white text-xs">×</button></div></div>`; }).join(''); badge.textContent = notifications.length; badge.classList.remove('hidden'); } }
            function removeNotif(idx) { notifications.splice(idx, 1); renderNotifList(); }
            function clearNotifPanel() { notifications = []; renderNotifList(); toggleNotifPanel(); }
            setInterval(() => { notifications = []; renderNotifList(); }, 60 * 60 * 1000);

            // AFK Warning System - check every 30 seconds
            setInterval(() => {
                if (!isOP() || !appData.afk?.length) return;
                const now = Date.now();
                if (!appData.afkWarnedTimes) appData.afkWarnedTimes = {};
                (appData.afk || []).forEach(name => {
                    const start = appData.afkTimes?.[name] || now;
                    const mins = Math.floor((now - start) / 60000);
                    if (!appData.afkWarnedTimes[name]) appData.afkWarnedTimes[name] = { 5: false, 15: false, 30: false };
                    // Warn at 5, 15, 30 mins - only if not warned yet
                    [5, 15, 30].forEach(m => {
                        if (mins >= m && !appData.afkWarnedTimes[name][m]) {
                            appData.afkWarnedTimes[name][m] = true;
                            if (!appData.afkWarnings) appData.afkWarnings = {};
                            appData.afkWarnings[name] = (appData.afkWarnings[name] || 0) + 1;
                            addNotification(`⚠️ AFK ${m} นาที: ${name}`, 'warning');
                            // Auto move to Off Duty if 3 warnings
                            if (appData.afkWarnings[name] >= 3) {
                                const idx = appData.afk.indexOf(name);
                                if (idx > -1) {
                                    appData.afk.splice(idx, 1);
                                    appData.offDuty.push(name);
                                    delete appData.afkTimes[name];
                                    delete appData.afkWarnedTimes[name];
                                    delete appData.afkWarnings[name];
                                    addNotification(`⛔ ${name} ถูกย้ายไป Off Duty (AFK >=3 ครั้ง)`, 'error');
                                }
                            }
                            // Auto-clear warnings 5 min after 30min warning
                            if (m === 30) {
                                setTimeout(() => {
                                    if (appData.afkWarnings?.[name]) {
                                        delete appData.afkWarnings[name];
                                        delete appData.afkWarnedTimes[name];
                                        saveOpData();
                                    }
                                }, 5 * 60 * 1000);
                            }
                            saveOpData();
                        }
                    });
                });
            }, 30000);

            // Main Tab Switching
            let currentMainTab = 'op';
            function switchMainTab(tab) {
                currentMainTab = tab;
                const opView = document.querySelector('#app-container > .flex-1:not(#cmd-view):not(#manual-view)');
                const cmdView = document.getElementById('cmd-view');
                const manualView = document.getElementById('manual-view');
                const opBtn = document.getElementById('tab-op-btn');
                const cmdBtn = document.getElementById('tab-cmd-btn');
                const manualBtn = document.getElementById('tab-manual-btn');

                // Hide all views first (with null checks)
                if (opView) opView.classList.add('hidden');
                if (cmdView) cmdView.classList.add('hidden');
                if (manualView) manualView.classList.add('hidden');

                // Reset all button styles (with null checks)
                if (opBtn) { opBtn.classList.remove('text-cyan-400'); opBtn.classList.add('text-slate-400'); }
                if (cmdBtn) { cmdBtn.classList.remove('text-cyan-400'); cmdBtn.classList.add('text-slate-400'); }
                if (manualBtn) { manualBtn.classList.remove('text-cyan-400'); manualBtn.classList.add('text-slate-400'); }

                if (tab === 'op') {
                    if (opView) opView.classList.remove('hidden');
                    if (opBtn) { opBtn.classList.add('text-cyan-400'); opBtn.classList.remove('text-slate-400'); const span = opBtn.querySelector('span'); if (span) span.classList.remove('hidden'); }
                } else if (tab === 'cmd') {
                    if (cmdView) cmdView.classList.remove('hidden');
                    if (cmdBtn) { cmdBtn.classList.add('text-cyan-400'); cmdBtn.classList.remove('text-slate-400'); }
                } else if (tab === 'manual') {
                    if (manualView) manualView.classList.remove('hidden');
                    if (manualBtn) { manualBtn.classList.add('text-cyan-400'); manualBtn.classList.remove('text-slate-400'); }
                }
            }

            // Story Tab Switching (นับไฟท์ / อุ้มเอ๋อ)
            function setStoryTab(tab) {
                const btnFight = document.getElementById('story-tab-fight');
                const btnUmae = document.getElementById('story-tab-umae');
                const viewFight = document.getElementById('story-view-fight');
                const viewUmae = document.getElementById('story-view-umae');

                // Check if non-OP user can access umae tab
                if (tab === 'umae') {
                    initUmaeData();
                    const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);
                    const isVisible = appData.umae?.visible;
                    if (!isOP && !isVisible) {
                        showNotif('Warning', '🔒 OP ยังไม่เปิดให้เข้าถึงหน้าอุ้มเอ๋อ');
                        return;
                    }
                }

                if (tab === 'fight') {
                    btnFight.classList.add('bg-indigo-600', 'text-white');
                    btnFight.classList.remove('text-slate-400', 'hover:bg-slate-700/50');
                    btnUmae.classList.remove('bg-indigo-600', 'text-white');
                    btnUmae.classList.add('text-slate-400', 'hover:bg-slate-700/50');
                    viewFight.classList.remove('hidden');
                    viewUmae.classList.add('hidden');
                } else {
                    btnUmae.classList.add('bg-indigo-600', 'text-white');
                    btnUmae.classList.remove('text-slate-400', 'hover:bg-slate-700/50');
                    btnFight.classList.remove('bg-indigo-600', 'text-white');
                    btnFight.classList.add('text-slate-400', 'hover:bg-slate-700/50');
                    viewUmae.classList.remove('hidden');
                    viewFight.classList.add('hidden');
                    renderUmaeTab(); // Populate Umae tab content
                }
            }

            // =============== อุ้มเอ๋อ (Body Wrap) Feature ===============
            function initUmaeData() {
                if (!appData.umae) appData.umae = { cases: [], expired: [], helped: [] };
            }

            function getUmaeMedicLimit() {
                const onDutyCount = (appData.onDuty?.length || 0) + (appData.afk?.length || 0);
                // Minimum is 5, scales up: 11-19 = 6, 20-29 = 7, etc.
                return Math.max(5, 5 + Math.floor((onDutyCount - 10) / 10));
            }

            function addUmaeCase() {
                initUmaeData();
                const phone = document.getElementById('umae-phone-input').value.trim();
                const mins = parseInt(document.getElementById('umae-countdown-mins').value) || 15;
                if (!phone) return showNotif('Error', 'กรุณากรอกเบอร์โทร');
                const newCase = {
                    id: Date.now().toString(),
                    phone,
                    startTime: Date.now(),
                    duration: mins * 60 * 1000,
                    medics: []
                };
                appData.umae.cases.push(newCase);
                document.getElementById('umae-phone-input').value = '';
                saveOpData();
                renderUmaeTab();
                showNotif('Success', `เพิ่มเบอร์ ${phone} (${mins} นาที)`);
            }

            function markUmaeHelped(id) {
                initUmaeData();
                const idx = appData.umae.cases.findIndex(c => c.id === id);
                if (idx > -1) {
                    const c = appData.umae.cases.splice(idx, 1)[0];
                    c.helpedAt = Date.now();
                    c.timeRemaining = c.duration - (Date.now() - c.startTime);
                    appData.umae.helped.push(c);
                    saveOpData();
                    renderUmaeTab();
                    showNotif('Success', `✅ ${c.phone} ได้รับการช่วยเหลือแล้ว`);
                }
            }

            function restoreUmaeCase(id) {
                initUmaeData();
                const idx = appData.umae.helped.findIndex(c => c.id === id);
                if (idx > -1) {
                    const c = appData.umae.helped.splice(idx, 1)[0];
                    // Check if time has already expired
                    const now = Date.now();
                    const originalRemaining = c.duration - (now - c.startTime);

                    if (originalRemaining <= 0) {
                        // Time already expired - move to expired list
                        c.expiredAt = now;
                        appData.umae.expired.push(c);
                        saveOpData();
                        renderUmaeTab();
                        showNotif('Warning', `⚠️ ${c.phone} หมดเวลาแล้ว - ย้ายไปเบอร์ที่เอ๋อ`);
                    } else {
                        // Still has time - restore to active queue
                        delete c.helpedAt;
                        delete c.timeRemaining;
                        appData.umae.cases.push(c);
                        saveOpData();
                        renderUmaeTab();
                        showNotif('Success', `🔄 ${c.phone} กลับมาในคิว`);
                    }
                }
            }

            function clearExpiredUmae() {
                initUmaeData();
                appData.umae.expired = [];
                saveOpData();
                renderUmaeTab();
                showNotif('Success', 'ล้างเบอร์ที่เอ๋อแล้ว');
            }

            function assignUmaeMedic(caseId, medicName) {
                initUmaeData();
                const c = appData.umae.cases.find(x => x.id === caseId);
                if (c) {
                    const limit = getUmaeMedicLimit();
                    if (!c.medics.includes(medicName) && c.medics.length < limit) {
                        c.medics.push(medicName);
                        // Remove from onDuty
                        const idx = appData.onDuty?.indexOf(medicName);
                        if (idx > -1) appData.onDuty.splice(idx, 1);
                        saveOpData();
                        renderUmaeTab();
                    }
                }
            }

            function removeUmaeMedic(caseId, medicName) {
                initUmaeData();
                const c = appData.umae.cases.find(x => x.id === caseId);
                if (c) {
                    const idx = c.medics.indexOf(medicName);
                    if (idx > -1) {
                        c.medics.splice(idx, 1);
                        if (!appData.onDuty.includes(medicName)) appData.onDuty.push(medicName);
                        saveOpData();
                        renderUmaeTab();
                    }
                }
            }

            // Global medic management for umae (not per-case)
            function addUmaeMedicGlobal(medicName) {
                if (!medicName) return;
                initUmaeData();
                if (!appData.umae.medics) appData.umae.medics = [];
                const limit = getUmaeMedicLimit();
                if (!appData.umae.medics.includes(medicName) && appData.umae.medics.length < limit) {
                    appData.umae.medics.push(medicName);
                    // Remove from onDuty
                    const idx = appData.onDuty?.indexOf(medicName);
                    if (idx > -1) appData.onDuty.splice(idx, 1);
                    saveOpData();
                    renderUmaeTab();
                    renderOnDuty();
                }
            }

            // Show Assign Medic dropdown
            function showUmaeAssignDropdown() {
                initUmaeData();
                const limit = getUmaeMedicLimit();
                if ((appData.umae.medics?.length || 0) >= limit) {
                    showNotif('Warning', '⚠️ ถึงจำนวนแพทย์สูงสุดแล้ว กรุณารอแพทย์เข้าเวรเพิ่ม');
                    return;
                }
                const assignSection = document.getElementById('umae-assign-section');
                const assignBtn = document.getElementById('umae-assign-btn');
                if (assignSection) {
                    assignSection.classList.remove('hidden');
                    if (assignBtn) assignBtn.classList.add('hidden');
                }
            }

            // Hide Assign Medic dropdown
            function hideUmaeAssignDropdown() {
                const assignSection = document.getElementById('umae-assign-section');
                const assignBtn = document.getElementById('umae-assign-btn');
                if (assignSection) {
                    assignSection.classList.add('hidden');
                    if (assignBtn) assignBtn.classList.remove('hidden');
                }
            }

            // Accept selected medic from dropdown
            function acceptUmaeMedic() {
                const select = document.getElementById('umae-add-medic-select');
                if (!select || !select.value) {
                    showNotif('Warning', '⚠️ กรุณาเลือกแพทย์ก่อน');
                    return;
                }
                addUmaeMedicGlobal(select.value);
                select.value = '';
                hideUmaeAssignDropdown();
            }

            function removeUmaeMedicGlobal(medicName) {
                initUmaeData();
                if (!appData.umae.medics) return;
                const idx = appData.umae.medics.indexOf(medicName);
                if (idx > -1) {
                    appData.umae.medics.splice(idx, 1);
                    if (!appData.onDuty.includes(medicName)) appData.onDuty.push(medicName);
                    saveOpData();
                    renderUmaeTab();
                    renderOnDuty();
                }
            }

            function toggleUmaeVisibility() {
                initUmaeData();
                appData.umae.visible = !appData.umae.visible;
                saveOpData();
                updateUmaeToggleBtn();
                showNotif('Success', appData.umae.visible ? '👁️ เปิดให้คนอื่นเห็นหน้าอุ้มห่อ' : '🙈 ปิดหน้าอุ้มห่อจากคนอื่น');
            }

            function updateUmaeToggleBtn() {
                const btn = document.getElementById('umae-toggle-btn');
                if (btn) {
                    // Only show toggle for OP/SupOP
                    const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);
                    if (!isOP) {
                        btn.classList.add('hidden');
                        return;
                    }
                    btn.classList.remove('hidden');
                    const isVisible = appData.umae?.visible;
                    btn.textContent = isVisible ? '🙈 ปิดจากคนอื่น' : '👁️ เปิดให้คนอื่นเห็น';
                    btn.classList.toggle('bg-purple-600', isVisible);
                    btn.classList.toggle('text-white', isVisible);
                    btn.classList.toggle('bg-slate-700', !isVisible);
                    btn.classList.toggle('text-slate-400', !isVisible);
                }
            }

            function renderUmaeTab() {
                initUmaeData();
                const now = Date.now();
                const search = (document.getElementById('umae-search')?.value || '').toLowerCase();
                const limit = getUmaeMedicLimit();
                document.getElementById('umae-medic-limit').textContent = `👨‍⚕️ Limit: ${limit}`;

                // Check for expired cases
                const expired = [];
                appData.umae.cases = appData.umae.cases.filter(c => {
                    const remaining = c.duration - (now - c.startTime);
                    if (remaining <= 0) {
                        c.expiredAt = now;
                        expired.push(c);
                        return false;
                    }
                    return true;
                });
                if (expired.length > 0) {
                    appData.umae.expired.push(...expired);
                    saveOpData();
                }

                // Use global medics array
                if (!appData.umae.medics) appData.umae.medics = [];
                const allUmaeMedics = appData.umae.medics;

                // Render medics section with remove buttons
                const medicListEl = document.getElementById('umae-medic-list');
                if (allUmaeMedics.length > 0) {
                    medicListEl.innerHTML = allUmaeMedics.map(m =>
                        `<span class="inline-flex items-center gap-0.5 bg-purple-800/50 text-purple-200 px-1 rounded mr-1">${m}<button onclick="removeUmaeMedicGlobal('${m}')" class="text-rose-400 hover:text-rose-300 ml-0.5">×</button></span>`
                    ).join('');
                } else {
                    medicListEl.innerHTML = '<span class="text-slate-500">ยังไม่มี</span>';
                }

                // Update limit display
                const limitEl = document.getElementById('umae-medic-limit');
                if (limitEl) {
                    limitEl.textContent = '(' + allUmaeMedics.length + '/' + limit + ')';
                }

                // Populate add medic dropdown (preserve selection)
                const addMedicSelect = document.getElementById('umae-add-medic-select');
                if (addMedicSelect) {
                    const currentValue = addMedicSelect.value; // Preserve selection
                    const availableMedics = (appData.onDuty || []).filter(m => !allUmaeMedics.includes(m));
                    addMedicSelect.innerHTML = '<option value="">-- เลือกแพทย์ --</option>' +
                        availableMedics.map(m => `<option value="${m}"${m === currentValue ? ' selected' : ''}>${m}</option>`).join('');
                }

                // Hide Assign button for non-OP
                const assignBtn = document.getElementById('umae-assign-btn');
                const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);
                if (assignBtn) {
                    assignBtn.classList.toggle('hidden', !isOP);
                }

                // Sort by time remaining (least first)
                const sorted = [...appData.umae.cases].sort((a, b) => {
                    const ra = a.duration - (now - a.startTime);
                    const rb = b.duration - (now - b.startTime);
                    return ra - rb;
                }).filter(c => c.phone.toLowerCase().includes(search));

                // Render active list - Windows 11 style
                const activeList = document.getElementById('umae-active-list');
                document.getElementById('umae-active-count').textContent = appData.umae.cases.length;

                if (sorted.length === 0) {
                    activeList.innerHTML = '<div class="text-center text-slate-500 text-[10px] py-3">ยังไม่มีเคส</div>';
                } else {
                    const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);
                    const isMedicInUmae = allUmaeMedics.includes(currentUser?.fullName?.split(' ')[0]);
                    const canControlUmae = isOP || isMedicInUmae;

                    activeList.innerHTML = sorted.map((c, idx) => {
                        const remaining = c.duration - (now - c.startTime);
                        const mins = Math.floor(remaining / 60000);
                        const secs = Math.floor((remaining % 60000) / 1000);
                        const isUrgent = remaining < 5 * 60 * 1000;
                        return `<div class="rounded-lg p-2 backdrop-blur-sm shadow border ${isUrgent ? 'umae-urgent border-rose-500/40' : 'bg-gradient-to-br from-slate-800/90 to-slate-900/90 border-white/10'}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-bold text-slate-500 bg-slate-700/50 w-4 h-4 rounded-full flex items-center justify-center">#${idx + 1}</span>
                                <span class="text-white font-medium text-xs">📞 ${c.phone}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-${isUrgent ? 'rose' : 'purple'}-400 font-mono text-sm font-bold tabular-nums">${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}</span>
                                ${canControlUmae ? `<button onclick="markUmaeHelped('${c.id}')" class="text-[10px] bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-0.5 rounded font-medium transition">✅</button>` : ''}
                            </div>
                        </div>
                    </div>`;
                    }).join('');
                }

                // Update toggle button state
                updateUmaeToggleBtn();

                // Render expired - Win11 style
                const expiredSection = document.getElementById('umae-expired-section');
                const expiredList = document.getElementById('umae-expired-list');
                document.getElementById('umae-expired-count').textContent = appData.umae.expired.length;
                if (appData.umae.expired.length > 0) {
                    expiredSection.classList.remove('hidden');
                    expiredList.innerHTML = appData.umae.expired.map(c =>
                        `<div class="bg-rose-950/50 text-rose-200 text-xs px-3 py-2 rounded-lg border border-rose-800/40 flex justify-between items-center backdrop-blur-sm">
                        <span class="flex items-center gap-2">💀 ${c.phone}</span>
                        <span class="text-rose-400 text-[10px] font-medium">หมดเวลา</span>
                    </div>`
                    ).join('');
                } else {
                    expiredSection.classList.add('hidden');
                }

                // Render history (helped) - original countdown continues, stops after 4 min of being helped
                const historySection = document.getElementById('umae-history-section');
                const historyList = document.getElementById('umae-history-list');
                document.getElementById('umae-helped-count').textContent = appData.umae.helped.length;
                if (appData.umae.helped.length > 0) {
                    historySection.classList.remove('hidden');
                    const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);
                    const isMedicInUmae = allUmaeMedics.includes(currentUser?.fullName?.split(' ')[0]);
                    const canControlUmae = isOP || isMedicInUmae;

                    historyList.innerHTML = appData.umae.helped.map(c => {
                        const helpedElapsed = now - c.helpedAt;
                        const stillCounting = helpedElapsed < 4 * 60 * 1000; // 4 min grace period

                        // Calculate original countdown (continues even after helped)
                        const originalRemaining = c.duration - (now - c.startTime);
                        const displayRemaining = stillCounting ? originalRemaining : 0;
                        const mins = Math.max(0, Math.floor(displayRemaining / 60000));
                        const secs = Math.max(0, Math.floor((displayRemaining % 60000) / 1000));
                        const isNegative = originalRemaining < 0;
                        const negMins = Math.abs(Math.floor(originalRemaining / 60000));
                        const negSecs = Math.abs(Math.floor((originalRemaining % 60000) / 1000));

                        return `<div class="bg-emerald-950/50 text-emerald-200 text-xs px-3 py-2 rounded-lg border border-emerald-800/40 flex justify-between items-center backdrop-blur-sm">
                        <span class="flex items-center gap-2">✅ ${c.phone}</span>
                        <div class="flex items-center gap-2">
                            ${stillCounting ?
                                (isNegative ?
                                    `<span class="text-rose-400 font-mono text-[10px]">-${String(negMins).padStart(2, '0')}:${String(negSecs).padStart(2, '0')}</span>` :
                                    `<span class="text-emerald-400 font-mono text-[10px]">${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}</span>`
                                ) :
                                '<span class="text-emerald-500 text-[10px]">เสร็จสิ้น</span>'
                            }
                            ${canControlUmae ? `<button onclick="restoreUmaeCase('${c.id}')" class="text-[10px] text-amber-400 hover:text-amber-300 px-2 py-0.5 bg-amber-900/40 rounded-md transition hover:bg-amber-800/40">↩️ คืน</button>` : ''}
                        </div>
                    </div>`;
                    }).join('');
                } else {
                    historySection.classList.add('hidden');
                }
            }

            // Render non-OP umae section (visible when OP enables)
            function renderNonOpUmae() {
                initUmaeData();
                const section = document.getElementById('nonop-umae-section');
                if (!section) return;

                const isVisible = appData.umae?.visible;
                const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);

                // Show section for non-OP users when visibility is enabled
                if (isVisible && !isOP) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                    return;
                }

                const now = Date.now();

                // Use global medics array
                const allUmaeMedics = appData.umae.medics || [];

                // Medic section
                const medicSection = document.getElementById('nonop-umae-medic-section');
                const medicListEl = document.getElementById('nonop-umae-medic-list');
                if (allUmaeMedics.length > 0) {
                    medicSection.classList.remove('hidden');
                    medicListEl.textContent = allUmaeMedics.join(', ');
                } else {
                    medicSection.classList.add('hidden');
                }

                // Sort cases
                const sorted = [...(appData.umae.cases || [])].sort((a, b) => {
                    const ra = a.duration - (now - a.startTime);
                    const rb = b.duration - (now - b.startTime);
                    return ra - rb;
                });

                document.getElementById('nonop-umae-count').textContent = sorted.length;
                const list = document.getElementById('nonop-umae-list');

                if (sorted.length === 0) {
                    list.innerHTML = '<div class="text-center text-slate-500 text-[10px] py-2">ยังไม่มีเคส</div>';
                } else {
                    list.innerHTML = sorted.map((c, idx) => {
                        const remaining = c.duration - (now - c.startTime);
                        const mins = Math.floor(remaining / 60000);
                        const secs = Math.floor((remaining % 60000) / 1000);
                        const isUrgent = remaining < 5 * 60 * 1000;
                        return `<div class="rounded p-1.5 border ${isUrgent ? 'umae-urgent border-rose-500/40' : 'bg-slate-800/50 border-white/10'}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-1">
                                <span class="text-[8px] font-bold text-slate-500 bg-slate-700/50 w-3.5 h-3.5 rounded-full flex items-center justify-center">#${idx + 1}</span>
                                <span class="text-white font-medium text-[10px]">📞 ${c.phone}</span>
                            </div>
                            <span class="text-${isUrgent ? 'rose' : 'purple'}-400 font-mono text-[10px] font-bold tabular-nums">${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}</span>
                        </div>
                    </div>`;
                    }).join('');
                }
            }

            // Umae countdown interval
            setInterval(() => {
                if (!document.getElementById('story-view-umae')?.classList.contains('hidden')) {
                    renderUmaeTab();
                }
                // Always try to render non-OP section (it handles visibility internally)
                renderNonOpUmae();
            }, 1000);

            // ========== EVENT SYSTEM [BETA] ==========

            // Check if event time matches current time (within 1 minute tolerance)
            function isEventTimeNow(timeStr) {
                const now = new Date();
                const [hours, minutes] = timeStr.split(':').map(Number);
                const nowMins = now.getHours() * 60 + now.getMinutes();
                const eventMins = hours * 60 + minutes;
                return Math.abs(nowMins - eventMins) < 1; // Within 1 minute
            }

            // Check and start events automatically
            function checkAndStartEvents() {
                if (!appData.activeEvents) appData.activeEvents = [];
                const now = Date.now();

                EVENT_CONFIG.forEach(config => {
                    config.times.forEach(timeStr => {
                        // Check if this event+time is already active
                        const eventKey = `${config.id}_${timeStr}`;
                        const joinDurationMs = (config.joinDuration || EVENT_JOIN_DURATION_DEFAULT) * 60 * 1000;
                        const totalDuration = joinDurationMs + EVENT_DURATION_MS;
                        const alreadyActive = appData.activeEvents.some(e => e.eventKey === eventKey && (now - e.startTime) < totalDuration);

                        if (!alreadyActive && isEventTimeNow(timeStr)) {
                            // Start this event
                            startEvent(config, timeStr);
                        }
                    });
                });

                // Clean up expired events (using total duration: join + event)
                const expiredEvents = appData.activeEvents.filter(e => {
                    const joinDurationMs = (e.joinDuration || EVENT_JOIN_DURATION_DEFAULT) * 60 * 1000;
                    const totalDuration = joinDurationMs + EVENT_DURATION_MS;
                    return (now - e.startTime) >= totalDuration;
                });
                expiredEvents.forEach(e => endEvent(e.eventKey, true)); // auto-end

                renderEventCards();
            }

            // Start a new event
            function startEvent(config, timeStr) {
                if (!appData.activeEvents) appData.activeEvents = [];
                const eventKey = `${config.id}_${timeStr}`;

                // Prevent duplicate
                if (appData.activeEvents.some(e => e.eventKey === eventKey)) return;

                const newEvent = {
                    eventKey: eventKey,
                    eventId: config.id,
                    name: config.name,
                    emoji: config.emoji,
                    startTime: Date.now(),
                    medics: [],
                    originalPositions: {}, // { medicName: position }
                    countsAsOnDuty: config.countsAsOnDuty,
                    timeStr: timeStr,
                    joinDuration: config.joinDuration || EVENT_JOIN_DURATION_DEFAULT // minutes
                };

                appData.activeEvents.push(newEvent);
                saveOpData();
                renderEventCards();
                showNotif('Info', `🎯 ${config.emoji} Event "${config.name}" เริ่มแล้ว!`);
            }

            // Assign medic to event
            function assignEventMedic(eventKey, medicName) {
                const event = appData.activeEvents?.find(e => e.eventKey === eventKey);
                if (!event) return;
                if (event.medics.includes(medicName)) return;

                // Check if still in join phase
                const elapsed = Date.now() - event.startTime;
                const joinDurationMs = (event.joinDuration || EVENT_JOIN_DURATION_DEFAULT) * 60 * 1000;
                if (elapsed >= joinDurationMs) {
                    showNotif('Warning', '⏰ หมดเวลาเข้าร่วม Event แล้ว');
                    return;
                }

                // Save original position
                const onDutyIdx = appData.onDuty.indexOf(medicName);
                if (onDutyIdx > -1) {
                    event.originalPositions[medicName] = onDutyIdx;
                    appData.onDuty.splice(onDutyIdx, 1);
                }

                // Also check AFK
                const afkIdx = appData.afk?.indexOf(medicName);
                if (afkIdx > -1) {
                    event.originalPositions[medicName] = -1; // Mark as from AFK
                    appData.afk.splice(afkIdx, 1);
                    delete appData.afkTimes?.[medicName];
                }

                event.medics.push(medicName);
                saveOpData();
                renderEventCards();
                renderOnDuty();
            }

            // Remove medic from event
            function removeEventMedic(eventKey, medicName) {
                const event = appData.activeEvents?.find(e => e.eventKey === eventKey);
                if (!event) return;

                const idx = event.medics.indexOf(medicName);
                if (idx === -1) return;

                event.medics.splice(idx, 1);

                // Return to original position
                const origPos = event.originalPositions[medicName];
                if (origPos !== undefined && origPos >= 0) {
                    const insertPos = Math.min(origPos, appData.onDuty.length);
                    appData.onDuty.splice(insertPos, 0, medicName);
                } else {
                    // Was from AFK or unknown - add to end of onDuty
                    if (!appData.onDuty.includes(medicName)) {
                        appData.onDuty.push(medicName);
                    }
                }
                delete event.originalPositions[medicName];

                saveOpData();
                renderEventCards();
                renderOnDuty();
            }

            // End event (manual or auto)
            function endEvent(eventKey, isAuto = false) {
                const eventIdx = appData.activeEvents?.findIndex(e => e.eventKey === eventKey);
                if (eventIdx === -1 || eventIdx === undefined) return;

                const event = appData.activeEvents[eventIdx];

                // Return all medics to original positions
                event.medics.forEach(medicName => {
                    const origPos = event.originalPositions[medicName];
                    if (origPos !== undefined && origPos >= 0) {
                        const insertPos = Math.min(origPos, appData.onDuty.length);
                        if (!appData.onDuty.includes(medicName)) {
                            appData.onDuty.splice(insertPos, 0, medicName);
                        }
                    } else {
                        if (!appData.onDuty.includes(medicName)) {
                            appData.onDuty.push(medicName);
                        }
                    }
                });

                appData.activeEvents.splice(eventIdx, 1);
                saveOpData();
                renderEventCards(true);

                if (!isAuto) {
                    if (event.isTest) {
                        showNotif('Success', `🧪 จบ Test Event แล้ว! ข้อมูลถูกลบเรียบร้อย`);
                    } else {
                        showNotif('Success', `✅ จบ Event "${event.name}" แล้ว`);
                    }
                }
            }

            // Get effective On Duty count (includes Blue Box medics)
            function getEffectiveOnDutyCount() {
                let count = appData.onDuty?.length || 0;
                // Add medics from Blue Box events (countsAsOnDuty = true)
                (appData.activeEvents || []).forEach(e => {
                    if (e.countsAsOnDuty) {
                        count += e.medics.length;
                    }
                });
                return count;
            }

            // Render event cards
            let lastEventCardsHTML = '';
            function renderEventCards(forceRender = false) {
                const section = document.getElementById('event-card-section');
                const container = document.getElementById('event-cards-container');
                const countEl = document.getElementById('event-active-count');

                if (!section || !container) return;

                const activeEvents = appData.activeEvents || [];
                const isOwner = currentUser?.role === 'Owner';

                if (activeEvents.length === 0 && !isOwner) {
                    section.classList.add('hidden');
                    lastEventCardsHTML = '';
                    return;
                }

                // Show section (Owner always sees it for Test button, others only when events exist)
                section.classList.remove('hidden');
                if (countEl) countEl.textContent = activeEvents.length;

                const now = Date.now();
                const isOP = appData.currentOP && (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP);

                // Generate a hash of current state to detect changes (include OP/SupOP for button visibility)
                const stateHash = JSON.stringify({
                    events: activeEvents.map(e => ({ key: e.eventKey, medics: e.medics })),
                    currentOP: appData.currentOP,
                    supOP: appData.supOP,
                    currentUser: currentUser?.fullName
                });
                const needsFullRender = forceRender || stateHash !== lastEventCardsHTML;

                if (needsFullRender) {
                    lastEventCardsHTML = stateHash;
                    container.innerHTML = activeEvents.map(event => {
                        const elapsed = now - event.startTime;
                        const joinDurationMs = (event.joinDuration || EVENT_JOIN_DURATION_DEFAULT) * 60 * 1000;
                        const totalDuration = joinDurationMs + EVENT_DURATION_MS;

                        // Calculate which phase we're in
                        const isJoinPhase = elapsed < joinDurationMs;
                        let countdownLabel, countdownMins, countdownSecs, countdownColor, phaseEmoji;

                        if (isJoinPhase) {
                            // Join phase countdown
                            const joinRemaining = joinDurationMs - elapsed;
                            countdownMins = Math.max(0, Math.floor(joinRemaining / 60000));
                            countdownSecs = Math.max(0, Math.floor((joinRemaining % 60000) / 1000));
                            countdownLabel = 'เข้าร่วม';
                            phaseEmoji = '⏱️';
                            countdownColor = joinRemaining < 60 * 1000 ? 'text-amber-400 event-countdown-pulse' : 'text-emerald-400';
                        } else {
                            // Event phase countdown
                            const eventRemaining = totalDuration - elapsed;
                            countdownMins = Math.max(0, Math.floor(eventRemaining / 60000));
                            countdownSecs = Math.max(0, Math.floor((eventRemaining % 60000) / 1000));
                            countdownLabel = 'กำลังเล่น';
                            phaseEmoji = '🎮';
                            countdownColor = eventRemaining < 5 * 60 * 1000 ? 'text-rose-400 event-countdown-pulse' : 'text-amber-400';
                        }

                        // Determine color based on countsAsOnDuty
                        const borderColor = event.countsAsOnDuty ? 'border-blue-500/50' : 'border-cyan-500/50';
                        const bgColor = event.countsAsOnDuty ? 'bg-blue-900/30' : 'bg-cyan-900/30';
                        const badgeColor = event.countsAsOnDuty ? 'text-blue-300 bg-blue-900' : 'text-cyan-300 bg-cyan-900';

                        // Medics display
                        const medicsHtml = event.medics.length > 0
                            ? event.medics.map(m => `
                            <span class="inline-flex items-center gap-1 ${badgeColor} px-2 py-1 rounded text-[10px]">
                                ${m}
                                ${isOP ? `<button onclick="removeEventMedic('${event.eventKey}', '${m}')" class="text-rose-400 hover:text-rose-300 hover:bg-rose-500/30 rounded px-1 text-sm font-bold transition">×</button>` : ''}
                            </span>
                        `).join('')
                            : '<span class="text-slate-500 text-[9px]">ยังไม่มีแพทย์</span>';

                        // Available medics dropdown (OP only) - ONLY during join phase
                        let assignDropdown = '';
                        if (isOP && appData.onDuty?.length > 0 && isJoinPhase) {
                            const availableMedics = appData.onDuty.filter(m => !event.medics.includes(m));
                            assignDropdown = `
                            <select id="event-dropdown-${event.eventKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                onchange="if(this.value) { assignEventMedic('${event.eventKey}', this.value); }" 
                                class="text-[9px] bg-slate-800 border border-slate-600 rounded px-1 py-0.5 text-white mt-1">
                                <option value="">+ เพิ่มแพทย์ (${availableMedics.length})</option>
                                ${availableMedics.map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                        `;
                        } else if (!isJoinPhase) {
                            // Show locked badge when join phase ended
                            assignDropdown = '<span class="text-[9px] text-slate-500 mt-1 inline-block">🔒 ปิดรับสมัคร</span>';
                        }

                        return `
                        <div class="glass ${borderColor} border rounded-xl p-2 ${bgColor}" data-event-key="${event.eventKey}">
                            <div class="flex items-center justify-between gap-1 mb-1">
                                <div class="flex items-center gap-1.5 min-w-0">
                                    <span class="text-base">${event.emoji}</span>
                                    <span class="text-[10px] font-bold text-white truncate">${event.name}</span>
                                </div>
                                <div id="countdown-${event.eventKey.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                    class="text-xs font-mono font-bold ${countdownColor} shrink-0"
                                    data-join-duration="${event.joinDuration || EVENT_JOIN_DURATION_DEFAULT}"
                                    data-start-time="${event.startTime}">
                                    ${String(countdownMins).padStart(2, '0')}:${String(countdownSecs).padStart(2, '0')}
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-[8px] text-slate-400 mb-2">
                                <span>${event.timeStr} | ${phaseEmoji} ${countdownLabel}</span>
                                ${event.countsAsOnDuty ? '<span class="text-blue-300">นับ On Duty</span>' : '<span class="text-rose-300">ไม่นับ</span>'}
                            </div>
                            <div class="border-t border-white/10 pt-2">
                                <div class="text-[9px] text-slate-400 mb-1">👨‍⚕️ แพทย์ (${event.medics.length})</div>
                                <div class="flex flex-wrap gap-1">${medicsHtml}</div>
                                ${assignDropdown}
                            </div>
                            ${isOP ? `
                                <div class="mt-2 pt-2 border-t border-white/10">
                                    <button onclick="endEvent('${event.eventKey}')" class="w-full text-[10px] bg-rose-600/80 hover:bg-rose-600 text-white py-1 rounded transition">
                                        ⏹️ จบ Event
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    }).join('');
                }
            }

            // Update only countdown timers (called every second)
            function updateEventCountdowns() {
                const now = Date.now();
                (appData.activeEvents || []).forEach(event => {
                    const elapsed = now - event.startTime;
                    const joinDurationMs = (event.joinDuration || EVENT_JOIN_DURATION_DEFAULT) * 60 * 1000;
                    const totalDuration = joinDurationMs + EVENT_DURATION_MS;

                    // Calculate which phase we're in
                    const isJoinPhase = elapsed < joinDurationMs;
                    let countdownMins, countdownSecs, countdownColor, phaseEmoji, countdownLabel;

                    if (isJoinPhase) {
                        const joinRemaining = joinDurationMs - elapsed;
                        countdownMins = Math.max(0, Math.floor(joinRemaining / 60000));
                        countdownSecs = Math.max(0, Math.floor((joinRemaining % 60000) / 1000));
                        countdownLabel = 'เข้าร่วม';
                        phaseEmoji = '⏱️';
                        countdownColor = joinRemaining < 60 * 1000 ? 'text-amber-400 event-countdown-pulse' : 'text-emerald-400';
                    } else {
                        const eventRemaining = totalDuration - elapsed;
                        countdownMins = Math.max(0, Math.floor(eventRemaining / 60000));
                        countdownSecs = Math.max(0, Math.floor((eventRemaining % 60000) / 1000));
                        countdownLabel = 'กำลังเล่น';
                        phaseEmoji = '🎮';
                        countdownColor = eventRemaining < 5 * 60 * 1000 ? 'text-rose-400 event-countdown-pulse' : 'text-amber-400';
                    }

                    const countdownEl = document.getElementById(`countdown-${event.eventKey.replace(/[^a-zA-Z0-9]/g, '_')}`);
                    if (countdownEl) {
                        countdownEl.textContent = `${String(countdownMins).padStart(2, '0')}:${String(countdownSecs).padStart(2, '0')}`;
                        countdownEl.className = `text-sm font-mono font-bold ${countdownColor}`;

                        // Update phase label in sibling element
                        const labelEl = countdownEl.previousElementSibling;
                        if (labelEl && labelEl.classList.contains('text-slate-400')) {
                            labelEl.textContent = `${phaseEmoji} ${countdownLabel}`;
                        }
                    }
                });
            }

            // Event check interval (every 5 seconds for faster sync)
            setInterval(checkAndStartEvents, 5000);
            // Also check on page load
            setTimeout(checkAndStartEvents, 1000);
            // Update only countdown every second (not full re-render)
            setInterval(updateEventCountdowns, 1000);

            // Toggle Event Cards collapse/expand
            let eventCardsCollapsed = localStorage.getItem('event_cards_collapsed') === 'true';
            function toggleEventCollapse() {
                eventCardsCollapsed = !eventCardsCollapsed;
                localStorage.setItem('event_cards_collapsed', eventCardsCollapsed);
                updateEventCollapseUI();
            }
            function updateEventCollapseUI() {
                const container = document.getElementById('event-cards-container');
                const icon = document.getElementById('event-collapse-icon');
                if (container) {
                    container.classList.toggle('hidden', eventCardsCollapsed);
                }
                if (icon) {
                    icon.textContent = eventCardsCollapsed ? '▶' : '▼';
                }
            }
            // Apply initial collapse state
            setTimeout(updateEventCollapseUI, 100);

            // Create Test Event (Owner only)
            function createTestEvent() {
                if (currentUser?.role !== 'Owner') {
                    showNotif('Error', '🔒 เฉพาะ Owner เท่านั้น');
                    return;
                }

                // Check if test event already exists
                if (!appData.activeEvents) appData.activeEvents = [];
                if (appData.activeEvents.some(e => e.isTest)) {
                    showNotif('Error', '⚠️ มี Test Event อยู่แล้ว');
                    return;
                }

                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                const testEvent = {
                    eventKey: `test-event_${timeStr}`,
                    eventId: 'test-event',
                    name: '🧪 TEST EVENT',
                    emoji: '🧪',
                    startTime: Date.now(),
                    medics: [],
                    originalPositions: {},
                    countsAsOnDuty: false,
                    timeStr: timeStr,
                    isTest: true, // Mark as test event
                    joinDuration: 1 // 1 minute for quick testing
                };

                appData.activeEvents.push(testEvent);
                saveOpData();
                renderEventCards(true);
                showNotif('Info', '🧪 Test Event เริ่มแล้ว! (จบแล้วจะลบข้อมูลอัตโนมัติ)');
            }

            // Update Test Event button visibility (Owner only)
            function updateTestEventButton() {
                const btn = document.getElementById('test-event-btn');
                const settingsBtn = document.getElementById('event-settings-btn');
                const isOwner = currentUser?.role === 'Owner';
                if (btn) btn.classList.toggle('hidden', !isOwner);
                if (settingsBtn) settingsBtn.classList.toggle('hidden', !isOwner);
            }
            // Check button visibility periodically
            setInterval(updateTestEventButton, 2000);
            setTimeout(updateTestEventButton, 500);

            // Event Settings Modal - temporary storage for edits
            let tempEventConfig = [];

            function showEventSettingsModal() {
                if (currentUser?.role !== 'Owner') {
                    showNotif('Error', '🔒 เฉพาะ Owner เท่านั้น');
                    return;
                }
                // Deep copy EVENT_CONFIG to tempEventConfig
                tempEventConfig = EVENT_CONFIG.map(e => ({ ...e, times: [...e.times] }));
                renderEventSettingsList();
                document.getElementById('event-settings-modal').classList.remove('hidden');
            }

            function closeEventSettingsModal() {
                document.getElementById('event-settings-modal').classList.add('hidden');
                tempEventConfig = [];
            }

            function renderEventSettingsList() {
                const container = document.getElementById('event-settings-list');
                if (!container) return;

                container.innerHTML = tempEventConfig.map((event, idx) => `
                <div class="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-lg">${event.emoji}</span>
                        <span class="font-bold text-white text-sm">${event.name}</span>
                        <span class="text-[9px] px-2 py-0.5 rounded ${event.countsAsOnDuty ? 'bg-blue-900 text-blue-300' : 'bg-slate-700 text-slate-400'}">
                            ${event.countsAsOnDuty ? 'นับ On Duty' : 'ไม่นับ'}
                        </span>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] text-slate-400">⏱️ เวลาเข้าร่วม:</span>
                        <input type="number" id="join-duration-${idx}" value="${event.joinDuration || EVENT_JOIN_DURATION_DEFAULT}" 
                            min="1" max="60" 
                            onchange="updateEventJoinDuration(${idx}, this.value)"
                            class="w-16 text-xs bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-center">
                        <span class="text-[10px] text-slate-400">นาที</span>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-2">
                        ${event.times.map((t, tIdx) => `
                            <span class="inline-flex items-center gap-1 bg-cyan-900/50 text-cyan-300 px-2 py-1 rounded text-xs">
                                ${t}
                                <button onclick="removeEventTime(${idx}, ${tIdx})" class="text-rose-400 hover:text-rose-300 hover:bg-rose-500/30 rounded px-1 transition">×</button>
                            </span>
                        `).join('')}
                        ${event.times.length === 0 ? '<span class="text-slate-500 text-xs">ไม่มีเวลา</span>' : ''}
                    </div>
                    <div class="flex gap-2">
                        <input type="time" id="new-time-${idx}" class="inp-pretty text-xs flex-1">
                        <button onclick="addEventTime(${idx})" class="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white text-xs rounded transition">
                            + เพิ่ม
                        </button>
                    </div>
                </div>
            `).join('');
            }

            function addEventTime(eventIdx) {
                const input = document.getElementById(`new-time-${eventIdx}`);
                if (!input || !input.value) {
                    showNotif('Error', 'กรุณาเลือกเวลา');
                    return;
                }
                const timeStr = input.value; // HH:MM format
                if (tempEventConfig[eventIdx].times.includes(timeStr)) {
                    showNotif('Error', 'เวลานี้มีอยู่แล้ว');
                    return;
                }
                tempEventConfig[eventIdx].times.push(timeStr);
                tempEventConfig[eventIdx].times.sort(); // Sort times
                renderEventSettingsList();
                showNotif('Success', `✅ เพิ่มเวลา ${timeStr} แล้ว`);
            }

            function removeEventTime(eventIdx, timeIdx) {
                const removed = tempEventConfig[eventIdx].times.splice(timeIdx, 1);
                renderEventSettingsList();
                showNotif('Info', `🗑️ ลบเวลา ${removed[0]} แล้ว`);
            }

            function updateEventJoinDuration(eventIdx, value) {
                const duration = Math.max(1, Math.min(60, parseInt(value) || EVENT_JOIN_DURATION_DEFAULT));
                tempEventConfig[eventIdx].joinDuration = duration;
                showNotif('Info', `⏱️ เวลาเข้าร่วม ${tempEventConfig[eventIdx].name}: ${duration} นาที`);
            }

            async function saveEventSettings() {
                try {
                    // Update global EVENT_CONFIG
                    EVENT_CONFIG.length = 0;
                    tempEventConfig.forEach(e => EVENT_CONFIG.push({ ...e, times: [...e.times] }));

                    // Save to Firestore (serverSettings)
                    const eventConfigData = EVENT_CONFIG.map(e => ({
                        id: e.id,
                        name: e.name,
                        times: e.times,
                        countsAsOnDuty: e.countsAsOnDuty,
                        emoji: e.emoji,
                        joinDuration: e.joinDuration || EVENT_JOIN_DURATION_DEFAULT
                    }));

                    await db.collection('settings').doc(getDocId('serverSettings')).set({
                        eventConfig: eventConfigData
                    }, { merge: true });

                    closeEventSettingsModal();
                    showNotif('Success', '💾 บันทึกการตั้งค่า Event แล้ว');
                } catch (error) {
                    console.error('Error saving event settings:', error);
                    showNotif('Error', 'เกิดข้อผิดพลาดในการบันทึก');
                }
            }

            // Load event config from serverSettings on page load
            async function loadEventConfig() {
                try {
                    const doc = await db.collection('settings').doc(getDocId('serverSettings')).get();
                    if (doc.exists) {
                        const data = doc.data();
                        // Load event config with times and joinDuration
                        if (data.eventConfig) {
                            const savedConfig = data.eventConfig;
                            savedConfig.forEach(saved => {
                                const existing = EVENT_CONFIG.find(e => e.id === saved.id);
                                if (existing) {
                                    existing.times = saved.times || [];
                                    existing.joinDuration = saved.joinDuration || EVENT_JOIN_DURATION_DEFAULT;
                                }
                            });
                            console.log('📅 Loaded event config from Firestore');
                        }
                        // Load restart times
                        if (data.restartTimes && Array.isArray(data.restartTimes)) {
                            serverSettings.restartTimes = [...data.restartTimes];
                            console.log('⏰ Loaded restart times from Firestore:', data.restartTimes);
                        }
                    }
                } catch (error) {
                    console.error('Error loading event config:', error);
                }
            }
            setTimeout(loadEventConfig, 1000);

            // Server Restart Times Management
            let tempRestartTimes = [];

            function renderRestartTimesList() {
                const container = document.getElementById('restart-times-list');
                if (!container) return;

                if (tempRestartTimes.length === 0) {
                    container.innerHTML = '<span class="text-slate-500 text-xs">ไม่มีเวลา Restart</span>';
                    return;
                }

                container.innerHTML = tempRestartTimes.map((t, idx) => `
                <span class="inline-flex items-center gap-1 bg-rose-900/50 text-rose-300 px-2 py-1 rounded text-xs">
                    ${t}
                    <button onclick="removeRestartTime(${idx})" class="text-rose-400 hover:text-rose-300 hover:bg-rose-500/30 rounded px-1 transition">×</button>
                </span>
            `).join('');
            }

            function addRestartTime() {
                const input = document.getElementById('new-restart-time');
                if (!input || !input.value) {
                    showNotif('Error', 'กรุณาเลือกเวลา');
                    return;
                }
                const timeStr = input.value;
                if (tempRestartTimes.includes(timeStr)) {
                    showNotif('Error', 'เวลานี้มีอยู่แล้ว');
                    return;
                }
                tempRestartTimes.push(timeStr);
                tempRestartTimes.sort();
                input.value = '';
                renderRestartTimesList();
                showNotif('Success', `✅ เพิ่มเวลา Restart ${timeStr} แล้ว`);
            }

            function removeRestartTime(idx) {
                const removed = tempRestartTimes.splice(idx, 1);
                renderRestartTimesList();
                showNotif('Info', `🗑️ ลบเวลา Restart ${removed[0]} แล้ว`);
            }

            // Update showEventSettingsModal to load restart times
            const originalShowEventSettingsModal = showEventSettingsModal;
            showEventSettingsModal = function () {
                // Load restart times from serverSettings
                tempRestartTimes = [...(serverSettings.restartTimes || [])];
                originalShowEventSettingsModal();
                renderRestartTimesList();
            };

            // Update saveEventSettings to save restart times
            const originalSaveEventSettings = saveEventSettings;
            saveEventSettings = async function () {
                try {
                    // Update global EVENT_CONFIG
                    EVENT_CONFIG.length = 0;
                    tempEventConfig.forEach(e => EVENT_CONFIG.push({ ...e, times: [...e.times] }));

                    // Save to Firestore (serverSettings) - including restart times
                    const eventConfigData = EVENT_CONFIG.map(e => ({
                        id: e.id,
                        name: e.name,
                        times: e.times,
                        countsAsOnDuty: e.countsAsOnDuty,
                        emoji: e.emoji,
                        joinDuration: e.joinDuration || EVENT_JOIN_DURATION_DEFAULT
                    }));

                    await db.collection('settings').doc(getDocId('serverSettings')).set({
                        eventConfig: eventConfigData,
                        restartTimes: tempRestartTimes
                    }, { merge: true });

                    serverSettings.restartTimes = [...tempRestartTimes];
                    closeEventSettingsModal();
                    showNotif('Success', '💾 บันทึกการตั้งค่า Event และ Restart Times แล้ว');
                } catch (error) {
                    console.error('Error saving event settings:', error);
                    showNotif('Error', 'เกิดข้อผิดพลาดในการบันทึก');
                }
            };

            // Server Restart Countdown (30 min before)
            let restartWarned = {};
            setInterval(() => {
                const restartTimes = serverSettings.restartTimes || [];
                if (restartTimes.length === 0 || !appData.shiftStart) return;

                const now = new Date();
                const nowMins = now.getHours() * 60 + now.getMinutes();

                restartTimes.forEach(timeStr => {
                    const [h, m] = timeStr.split(':').map(Number);
                    const restartMins = h * 60 + m;
                    const countdownStartMins = restartMins - 30; // 30 min before

                    // Handle midnight crossing
                    let diffMins = restartMins - nowMins;
                    if (diffMins < -60) diffMins += 24 * 60; // Next day
                    if (diffMins < 0) diffMins = 0;

                    // Check if within 30 min window and shift is active
                    if (diffMins <= 30 && diffMins > 0) {
                        // Show countdown warning
                        if (!restartWarned[timeStr]) {
                            restartWarned[timeStr] = true;
                            showNotif('Warning', `🔁 Server จะ Restart เวลา ${timeStr} (อีก ${diffMins} นาที) - กะจะถูกจบอัตโนมัติ`);
                            addNotification(`🔁 Server Restart ${timeStr} อีก ${diffMins} นาที`, 'warning');
                        }
                    }

                    // At restart time - force end shift
                    if (diffMins === 0 && appData.shiftStart) {
                        // Force end shift (like forceEndShift but automatic)
                        const prevOP = appData.currentOP;
                        const prevSupOP = appData.supOP;
                        const shiftDuration = appData.shiftStart ? Date.now() - appData.shiftStart : 0;

                        // Collect AFK warnings for summary
                        const afkWarnings = {};
                        if (appData.afkTimes) {
                            Object.entries(appData.afkTimes).forEach(([name, start]) => {
                                const mins = Math.floor((Date.now() - start) / 60000);
                                if (mins >= 5) afkWarnings[name] = mins;
                            });
                        }

                        // Auto-close started stories (not pending) before force ending shift
                        const startedCases = (appData.cases || []).filter(c => !isTimeInFuture(c.startTime, c.storyDate) && !c.pendingStart);
                        if (startedCases.length > 0) {
                            if (!appData.closedCases) appData.closedCases = [];
                            startedCases.forEach(sc => {
                                appData.closedCases.push({ ...sc, closedAt: Date.now(), forceClosed: true });
                            });
                            const caseNames = startedCases.map(c => `${c.partyA} VS ${c.partyB}`).join(', ');
                            addOpLog('Server Restart - บังคับปิดสตอรี่', caseNames);
                        }

                        // Create summary data before resetting
                        lastShiftSummaryData = {
                            op: prevOP,
                            supOP: prevSupOP,
                            onDuty: [...(appData.onDuty || [])],
                            offDuty: [...(appData.offDuty || [])],
                            closedCases: [...(appData.closedCases || [])],
                            afkWarnings,
                            duration: shiftDuration,
                            startTime: appData.shiftStart,
                            endTime: new Date(),
                            umaeHelped: appData.umae?.helped?.length || 0,
                            umaeExpired: appData.umae?.expired?.length || 0,
                            autoRestart: true
                        };

                        // Show summary if current user is OP
                        if (currentUser?.fullName === prevOP) {
                            showShiftSummary();
                        }

                        const preservedCases = (appData.cases || []).filter(c => isTimeInFuture(c.startTime, c.storyDate) || c.pendingStart || !c.closed);
                        appData = {
                            shiftStart: null, currentOP: null, supOP: null,
                            onDuty: [], offDuty: [], afk: [], afkTimes: {},
                            cases: preservedCases, closedCases: [], medicStatuses: {},
                            opPendingRequests: [], opHandoverAt: null, handoverNextOP: null,
                            afkWarnings: {}, afkWarnedTimes: {}
                        };
                        saveOpData();
                        addOpLog('Server Restart - จบกะอัตโนมัติ', `OP: ${prevOP || '-'}`);
                        showNotif('Warning', '🔁 Server Restart - กะถูกจบอัตโนมัติ');
                        addNotification('🔁 Server Restart - กะถูกจบอัตโนมัติ', 'warning');
                        renderAllDebounced();
                        restartWarned[timeStr] = false; // Reset for next day
                    }
                });
            }, 60000); // Check every minute

            // App Deploy Version Check for Force Refresh - Real-time listener with centered popup
            let versionRefreshPending = false;
            let versionUnsubscribe = null;
            let countdownInterval = null;

            function showVersionUpdatePopup(newVersion, countdown = 30) {
                // Remove existing popup if any
                const existing = document.getElementById('version-update-popup');
                if (existing) existing.remove();

                // Create fullscreen centered popup
                const popup = document.createElement('div');
                popup.id = 'version-update-popup';
                popup.className = 'fixed inset-0 z-[9999] flex items-center justify-center';
                popup.style.cssText = 'background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);';

                popup.innerHTML = `
                <div class="text-center p-8 rounded-3xl animate-zoom-in" style="background: linear-gradient(135deg, rgba(6,182,212,0.2) 0%, rgba(168,85,247,0.2) 100%); border: 2px solid rgba(6,182,212,0.5); max-width: 400px;">
                    <div class="text-6xl mb-4 animate-bounce">🔄</div>
                    <h2 class="text-2xl font-bold text-white mb-2">มีการอัปเดตใหม่!</h2>
                    <p class="text-cyan-300 text-lg mb-4">Version ${newVersion}</p>
                    <div class="bg-slate-900/80 rounded-2xl p-6 mb-4">
                        <p class="text-slate-300 text-sm mb-2">ระบบจะทำการ Refresh หน้าเว็บในอีก</p>
                        <div id="version-countdown-display" class="text-5xl font-mono font-bold text-cyan-400">${countdown}</div>
                        <p class="text-slate-400 text-xs mt-2">วินาที</p>
                    </div>
                    <div class="flex gap-3 justify-center">
                        <button onclick="forceRefreshNow()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-xl transition shadow-lg shadow-cyan-500/30">
                            ⚡ Refresh เลย
                        </button>
                    </div>
                    <p class="text-slate-500 text-xs mt-4">กรุณาอย่าปิดหน้านี้</p>
                </div>
            `;

                document.body.appendChild(popup);

                // Start countdown
                let remaining = countdown;
                const countdownEl = document.getElementById('version-countdown-display');

                countdownInterval = setInterval(() => {
                    remaining--;
                    if (countdownEl) countdownEl.textContent = remaining;

                    // Change color when low
                    if (remaining <= 5 && countdownEl) {
                        countdownEl.classList.remove('text-cyan-400');
                        countdownEl.classList.add('text-rose-400');
                    }

                    if (remaining <= 0) {
                        clearInterval(countdownInterval);
                        forceRefreshNow();
                    }
                }, 1000);
            }

            function forceRefreshNow() {
                if (countdownInterval) clearInterval(countdownInterval);
                const popup = document.getElementById('version-update-popup');
                if (popup) {
                    popup.innerHTML = `
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">⏳</div>
                        <h2 class="text-2xl font-bold text-white">กำลัง Refresh...</h2>
                    </div>
                `;
                }
                setTimeout(() => window.location.reload(true), 500);
            }

            function initVersionListener() {
                if (versionUnsubscribe) versionUnsubscribe();

                // Real-time listener for version changes
                versionUnsubscribe = db.collection('settings').doc('appVersion').onSnapshot(async (doc) => {
                    if (versionRefreshPending) return; // Already showing popup

                    if (doc.exists) {
                        const serverVersion = doc.data().version;
                        const storedVersion = localStorage.getItem('appVersion');

                        // First time loading - just store the version
                        if (!storedVersion) {
                            localStorage.setItem('appVersion', serverVersion);
                            console.log('📍 First load, stored version:', serverVersion);
                            return;
                        }

                        // Compare versions: returns true if v1 > v2
                        const isNewerVersion = (v1, v2) => {
                            const parts1 = v1.split('.').map(Number);
                            const parts2 = v2.split('.').map(Number);
                            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                                const p1 = parts1[i] || 0;
                                const p2 = parts2[i] || 0;
                                if (p1 > p2) return true;
                                if (p1 < p2) return false;
                            }
                            return false;
                        };

                        // Debug: Log version info
                        console.log('📊 Version Check:', {
                            'APP_VERSION (code)': APP_VERSION,
                            'serverVersion (Firebase)': serverVersion,
                            'storedVersion (localStorage)': storedVersion
                        });

                        // AUTO-UPDATE: If our code version is NEWER than Firebase, update Firebase
                        // This triggers Force Refresh for other users who have the page open
                        if (currentUser && isNewerVersion(APP_VERSION, serverVersion)) {
                            console.log('⬆️ Updating Firebase version:', serverVersion, '→', APP_VERSION);
                            try {
                                await db.collection('settings').doc('appVersion').set({
                                    version: APP_VERSION,
                                    updatedAt: Date.now(),
                                    updatedBy: currentUser.fullName || currentUser.username
                                });
                                localStorage.setItem('appVersion', APP_VERSION);
                                console.log('✅ Firebase updated! Other users will get Force Refresh popup.');
                                return; // Don't show popup for this user - they have new code
                            } catch (e) {
                                console.error('Version update error:', e);
                            }
                        }

                        // If Firebase version changed and is NEWER than our code - show Force Refresh popup
                        if (storedVersion !== serverVersion) {
                            if (isNewerVersion(serverVersion, APP_VERSION)) {
                                console.log('🔔 Force Refresh! Firebase:', serverVersion, '> Code:', APP_VERSION);
                                versionRefreshPending = true;
                                localStorage.setItem('appVersion', serverVersion);
                                showVersionUpdatePopup(serverVersion, 30);
                            } else {
                                // Just sync localStorage (we already have new/same code)
                                localStorage.setItem('appVersion', serverVersion);
                                console.log('📍 Synced localStorage:', serverVersion);
                            }
                        }
                    } else {
                        // Document doesn't exist - create it
                        if (currentUser) {
                            try {
                                await db.collection('settings').doc('appVersion').set({
                                    version: APP_VERSION,
                                    updatedAt: Date.now(),
                                    updatedBy: currentUser.fullName || currentUser.username
                                });
                                localStorage.setItem('appVersion', APP_VERSION);
                                console.log('✅ Created appVersion document:', APP_VERSION);
                            } catch (e) {
                                console.error('Version create error:', e);
                            }
                        }
                    }
                }, (error) => {
                    console.error('Version listener error:', error);
                });
            }

            // Initialize version listener after login - Skip for Electron (EXE has its own auto-updater)
            setTimeout(() => {
                if (currentUser && !window.isElectronApp && !(window.electronEnv && window.electronEnv.isElectron)) {
                    initVersionListener();
                }
            }, 2000);

            function copyCmdCooldown() { const cmd = getAnnounceCmd(); const pA = document.getElementById('cmd-cooldown-a').value.trim(), pB = document.getElementById('cmd-cooldown-b').value.trim(); if (!pA || !pB) return showNotif('Error', 'กรุณากรอก Party A และ B'); const now = new Date(), later = new Date(now.getTime() + 10 * 60 * 1000); const msg = `${cmd} ประกาศคูลดาวน์สตอรี่ ระหว่าง ${pA} vs ${pB} เป็นเวลา 10 นาที ตั้งแต่เวลา ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} - ${later.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} น. หรือหากพร้อม สามารถเริ่มได้ทันที`; navigator.clipboard.writeText(msg); document.getElementById('cmd-cooldown-a').value = ''; document.getElementById('cmd-cooldown-b').value = ''; showNotif('Success', 'คัดลอกแล้ว'); }
            function copyCmdEnterArea() { const cmd = getAnnounceCmd(); const pA = document.getElementById('cmd-enter-a').value.trim(), pB = document.getElementById('cmd-enter-b').value.trim(); if (!pA || !pB) return showNotif('Error', 'กรุณากรอก Party A และ B'); const msg = `${cmd} แพทย์กำลังเข้าพื้นที่สตอรี่ ${pA} vs ${pB} ขอให้แก๊งที่ชนะ ออกจากพื้นที่และหยุดการกระทำทุกอย่างภายใน 2 นาที ขออภัยในความไม่สะดวก`; navigator.clipboard.writeText(msg); document.getElementById('cmd-enter-a').value = ''; document.getElementById('cmd-enter-b').value = ''; showNotif('Success', 'คัดลอกแล้ว'); }

            // Command Modal Functions
            function showCommandModal() {
                document.getElementById('command-modal').classList.remove('hidden');
                // Update command prefix display
                const prefixEl = document.getElementById('cmd-prefix-display');
                if (prefixEl) prefixEl.textContent = getAnnounceCmd();
                // Update server name display
                const srvNameEl = document.getElementById('cmd-server-name');
                if (srvNameEl) srvNameEl.textContent = serverSettings.serverName ? `(${serverSettings.serverName})` : '';
                // Populate unblacklist dropdown
                populateUnblacklistDropdown();
            }
            function closeCommandModal() { document.getElementById('command-modal').classList.add('hidden'); }
            function toggleCmdSection(section) {
                const allSections = ['hospital', 'work', 'blacklist', 'other'];
                const el = document.getElementById('cmd-section-' + section);
                const toggle = document.getElementById('cmd-toggle-' + section);
                const isCurrentlyHidden = el?.classList.contains('hidden');

                // Close all sections first
                allSections.forEach(s => {
                    const sEl = document.getElementById('cmd-section-' + s);
                    const sToggle = document.getElementById('cmd-toggle-' + s);
                    if (sEl) sEl.classList.add('hidden');
                    if (sToggle) sToggle.textContent = '▼';
                });

                // Open clicked section if it was closed
                if (isCurrentlyHidden && el) {
                    el.classList.remove('hidden');
                    if (toggle) toggle.textContent = '▲';
                }
            }
            function copyCmd(type) {
                const cmd = getAnnounceCmd();
                const srvName = serverSettings.serverName || 'โรงพยาบาล';
                let msg = '';
                switch (type) {
                    // ประกาศเปิด/ปิดโรงพยาบาล
                    case 'hospital-open':
                        msg = `${cmd} โรงพยาบาล ${srvName} เปิดทำการยินดีต้อนรับครับ/ค่ะ`;
                        break;
                    case 'hospital-close':
                        msg = `${cmd} โรงพยาบาล ${srvName} ขออนุญาตปิดทำการ ขออภัยในความไม่สะดวก ดูแลตัวเองกันด้วยนะครับ/ค่ะ`;
                        break;
                    case 'hospital-close-5':
                        msg = `${cmd} โรงพยาบาลกำลังจะปิดทำการในอีก 5 นาที งดรับเคสนอกทุกกรณี ขอให้ประชาชนรักษาสุขภาพกันด้วยนะคะ/ครับ`;
                        break;
                    case 'hospital-close-10':
                        msg = `${cmd} โรงพยาบาลกำลังจะปิดทำการในอีก 10 นาที งดรับเคสนอกทุกกรณี ขอให้ประชาชนรักษาสุขภาพกันด้วยนะคะ/ครับ`;
                        break;
                    case 'hospital-close-15':
                        msg = `${cmd} โรงพยาบาลกำลังจะปิดทำการในอีก 15 นาที งดรับเคสนอกทุกกรณี ขอให้ประชาชนรักษาสุขภาพกันด้วยนะคะ/ครับ`;
                        break;
                    // ประกาศการแต่งกายพิเศษ
                    case 'dress-freeday':
                        msg = `${cmd} เนื่องจากวัน ศุกร์ เสาร์-อาทิตย์ หมอแต่งตัวFree Day ให้สังเกตุถุงมือสีฟ้านะครับ/ค่ะ`;
                        break;
                    case 'dress-event':
                        const eventMsg = document.getElementById('cmd-event-msg')?.value.trim();
                        if (!eventMsg) return showNotif('Error', 'กรุณากรอกข้อความกิจกรรม');
                        msg = `${cmd} เนื่องจากช่วงนี้เป็นกิจกรรมจากทางโรงพยาบาล ${eventMsg}`;
                        document.getElementById('cmd-event-msg').value = '';
                        break;
                    // ประกาศเกี่ยวกับการทำงาน - Safezone
                    case 'safezone-story':
                        msg = `${cmd} ขอความร่วมมือแก๊งที่ประกาศสตอรี่ทางการ ออกจากพื้นที่โรงพยาบาลภายใน 5 นาที ฝ่าฝืนขออนุญาต Blacklist ครับ/ค่ะ`;
                        break;
                    case 'safezone-done':
                        msg = `${cmd} ขอความร่วมมือแก๊ง/ครอบครัว หากรักษาตัวเสร็จเรียบร้อยและไม่มีกิจธุระกับทางโรงพยาบาล รบกวนออกจากพื้นที่โรงพยาบาลภายใน 5 นาที เนื่องจากเขตพื้นที่โรงพยาบาลมิใช่สถานที่พักพิง ขอบคุณ ครับ/ค่ะ`;
                        break;
                    // ประกาศเกี่ยวกับการทำงาน - เข้าพื้นที่
                    case 'enter-rebel':
                        msg = `${cmd} แพทย์กำลังเข้าพื้นที่ เรเบล เพื่อช่วยเหลือประชาชนห้ามทำร้ายแพทย์และขัดขวางการทำงาน ครับ/ค่ะ`;
                        break;
                    // ประกาศอื่นๆ (Custom)
                    case 'other':
                        const otherMsg = document.getElementById('cmd-other-msg')?.value.trim();
                        if (!otherMsg) return showNotif('Error', 'กรุณากรอกข้อความประกาศ');
                        msg = `${cmd} ${otherMsg}`;
                        document.getElementById('cmd-other-msg').value = '';
                        break;
                    default:
                        return showNotif('Error', 'ไม่พบประเภทคำสั่ง');
                }
                navigator.clipboard.writeText(msg);
                showNotif('Success', 'คัดลอกคำสั่งแล้ว');
            }

            // Admin Settings Functions
            let serverSettings = { serverName: 'ONE CITY', iconLogo: '', loginLogo: '', themeColor: '#06b6d4', countdownMinutes: 30, announceCmd: '/an' };
            function getAnnounceCmd() { return serverSettings.announceCmd || '/an'; }
            function applyServerLogos() {
                const navIcon = document.getElementById('nav-icon-logo');
                const navEmoji = document.getElementById('nav-icon-emoji');
                const loginLogo = document.getElementById('login-logo');
                const favicon = document.getElementById('dynamic-favicon');

                if (serverSettings.iconLogo) {
                    if (navIcon) { navIcon.src = serverSettings.iconLogo; navIcon.classList.remove('hidden'); }
                    if (navEmoji) navEmoji.classList.add('hidden');
                    // Set favicon
                    if (favicon) favicon.href = serverSettings.iconLogo;
                } else {
                    if (navIcon) navIcon.classList.add('hidden');
                    if (navEmoji) navEmoji.classList.remove('hidden');
                }
                if (serverSettings.loginLogo) {
                    if (loginLogo) { loginLogo.src = serverSettings.loginLogo; loginLogo.classList.remove('hidden'); }
                } else {
                    if (loginLogo) loginLogo.classList.add('hidden');
                }
            }
            function applyThemeColor() { const c = serverSettings.themeColor || '#06b6d4'; document.documentElement.style.setProperty('--theme-color', c); document.getElementById('server-name-display').style.color = c; const nav = document.querySelector('nav'); if (nav) nav.style.borderBottomColor = c + '40'; document.querySelectorAll('.text-cyan-400, .text-purple-400, .text-indigo-400').forEach(el => { if (!el.closest('.bg-cyan-600') && !el.closest('[data-no-theme]')) el.style.color = c; }); document.querySelectorAll('.border-cyan-500, .border-purple-500, .border-indigo-500').forEach(el => { el.style.borderColor = c; }); document.querySelectorAll('.bg-cyan-600, .bg-purple-600, .bg-indigo-500').forEach(el => { if (!el.closest('[data-no-theme]')) el.style.backgroundColor = c; }); document.querySelectorAll('.bg-indigo-500\\/20, .bg-cyan-500\\/20, .bg-purple-500\\/20').forEach(el => el.style.backgroundColor = c + '33'); }
            async function loadServerSettings() { try { const doc = await db.collection('op_settings').doc('server').get(); if (doc.exists) serverSettings = { ...serverSettings, ...doc.data() }; document.getElementById('server-name-display').textContent = serverSettings.serverName || 'ONE CITY'; applyServerLogos(); applyThemeColor(); } catch (e) { } db.collection('op_settings').doc('server').onSnapshot(doc => { if (doc.exists) { serverSettings = { ...serverSettings, ...doc.data() }; document.getElementById('server-name-display').textContent = serverSettings.serverName || 'ONE CITY'; applyServerLogos(); applyThemeColor(); } }); }
            function showAdminModal() { if (!currentUser || currentUser.role !== 'Owner') return showNotif('Error', 'สำหรับ Owner เท่านั้น'); document.getElementById('admin-server-name').value = serverSettings.serverName || 'ONE CITY'; document.getElementById('admin-icon-logo').value = serverSettings.iconLogo || ''; document.getElementById('admin-login-logo').value = serverSettings.loginLogo || ''; document.getElementById('admin-theme-color').value = serverSettings.themeColor || '#06b6d4'; document.getElementById('admin-modal').classList.remove('hidden'); }
            function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
            async function saveServerSettings() { if (!currentUser || currentUser.role !== 'Owner') return; const name = document.getElementById('admin-server-name').value.trim(), iconLogo = document.getElementById('admin-icon-logo').value.trim(), loginLogo = document.getElementById('admin-login-logo').value.trim(), themeColor = document.getElementById('admin-theme-color').value; if (!name) return showNotif('Error', 'กรุณากรอกชื่อ Server'); try { await db.collection('op_settings').doc('server').set({ serverName: name, iconLogo, loginLogo, themeColor }); serverSettings = { serverName: name, iconLogo, loginLogo, themeColor }; applyServerLogos(); applyThemeColor(); closeAdminModal(); showNotif('Success', 'บันทึกค่าเรียบร้อย'); } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); } }

            let medicalFees = {
                normal: { cityChub: '-', cityChit: '-', desertChub: '-', desertChit: '-', upperChub: '-', upperChit: '-', hardChub: '-', hardChit: '-' },
                risky: { areaChub: '-' },
                story: { areaChub: '-' }
            };
            async function loadMedicalFees() {
                try {
                    const doc = await db.collection('op_settings').doc('medical_fees').get();
                    if (doc.exists) medicalFees = { ...medicalFees, ...doc.data() };
                    renderMedicalFees();
                } catch (e) { }
                db.collection('op_settings').doc('medical_fees').onSnapshot(doc => {
                    if (doc.exists) { medicalFees = { ...medicalFees, ...doc.data() }; renderMedicalFees(); }
                });
            }
            function renderMedicalFees() {
                // Normal case: 4 zones x 2 types
                ['city', 'desert', 'upper', 'hard'].forEach(zone => {
                    ['chub', 'chit'].forEach(pt => {
                        const el = document.getElementById(`fee-normal-${zone}-${pt}`);
                        if (el) el.textContent = medicalFees.normal?.[zone + pt.charAt(0).toUpperCase() + pt.slice(1)] || '-';
                    });
                });
                // Risky and Story: single area
                const riskyEl = document.getElementById('fee-risky-area-chub');
                if (riskyEl) riskyEl.textContent = medicalFees.risky?.areaChub || '-';
                const storyEl = document.getElementById('fee-story-area-chub');
                if (storyEl) storyEl.textContent = medicalFees.story?.areaChub || '-';
            }
            function toggleFeeEdit(type) {
                const form = document.getElementById('fee-' + type + '-form');
                if (!form) return;
                const isHidden = form.classList.contains('hidden');
                form.classList.toggle('hidden');
                if (isHidden) {
                    if (type === 'normal') {
                        ['city', 'desert', 'upper', 'hard'].forEach(zone => {
                            ['chub', 'chit'].forEach(pt => {
                                const input = document.getElementById(`fee-${type}-${zone}-${pt}-input`);
                                if (input) input.value = medicalFees[type]?.[zone + pt.charAt(0).toUpperCase() + pt.slice(1)] || '';
                            });
                        });
                    } else {
                        const input = document.getElementById(`fee-${type}-area-chub-input`);
                        if (input) input.value = medicalFees[type]?.areaChub || '';
                    }
                }
            }
            async function saveMedicalFees(type) {
                let data = {};
                if (type === 'normal') {
                    ['city', 'desert', 'upper', 'hard'].forEach(zone => {
                        ['chub', 'chit'].forEach(pt => {
                            const input = document.getElementById(`fee-${type}-${zone}-${pt}-input`);
                            data[zone + pt.charAt(0).toUpperCase() + pt.slice(1)] = input?.value.trim() || '-';
                        });
                    });
                    medicalFees[type] = data;
                } else if (type === 'risky') {
                    const riskyInput = document.getElementById('fee-risky-area-chub-input');
                    const storyInput = document.getElementById('fee-story-area-chub-input');
                    medicalFees.risky = { areaChub: riskyInput?.value.trim() || '-' };
                    medicalFees.story = { areaChub: storyInput?.value.trim() || '-' };
                } else {
                    const input = document.getElementById(`fee-${type}-area-chub-input`);
                    data.areaChub = input?.value.trim() || '-';
                    medicalFees[type] = data;
                }
                try {
                    await db.collection('op_settings').doc('medical_fees').set(medicalFees);
                    showNotif('Success', 'บันทึกค่ารักษาเรียบร้อย');
                    document.getElementById('fee-risky-form')?.classList.add('hidden');
                    renderMedicalFees();
                } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); }
            }

            // Blacklist Functions
            let blacklistData = [];
            async function loadBlacklist() {
                try {
                    const doc = await db.collection('op_settings').doc('blacklist').get();
                    if (doc.exists) blacklistData = doc.data().list || [];
                } catch (e) { }
                db.collection('op_settings').doc('blacklist').onSnapshot(doc => {
                    if (doc.exists) { blacklistData = doc.data().list || []; renderAll(); }
                });
            }
            function showBlacklistModal() { renderBlacklistModal(); document.getElementById('blacklist-modal').classList.remove('hidden'); }
            function closeBlacklistModal() { document.getElementById('blacklist-modal').classList.add('hidden'); }
            function renderBlacklistModal(searchTerm = '') {
                const list = document.getElementById('blacklist-list');
                if (!list) return;

                // Filter by search term
                const filtered = searchTerm
                    ? blacklistData.filter(entry => {
                        const name = typeof entry === 'object' ? entry.name : entry;
                        return name?.toLowerCase().includes(searchTerm.toLowerCase());
                    })
                    : blacklistData;

                if (filtered.length === 0) {
                    list.innerHTML = `<p class="text-xs text-slate-500 text-center py-4">${searchTerm ? 'ไม่พบรายการที่ค้นหา' : 'ไม่มีรายการ Blacklist'}</p>`;
                    return;
                }
                // Get all active story parties for penalty detection (case-insensitive)
                const partyAs = (appData.cases || []).map(c => c.partyA?.toLowerCase()).filter(Boolean);
                const partyBs = (appData.cases || []).map(c => c.partyB?.toLowerCase()).filter(Boolean);

                list.innerHTML = filtered.map(entry => {
                    // Handle both string and object format
                    const name = typeof entry === 'object' ? entry.name : entry;
                    const nameLower = name?.toLowerCase() || '';
                    const isPartyA = partyAs.includes(nameLower);
                    const isPartyB = partyBs.includes(nameLower);
                    let displayName = name;

                    let details = '';
                    let x5Tag = '';
                    let x2Tag = '';
                    let copyText = '';
                    let penaltyTag = entry.penaltyTag || '';
                    if (typeof entry === 'object') {
                        const typeLabel = entry.type === 'patient' ? 'คนไข้เบอร์' : entry.type === 'citizen' ? 'คุณ' : entry.type === 'gang' ? 'แก๊ง' : 'ครอบครัว';
                        details = `<div class="text-sm text-slate-300 mt-1">${typeLabel} <span class="text-cyan-400 font-semibold">${name}</span> ติด Blacklist ในข้อหา <span class="text-amber-400 font-semibold">${entry.reason}</span></div><div class="text-sm text-slate-300">ค่าปรับ <span class="text-emerald-400 font-bold">${entry.fine}</span> One-Dollars</div>`;

                        // Show penalty tag based on stored value only
                        let x2TagContent = '';
                        if (penaltyTag) {
                            const penaltyDisplay = penaltyTag === 'x2' ? 'โทษค่ารักษา x2' : penaltyTag === 'x5' ? 'โทษค่ารักษา x5' : 'ไม่ทำการรักษา';
                            const penaltyColor = penaltyTag === 'no-treat' ? 'bg-rose-500/20 text-rose-400' : 'bg-amber-500/20 text-amber-400';
                            x2Tag = `<span class="inline-block mt-1 ml-1 px-2 py-0.5 ${penaltyColor} rounded text-[10px] font-bold">${penaltyDisplay}</span>`;
                        }

                        // Build copy text
                        copyText = `ประกาศ Blacklist ${typeLabel} ${name} เนื่องจาก ${entry.reason} กรุณาติดต่อแพทย์เพื่อจ่ายค่าปรับจำนวน ${entry.fine} One-Dollars กรุณามาติดต่อเพื่อชำระค่าปรับด้วย ขอบคุณครับ/ค่ะ`;
                    }
                    const idx = blacklistData.indexOf(entry);
                    const escapedCopyText = copyText.replace(/'/g, "\\'");
                    return `<div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            ${typeof entry === 'object' ? details : `<span class="text-white text-sm">${displayName}</span>`}
                            <div class="flex flex-wrap items-center gap-1 mt-1">
                                ${x5Tag}${x2Tag}
                            </div>
                        </div>
                        ${typeof entry === 'object' ? `<button onclick="navigator.clipboard.writeText('${escapedCopyText}'); showNotif('Success', 'คัดลอกแล้ว');" class="text-slate-400 hover:text-white text-xs ml-2 shrink-0" title="คัดลอกสำหรับ Discord">📋</button>` : ''}
                    </div>
                </div>`;
                }).join('');
            }
            function filterBlacklistModal() {
                const search = document.getElementById('blacklist-search')?.value || '';
                renderBlacklistModal(search);
            }
            async function updateBlacklistTag(idx, tag) {
                if (blacklistData[idx] && typeof blacklistData[idx] === 'object') {
                    blacklistData[idx].penaltyTag = tag;
                    try {
                        await db.collection('op_settings').doc('blacklist').set({ list: blacklistData });
                        renderBlacklistModal();
                        showNotif('Success', 'อัปเดต Tag เรียบร้อย');
                    } catch (e) { console.error(e); }
                }
            }
            async function addToBlacklist() {
                const input = document.getElementById('blacklist-input');
                const gang = input.value.trim();
                if (!gang) return showNotif('Error', 'กรุณากรอกชื่อแก๊ง');
                const exists = blacklistData.some(b => (typeof b === 'object' ? b.name : b) === gang);
                if (exists) return showNotif('Error', 'ชื่อนี้มีอยู่ในรายการแล้ว');
                blacklistData.push(gang);
                try {
                    await db.collection('op_settings').doc('blacklist').set({ list: blacklistData });
                    input.value = '';
                    renderBlacklistModal();
                    showNotif('Success', `เพิ่ม ${gang} ใน Blacklist แล้ว`);
                } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); }
            }
            async function removeFromBlacklist(name) {
                blacklistData = blacklistData.filter(b => (typeof b === 'object' ? b.name : b) !== name);
                try {
                    await db.collection('op_settings').doc('blacklist').set({ list: blacklistData });
                    renderBlacklistModal();
                    populateUnblacklistDropdown();
                    showNotif('Success', `ลบ ${name} ออกจาก Blacklist แล้ว`);
                } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); }
            }

            // Blacklist Announcement Functions
            function updateBlTypeLabel() {
                const type = document.getElementById('cmd-bl-type').value;
                const label = document.getElementById('cmd-bl-name-label');
                const input = document.getElementById('cmd-bl-name');
                if (type === 'patient') {
                    label.textContent = 'เบอร์คนไข้ที่ต้องการ Blacklist';
                    input.placeholder = 'กรอกเบอร์...';
                } else if (type === 'citizen') {
                    label.textContent = 'ชื่อที่ต้องการ Blacklist';
                    input.placeholder = 'กรอกชื่อ...';
                } else if (type === 'gang') {
                    label.textContent = 'ชื่อแก๊งที่ต้องการ Blacklist';
                    input.placeholder = 'กรอกชื่อแก๊ง...';
                } else {
                    label.textContent = 'ชื่อครอบครัวที่ต้องการ Blacklist';
                    input.placeholder = 'กรอกชื่อครอบครัว...';
                }
            }

            function populateUnblacklistDropdown() {
                const select = document.getElementById('cmd-unbl-select');
                if (!select) return;
                select.innerHTML = '<option value="">-- เลือกรายการ --</option>';
                blacklistData.forEach((entry, idx) => {
                    const name = typeof entry === 'object' ? entry.name : entry;
                    const type = typeof entry === 'object' ? entry.type : 'unknown';
                    const typeLabel = type === 'patient' ? 'คนไข้' : type === 'citizen' ? 'ประชาชน' : type === 'gang' ? 'แก๊ง' : type === 'family' ? 'ครอบครัว' : '';
                    select.innerHTML += `<option value="${idx}">${typeLabel ? `[หมวด: ${typeLabel}] ` : ''}${name}</option>`;
                });
            }

            async function copyBlacklistAnnounce() {
                const cmd = getAnnounceCmd();
                const type = document.getElementById('cmd-bl-type').value;
                const name = document.getElementById('cmd-bl-name').value.trim();
                const reason = document.getElementById('cmd-bl-reason').value;
                const fine = document.getElementById('cmd-bl-fine').value.trim();
                const penalty = document.getElementById('cmd-bl-penalty').value;

                if (!name) return showNotif('Error', 'กรุณากรอกชื่อ/เบอร์');
                if (!fine) return showNotif('Error', 'กรุณากรอกค่าปรับ');

                let typeLabel = '';
                if (type === 'patient') typeLabel = 'คนไข้เบอร์';
                else if (type === 'citizen') typeLabel = 'คุณ';
                else if (type === 'gang') typeLabel = 'แก๊ง';
                else typeLabel = 'ครอบครัว';

                const msg = `${cmd} ประกาศ Blacklist ${typeLabel} ${name} เนื่องจาก ${reason} กรุณาติดต่อแพทย์เพื่อจ่ายค่าปรับจำนวน ${fine} One-Dollars กรุณามาติดต่อเพื่อชำระค่าปรับด้วย ขอบคุณครับ/ค่ะ`;

                // Save to blacklist
                const entry = { name, type, reason, fine, penaltyTag: penalty, createdAt: Date.now() };
                const exists = blacklistData.some(b => (typeof b === 'object' ? b.name : b) === name);
                if (!exists) {
                    blacklistData.push(entry);
                    try {
                        await db.collection('op_settings').doc('blacklist').set({ list: blacklistData });
                        renderBlacklistModal();
                        populateUnblacklistDropdown();
                    } catch (e) { console.error(e); }
                }

                navigator.clipboard.writeText(msg);
                document.getElementById('cmd-bl-name').value = '';
                document.getElementById('cmd-bl-fine').value = '';
                document.getElementById('cmd-bl-penalty').value = '';
                showNotif('Success', 'คัดลอกแล้ว + บันทึก Blacklist');
            }

            async function copyUnblacklistAnnounce() {
                const cmd = getAnnounceCmd();
                const select = document.getElementById('cmd-unbl-select');
                const idx = select.value;
                if (idx === '') return showNotif('Error', 'กรุณาเลือกรายการที่จะปลด');

                const entry = blacklistData[parseInt(idx)];
                const name = typeof entry === 'object' ? entry.name : entry;
                const type = typeof entry === 'object' ? entry.type : 'unknown';

                let typeLabel = '';
                if (type === 'patient') typeLabel = 'คนไข้เบอร์';
                else if (type === 'citizen') typeLabel = 'คุณ';
                else if (type === 'gang') typeLabel = 'แก๊ง';
                else if (type === 'family') typeLabel = 'ครอบครัว';
                else typeLabel = '';

                const msg = `${cmd} ประกาศปลด Blacklist ${typeLabel} ${name} เนื่องจากได้จ่ายค่าปรับครบจำนวนเป็นที่เรียบร้อย และจะได้รับการรักษาจากแพทย์ตามปกติครับ/ค่ะ`;

                // Remove from blacklist
                blacklistData = blacklistData.filter((_, i) => i !== parseInt(idx));
                try {
                    await db.collection('op_settings').doc('blacklist').set({ list: blacklistData });
                    renderBlacklistModal();
                    populateUnblacklistDropdown();
                } catch (e) { console.error(e); }

                navigator.clipboard.writeText(msg);
                select.value = '';
                showNotif('Success', 'คัดลอกแล้ว + ลบ Blacklist');
            }

            // Staff Admin Functions
            function isStaff() { return ['Owner', 'Admin', 'Staff'].includes(currentUser?.role); }
            function isAdmin() { return ['Owner', 'Admin'].includes(currentUser?.role); }

            // Log collection name based on environment (main vs test)
            function getLogCollectionName() {
                const host = window.location.hostname;
                // Test site uses different collection
                if (host.includes('localhost') || host.includes('test') || host.includes('127.0.0.1')) {
                    return 'op_logs_test';
                }
                return 'op_logs';
            }

            let opLogs = [];
            async function loadOpLogs() { try { const snap = await db.collection(getLogCollectionName()).orderBy('timestamp', 'desc').limit(100).get(); opLogs = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderAdminLogs(); } catch (e) { } }
            async function addOpLog(action, details = '') { try { const logEntry = { action, details, user: currentUser?.fullName || 'System', timestamp: Date.now() }; await db.collection(getLogCollectionName()).add(logEntry); } catch (e) { } }
            async function clearOldLogs() { try { const threeDaysAgo = Date.now() - 3 * 24 * 60 * 60 * 1000; const old = await db.collection(getLogCollectionName()).where('timestamp', '<', threeDaysAgo).get(); const batch = db.batch(); old.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); } catch (e) { } }
            async function clearAllLogs() { if (currentUser?.role !== 'Owner') return showNotif('Error', 'เฉพาะ Owner'); try { const snap = await db.collection(getLogCollectionName()).get(); const batch = db.batch(); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); opLogs = []; renderAdminLogs(); showNotif('Success', 'ล้าง Log ทั้งหมดแล้ว'); } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); } }
            function renderAdminLogs() { const list = document.getElementById('admin-logs-list'); if (!list) return; if (!opLogs.length) { list.innerHTML = '<p class="text-slate-500 text-center py-4">ไม่มี Log</p>'; return; } list.innerHTML = opLogs.map(l => `<div class="flex gap-2 items-start bg-slate-800/50 p-2 rounded"><span class="text-slate-500 text-[10px] font-mono shrink-0">${new Date(l.timestamp).toLocaleString('th-TH', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span><span class="text-purple-400 text-[10px] shrink-0">${l.user}</span><span class="text-slate-300 flex-1">${l.action}</span>${l.details ? `<span class="text-slate-500">${l.details}</span>` : ''}</div>`).join(''); }
            function renderAdminUsers() {
                const list = document.getElementById('admin-user-list');
                if (!list) return;
                const canManageAdmin = currentUser?.role === 'Owner';
                list.innerHTML = allUsers.map(u => {
                    const isOwner = u.role === 'Owner';
                    const isSelf = u.id === currentUser?.username;
                    const canChange = !isOwner && !isSelf && (canManageAdmin || (isAdmin() && ['Staff', 'Member'].includes(u.role)));
                    const canDelete = canManageAdmin && !isOwner && !isSelf;
                    const canEditName = canManageAdmin && !isOwner;
                    const roleOptions = canManageAdmin ? ['Admin', 'Staff', 'Member'] : ['Staff', 'Member'];
                    return `<div class="flex justify-between items-center bg-slate-800/50 p-2 rounded">
                    <div class="flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs">${u.fullName?.[0] || 'U'}</span>
                        <div>
                            <div class="text-sm text-white flex items-center gap-1">${u.fullName || u.id}${canEditName ? `<button onclick="editUserName('${u.id}', '${escapeHtml(u.fullName || u.id)}')" class="text-[10px] text-cyan-400 hover:text-cyan-300">✏️</button>` : ''}</div>
                            <div class="text-[10px] text-slate-500">${u.id}</div>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center">
                        ${canChange ? `<select onchange="changeUserRole('${u.id}', this.value)" class="text-xs bg-slate-700 border-slate-600 rounded px-2 py-1 text-white"><option value="${u.role}">${u.role}</option>${roleOptions.filter(r => r !== u.role).map(r => `<option value="${r}">${r}</option>`).join('')}</select>` : `<span class="text-xs px-2 py-1 rounded ${isOwner ? 'bg-amber-600' : 'bg-slate-600'} text-white">${u.role}</span>`}
                        ${canDelete ? `<button onclick="deleteUser('${u.id}')" class="text-rose-400 hover:text-rose-300 text-xs px-1">🗑️</button>` : ''}
                    </div>
                </div>`;
                }).join('');
            }
            async function deleteUser(userId) { if (currentUser?.role !== 'Owner') return; const c = await showConfirm('ลบ Account', `ยืนยันลบ ${userId}?`); if (!c) return; try { await db.collection('op_users').doc(userId).delete(); addOpLog('ลบ Account', userId); showNotif('Success', 'ลบเรียบร้อย'); } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); } }


            async function editUserName(userId, currentName) {
                if (currentUser?.role !== 'Owner') return;

                // Create popup modal
                const existing = document.getElementById('edit-name-modal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'edit-name-modal';
                modal.className = 'fixed inset-0 z-[700] flex items-center justify-center p-4';
                modal.style.background = 'rgba(0,0,0,0.7)';
                modal.style.backdropFilter = 'blur(8px)';

                modal.innerHTML = `
                <div class="w-96 rounded-2xl p-6 animate-zoom-in" style="background: linear-gradient(135deg, rgba(30,41,59,0.98) 0%, rgba(51,65,85,0.95) 100%); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">✏️ แก้ไขชื่อผู้ใช้</h3>
                        <button onclick="document.getElementById('edit-name-modal').remove()" class="w-8 h-8 text-slate-400 hover:text-white hover:bg-white/10 rounded-lg flex items-center justify-center transition">✕</button>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-slate-400 mb-1 block">ชื่อปัจจุบัน</label>
                        <div class="text-sm text-slate-300 bg-slate-800/50 px-3 py-2 rounded-lg">${escapeHtml(currentName)}</div>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs text-slate-400 mb-1 block">ชื่อใหม่</label>
                        <input type="text" id="edit-name-input" value="${escapeHtml(currentName)}" 
                            class="w-full text-sm bg-slate-900/80 border border-slate-600 focus:border-cyan-500 rounded-lg px-3 py-2.5 text-white outline-none transition"
                            placeholder="กรอกชื่อใหม่...">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('edit-name-modal').remove()" 
                            class="flex-1 py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium transition">
                            ❌ ยกเลิก
                        </button>
                        <button onclick="confirmEditUserName('${userId}', '${escapeHtml(currentName)}')" 
                            class="flex-1 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium transition">
                            ✅ บันทึก
                        </button>
                    </div>
                </div>
            `;

                document.body.appendChild(modal);

                // Focus and select input
                setTimeout(() => {
                    const input = document.getElementById('edit-name-input');
                    if (input) { input.focus(); input.select(); }
                }, 100);
            }

            async function confirmEditUserName(userId, currentName) {
                const input = document.getElementById('edit-name-input');
                const newName = input?.value?.trim();
                if (!newName || newName === '' || newName === currentName) {
                    document.getElementById('edit-name-modal')?.remove();
                    return;
                }
                try {
                    const firstName = newName.split(' ')[0];
                    await db.collection('op_users').doc(userId).update({
                        fullName: newName,
                        firstName: firstName
                    });
                    addOpLog('แก้ไขชื่อ', `${userId}: ${currentName} → ${newName}`);
                    showNotif('Success', 'แก้ไขชื่อเรียบร้อย');
                    document.getElementById('edit-name-modal')?.remove();
                    renderAdminUsers();
                } catch (e) {
                    showNotif('Error', 'เกิดข้อผิดพลาด');
                }
            }
            async function changeUserRole(userId, newRole) { if (!isAdmin()) return; try { await db.collection('op_users').doc(userId).update({ role: newRole }); addOpLog('เปลี่ยนยศ', `${userId} → ${newRole}`); showNotif('Success', `เปลี่ยนยศเป็น ${newRole}`); } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); } }
            function showStaffAdminModal() { if (!isStaff()) return showNotif('Error', 'สำหรับ Staff ขึ้นไปเท่านั้น'); loadOpLogs(); renderAdminUsers(); renderAdminNotifications(); populateStaffAdminSettings(); if (currentUser?.role !== 'Owner') { document.getElementById('admin-tab-settings').classList.add('hidden'); document.getElementById('admin-tab-announcements').classList.add('hidden'); } else { document.getElementById('admin-tab-settings').classList.remove('hidden'); document.getElementById('admin-tab-announcements').classList.remove('hidden'); loadAdminAnnouncements(); } if (!isAdmin()) document.getElementById('admin-tab-notifications').classList.add('hidden'); else document.getElementById('admin-tab-notifications').classList.remove('hidden'); document.getElementById('staff-admin-modal').classList.remove('hidden'); switchAdminTab('users'); }
            function closeStaffAdminModal() { document.getElementById('staff-admin-modal').classList.add('hidden'); }
            function switchAdminTab(tab) { const themeColor = serverSettings.themeColor || '#06b6d4';['users', 'logs', 'actions', 'notifications', 'settings', 'announcements'].forEach(t => { const tabBtn = document.getElementById(`admin-tab-${t}`); const tabContent = document.getElementById(`admin-tab-content-${t}`); if (tabBtn) { tabBtn.style.backgroundColor = ''; tabBtn.classList.remove('text-white'); tabBtn.classList.add('bg-slate-700', 'text-slate-300'); } if (tabContent) tabContent.classList.add('hidden'); }); const activeBtn = document.getElementById(`admin-tab-${tab}`); activeBtn.style.backgroundColor = themeColor; activeBtn.classList.add('text-white'); activeBtn.classList.remove('bg-slate-700', 'text-slate-300'); document.getElementById(`admin-tab-content-${tab}`).classList.remove('hidden'); if (tab === 'users' && !isAdmin()) { document.getElementById('admin-tab-content-users').innerHTML = '<p class="text-amber-400 text-center py-8">⚠️ Staff ไม่มีสิทธิ์จัดการยศ</p>'; } else if (tab === 'users') renderAdminUsers(); if (tab === 'notifications') renderAdminNotifications(); if (tab === 'settings') populateStaffAdminSettings(); if (tab === 'announcements') loadAdminAnnouncements(); }
            function renderAdminNotifications() { const list = document.getElementById('admin-all-notifications'); if (!list || !isAdmin()) return; if (!notifications.length) { list.innerHTML = '<p class="text-slate-500 text-center py-4">ไม่มีแจ้งเตือน</p>'; return; } list.innerHTML = notifications.map((n, i) => `<div class="flex gap-2 items-start bg-slate-800/50 p-2 rounded"><span class="text-sm ${n.type === 'warning' ? 'text-amber-400' : n.type === 'error' ? 'text-rose-400' : n.type === 'success' ? 'text-emerald-400' : 'text-cyan-400'}">${n.type === 'warning' ? '⚠️' : n.type === 'error' ? '❌' : n.type === 'success' ? '✅' : 'ℹ️'}</span><div class="flex-1"><p class="text-white">${n.msg}</p><p class="text-[10px] text-slate-500">${n.time}</p></div></div>`).join(''); }
            function populateStaffAdminSettings() {
                document.getElementById('staff-admin-server-name').value = serverSettings.serverName || 'ONE CITY';
                document.getElementById('staff-admin-icon-logo').value = serverSettings.iconLogo || '';
                document.getElementById('staff-admin-login-logo').value = serverSettings.loginLogo || '';
                document.getElementById('staff-admin-theme-color').value = serverSettings.themeColor || '#06b6d4';
                document.getElementById('staff-admin-countdown-minutes').value = serverSettings.countdownMinutes || 30;
                document.getElementById('staff-admin-announce-cmd').value = serverSettings.announceCmd || '/an';
                // Render logo galleries
                renderLogoGallery('icon');
                renderLogoGallery('login');
            }

            // ========== Announcement Management ==========
            async function loadAdminAnnouncements() {
                const list = document.getElementById('admin-announcements-list');
                if (!list) return;

                list.innerHTML = '<p class="text-slate-500 text-xs text-center py-4">กำลังโหลด...</p>';

                try {
                    const snapshot = await db.collection('announcements')
                        .orderBy('pinned', 'desc')
                        .orderBy('createdAt', 'desc')
                        .limit(20)
                        .get();

                    if (snapshot.empty) {
                        list.innerHTML = '<p class="text-slate-500 text-xs text-center py-4">ยังไม่มีข่าวสาร</p>';
                        return;
                    }

                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString('th-TH') : '-';
                        const typeIcon = { news: '📰', update: '🆕', event: '🎉', maintenance: '🔧' }[data.type] || '📌';
                        const typeColor = { news: 'text-blue-400', update: 'text-emerald-400', event: 'text-purple-400', maintenance: 'text-rose-400' }[data.type] || 'text-slate-400';

                        const card = document.createElement('div');
                        card.className = `p-3 rounded-lg border ${data.pinned ? 'bg-rose-900/20 border-rose-500/30' : 'bg-slate-800/50 border-slate-700/50'}`;
                        card.innerHTML = `
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="${typeColor}">${typeIcon}</span>
                                        <span class="text-xs font-bold text-white truncate">${data.title || 'ไม่มีหัวข้อ'}</span>
                                        ${data.pinned ? '<span class="text-[9px] bg-rose-500 text-white px-1.5 rounded">📌 ปักหมุด</span>' : ''}
                                    </div>
                                    <p class="text-[10px] text-slate-400 line-clamp-2">${data.content || ''}</p>
                                    <p class="text-[9px] text-slate-500 mt-1">${date}</p>
                                </div>
                                <div class="flex items-center gap-1 shrink-0">
                                    <button onclick="toggleAnnouncementPin('${doc.id}', ${!data.pinned})" class="p-1.5 ${data.pinned ? 'bg-rose-500/30 text-rose-400' : 'bg-slate-700 text-slate-400'} hover:bg-rose-500/50 rounded transition" title="${data.pinned ? 'เลิกปักหมุด' : 'ปักหมุด'}">
                                        📌
                                    </button>
                                    <button onclick="deleteAnnouncement('${doc.id}')" class="p-1.5 bg-slate-700 hover:bg-rose-600 text-slate-400 hover:text-white rounded transition" title="ลบ">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        `;
                        list.appendChild(card);
                    });
                } catch (e) {
                    console.error('Load announcements error:', e);
                    list.innerHTML = '<p class="text-rose-400 text-xs text-center py-4">❌ โหลดข้อมูลไม่สำเร็จ</p>';
                }
            }

            async function addAnnouncement() {
                if (currentUser?.role !== 'Owner') return showNotif('Error', 'เฉพาะ Owner เท่านั้น');

                const title = document.getElementById('announce-title').value.trim();
                const type = document.getElementById('announce-type').value;
                const content = document.getElementById('announce-content').value.trim();
                const pinned = document.getElementById('announce-pinned').checked;

                if (!title) return showNotif('Error', 'กรุณากรอกหัวข้อ');
                if (!content) return showNotif('Error', 'กรุณากรอกเนื้อหา');

                try {
                    await db.collection('announcements').add({
                        title,
                        type,
                        content,
                        pinned,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        author: currentUser.username
                    });

                    showNotif('Success', '📢 เผยแพร่ข่าวสารแล้ว');

                    // Clear form
                    document.getElementById('announce-title').value = '';
                    document.getElementById('announce-content').value = '';
                    document.getElementById('announce-pinned').checked = false;

                    // Reload list
                    loadAdminAnnouncements();
                } catch (e) {
                    console.error('Add announcement error:', e);
                    showNotif('Error', 'เกิดข้อผิดพลาด');
                }
            }

            async function toggleAnnouncementPin(docId, pinned) {
                if (currentUser?.role !== 'Owner') return;

                try {
                    await db.collection('announcements').doc(docId).update({ pinned });
                    showNotif('Success', pinned ? '📌 ปักหมุดแล้ว' : 'เลิกปักหมุดแล้ว');
                    loadAdminAnnouncements();
                } catch (e) {
                    showNotif('Error', 'เกิดข้อผิดพลาด');
                }
            }

            async function deleteAnnouncement(docId) {
                if (currentUser?.role !== 'Owner') return;

                const confirmed = await showConfirm('ลบข่าวสาร', 'ต้องการลบข่าวสารนี้?');
                if (!confirmed) return;

                try {
                    await db.collection('announcements').doc(docId).delete();
                    showNotif('Success', '🗑️ ลบข่าวสารแล้ว');
                    loadAdminAnnouncements();
                } catch (e) {
                    showNotif('Error', 'เกิดข้อผิดพลาด');
                }
            }

            // Server Logo Gallery System
            async function uploadServerLogo(type, input) {
                const file = input.files[0];
                if (!file) return;
                if (file.size > 2 * 1024 * 1024) {
                    showNotif('Error', 'รูปภาพต้องมีขนาดไม่เกิน 2MB');
                    input.value = '';
                    return;
                }

                const statusEl = document.getElementById(`${type}-logo-upload-status`);
                if (statusEl) statusEl.textContent = '⏳ กำลัง Upload...';

                try {
                    const timestamp = Date.now();
                    const ext = file.name.split('.').pop();
                    const path = `logos/${type}_${timestamp}.${ext}`;

                    const ref = storage.ref(path);
                    await ref.put(file);
                    const url = await ref.getDownloadURL();

                    // Add to gallery
                    if (!serverSettings.logoGallery) serverSettings.logoGallery = { icon: [], login: [] };
                    if (!serverSettings.logoGallery[type]) serverSettings.logoGallery[type] = [];
                    serverSettings.logoGallery[type].push({ url, path, uploadedAt: timestamp });

                    // Auto-select if first upload
                    if (serverSettings.logoGallery[type].length === 1) {
                        document.getElementById(`staff-admin-${type}-logo`).value = url;
                    }

                    // Save gallery to Firestore
                    await db.collection('op_settings').doc('server').update({ logoGallery: serverSettings.logoGallery });

                    renderLogoGallery(type);
                    if (statusEl) statusEl.textContent = '✓ Upload สำเร็จ';
                    setTimeout(() => { if (statusEl) statusEl.textContent = ''; }, 2000);
                    input.value = '';
                } catch (e) {
                    console.error('Upload error:', e);
                    if (statusEl) statusEl.textContent = '❌ Upload ล้มเหลว';
                    showNotif('Error', 'Upload ล้มเหลว');
                }
            }

            function renderLogoGallery(type) {
                const gallery = document.getElementById(`${type}-logo-gallery`);
                if (!gallery) return;

                const items = serverSettings.logoGallery?.[type] || [];
                const currentSelected = document.getElementById(`staff-admin-${type}-logo`)?.value || '';

                if (items.length === 0) {
                    gallery.innerHTML = '<div class="col-span-4 text-xs text-slate-500 text-center py-2">ยังไม่มีรูป - กด Upload เพื่อเพิ่ม</div>';
                    return;
                }

                gallery.innerHTML = items.map((item, idx) => {
                    const isSelected = item.url === currentSelected;
                    return `
                    <div class="relative group cursor-pointer ${isSelected ? 'ring-2 ring-cyan-400' : ''}" onclick="selectServerLogo('${type}', '${item.url}')">
                        <img src="${item.url}" class="w-full h-16 object-cover rounded-lg border border-slate-600">
                        ${isSelected ? '<div class="absolute top-1 left-1 text-xs bg-cyan-500 text-white px-1 rounded">✓</div>' : ''}
                        <button onclick="event.stopPropagation(); deleteServerLogo('${type}', ${idx})" 
                            class="absolute top-1 right-1 w-5 h-5 bg-red-500/80 hover:bg-red-500 text-white rounded-full text-xs hidden group-hover:flex items-center justify-center">✕</button>
                    </div>
                `;
                }).join('');
            }

            function selectServerLogo(type, url) {
                document.getElementById(`staff-admin-${type}-logo`).value = url;
                renderLogoGallery(type);
            }

            async function deleteServerLogo(type, index) {
                const items = serverSettings.logoGallery?.[type] || [];
                if (index < 0 || index >= items.length) return;

                const item = items[index];
                const confirmed = await showConfirm('ลบรูปภาพ', 'ยืนยันลบรูปนี้?');
                if (!confirmed) return;

                try {
                    // Delete from Storage
                    if (item.path) await storage.ref(item.path).delete().catch(() => { });

                    // Remove from gallery
                    items.splice(index, 1);
                    serverSettings.logoGallery[type] = items;

                    // If deleted was selected, clear selection
                    const currentSelected = document.getElementById(`staff-admin-${type}-logo`)?.value;
                    if (currentSelected === item.url) {
                        document.getElementById(`staff-admin-${type}-logo`).value = items[0]?.url || '';
                    }

                    // Save to Firestore
                    await db.collection('op_settings').doc('server').update({ logoGallery: serverSettings.logoGallery });

                    renderLogoGallery(type);
                    showNotif('Success', 'ลบรูปเรียบร้อย');
                } catch (e) {
                    console.error('Delete error:', e);
                    showNotif('Error', 'ลบไม่สำเร็จ');
                }
            }

            async function saveStaffAdminSettings() {
                if (currentUser?.role !== 'Owner') return showNotif('Error', 'เฉพาะ Owner');
                const name = document.getElementById('staff-admin-server-name').value.trim(),
                    iconLogo = document.getElementById('staff-admin-icon-logo').value.trim(),
                    loginLogo = document.getElementById('staff-admin-login-logo').value.trim(),
                    themeColor = document.getElementById('staff-admin-theme-color').value,
                    countdownMinutes = parseInt(document.getElementById('staff-admin-countdown-minutes').value) || 30,
                    announceCmd = document.getElementById('staff-admin-announce-cmd').value.trim() || '/an';
                if (!name) return showNotif('Error', 'กรุณากรอกชื่อ Server');
                try {
                    await db.collection('op_settings').doc('server').set({
                        serverName: name, iconLogo, loginLogo, themeColor, countdownMinutes, announceCmd,
                        logoGallery: serverSettings.logoGallery || { icon: [], login: [] }
                    });
                    serverSettings = { serverName: name, iconLogo, loginLogo, themeColor, countdownMinutes, announceCmd, logoGallery: serverSettings.logoGallery };
                    applyServerLogos(); applyThemeColor(); showNotif('Success', 'บันทึกค่าเรียบร้อย');
                } catch (e) { showNotif('Error', 'เกิดข้อผิดพลาด'); }
            }
            async function forceEndShift() {
                if (!isStaff()) return;

                // Auto-close started stories (not pending) before force ending shift
                const startedCases = (appData.cases || []).filter(c => !isTimeInFuture(c.startTime, c.storyDate) && !c.pendingStart);
                if (startedCases.length > 0) {
                    if (!appData.closedCases) appData.closedCases = [];
                    startedCases.forEach(sc => {
                        // Move case to closed cases
                        appData.closedCases.push({ ...sc, closedAt: Date.now(), forceClosed: true });
                        // Return medics to available pool (they'll be cleared anyway in appData reset)
                    });
                    // Log which stories were force-closed
                    const caseNames = startedCases.map(c => `${c.partyA} VS ${c.partyB}`).join(', ');
                    addOpLog('บังคับปิดสตอรี่', caseNames);
                }

                const c = await showConfirm('⚠️ บังคับปิดกะ', 'คุณแน่ใจหรือไม่? การกระทำนี้จะปิดกะทันทีและไม่สามารถย้อนกลับได้');
                if (!c) return;
                const prevOP = appData.currentOP;
                // New logic: If any story is still active (not closed), keep ALL stories. If all closed, delete closed stories.
                const activeStories = (appData.cases || []).filter(cs => !cs.closed && !isTimeInFuture(cs.startTime, cs.storyDate) && !cs.pendingStart);
                const hasActiveStories = activeStories.length > 0;
                const preservedCases = (appData.cases || []).filter(cs => {
                    if (isTimeInFuture(cs.startTime, cs.storyDate) || cs.pendingStart) return true;
                    if (hasActiveStories) return true;
                    return !cs.closed;
                });
                appData = { shiftStart: null, currentOP: null, supOP: null, onDuty: [], offDuty: [], afk: [], afkTimes: {}, cases: preservedCases, closedCases: [], medicStatuses: {}, opPendingRequests: [], opHandoverAt: null, handoverNextOP: null, afkWarnings: {}, afkWarnedTimes: {} };

                // CRITICAL: Wait for save to complete before proceeding
                const saved = await saveOpData();
                if (!saved) {
                    showNotif('Error', '❌ บันทึกไม่สำเร็จ กรุณารีเฟรชหน้าเว็บ');
                    return;
                }

                addOpLog('บังคับปิดกะ', `OP เดิม: ${prevOP || '-'}`);
                closeStaffAdminModal();
                showNotif('Success', 'บังคับปิดกะเรียบร้อย');
            }

            async function loadOpData() {
                try {
                    const doc = await db.collection('op_data').doc(getDocId('current')).get();
                    if (doc.exists) {
                        appData = { ...appData, ...doc.data() };
                        serverDataVersion = appData._version || 0; // Sync version on load
                    }
                    renderAllDebounced();
                } catch (e) { }
                db.collection('op_data').doc(getDocId('current')).onSnapshot(doc => {
                    if (doc.exists) {
                        const prevReqCount = appData.opPendingRequests?.length || 0;
                        appData = { ...appData, ...doc.data() };
                        serverDataVersion = appData._version || 0; // Sync version on real-time update
                        const newReqCount = appData.opPendingRequests?.length || 0;
                        if (newReqCount > prevReqCount && currentUser?.fullName === appData.currentOP) {
                            const reqIdx = newReqCount - 1;
                            const newReq = appData.opPendingRequests[reqIdx];
                            addNotification(`📋 Request OP จาก ${newReq?.requester || 'ไม่ทราบ'} (${newReq?.wantedTime || '-'})`, 'warning', [{ label: '✅ ยืนยัน', action: `showApproveModal(${reqIdx})`, color: 'bg-emerald-600' }, { label: '❌ ปฏิเสธ', action: `rejectOPRequest(${reqIdx});removeNotif(0)`, color: 'bg-rose-600' }]);
                        }
                        renderAllDebounced();
                    }
                });
                loadUsers();
            }
            // Track server data version for conflict detection
            let serverDataVersion = 0;

            async function saveOpData() {
                try {
                    const docRef = db.collection('op_data').doc(getDocId('current'));

                    // Get current server data to check version
                    const serverDoc = await docRef.get();
                    const serverData = serverDoc.exists ? serverDoc.data() : null;

                    // Conflict detection: if server version is higher than our known version
                    if (serverData && serverData._version && serverData._version > serverDataVersion) {
                        // CONFLICT DETECTED! Log it and show warning
                        console.warn('[saveOpData] CONFLICT! Server v' + serverData._version + ' > Local v' + serverDataVersion);

                        // Log conflict to Firestore
                        try {
                            await db.collection('conflict_logs').add({
                                timestamp: Date.now(),
                                user: currentUser?.fullName || 'Unknown',
                                localVersion: serverDataVersion,
                                serverVersion: serverData._version,
                                serverOP: serverData.currentOP,
                                localOP: appData.currentOP,
                                serverModifiedBy: serverData._modifiedBy,
                                serverModifiedAt: serverData._lastModified
                            });
                        } catch (logErr) { console.error('Conflict log error:', logErr); }

                        // Show conflict modal instead of saving
                        showDataConflictModal(serverData);
                        return false;
                    }

                    // Increment version and update metadata
                    appData._version = (serverData?._version || serverDataVersion || 0) + 1;
                    appData._lastModified = Date.now();
                    appData._modifiedBy = currentUser?.fullName || 'System';

                    // Save to Firestore
                    await docRef.set(appData);

                    // Update local version tracker
                    serverDataVersion = appData._version;

                    return true;
                } catch (e) {
                    console.error('[saveOpData] Error:', e);
                    return false;
                }
            }

            function showDataConflictModal(serverData) {
                // Create or update conflict modal
                let modal = document.getElementById('data-conflict-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'data-conflict-modal';
                    modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center';
                    modal.style.cssText = 'background: rgba(0,0,0,0.85); backdrop-filter: blur(12px);';
                    document.body.appendChild(modal);
                }

                const serverOP = serverData?.currentOP?.split(' ')[0] || '-';
                const serverTime = serverData?._lastModified ? new Date(serverData._lastModified).toLocaleTimeString('th-TH') : '-';
                const modifiedBy = serverData?._modifiedBy?.split(' ')[0] || 'ไม่ทราบ';

                modal.innerHTML = `
                <div class="bg-slate-900 rounded-2xl p-8 text-center max-w-md mx-4 shadow-2xl border border-rose-500/50">
                    <div class="text-6xl mb-4">⚠️</div>
                    <h2 class="text-xl font-bold text-rose-400 mb-3">พบการเปลี่ยนแปลงข้อมูล!</h2>
                    <p class="text-slate-300 mb-4">
                        มีผู้ใช้อื่นแก้ไขข้อมูลแล้ว<br>
                        ข้อมูลของคุณอาจไม่เป็นปัจจุบัน
                    </p>
                    <div class="bg-slate-800/50 rounded-lg p-3 mb-4 text-left text-sm">
                        <p class="text-slate-400">📊 ข้อมูล Server:</p>
                        <p class="text-white">OP: <span class="text-cyan-400">${serverOP}</span></p>
                        <p class="text-white">แก้ไขโดย: <span class="text-amber-400">${modifiedBy}</span></p>
                        <p class="text-white">เวลา: <span class="text-emerald-400">${serverTime}</span></p>
                    </div>
                    <button onclick="location.reload()" 
                        class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-xl transition duration-200">
                        🔄 รีเฟรชหน้าเว็บ
                    </button>
                    <p class="text-slate-500 text-xs mt-3">กรุณา Refresh เพื่อดูข้อมูลล่าสุด</p>
                </div>
            `;

                modal.classList.remove('hidden');
            } let allUsers = [];
            let renderTimeout = null;
            function renderAllDebounced() { if (renderTimeout) clearTimeout(renderTimeout); renderTimeout = setTimeout(() => { renderAll(); updateUserDropdowns(); applyRoleRestrictions(); if (typeof updateSupOPDisplay === 'function') updateSupOPDisplay(); }, 300); }
            async function loadUsers() { try { const snap = await db.collection('op_users').get(); allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() })); updateUserDropdowns(); renderOPControl(); startIncomingDMListener(); renderOnlineUsersList(); listenToLastMessages(); } catch (e) { } db.collection('op_users').onSnapshot(snap => { allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() })); updateUserDropdowns(); startIncomingDMListener(); renderOnlineUsersList(); if (chatListOpen) renderChatList(); }); }
            function updateUserDropdowns() { const supSel = document.getElementById('op-sup-select'); const m1 = document.getElementById('case-medic-1'), m2 = document.getElementById('case-medic-2'), m3 = document.getElementById('case-medic-3'); if (!supSel) return;[m1, m2, m3].forEach(s => { if (s) s.innerHTML = '<option value="">-- เลือก --</option>'; }); supSel.innerHTML = '<option value="">-- Select --</option>'; allUsers.filter(u => u.workStatus !== 'ลางาน' && u.fullName !== appData.currentOP).forEach(u => { const displayName = u.firstName || u.fullName.split(' ')[0]; supSel.innerHTML += `<option value="${u.fullName}">${displayName}</option>`; }); (appData.onDuty || []).forEach(name => { [m1, m2, m3].forEach(s => { if (s) s.innerHTML += `<option value="${name}">${name}</option>`; }); }); if (appData.supOP) supSel.value = appData.supOP; }

            function updateHeader() { const el = document.getElementById('op-shift-date'); if (el) el.textContent = new Date().toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); }
            function setSidebarTab(tab) { const btnW = document.getElementById('tab-btn-working'), btnA = document.getElementById('tab-btn-afk'), viewW = document.getElementById('sidebar-view-working'), viewA = document.getElementById('sidebar-view-afk'); if (tab === 'working') { btnW.classList.add('bg-slate-700', 'shadow-sm', 'text-white'); btnW.classList.remove('text-slate-400', 'hover:bg-slate-700/50'); btnA.classList.remove('bg-slate-700', 'shadow-sm', 'text-white'); btnA.classList.add('text-slate-400', 'hover:bg-slate-700/50'); viewW.classList.remove('hidden'); viewA.classList.add('hidden'); } else { btnA.classList.add('bg-slate-700', 'shadow-sm', 'text-white'); btnA.classList.remove('text-slate-400', 'hover:bg-slate-700/50'); btnW.classList.remove('bg-slate-700', 'shadow-sm', 'text-white'); btnW.classList.add('text-slate-400', 'hover:bg-slate-700/50'); viewA.classList.remove('hidden'); viewW.classList.add('hidden'); } }

            function renderAll() {
                // Check if OP is on duty
                const hasOP = !!appData.currentOP;
                // Fix: Compare first name or check if fullName includes OP name (handles "Jummxm Shehot" vs "Jummxm")
                const userFirstName = currentUser?.fullName?.split(' ')[0] || '';
                const opFirstName = appData.currentOP?.split(' ')[0] || '';
                const supOpFirstName = appData.supOP?.split(' ')[0] || '';

                // Check conditions with null safety
                const isOPMatch = userFirstName && opFirstName && userFirstName === opFirstName;
                const isSupOPMatch = userFirstName && supOpFirstName && userFirstName === supOpFirstName;
                const includesOP = currentUser?.fullName && appData.currentOP && currentUser.fullName.includes(appData.currentOP);
                const includesSupOP = currentUser?.fullName && appData.supOP && currentUser.fullName.includes(appData.supOP);

                const isOP = hasOP && (isOPMatch || isSupOPMatch || includesOP || includesSupOP);
                const isStaffPlus = currentUser?.role && ['Staff', 'Admin', 'Owner'].includes(currentUser.role);

                // Fight form visibility:
                // - isOP (current OP or Sup OP): Always see the form
                // - Staff+ with no OP on duty: Can see and create
                // - Otherwise: Hidden
                const fightForm = document.getElementById('fight-create-form');
                const canSeeFightForm = isOP || (!hasOP && isStaffPlus);
                if (fightForm) fightForm.classList.toggle('hidden', !canSeeFightForm);

                // Umae form: Only OP can see
                const umaeForm = document.getElementById('umae-add-form');
                if (umaeForm) umaeForm.classList.toggle('hidden', !isOP);

                // Show/hide umae tab lock for non-OP users
                initUmaeData();
                const umaeTabBtn = document.getElementById('story-tab-umae');
                if (umaeTabBtn) {
                    const isUmaeVisible = appData.umae?.visible;
                    if (!isOP && !isUmaeVisible) {
                        // Lock the tab for non-OP
                        umaeTabBtn.innerHTML = '🔒 อุ้มเอ๋อ(ห่อศพ)';
                        umaeTabBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        // Unlock the tab
                        umaeTabBtn.innerHTML = '💀 อุ้มเอ๋อ(ห่อศพ)';
                        umaeTabBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                renderOPControl();
                const numOn = appData.onDuty?.length || 0, numOff = appData.offDuty?.length || 0, numAfk = (appData.afk || []).length;
                // Only count medics in stories that have STARTED (not pending)
                const numInCases = (appData.cases || []).reduce((s, c) => s + (!c.pendingStart && !isTimeInFuture(c.startTime, c.storyDate) ? (c.medics?.length || 0) : 0), 0);
                const numInUmae = appData.umae?.medics?.length || 0;
                // Count medics in Blue Box events (countsAsOnDuty = true)
                const numInBlueBoxEvents = (appData.activeEvents || []).filter(e => e.countsAsOnDuty).reduce((s, e) => s + (e.medics?.length || 0), 0);
                // Total working includes: On Duty + AFK + In Cases + In Umae + In Blue Box Events + OP + Sup OP
                let totalWorking = numOn + numAfk + numInCases + numInUmae + numInBlueBoxEvents;
                if (appData.currentOP) totalWorking += 1;
                if (appData.supOP) totalWorking += 1;
                const el1 = document.getElementById('count-tab-working'); if (el1) el1.textContent = totalWorking;
                const el2 = document.getElementById('count-tab-afk'); if (el2) el2.textContent = numAfk;
                const el3 = document.getElementById('count-on-duty'); if (el3) el3.textContent = totalWorking;
                const el4 = document.getElementById('count-off-duty'); if (el4) el4.textContent = numOff;
                const el5 = document.getElementById('count-afk'); if (el5) el5.textContent = numAfk;

                const listOnDuty = document.getElementById('list-on-duty');
                if (listOnDuty) listOnDuty.innerHTML = (appData.onDuty || []).map(n => {
                    const st = appData.medicStatuses?.[n] || '';
                    const warnCount = appData.afkWarnings?.[n] || 0;
                    const warnBadge = warnCount > 0 ? `<span class="text-[9px] bg-amber-600 text-white px-1 rounded ml-1" title="AFK Warning: ${warnCount}">${warnCount > 2 ? '⛔' : '⚠️'}${warnCount}</span>` : '';
                    const acceptBtn = st === 'accept' ? `<button onclick="toggleMedicStatus('${n}','accept')" class="medic-action-btn flex-shrink-0 px-2 py-1 rounded text-[10px] bg-cyan-600 text-white font-medium">✓</button>` : `<button onclick="toggleMedicStatus('${n}','accept')" class="medic-action-btn flex-shrink-0 px-2 py-1 rounded text-[10px] bg-slate-700/80 text-slate-400 hover:bg-cyan-600/40 hover:text-cyan-300">✓</button>`;
                    const waitBtn = st === 'waitfix' ? `<button onclick="toggleMedicStatus('${n}','waitfix')" class="medic-action-btn flex-shrink-0 px-2 py-1 rounded text-[10px] bg-amber-600 text-white font-medium">⏳</button>` : `<button onclick="toggleMedicStatus('${n}','waitfix')" class="medic-action-btn flex-shrink-0 px-2 py-1 rounded text-[10px] bg-slate-700/80 text-slate-400 hover:bg-amber-600/40 hover:text-amber-300">⏳</button>`;
                    const declineBtn = st === 'decline' ? `<button onclick="toggleMedicStatus('${n}','decline')" class="medic-action-btn flex-shrink-0 px-2 py-1 rounded text-[10px] bg-rose-600 text-white font-medium">❌</button>` : `<button onclick="toggleMedicStatus('${n}','decline')" class="medic-action-btn flex-shrink-0 px-2 py-1 rounded text-[10px] bg-slate-700/80 text-slate-400 hover:bg-rose-600/40 hover:text-rose-300">❌</button>`;
                    // Find registered user by matching first name (not full name)
                    const matchedUser = allUsers.find(u => u.firstName && u.firstName === n.split(' ')[0]);
                    const icPhone = matchedUser?.icPhone ? `<span class="text-[10px] text-slate-500 ml-1">📞${matchedUser.icPhone}</span>` : '';
                    const themeHex = (serverSettings.themeColor || '#06b6d4').replace('#', '');
                    const avatarUrl = matchedUser?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=${themeHex}&color=fff&size=32`;
                    const avatarImg = matchedUser ? `<img src="${avatarUrl}" onclick="showImagePreview('${avatarUrl}', '${n}')" class="w-6 h-6 rounded-md object-cover shrink-0 cursor-pointer hover:ring-2 hover:ring-cyan-400 transition" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=${themeHex}&color=fff&size=32'">` : '';
                    return `<div class="flex flex-col gap-1 bg-slate-800/60 px-2 py-1.5 rounded-lg border border-slate-700/50">
                    <div class="flex items-center gap-1.5">
                        ${avatarImg}<span class="text-cyan-300 text-xs font-medium truncate">${n}${warnBadge}</span>${icPhone}
                    </div>
                    <div class="flex items-center gap-1 flex-wrap">
                        ${isOP ? `${acceptBtn}${waitBtn}${declineBtn}` : (
                            st === 'accept' ? '<span class="px-1.5 py-0.5 rounded text-[10px] bg-cyan-900/50 border border-cyan-700/50 text-cyan-400">✓ คิวรับเคส</span>' :
                                st === 'waitfix' ? '<span class="px-1.5 py-0.5 rounded text-[10px] bg-amber-900/50 border border-amber-700/50 text-amber-400">⏳ รอเคสแก้</span>' :
                                    st === 'decline' ? '<span class="px-1.5 py-0.5 rounded text-[10px] bg-rose-900/50 border border-rose-700/50 text-rose-400">❌ ไม่รับเคส</span>' : ''
                        )}
                        <button onclick="moveMedic('${n}','onDuty','afk')" class="medic-action-btn px-1.5 py-1 rounded text-[10px] bg-slate-700/80 text-yellow-400 hover:bg-yellow-600/40" title="AFK">💤</button>
                        <button onclick="moveMedic('${n}','onDuty','offDuty')" class="medic-action-btn px-1.5 py-1 rounded text-[10px] bg-slate-700/80 text-slate-400 hover:bg-slate-600" title="Off">📴</button>
                    </div>
                </div>`;
                }).join('') || '<p class="text-xs text-slate-500 text-center py-3">ไม่มีข้อมูล</p>';
                const listOffDuty = document.getElementById('list-off-duty');
                if (listOffDuty) listOffDuty.innerHTML = (appData.offDuty || []).map(n => `<div class="flex justify-between items-center bg-slate-800/50 px-2 py-1.5 rounded text-xs group hover:bg-slate-700/50"><span class="text-slate-400">${n}</span><button onclick="moveMedic('${n}','offDuty','onDuty')" class="medic-action-btn opacity-0 group-hover:opacity-100 text-green-400 hover:text-green-300">🔼</button></div>`).join('') || '<p class="text-xs text-slate-500 text-center py-2">ไม่มีข้อมูล</p>';
                const listAfk = document.getElementById('list-afk');
                if (listAfk) listAfk.innerHTML = (appData.afk || []).map(n => { const start = appData.afkTimes?.[n] || Date.now(); return `<div class="flex justify-between items-center bg-yellow-900/30 px-2 py-1.5 rounded text-xs group"><div><span class="text-yellow-200">💤 ${n}</span><span class="text-[10px] font-mono text-yellow-400/60 afk-timer" data-start="${start}">00:00</span></div><button onclick="moveMedic('${n}','afk','onDuty')" class="medic-action-btn opacity-0 group-hover:opacity-100 text-green-400 hover:text-green-300">🔼</button></div>`; }).join('') || '<p class="text-xs text-slate-500 text-center py-2">ไม่มีข้อมูล</p>';

                const caseList = document.getElementById('op-case-list');
                if (!caseList) return;
                if (!appData.cases || appData.cases.length === 0) { caseList.innerHTML = '<p class="text-center text-slate-500 text-xs py-8">ยังไม่มีสตอรี่</p>'; }
                else {
                    // Use isOP from renderAll scope (already defined at top with correct firstName matching)

                    // Group cases by date
                    const casesByDate = {};
                    appData.cases.forEach((c, idx) => {
                        const dateKey = c.storyDate || 'no-date';
                        if (!casesByDate[dateKey]) casesByDate[dateKey] = [];
                        casesByDate[dateKey].push({ ...c, originalIndex: idx });
                    });

                    // Sort date keys (no-date at the end)
                    const dateKeys = Object.keys(casesByDate).sort((a, b) => {
                        if (a === 'no-date') return 1;
                        if (b === 'no-date') return -1;
                        return a.localeCompare(b);
                    });

                    // Render grouped cases
                    let html = '';
                    dateKeys.forEach(dateKey => {
                        const dateLabel = dateKey === 'no-date'
                            ? '📅 ไม่ระบุวันที่'
                            : '📅 ' + new Date(dateKey).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', weekday: 'short' });

                        html += '<div class="mb-4">';
                        html += '<div class="text-xs font-bold text-indigo-300 mb-2 px-1 py-1 bg-indigo-900/30 rounded flex items-center gap-2">' + dateLabel + ' <span class="text-slate-500 font-normal">(' + casesByDate[dateKey].length + ' สตอรี่)</span></div>';
                        html += '<div class="grid grid-cols-2 gap-2" style="grid-auto-rows: 1fr;">';

                        casesByDate[dateKey].forEach((c, localIdx) => {
                            const idx = c.originalIndex;
                            if (editingCaseId === c.id) {
                                html += `<div class="bg-slate-800/80 rounded-lg overflow-hidden border-2 border-indigo-500 flex flex-col">
                                    <div class="px-2 py-1.5 bg-gradient-to-r from-indigo-900/60 to-transparent flex justify-between items-center">
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] font-bold text-indigo-300 bg-indigo-500/20 px-2 py-0.5 rounded">#${localIdx + 1}</span>
                                            <span class="text-xs text-amber-400 font-bold">✏️ กำลังแก้ไข</span>
                                        </div>
                                        <span class="text-[10px] text-slate-400">🕐 ${c.startTime || '--:--'}</span>
                                    </div>
                                    <div class="p-2 space-y-2">
                                        <div class="flex items-center gap-2">
                                            <span class="text-[10px] text-slate-400 w-16">⚔️ ฝ่าย:</span>
                                            <input id="edit-pA-${c.id}" class="flex-1 text-xs bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value="${c.partyA}" placeholder="Party A">
                                            <span class="text-rose-400 text-xs font-bold">VS</span>
                                            <input id="edit-pB-${c.id}" class="flex-1 text-xs bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value="${c.partyB}" placeholder="Party B">
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            <div class="flex items-center gap-1">
                                                <span class="text-[10px] text-slate-400">📍</span>
                                                <select id="edit-loc-${c.id}" class="w-28 text-[10px] bg-slate-700/50 border border-slate-600 rounded px-1.5 py-0.5 text-slate-300">
                                                    <option value="ยังไม่ระบุ" ${!c.location || c.location === 'ยังไม่ระบุ' ? 'selected' : ''}>ยังไม่ระบุ</option>
                                                    <option value="สนามบินล่าง" ${c.location === 'สนามบินล่าง' ? 'selected' : ''}>สนามบินล่าง</option>
                                                    <option value="สนามบินทะเลทราย" ${c.location === 'สนามบินทะเลทราย' ? 'selected' : ''}>สนามบินทะเลทราย</option>
                                                    <option value="สนามบินค่ายทหาร" ${c.location === 'สนามบินค่ายทหาร' ? 'selected' : ''}>สนามบินค่ายทหาร</option>
                                                    <option value="ปั้มเมืองบน" ${c.location === 'ปั้มเมืองบน' ? 'selected' : ''}>ปั้มเมืองบน</option>
                                                    <option value="โรงเชือดไก่" ${c.location === 'โรงเชือดไก่' ? 'selected' : ''}>โรงเชือดไก่</option>
                                                </select>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="text-[10px] text-slate-400">📻</span>
                                                <input id="edit-rad-${c.id}" class="w-20 text-[10px] bg-slate-700/50 border border-slate-600 rounded px-1.5 py-0.5 text-slate-300" value="${c.radio || ''}" placeholder="Radio">
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="text-[10px] text-slate-400">⚖️</span>
                                                <input id="edit-cou-${c.id}" class="w-20 text-[10px] bg-slate-700/50 border border-slate-600 rounded px-1.5 py-0.5 text-slate-300" value="${c.council || ''}" placeholder="Council">
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="text-[10px] text-slate-400">📅</span>
                                                <input type="date" id="edit-date-${c.id}" class="w-28 text-[10px] bg-slate-700/50 border border-slate-600 rounded px-1.5 py-0.5 text-slate-300" value="${c.storyDate || ''}">
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-1 flex-wrap">
                                            <span class="text-[10px] text-slate-500">👨‍⚕️ แพทย์:</span>
                                            ${c.medics.map(m => '<span class="text-[10px] bg-amber-900/50 text-amber-300 px-1.5 py-0.5 rounded">👑 ' + m + '</span>').join('')}
                                        </div>
                                        <div class="flex gap-1.5 pt-1.5 border-t border-slate-700/30">
                                            <button onclick="cancelEdit()" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded font-medium">❌ ยกเลิก</button>
                                            <button onclick="saveEdit('${c.id}')" class="text-[10px] bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded font-medium">💾 บันทึก</button>
                                        </div>
                                    </div>
                                </div>`;
                            } else {
                                const isMedicInCase = c.medics.includes(currentUser?.fullName?.split(' ')[0]);
                                const canCopy = isOP || isMedicInCase;
                                // Calculate pending dynamically based on current time and story date/time
                                const isPending = isTimeInFuture(c.startTime, c.storyDate);
                                // Check if story is closed
                                const isClosed = c.closed === true;
                                // Check if story date is today or past (not future date) - show "ห้ามฉีดยา"
                                const now = new Date();
                                const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                                const storyDateStr = c.storyDate || today;
                                const isStoryDateReached = storyDateStr <= today;
                                const closedBadge = isClosed ? '<span class="text-[10px] font-bold text-emerald-400 bg-emerald-500/20 px-2 py-0.5 rounded ml-1">✅ Clear</span>' : '';
                                const playingBadge = !isPending && !isClosed && isStoryDateReached ? '<span class="text-[10px] font-bold text-purple-400 bg-purple-500/20 px-2 py-0.5 rounded ml-1">🎮 กำลังเล่น</span>' : '';
                                const noInjectionBadge = isStoryDateReached && !isClosed ? '<span class="text-[10px] font-bold text-rose-400 bg-rose-500/20 px-2 py-0.5 rounded ml-1">🚫 ห้ามฉีดยา</span>' : '';
                                const pendingBadge = isPending && !isClosed ? '<span class="text-[10px] font-bold text-amber-400 bg-amber-500/20 px-2 py-0.5 rounded ml-1">⏳ รอเริ่ม</span>' : '';
                                const isAssigning = assigningCaseId === c.id;

                                // Check blacklist for Party A and Party B (handle both string and object format)
                                const partyABlEntry = blacklistData.find(g => {
                                    const name = typeof g === 'object' ? g.name : g;
                                    return name?.toLowerCase() === c.partyA?.toLowerCase();
                                });
                                const partyBBlEntry = blacklistData.find(g => {
                                    const name = typeof g === 'object' ? g.name : g;
                                    return name?.toLowerCase() === c.partyB?.toLowerCase();
                                });

                                // Build emoji tag based on penaltyTag with tooltip showing penalty only
                                const getEmojiTag = (entry) => {
                                    if (!entry || typeof entry !== 'object' || !entry.penaltyTag) return '';
                                    // Simplified tooltip - only show penalty type
                                    const penaltyLabels = { 'x2': 'โทษค่ารักษา x2', 'x5': 'โทษค่ารักษา x5', 'no-treat': 'ไม่ทำการรักษา' };
                                    const tooltipText = penaltyLabels[entry.penaltyTag] || '';

                                    if (entry.penaltyTag === 'x2') return `<span class="text-[9px] text-amber-400 bg-amber-500/20 px-1 py-0.5 rounded cursor-help" title="${tooltipText}">💰x2</span>`;
                                    if (entry.penaltyTag === 'x5') return `<span class="text-[9px] text-rose-400 bg-rose-500/20 px-1 py-0.5 rounded cursor-help" title="${tooltipText}">💰x5</span>`;
                                    if (entry.penaltyTag === 'no-treat') return `<span class="text-[9px] text-rose-400 bg-rose-500/20 px-1 py-0.5 rounded cursor-help" title="${tooltipText}">🚫💊</span>`;
                                    return '';
                                };
                                const partyATag = getEmojiTag(partyABlEntry);
                                const partyBTag = getEmojiTag(partyBBlEntry);
                                const partyADisplay = partyATag ? partyATag + ' ' + c.partyA : c.partyA;
                                const partyBDisplay = partyBTag ? c.partyB + ' ' + partyBTag : c.partyB;

                                let assignMedicUI = '';
                                if (isAssigning) {
                                    const availableMedics = (appData.onDuty || []).concat(c.medics || []).filter((v, i, a) => a.indexOf(v) === i);
                                    assignMedicUI = '<div class="bg-slate-900/50 rounded-lg p-2 mb-2 border border-indigo-500/50">' +
                                        '<div class="text-[10px] text-indigo-300 font-bold mb-1">👨‍⚕️ เลือกแพทย์ (สูงสุด 3 คน):</div>' +
                                        '<div class="flex flex-wrap gap-1 mb-2 max-h-20 overflow-y-auto">' +
                                        availableMedics.map(m => {
                                            const isSelected = tempAssignedMedics.includes(m);
                                            return '<button onclick="toggleTempMedic(\'' + m + '\')" class="text-[9px] px-2 py-0.5 rounded ' +
                                                (isSelected ? 'bg-indigo-500 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600') + '">' +
                                                (isSelected ? '✓ ' : '') + m + '</button>';
                                        }).join('') +
                                        '</div>' +
                                        '<div class="flex gap-1">' +
                                        '<button onclick="confirmAssignMedic()" class="text-[10px] bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-0.5 rounded font-medium">✅ ยืนยัน</button>' +
                                        '<button onclick="cancelAssignMedic()" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-white px-2 py-0.5 rounded">❌ ยกเลิก</button>' +
                                        '</div>' +
                                        '</div>';
                                }

                                const medicsDisplay = c.medics.length > 0
                                    ? c.medics.map(m => '<span class="text-[10px] bg-amber-900/50 text-amber-300 px-1.5 py-0.5 rounded">' + m + '</span>').join('')
                                    : '<span class="text-[10px] text-slate-500 italic">ยังไม่มีแพทย์</span>';

                                html += '<div class="bg-slate-800/80 rounded-lg overflow-hidden border border-slate-700/50 flex flex-col">' +
                                    '<div class="px-3 py-1.5 bg-gradient-to-r from-indigo-900/40 to-transparent flex justify-between items-center flex-wrap gap-1">' +
                                    '<span class="text-[10px] font-bold text-indigo-300 bg-indigo-500/20 px-2 py-0.5 rounded">สตอรี่ #' + (localIdx + 1) + '</span>' + closedBadge + playingBadge + pendingBadge + noInjectionBadge +
                                    '<span class="text-[10px] text-slate-400">🕐 ' + (c.startTime || '--:--') + '</span>' +
                                    '</div>' +
                                    '<div class="px-3 py-2 flex-1 flex flex-col">' +
                                    '<div class="text-center text-sm font-bold text-white mb-2">' + partyADisplay + ' <span class="text-rose-400">VS</span> ' + partyBDisplay + '</div>' +
                                    '<div class="grid grid-cols-3 gap-2 text-[10px] text-center mb-2">' +
                                    '<div><div class="text-slate-500">📍 สถานที่</div><div class="text-slate-300">' + (c.location || '-') + '</div></div>' +
                                    '<div><div class="text-slate-500">📻 วิทยุ</div><div class="text-slate-300">' + (c.radio || '-') + '</div></div>' +
                                    '<div><div class="text-slate-500">⚖️ สภาผู้ดูแล</div><div class="text-slate-300">' + (c.council || '-') + '</div></div>' +
                                    '</div>' +
                                    assignMedicUI +
                                    '<div class="flex items-center gap-1.5 flex-wrap mb-2">' +
                                    '<span class="text-[10px] text-slate-500">👨‍⚕️ แพทย์:</span>' + medicsDisplay +
                                    (isOP && !isAssigning ? '<button onclick="showAssignMedicMenu(\'' + c.id + '\')" class="text-[9px] bg-indigo-600 hover:bg-indigo-500 text-white px-1.5 py-0.5 rounded ml-1">+ Assign</button>' : '') +
                                    '</div>' +
                                    '<div class="flex gap-1.5 pt-2 border-t border-slate-700/30 mt-auto">' +
                                    (canCopy ? '<button onclick="copyAnnounce(\'cooldown\',\'' + c.partyA + '\',\'' + c.partyB + '\')" class="text-[10px] bg-cyan-700/60 hover:bg-cyan-600 text-white px-2.5 py-1 rounded transition">📋 คูลดาวน์</button>' +
                                        '<button onclick="copyAnnounce(\'enter\',\'' + c.partyA + '\',\'' + c.partyB + '\')" class="text-[10px] bg-purple-700/60 hover:bg-purple-600 text-white px-2.5 py-1 rounded transition">📋 เข้าพื้นที่</button>' : '') +
                                    '<div class="flex-1"></div>' +
                                    (isOP ? '<button onclick="editCase(\'' + c.id + '\')" class="text-[10px] bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded" title="แก้ไข">✏️</button>' +
                                        '<button onclick="showRescheduleModal(\'' + c.id + '\')" class="text-[10px] bg-amber-700 hover:bg-amber-600 text-white px-2 py-1 rounded" title="เลื่อนเวลา">📅</button>' +
                                        '<button onclick="closeCase(\'' + c.id + '\')" class="text-[10px] bg-emerald-600 hover:bg-emerald-500 text-white px-2 py-1 rounded" title="ปิดเคส">✅</button>' : '') +
                                    '</div>' +
                                    '</div>' +
                                    '</div>';
                            }
                        });

                        html += '</div></div>';
                    });

                    caseList.innerHTML = html;
                }

                const hc = appData.closedCases?.length || 0; document.getElementById('history-count').textContent = '(' + hc + ')';
                document.getElementById('history-list').innerHTML = (appData.closedCases || []).map((c, i) => '<div class="bg-slate-800/50 rounded p-2 text-xs"><div class="flex justify-between"><span class="text-slate-300">' + c.partyA + ' vs ' + c.partyB + ' <span class="text-slate-500">📍' + c.location + '</span></span><button onclick="deleteHistory(' + i + ')" class="text-red-400 hover:text-red-300">🗑️</button></div><div class="text-slate-500 mt-1">' + (c.medics?.join(', ') || '-') + '</div></div>').join('') || '<p class="text-xs text-slate-500 text-center py-2">ไม่มีประวัติ</p>';
            }

            function editCase(id) { editingCaseId = id; renderAll(); }
            function cancelEdit() { editingCaseId = null; renderAll(); }
            function saveEdit(id) { const idx = appData.cases.findIndex(c => c.id === id); if (idx === -1) return; appData.cases[idx].partyA = document.getElementById(`edit-pA-${id}`).value; appData.cases[idx].partyB = document.getElementById(`edit-pB-${id}`).value; appData.cases[idx].location = document.getElementById(`edit-loc-${id}`).value; appData.cases[idx].radio = document.getElementById(`edit-rad-${id}`).value; appData.cases[idx].council = document.getElementById(`edit-cou-${id}`).value; appData.cases[idx].storyDate = document.getElementById(`edit-date-${id}`).value; editingCaseId = null; saveOpData(); showNotif('Success', 'แก้ไขเรียบร้อย'); }
            function toggleHistory() { showingHistory = !showingHistory; document.getElementById('history-section').classList.toggle('hidden', !showingHistory); }
            async function deleteHistory(idx) { const c = await showConfirm('ยืนยันลบ', 'ลบสตอรี่จากประวัติ?'); if (!c) return; if (appData.closedCases?.[idx]) { appData.closedCases.splice(idx, 1); saveOpData(); showNotif('Success', 'ลบเรียบร้อย'); } }

            // Reschedule Story Functions
            let reschedulingCaseId = null;
            function showRescheduleModal(id) {
                const c = appData.cases.find(x => x.id === id);
                if (!c) return showNotif('Error', 'ไม่พบสตอรี่');
                reschedulingCaseId = id;

                // Show story info
                document.getElementById('reschedule-story-info').innerHTML = `
                <div class="font-bold text-white mb-1">${c.partyA} VS ${c.partyB}</div>
                <div class="text-slate-400">📅 วันที่เดิม: ${c.storyDate || '-'} | 🕐 เวลาเดิม: ${c.startTime || '-'}</div>
            `;

                // Pre-fill current values
                document.getElementById('reschedule-date').value = c.storyDate || '';
                document.getElementById('reschedule-time').value = c.startTime || '';

                document.getElementById('reschedule-modal').classList.remove('hidden');
            }

            function closeRescheduleModal() {
                reschedulingCaseId = null;
                document.getElementById('reschedule-modal').classList.add('hidden');
            }

            function confirmReschedule() {
                if (!reschedulingCaseId) return;
                const idx = appData.cases.findIndex(c => c.id === reschedulingCaseId);
                if (idx === -1) return showNotif('Error', 'ไม่พบสตอรี่');

                const newDate = document.getElementById('reschedule-date').value;
                const newTime = document.getElementById('reschedule-time').value;

                if (!newDate || !newTime) {
                    return showNotif('Error', 'กรุณาระบุวันที่และเวลา');
                }

                const oldDate = appData.cases[idx].storyDate;
                const oldTime = appData.cases[idx].startTime;

                // Update story
                appData.cases[idx].storyDate = newDate;
                appData.cases[idx].startTime = newTime;
                appData.cases[idx].pendingStart = isTimeInFuture(newTime, newDate);

                // Sort cases by start time
                appData.cases.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));

                addOpLog('เลื่อนสตอรี่', `${appData.cases[idx].partyA} vs ${appData.cases[idx].partyB}: ${oldDate} ${oldTime} → ${newDate} ${newTime}`);

                closeRescheduleModal();
                saveOpData();
                showNotif('Success', '📅 เลื่อนสตอรี่เรียบร้อย');
            }

            // OP Control Panel Rendering
            function renderOPControl() {
                const statusEl = document.getElementById('op-status-display');
                const btnsEl = document.getElementById('op-control-buttons');
                const pendingEl = document.getElementById('op-pending-requests');
                const handoverEl = document.getElementById('op-handover-countdown');
                const hasOP = appData.currentOP;
                const isActualOP = currentUser?.fullName === appData.currentOP;
                const iAmOP = isCurrentOPorSupOP(); // For viewing panel
                const canControlShift = isActualOP; // Only actual OP can random/start/end

                // Status Display
                if (hasOP) {
                    const opUser = allUsers.find(u => u.fullName === appData.currentOP);
                    const isUnregisteredOP = !opUser;
                    const opPhone = opUser?.icPhone || '';
                    const themeHex = (serverSettings.themeColor || '#06b6d4').replace('#', '');
                    const opFirstName = appData.currentOP.split(' ')[0];
                    const opAvatar = opUser?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(opFirstName)}&background=${isUnregisteredOP ? 'f59e0b' : themeHex}&color=fff&size=80`;
                    const warningBadge = isUnregisteredOP ? `<span class="text-[9px] bg-amber-600 text-white px-1.5 py-0.5 rounded ml-1" title="ผู้ใช้นี้ไม่ได้ลงทะเบียนในระบบ">⚠️</span>` : '';
                    const shiftTimerHTML = `<span class="ml-2 px-2 py-0.5 bg-slate-800/50 rounded text-[10px] font-mono text-cyan-400" id="op-shift-timer">00:00:00</span>`;
                    statusEl.innerHTML = `<div class="text-sm font-bold text-white truncate flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full ${isUnregisteredOP ? 'bg-amber-500' : 'bg-emerald-500'} animate-pulse"></div><span>${opFirstName}${warningBadge}</span>${shiftTimerHTML}<img src="${opAvatar}" onclick="showImagePreview('${opAvatar}', '${opFirstName}')" class="w-12 h-12 rounded-lg object-cover ml-auto cursor-pointer hover:ring-2 hover:ring-cyan-400 transition" onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(opFirstName)}&background=${themeHex}&color=fff&size=80'"></div>${isUnregisteredOP ? `<div class="text-[10px] text-amber-400 ml-3.5">⚠️ ไม่ได้ลงทะเบียน</div><button onclick="forceEndUnregisteredOP()" class="mt-1 w-full bg-rose-600/80 hover:bg-rose-600 text-white text-[10px] font-medium py-1 rounded transition">🚫 บังคับปิดกะ</button>` : (opPhone ? `<div class="text-[10px] text-slate-400 ml-3.5">📞 ${opPhone}</div>` : '')}`;
                } else {
                    statusEl.innerHTML = `<div class="text-sm text-slate-400 flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span>ยังไม่มี OP</div>`;
                }

                // Control Buttons (softer colors)
                let btnsHTML = '';

                // Guest mode - view only, no control buttons
                if (isGuest()) {
                    btnsHTML = `<div class="text-center py-2">
                    <div class="text-[10px] text-slate-500 bg-slate-800/50 rounded-lg px-3 py-2">
                        <span class="text-lg">👁️</span><br>
                        <span class="font-medium">โหมด Guest</span><br>
                        <span class="text-slate-600">ดูได้อย่างเดียว</span>
                    </div>
                </div>`;
                } else if (!hasOP) {
                    // No OP - show "เข้ากะ" button
                    btnsHTML = `<button onclick="becomeOP()" class="w-full bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold py-2 rounded-lg shadow-sm transition">🎯 เข้ากะ (เป็น OP)</button>`;
                } else if (canControlShift) {
                    // Current user is actual OP - full control
                    btnsHTML = `<div class="space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                    <button onclick="handOverOP()" class="bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold py-2 rounded-lg transition">🔄 ส่งต่อ OP</button>
                    ${appData.shiftStart ? `<button onclick="endShift()" class="bg-slate-700 hover:bg-rose-600/80 text-slate-300 hover:text-white text-xs font-bold py-2 rounded-lg transition">⏹️ จบกะ</button>` : `<button onclick="startShift()" class="bg-slate-700 hover:bg-emerald-600/80 text-slate-300 hover:text-white text-xs font-bold py-2 rounded-lg transition">▶ เริ่มกะ</button>`}
                    </div>
                    ${!appData.shiftStart ? `<button onclick="exitShift()" class="w-full bg-rose-900/50 hover:bg-rose-700 text-rose-300 hover:text-white text-xs font-medium py-1.5 rounded-lg transition">🚪 ออกกะ</button>` : ''}
                </div>`;
                } else if (iAmOP) {
                    // Sup OP - can view, use panel, and request OP
                    btnsHTML = `<div class="space-y-1">
                    <div class="text-[10px] text-cyan-400 text-center py-0.5 bg-cyan-900/30 rounded">🛡️ Sup OP Mode</div>
                    <button onclick="showRequestOPModal()" class="w-full bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold py-1.5 rounded-lg transition">📋 Request เป็น OP</button>
                </div>`;
                } else {
                    // Not OP - show Request button
                    btnsHTML = `<button onclick="showRequestOPModal()" class="w-full bg-slate-600 hover:bg-slate-500 text-white text-xs font-bold py-2 rounded-lg shadow-sm transition">📋 Request เป็น OP ถัดไป</button>`;
                }
                btnsEl.innerHTML = btnsHTML;

                // Pending Requests (only for actual OP)
                if (isActualOP && appData.opPendingRequests?.length > 0) {
                    pendingEl.classList.remove('hidden');
                    document.getElementById('op-pending-list').innerHTML = appData.opPendingRequests.map((r, i) => `
                    <div class="bg-slate-800/50 rounded-lg p-2 flex justify-between items-center border border-slate-700/50">
                        <div><span class="text-white text-xs font-bold">${r.requester}</span><span class="text-slate-400 text-[10px] ml-2">เวลา ${r.wantedTime}</span></div>
                        <div class="flex gap-1">
                            <button onclick="showApproveModal(${i})" class="px-2 py-1 bg-slate-600 hover:bg-emerald-600/80 text-white text-[10px] rounded">✅</button>
                            <button onclick="rejectOPRequest(${i})" class="px-2 py-1 bg-slate-600 hover:bg-rose-600/80 text-white text-[10px] rounded">❌</button>
                        </div>
                    </div>
                `).join('');
                } else { pendingEl.classList.add('hidden'); }

                // Handover Countdown
                if (appData.opHandoverAt) {
                    handoverEl.classList.remove('hidden');
                    const targetTimeStr = appData.opHandoverTargetTime ? new Date(appData.opHandoverTargetTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
                    const nextOPName = (appData.handoverNextOP || '-').split(' ')[0]; // Show only first name
                    document.getElementById('handover-next-op').innerHTML = `<span class="text-xs text-slate-400">OP ถัดไป:</span> <span class="text-white">${nextOPName}</span>`;
                } else { handoverEl.classList.add('hidden'); }
            }

            // Become OP (when no one is OP)
            async function becomeOP() { if (!currentUser) return; appData.currentOP = currentUser.fullName; const saved = await saveOpData(); if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; } showNotif('Success', 'คุณเป็น OP แล้ว! กด "เริ่มกะ" เพื่อเริ่มนับเวลา'); addNotification(`${currentUser.fullName} เป็น OP แล้ว`, 'info'); renderOPControl(); }

            // Force end shift when OP is not registered in the system
            async function forceEndUnregisteredOP() {
                const prevOP = appData.currentOP;
                const confirmed = await showConfirm('⚠️ ผู้ใช้ไม่ได้ลงทะเบียน', `"${prevOP}" ไม่ได้ลงทะเบียนในระบบ OP ต้องการรีเซ็ตและเริ่มใหม่หรือไม่?`);
                if (!confirmed) return;
                appData.currentOP = null;
                appData.shiftStart = null;
                appData.supOP = null;
                const saved = await saveOpData();
                if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; }
                addOpLog('รีเซ็ต OP (ไม่ลงทะเบียน)', `OP เดิม: ${prevOP}`);
                showNotif('Success', 'รีเซ็ต OP เรียบร้อย');
                renderOPControl();
            }

            // Exit OP shift before starting (cancel becoming OP)
            async function exitShift() {
                if (!currentUser || currentUser.fullName !== appData.currentOP) return;
                if (appData.shiftStart) return showNotif('Error', 'กะเริ่มแล้ว ใช้ "จบกะ" แทน');
                const c = await showConfirm('ออกกะ', 'ออกกะโดยไม่เริ่มนับเวลา? (จะเคลียร์รายชื่อทั้งหมด)');
                if (!c) return;
                appData.currentOP = null;
                appData.supOP = null;
                appData.onDuty = [];
                appData.offDuty = [];
                appData.afk = [];
                appData.afkTimes = {};
                const saved = await saveOpData();
                if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; }
                renderAll();
                showNotif('Success', 'ออกกะเรียบร้อย');
                addNotification(`${currentUser.fullName} ออกกะ`, 'info');
                renderOPControl();
            }

            // Random OP from On Duty + AFK + Medics in stories (BACKUP - kept for future use)
            function randomOP_BACKUP() {
                // Collect candidates: On Duty + AFK + Medics in active cases
                let candidates = [...(appData.onDuty || []), ...(appData.afk || [])];
                (appData.cases || []).forEach(c => { if (c.medics) candidates = candidates.concat(c.medics); });
                candidates = [...new Set(candidates)]; // Remove duplicates
                if (candidates.length === 0) return showNotif('Error', 'ไม่มีแพทย์ใน On Duty / AFK / สตอรี่');
                // Pick random candidate
                const chosenName = candidates[Math.floor(Math.random() * candidates.length)];
                // Try to find registered user, if not found use the name directly
                const user = allUsers.find(u => u.firstName === chosenName.split(' ')[0]);
                appData.currentOP = user ? user.fullName : chosenName;
                saveOpData();
                const displayName = (user?.fullName || chosenName).split(' ')[0];
                showNotif('Success', `สุ่ม OP ใหม่: ${displayName}`);
                addNotification(`สุ่ม OP ใหม่: ${displayName}`, 'info');
            }

            // Hand Over OP to Sup OP
            async function handOverOP() {
                // Check if there's a Sup OP
                if (!appData.supOP) {
                    return showNotif('Error', '❌ ต้องมี Sup OP ก่อนจึงจะส่งต่อได้');
                }

                // Confirm action
                const confirmed = await showConfirm('🔄 ส่งต่อ OP', `ส่งต่อหน้าที่ OP ให้ "${appData.supOP}" หรือไม่?\n\n• คุณจะถูกย้ายไปหน้า Summary\n• คุณจะถูกย้ายไป Off Duty`);
                if (!confirmed) return;

                const prevOP = appData.currentOP;
                const prevSupOP = appData.supOP;
                const shiftDuration = appData.shiftStart ? Date.now() - appData.shiftStart : 0;

                // Collect AFK warnings for summary
                const afkWarnings = {};
                if (appData.afkTimes) {
                    Object.entries(appData.afkTimes).forEach(([name, start]) => {
                        const mins = Math.floor((Date.now() - start) / 60000);
                        if (mins >= 5) afkWarnings[name] = mins;
                    });
                }

                // Store summary data for old OP
                lastShiftSummaryData = {
                    op: prevOP,
                    supOP: prevSupOP,
                    onDuty: [...(appData.onDuty || [])],
                    offDuty: [...(appData.offDuty || [])],
                    closedCases: [...(appData.closedCases || [])],
                    afkWarnings,
                    duration: shiftDuration,
                    startTime: appData.shiftStart,
                    endTime: new Date()
                };

                // Get old OP's first name for moving to On Duty
                const prevOPFirstName = prevOP ? prevOP.split(' ')[0] : null;

                // Update OP data:
                // 1. New OP is the previous Sup OP
                // 2. Clear Sup OP
                // 3. Move old OP to On Duty (not Off Duty)
                // 4. Keep On Duty, AFK, stories intact
                // 5. Reset shift timer for new OP

                appData.currentOP = prevSupOP;

                // Move previous Sup OP's first name to On Duty (since they are now OP, they're not in the Sup OP position anymore)
                // But since Sup OP becoming OP, we don't add to OnDuty - they ARE the OP now
                // Note: Sup OP was removed from OnDuty when selected, no action needed here

                appData.supOP = null;
                appData.shiftStart = Date.now(); // Reset timer for new OP

                // Add old OP to On Duty (not Off Duty)
                if (prevOPFirstName && !appData.onDuty.includes(prevOPFirstName)) {
                    appData.onDuty.push(prevOPFirstName);
                }

                // Clear closed cases for new session
                appData.closedCases = [];

                // Clear pending requests
                appData.opPendingRequests = [];
                appData.opHandoverAt = null;
                appData.handoverNextOP = null;

                const saved = await saveOpData();
                if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; }
                addOpLog('ส่งต่อ OP', `${prevOP} → ${prevSupOP}`);

                // Show summary to old OP
                if (currentUser?.fullName === prevOP) {
                    showShiftSummary();
                }

                applyRoleRestrictions();
                renderAllDebounced();

                showNotif('Success', `🔄 ส่งต่อ OP สำเร็จ! ${prevOP?.split(' ')[0] || '-'} → ${prevSupOP?.split(' ')[0] || '-'}`);
                addNotification(`🔄 ส่งต่อ OP: ${prevOP || '-'} → ${prevSupOP}`, 'info');
            }

            // Request OP Modal
            function showRequestOPModal() { if (!appData.currentOP) return showNotif('Error', 'ยังไม่มี OP ในระบบ'); document.getElementById('request-op-time').value = ''; document.getElementById('request-op-modal').classList.remove('hidden'); }
            function closeRequestOPModal() { document.getElementById('request-op-modal').classList.add('hidden'); }
            function submitOPRequest() { if (!currentUser) return; const time = document.getElementById('request-op-time').value; if (!time) return showNotif('Error', 'กรุณาเลือกเวลา'); if (!appData.opPendingRequests) appData.opPendingRequests = []; appData.opPendingRequests.push({ requester: currentUser.fullName, requestTime: Date.now(), wantedTime: time }); saveOpData(); closeRequestOPModal(); showNotif('Success', 'ส่ง Request เรียบร้อย รอ OP ยืนยัน'); addNotification(`📋 มี Request ใหม่จาก ${currentUser.fullName} เวลา ${time}`, 'info'); }

            // Approve/Reject Modal
            let currentApproveIdx = null;
            function showApproveModal(idx) { currentApproveIdx = idx; const req = appData.opPendingRequests?.[idx]; if (!req) return; document.getElementById('approve-requester-name').textContent = req.requester; document.getElementById('approve-wanted-time').textContent = req.wantedTime; document.getElementById('op-approve-modal').classList.remove('hidden'); }
            function closeApproveModal() { document.getElementById('op-approve-modal').classList.add('hidden'); currentApproveIdx = null; }
            function approveOPRequest() { if (currentApproveIdx === null) return; const req = appData.opPendingRequests?.[currentApproveIdx]; if (!req) return; const [h, m] = req.wantedTime.split(':').map(Number); const now = new Date(); const targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0); if (targetTime.getTime() < now.getTime()) targetTime.setDate(targetTime.getDate() + 1); const countdownMins = serverSettings.countdownMinutes || 30; appData.handoverNextOP = req.requester; appData.opHandoverTargetTime = targetTime.getTime(); appData.opHandoverAt = targetTime.getTime() - countdownMins * 60 * 1000; appData.opPendingRequests = []; saveOpData(); closeApproveModal(); showNotif('Success', `ยืนยันแล้ว! ${req.requester} จะเป็น OP เวลา ${req.wantedTime}`); addNotification(`✅ ยืนยัน Request: ${req.requester} จะเป็น OP เวลา ${req.wantedTime}`, 'success'); }
            function rejectOPRequest(idx) { if (!appData.opPendingRequests?.[idx]) return; const name = appData.opPendingRequests[idx].requester; appData.opPendingRequests.splice(idx, 1); saveOpData(); showNotif('Success', 'ปฏิเสธ Request เรียบร้อย'); addNotification(`❌ ปฏิเสธ Request จาก ${name}`, 'warning'); }

            // Perform Handover - shows summary for old OP and adds old OP to On Duty
            async function performHandover() { if (!appData.handoverNextOP) return; const prevOP = appData.currentOP; const prevSupOP = appData.supOP; const shiftDuration = appData.shiftStart ? Date.now() - appData.shiftStart : 0; const afkWarnings = {}; if (appData.afkTimes) { Object.entries(appData.afkTimes).forEach(([name, start]) => { const mins = Math.floor((Date.now() - start) / 60000); if (mins >= 5) afkWarnings[name] = mins; }); } lastShiftSummaryData = { op: prevOP, supOP: prevSupOP, onDuty: [...(appData.onDuty || [])], offDuty: [...(appData.offDuty || [])], closedCases: [...(appData.closedCases || [])], afkWarnings, duration: shiftDuration, startTime: appData.shiftStart, endTime: new Date() }; addOpLog('Handover', `${prevOP} → ${appData.handoverNextOP}`); const prevOPFirstName = prevOP ? prevOP.split(' ')[0] : null; const prevSupOPFirstName = prevSupOP ? prevSupOP.split(' ')[0] : null; const newOPFirstName = appData.handoverNextOP.split(' ')[0]; let newOnDuty = [...(appData.onDuty || [])]; let newOffDuty = [...(appData.offDuty || [])]; if (prevOPFirstName && !newOnDuty.includes(prevOPFirstName)) newOnDuty.push(prevOPFirstName); if (prevSupOPFirstName && !newOnDuty.includes(prevSupOPFirstName)) newOnDuty.push(prevSupOPFirstName); const newOPIdx = newOnDuty.indexOf(newOPFirstName); if (newOPIdx > -1) newOnDuty.splice(newOPIdx, 1); appData = { shiftStart: Date.now(), currentOP: appData.handoverNextOP, supOP: null, onDuty: newOnDuty, offDuty: newOffDuty, afk: appData.afk || [], afkTimes: appData.afkTimes || {}, cases: appData.cases || [], closedCases: [], medicStatuses: appData.medicStatuses || {}, opPendingRequests: [], opHandoverAt: null, handoverNextOP: null }; const saved = await saveOpData(); if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; } if (currentUser?.fullName === prevOP) showShiftSummary(); applyRoleRestrictions(); renderAllDebounced(); showNotif('Success', `Handover สำเร็จ! ${prevOP || 'ไม่มี'} → ${appData.currentOP}`); addNotification(`🔄 Handover: ${prevOP || '-'} → ${appData.currentOP}`, 'info'); }

            async function startShift() { if (!appData.currentOP) return showNotif('Error', 'กรุณากด "เข้ากะ" ก่อน'); appData.shiftStart = Date.now(); const saved = await saveOpData(); if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; } addOpLog('เริ่มกะ', `OP: ${appData.currentOP}`); showNotif('Success', 'เริ่มกะเรียบร้อย'); addNotification(`▶ เริ่มกะโดย ${appData.currentOP}`, 'success'); renderOPControl(); }
            let lastShiftSummaryData = null;
            async function endShift() {
                // UMAE check remains
                if (appData.umae?.cases?.length > 0) return showNotif('Error', 'กรุณาช่วยเหลือหรือปล่อยเคสอุ้มเอ๋อก่อนจบกะ');
                const c = await showConfirm('ยืนยันจบกะ', 'ต้องการจบกะ?');
                if (!c) return;
                const prevOP = appData.currentOP;
                const shiftDuration = appData.shiftStart ? Date.now() - appData.shiftStart : 0;
                const afkWarnings = {};
                if (appData.afkTimes) { Object.entries(appData.afkTimes).forEach(([name, start]) => { const mins = Math.floor((Date.now() - start) / 60000); if (mins >= 5) afkWarnings[name] = mins; }); }
                lastShiftSummaryData = { op: prevOP, supOP: appData.supOP, onDuty: [...(appData.onDuty || [])], offDuty: [...(appData.offDuty || [])], closedCases: [...(appData.closedCases || [])], afkWarnings, duration: shiftDuration, startTime: appData.shiftStart, endTime: new Date(), umaeHelped: appData.umae?.helped?.length || 0, umaeExpired: appData.umae?.expired?.length || 0 };
                showShiftSummary();
                addOpLog('จบกะ', `OP: ${prevOP}`);
                // New logic: If any story is still active (not closed), keep ALL stories. If all closed, delete closed stories.
                const activeStories = (appData.cases || []).filter(cs => !cs.closed && !isTimeInFuture(cs.startTime, cs.storyDate) && !cs.pendingStart);
                const hasActiveStories = activeStories.length > 0;
                const preservedCases = (appData.cases || []).filter(cs => {
                    // Always keep pending/future stories
                    if (isTimeInFuture(cs.startTime, cs.storyDate) || cs.pendingStart) return true;
                    // If there are active stories, keep ALL (including closed for Discord bot)
                    if (hasActiveStories) return true;
                    // If all stories are closed, only keep pending/future (already checked above)
                    return !cs.closed;
                });
                appData = { shiftStart: null, currentOP: null, supOP: null, onDuty: [], offDuty: [], afk: [], afkTimes: {}, cases: preservedCases, closedCases: [], medicStatuses: {}, opPendingRequests: [], opHandoverAt: null, handoverNextOP: null, umae: { cases: [], expired: [], helped: [] } };
                const saved = await saveOpData();
                if (!saved) { showNotif('Error', '❌ บันทึกไม่สำเร็จ'); return; }
                renderAll();
                addNotification(`⏹️ จบกะโดย ${prevOP}`, 'info');
                renderOPControl();
            }


            // Server Restart UI countdown support (for timer display)
            let restartWarned30 = false;
            let restartWarned15 = false;
            let restartWarned10 = false;
            let restartWarned5 = false;
            let restartWarned2 = false;
            let restartEndedForSession = false;

            function getNextRestartTime() {
                const restartTimes = (serverSettings.restartTimes || []).filter(t => t && typeof t === 'string');
                if (restartTimes.length === 0) return Date.now() + 999999999; // Far future if no restart times

                const now = new Date();
                const todayRestarts = restartTimes.map(t => {
                    if (!t || typeof t !== 'string') return 0;
                    const [h, m] = t.split(':').map(Number);
                    const d = new Date(now);
                    d.setHours(h, m, 0, 0);
                    return d.getTime();
                }).filter(t => t > now.getTime());

                if (todayRestarts.length === 0 && restartTimes[0]) {
                    const [h, m] = restartTimes[0].split(':').map(Number);
                    const tomorrow = new Date(now);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(h, m, 0, 0);
                    return tomorrow.getTime();
                }

                return todayRestarts.length > 0 ? Math.min(...todayRestarts) : Date.now() + 999999999;
            }

            // Auto-end shift at restart time (called from UI countdown timer)
            function autoEndShiftForRestart() {
                if (restartEndedForSession) return;
                if (!appData.currentOP) return;

                restartEndedForSession = true;
                const prevOP = appData.currentOP;
                const prevSupOP = appData.supOP;
                const shiftDuration = appData.shiftStart ? Date.now() - appData.shiftStart : 0;

                const afkWarnings = {};
                if (appData.afkTimes) {
                    Object.entries(appData.afkTimes).forEach(([name, start]) => {
                        const mins = Math.floor((Date.now() - start) / 60000);
                        if (mins >= 5) afkWarnings[name] = mins;
                    });
                }

                // Auto-close started stories
                const startedCases = (appData.cases || []).filter(c => !isTimeInFuture(c.startTime, c.storyDate) && !c.pendingStart);
                if (startedCases.length > 0) {
                    if (!appData.closedCases) appData.closedCases = [];
                    startedCases.forEach(sc => {
                        appData.closedCases.push({ ...sc, closedAt: Date.now(), forceClosed: true });
                    });
                }

                // Create summary data
                lastShiftSummaryData = {
                    op: prevOP,
                    supOP: prevSupOP,
                    onDuty: [...(appData.onDuty || [])],
                    offDuty: [...(appData.offDuty || [])],
                    closedCases: [...(appData.closedCases || [])],
                    afkWarnings,
                    duration: shiftDuration,
                    startTime: appData.shiftStart,
                    endTime: new Date(),
                    umaeHelped: appData.umae?.helped?.length || 0,
                    umaeExpired: appData.umae?.expired?.length || 0,
                    autoRestart: true
                };

                // Show notification and summary IMMEDIATELY (before any async operations)
                showNotif('Warning', '🔄 Server Restart - กะถูกจบโดยอัตโนมัติ');
                addNotification(`🔄 Server Restart - จบกะโดยอัตโนมัติ (OP: ${prevOP})`, 'warning');
                if (currentUser?.fullName === prevOP) {
                    showShiftSummary();
                }

                // Then reset data and save (async)
                addOpLog('จบกะ (Server Restart)', `OP: ${prevOP}`);
                // New logic: If any story is still active (not closed), keep ALL stories. If all closed, delete closed stories.
                const activeStories = (appData.cases || []).filter(cs => !cs.closed && !isTimeInFuture(cs.startTime, cs.storyDate) && !cs.pendingStart);
                const hasActiveStories = activeStories.length > 0;
                const preservedCases = (appData.cases || []).filter(cs => {
                    if (isTimeInFuture(cs.startTime, cs.storyDate) || cs.pendingStart) return true;
                    if (hasActiveStories) return true;
                    return !cs.closed;
                });
                appData = { shiftStart: null, currentOP: null, supOP: null, onDuty: [], offDuty: [], afk: [], afkTimes: {}, cases: preservedCases, closedCases: [], medicStatuses: {}, opPendingRequests: [], opHandoverAt: null, handoverNextOP: null, umae: { cases: [], expired: [], helped: [] } };
                saveOpData();
                renderAll();
                renderOPControl();
            }

            function showShiftSummary() { const data = lastShiftSummaryData; if (!data) return; const dur = data.duration; const h = Math.floor(dur / 3600000), m = Math.floor((dur % 3600000) / 60000); const durStr = `${h}ชม. ${m}นาที`; const startTime = data.startTime ? new Date(data.startTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '-'; const endTime = data.endTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }); let html = `${data.autoRestart ? '<div class="bg-amber-900/50 rounded-lg p-2 mb-3 border border-amber-500/30 text-center"><span class="text-amber-400 font-bold">🔄 จบกะอัตโนมัติเนื่องจาก Server Restart</span></div>' : ''}<div class="bg-slate-800/50 rounded-lg p-3"><p class="font-medium text-cyan-400 mb-2">📊 สรุปภาพรวม OP</p><p>📅 วันที่: <span class="text-white">${data.endTime.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' })}</span></p><p>👨‍⚕️ OP: <span class="text-white">${data.op || '-'}</span></p><p>👨‍⚕️ Support OP: <span class="text-white">${data.supOP || '-'}</span></p><p>⏰ เวลา: <span class="text-white">${startTime} - ${endTime} (${durStr})</span></p></div>`; html += `<div class="bg-emerald-900/30 rounded-lg p-3 border border-emerald-500/20"><p class="font-medium text-emerald-400 mb-2">✅ On Duty (${data.onDuty.length} คน)</p>${data.onDuty.length ? '<div class="space-y-0.5">' + data.onDuty.map(n => `<p class="text-white text-xs">- ${n}</p>`).join('') + '</div>' : '<p class="text-slate-500 text-xs">ไม่มี</p>'}</div>`; html += `<div class="bg-slate-800/50 rounded-lg p-3"><p class="font-medium text-rose-400 mb-2">❌ Off Duty (${data.offDuty.length} คน)</p>${data.offDuty.length ? '<div class="space-y-0.5">' + data.offDuty.map(n => `<p class="text-white text-xs">- ${n}</p>`).join('') + '</div>' : '<p class="text-slate-500 text-xs">ไม่มี</p>'}</div>`; if (data.afkWarnings && Object.keys(data.afkWarnings).length) { html += `<div class="bg-amber-900/30 rounded-lg p-3 border border-amber-500/20"><p class="font-medium text-amber-400 mb-2">⚠️ คนที่โดน Warning</p><div class="space-y-0.5">${Object.entries(data.afkWarnings).map(([name, mins]) => `<p class="text-white text-xs">- ${name} (เหม่อ ${mins} นาที)</p>`).join('')}</div></div>`; } if (data.closedCases?.length) { html += `<div class="bg-indigo-900/30 rounded-lg p-3 border border-indigo-500/20"><p class="font-medium text-indigo-400 mb-2">⚔️ สตอรี่ (${data.closedCases.length} เคส)</p>${data.closedCases.map((cs, i) => `<div class="bg-slate-800/50 p-2 rounded mb-2"><p class="text-white text-xs font-medium">สตอรี่ #${i + 1} ระหว่าง ${cs.partyA} VS ${cs.partyB}</p><p class="text-slate-400 text-[10px]">แพทย์ผู้รับผิดชอบ : ${cs.medics?.[0] || '-'}</p>${cs.medics?.length > 1 ? `<p class="text-slate-400 text-[10px]">แพทย์ช่วยเหลือ : ${cs.medics.slice(1).join(' , ')}</p>` : ''}</div>`).join('')}</div>`; } if (data.umaeHelped > 0 || data.umaeExpired > 0) { html += `<div class="bg-purple-900/30 rounded-lg p-3 border border-purple-500/20"><p class="font-medium text-purple-400 mb-2">💀 อุ้มเอ๋อ</p><p class="text-white text-xs">✅ ช่วยเหลือได้: <span class="text-emerald-400 font-bold">${data.umaeHelped}</span> เบอร์</p><p class="text-white text-xs">💀 เอ๋อ: <span class="text-rose-400 font-bold">${data.umaeExpired}</span> เบอร์</p></div>`; } document.getElementById('shift-summary-content').innerHTML = html; document.getElementById('shift-summary-modal').classList.remove('hidden'); saveShiftHistory(data); }
            function closeShiftSummary() { document.getElementById('shift-summary-modal').classList.add('hidden'); }

            // Shift History - Store up to 3 summaries, auto-delete after 24h
            function saveShiftHistory(summaryData) {
                if (!currentUser || !summaryData) return;
                const key = `shift_history_${currentUser.id || currentUser.fullName}`;
                let history = JSON.parse(localStorage.getItem(key) || '[]');

                // Check if this summary was already saved to history (has savedAt from localStorage)
                // If it has savedAt, it means it's being viewed from history, not a new summary
                const isFromHistory = summaryData.savedAt && summaryData.savedAt > 0;

                // Add timestamp for expiration and convert Date to ISO string
                const entry = {
                    ...summaryData,
                    savedAt: Date.now(),
                    endTime: summaryData.endTime instanceof Date ? summaryData.endTime.toISOString() : summaryData.endTime
                };

                // Remove entries older than 24 hours
                const now = Date.now();
                history = history.filter(h => (now - h.savedAt) < 24 * 60 * 60 * 1000);

                // Add new entry at the beginning (only if not already in history)
                if (!isFromHistory) {
                    history.unshift(entry);
                }

                // Keep only last 3 entries
                history = history.slice(0, 3);

                localStorage.setItem(key, JSON.stringify(history));

                // Only save to Firestore for Discord bot if this is a NEW summary (not from viewing history)
                if (!isFromHistory) {
                    saveShiftSummaryToFirestore(summaryData);
                }
            }

            // Save shift summary to Firestore for Discord bot
            async function saveShiftSummaryToFirestore(summaryData) {
                try {
                    const now = new Date();
                    const startTime = summaryData.startTime ? new Date(summaryData.startTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' }) : '-';
                    const endTime = summaryData.endTime instanceof Date ? summaryData.endTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Bangkok' }) : '-';
                    const dur = summaryData.duration || 0;
                    const h = Math.floor(dur / 3600000), m = Math.floor((dur % 3600000) / 60000);
                    const durStr = `${h}ชม. ${m}นาที`;

                    await db.collection('shift_summaries').add({
                        type: 'end_shift',
                        op: summaryData.op || '-',
                        supOP: summaryData.supOP || '-',
                        startTime: startTime,
                        endTime: endTime,
                        duration: durStr,
                        onDuty: (summaryData.onDuty || []).map(name => ({ name })),
                        offDuty: (summaryData.offDuty || []).map(name => ({ name })),
                        stories: summaryData.closedCases || [],
                        postedToDiscord: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('✅ Shift summary saved to Firestore for Discord');
                } catch (e) {
                    console.error('❌ Failed to save shift summary to Firestore:', e);
                }
            }

            function getShiftHistory() {
                if (!currentUser) return [];
                const key = `shift_history_${currentUser.id || currentUser.fullName}`;
                let history = JSON.parse(localStorage.getItem(key) || '[]');

                // Remove entries older than 24 hours
                const now = Date.now();
                history = history.filter(h => (now - h.savedAt) < 24 * 60 * 60 * 1000);

                // Save cleaned history back
                localStorage.setItem(key, JSON.stringify(history));

                return history;
            }

            function showShiftHistoryFromIndex(idx) {
                const history = getShiftHistory();
                if (!history[idx]) return;

                const data = history[idx];
                data.endTime = new Date(data.endTime); // Convert back to Date object
                lastShiftSummaryData = data;
                showShiftSummary();
            }

            function renderShiftHistoryInProfile() {
                const container = document.getElementById('profile-shift-history');
                if (!container) return;

                const history = getShiftHistory();
                if (history.length === 0) {
                    container.innerHTML = '<p class="text-slate-500 text-xs text-center py-2">ไม่มีประวัติกะ</p>';
                    return;
                }

                container.innerHTML = history.map((h, i) => {
                    const endTime = new Date(h.endTime);
                    const dateStr = endTime.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
                    const timeStr = endTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                    const dur = h.duration || 0;
                    const hours = Math.floor(dur / 3600000);
                    const mins = Math.floor((dur % 3600000) / 60000);

                    return `<div onclick="showShiftHistoryFromIndex(${i})" class="bg-slate-700/50 hover:bg-slate-600/50 rounded-lg p-2 cursor-pointer transition border border-slate-600/50">
                    <div class="flex justify-between items-center">
                        <span class="text-cyan-400 font-medium text-xs">📊 กะที่ ${i + 1}</span>
                        <span class="text-slate-400 text-[10px]">${dateStr} ${timeStr}</span>
                    </div>
                    <div class="text-slate-300 text-[10px] mt-1">⏱️ ${hours}ชม. ${mins}นาที • On Duty: ${h.onDuty?.length || 0} คน</div>
                </div>`;
                }).join('');
            }
            function showHowToModal() { document.getElementById('how-to-modal').classList.remove('hidden'); }
            function closeHowToModal() { document.getElementById('how-to-modal').classList.add('hidden'); }
            // Helper to get Discord mention or fallback to name
            function getDiscordMentionOrName(name) {
                // Find user by firstName or fullName
                const user = (allUsers || []).find(u =>
                    u.firstName === name ||
                    u.fullName === name ||
                    u.fullName?.split(' ')[0] === name
                );
                if (user?.discordId) {
                    return `<@${user.discordId}>`;
                }
                return name;
            }
            function copyShiftSummary() {
                const data = lastShiftSummaryData;
                if (!data) return;
                const dur = data.duration;
                const h = Math.floor(dur / 3600000), m = Math.floor((dur % 3600000) / 60000);
                const durStr = `${h}ชม. ${m}นาที`;
                const startTime = data.startTime ? new Date(data.startTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) : '-';
                const endTime = data.endTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const dateStr = data.endTime.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
                // Use Discord mentions for OP and Support OP
                const opMention = data.op ? getDiscordMentionOrName(data.op) : '-';
                const supOpMention = data.supOP ? getDiscordMentionOrName(data.supOP) : '-';
                let text = `📊 สรุปการเข้าเวร OP\n━━━━━━━━━━━━━━━━━━━━\n📅 วันที่: ${dateStr}\n👨‍⚕️ OP: ${opMention}\n👨‍⚕️ Support OP: ${supOpMention}\n⏰ เวลา: ${startTime} - ${endTime} (${durStr})\n━━━━━━━━━━━━━━━━━━━━\n✅ On Duty (${data.onDuty.length} คน):\n${data.onDuty.length ? data.onDuty.map(n => `- ${n}`).join('\n') : '- ไม่มี'}\n━━━━━━━━━━━━━━━━━━━━\n❌ Off Duty (${data.offDuty.length} คน):\n${data.offDuty.length ? data.offDuty.map(n => `- ${n}`).join('\n') : '- ไม่มี'}`;
                if (data.afkWarnings && Object.keys(data.afkWarnings).length) {
                    text += `\n━━━━━━━━━━━━━━━━━━━━\n⚠️ คนที่โดน Warning:\n${Object.entries(data.afkWarnings).map(([name, mins]) => `- ${name} (เหม่อ ${mins} นาที)`).join('\n')}`;
                }
                if (data.closedCases?.length) {
                    text += `\n━━━━━━━━━━━━━━━━━━━━\n⚔️ สตอรี่ (${data.closedCases.length} เคส):\n${data.closedCases.map((cs, i) => {
                        const mainMedic = cs.medics?.[0] ? getDiscordMentionOrName(cs.medics[0]) : '-';
                        let storyText = `สตอรี่ #${i + 1} ระหว่าง ${cs.partyA} VS ${cs.partyB}\nแพทย์ผู้รับผิดชอบ : ${mainMedic}`;
                        if (cs.medics?.length > 1) storyText += `\nแพทย์ช่วยเหลือ : ${cs.medics.slice(1).map(m => getDiscordMentionOrName(m)).join(' , ')}`;
                        return storyText;
                    }).join('\n\n')}`;
                }
                if (data.umaeHelped > 0 || data.umaeExpired > 0) {
                    text += `\n━━━━━━━━━━━━━━━━━━━━\n💀 อุ้มเอ๋อ:\n- ช่วยเหลือได้: ${data.umaeHelped} เบอร์\n- เอ๋อ: ${data.umaeExpired} เบอร์`;
                }
                navigator.clipboard.writeText(text);
                showNotif('Success', 'คัดลอกสรุปกะแล้ว');
            }
            // Levenshtein distance for fuzzy name matching
            function levenshteinDistance(a, b) {
                const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
                for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
                for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
                for (let j = 1; j <= b.length; j++) {
                    for (let i = 1; i <= a.length; i++) {
                        const cost = a[i - 1].toLowerCase() === b[j - 1].toLowerCase() ? 0 : 1;
                        matrix[j][i] = Math.min(
                            matrix[j][i - 1] + 1,
                            matrix[j - 1][i] + 1,
                            matrix[j - 1][i - 1] + cost
                        );
                    }
                }
                return matrix[b.length][a.length];
            }

            // Find similar names from registered users (returns array for autocomplete)
            function findSimilarNames(inputName) {
                if (!inputName || inputName.length < 2) return [];
                const registeredNames = (allUsers || []).map(u => u.firstName || u.fullName?.split(' ')[0]).filter(Boolean);
                const inputLower = inputName.toLowerCase();
                const results = [];

                for (const name of registeredNames) {
                    const nameLower = name.toLowerCase();
                    // Exact match (case-insensitive)
                    if (nameLower === inputLower) {
                        results.unshift({ name, type: 'exact', distance: 0 });
                        continue;
                    }
                    // Starts with input
                    if (nameLower.startsWith(inputLower)) {
                        results.push({ name, type: 'prefix', distance: 0 });
                        continue;
                    }
                    // Fuzzy match (Levenshtein distance ≤ 2)
                    const distance = levenshteinDistance(inputName, name);
                    if (distance <= 2) {
                        results.push({ name, type: 'similar', distance });
                    }
                }

                // Sort: exact first, then prefix, then by distance
                return results.sort((a, b) => {
                    if (a.type === 'exact') return -1;
                    if (b.type === 'exact') return 1;
                    if (a.type === 'prefix' && b.type !== 'prefix') return -1;
                    if (b.type === 'prefix' && a.type !== 'prefix') return 1;
                    return a.distance - b.distance;
                }).slice(0, 5); // Max 5 suggestions
            }

            // Autocomplete state
            let autocompleteSelectedIndex = -1;
            let autocompleteItems = [];

            // Setup autocomplete for manual add input
            function setupManualAddAutocomplete() {
                const input = document.getElementById('manual-add-name');
                if (!input) return;

                // Create dropdown container if not exists
                let dropdown = document.getElementById('manual-add-autocomplete');
                if (!dropdown) {
                    dropdown = document.createElement('div');
                    dropdown.id = 'manual-add-autocomplete';
                    dropdown.className = 'absolute z-50 w-full bg-slate-800 border border-slate-600 rounded-lg shadow-xl max-h-40 overflow-y-auto hidden';
                    dropdown.style.top = '100%';
                    dropdown.style.left = '0';
                    input.parentElement.style.position = 'relative';
                    input.parentElement.appendChild(dropdown);
                }

                // Input event - show suggestions
                input.addEventListener('input', () => {
                    const value = input.value.trim();
                    autocompleteItems = findSimilarNames(value);
                    autocompleteSelectedIndex = -1;
                    renderAutocomplete(dropdown);
                });

                // Keyboard navigation
                input.addEventListener('keydown', (e) => {
                    if (autocompleteItems.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        autocompleteSelectedIndex = Math.min(autocompleteSelectedIndex + 1, autocompleteItems.length - 1);
                        renderAutocomplete(dropdown);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        autocompleteSelectedIndex = Math.max(autocompleteSelectedIndex - 1, -1);
                        renderAutocomplete(dropdown);
                    } else if (e.key === 'Enter') {
                        if (autocompleteSelectedIndex >= 0) {
                            e.preventDefault();
                            selectAutocompleteItem(autocompleteItems[autocompleteSelectedIndex].name);
                        }
                    } else if (e.key === 'Escape') {
                        hideAutocomplete(dropdown);
                    }
                });

                // Hide on blur (with delay to allow click)
                input.addEventListener('blur', () => {
                    setTimeout(() => hideAutocomplete(dropdown), 200);
                });
            }

            function renderAutocomplete(dropdown) {
                if (autocompleteItems.length === 0) {
                    dropdown.classList.add('hidden');
                    return;
                }

                dropdown.classList.remove('hidden');
                dropdown.innerHTML = autocompleteItems.map((item, i) => {
                    const isSelected = i === autocompleteSelectedIndex;
                    const bgClass = isSelected ? 'bg-cyan-600' : 'hover:bg-slate-700';
                    const typeIcon = item.type === 'exact' ? '✓' : item.type === 'prefix' ? '→' : '~';
                    return `
                    <div class="px-3 py-2 cursor-pointer text-sm ${bgClass} text-white flex items-center gap-2"
                         onmousedown="selectAutocompleteItem('${escapeHtml(item.name)}')"
                         onmouseenter="autocompleteSelectedIndex=${i}; renderAutocomplete(document.getElementById('manual-add-autocomplete'))">
                        <span class="text-xs text-slate-400">${typeIcon}</span>
                        <span>${escapeHtml(item.name)}</span>
                    </div>
                `;
                }).join('');
            }

            function hideAutocomplete(dropdown) {
                if (dropdown) dropdown.classList.add('hidden');
                autocompleteItems = [];
                autocompleteSelectedIndex = -1;
            }

            function selectAutocompleteItem(name) {
                const input = document.getElementById('manual-add-name');
                if (input) {
                    input.value = name;
                    hideAutocomplete(document.getElementById('manual-add-autocomplete'));
                }
            }

            function addManualMedic() {
                const input = document.getElementById('manual-add-name');
                const inputName = input.value.trim();
                if (!inputName) return;

                // Check for exact case-insensitive match and auto-correct silently
                const registeredNames = (allUsers || []).map(u => u.firstName || u.fullName?.split(' ')[0]).filter(Boolean);
                const exactMatch = registeredNames.find(n => n.toLowerCase() === inputName.toLowerCase());
                const nameToAdd = exactMatch || inputName;

                // Remove from all lists first to prevent duplicates
                removeFromAllLists(nameToAdd);
                appData.onDuty.push(nameToAdd);
                input.value = '';
                hideAutocomplete(document.getElementById('manual-add-autocomplete'));
                saveOpData();
            }

            // Initialize autocomplete after page loads
            setTimeout(setupManualAddAutocomplete, 1000);

            // Helper: Remove name from all lists (prevents duplicates)
            function removeFromAllLists(name) {
                ['onDuty', 'offDuty', 'afk'].forEach(list => {
                    if (!appData[list]) appData[list] = [];
                    const idx = appData[list].indexOf(name);
                    if (idx > -1) appData[list].splice(idx, 1);
                });
                // Also clean up related data
                delete appData.afkTimes?.[name];
                delete appData.afkPositions?.[name];
            }

            function moveMedic(name, from, to) {
                if (!appData.afkPositions) appData.afkPositions = {};
                if (!appData.afkTimes) appData.afkTimes = {};

                // FIXED: Save CURRENT position in onDuty BEFORE removing
                const currentOnDutyIndex = (appData.onDuty || []).indexOf(name);

                // Preserve AFK time and position if coming from AFK
                const savedAfkTime = appData.afkTimes?.[name];
                const savedAfkPos = appData.afkPositions?.[name];

                // Remove from ALL lists first to prevent duplicates
                removeFromAllLists(name);

                if (to === 'afk') {
                    // Going TO AFK - save the CURRENT position from onDuty
                    appData.afkTimes[name] = Date.now();
                    // Use current onDuty index, not old afkPos
                    appData.afkPositions[name] = currentOnDutyIndex !== -1 ? currentOnDutyIndex : 0;
                    appData.afk.push(name);
                    saveOpData();
                    return;
                } else if (from === 'afk' && to === 'onDuty') {
                    // Returning FROM AFK to onDuty - restore to saved position
                    const restorePos = savedAfkPos !== undefined ? Math.min(savedAfkPos, appData.onDuty.length) : 0;
                    appData.onDuty.splice(restorePos, 0, name);
                    // Clean up AFK data
                    delete appData.afkTimes?.[name];
                    delete appData.afkPositions?.[name];
                    saveOpData();
                    return;
                }

                if (to === 'offDuty') {
                    delete appData.afkWarnings?.[name];
                    delete appData.afkWarnedTimes?.[name];
                }
                if (!appData[to]) appData[to] = [];
                appData[to].push(name);
                saveOpData();
            }
            function removeMedic(name) { removeFromAllLists(name); delete appData.medicStatuses?.[name]; saveOpData(); }

            // Helper to check if a time string (HH:MM) is in the future (with optional date)
            function isTimeInFuture(timeStr, dateStr) {
                if (!timeStr) return false;
                const now = new Date();
                const [hours, minutes] = timeStr.split(':').map(Number);
                let targetTime;
                if (dateStr) {
                    // Use the provided date
                    targetTime = new Date(dateStr);
                    targetTime.setHours(hours, minutes, 0, 0);
                } else {
                    // Use today's date
                    targetTime = new Date();
                    targetTime.setHours(hours, minutes, 0, 0);
                }
                return targetTime > now;
            }

            // Convert time string to minutes for sorting
            function timeToMinutes(timeStr) {
                if (!timeStr) return 9999;
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            }

            function createOpCase() {
                const pA = document.getElementById('case-party-a').value.trim(),
                    pB = document.getElementById('case-party-b').value.trim(),
                    time = document.getElementById('case-time').value,
                    storyDate = document.getElementById('case-date').value;
                if (!time || !pA || !pB) return showNotif('Error', 'กรุณากรอกข้อมูลให้ครบ (เวลา, คู่กรณี)');
                const pendingStart = isTimeInFuture(time, storyDate);

                if (!appData.cases) appData.cases = [];
                appData.cases.push({
                    id: Date.now().toString(),
                    partyA: pA,
                    partyB: pB,
                    location: 'ยังไม่ระบุ',
                    radio: '',
                    council: '',
                    medics: [], // Empty, will be assigned via Assign Medic
                    startTime: time,
                    storyDate: storyDate,
                    timestamp: Date.now(),
                    pendingStart: pendingStart
                });
                // Sort cases by start time
                appData.cases.sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
                addOpLog('สร้างสตอรี่', `${pA} vs ${pB}`);
                ['case-party-a', 'case-party-b', 'case-time', 'case-date'].forEach(id => document.getElementById(id).value = '');
                saveOpData();
                showNotif('Success', 'สร้างสตอรี่เรียบร้อย (กด ✏️ เพื่อแก้ไขรายละเอียด)');
            }

            // Assign medic to a case
            let assigningCaseId = null;
            let tempAssignedMedics = [];

            function showAssignMedicMenu(caseId) {
                assigningCaseId = caseId;
                const c = appData.cases.find(x => x.id === caseId);
                tempAssignedMedics = [...(c?.medics || [])];
                renderAll();
            }

            function cancelAssignMedic() {
                assigningCaseId = null;
                tempAssignedMedics = [];
                renderAll();
            }

            function toggleTempMedic(name) {
                const idx = tempAssignedMedics.indexOf(name);
                if (idx > -1) {
                    tempAssignedMedics.splice(idx, 1);
                } else if (tempAssignedMedics.length < 3) {
                    tempAssignedMedics.push(name);
                } else {
                    showNotif('Warning', 'สูงสุด 3 คน');
                }
                renderAll();
            }

            function confirmAssignMedic() {
                const c = appData.cases.find(x => x.id === assigningCaseId);
                if (!c) return;

                // Return old medics to onDuty if story started
                if (!c.pendingStart) {
                    c.medics.forEach(m => {
                        if (!appData.onDuty.includes(m) && !tempAssignedMedics.includes(m)) {
                            appData.onDuty.push(m);
                        }
                    });
                }

                // Set new medics
                c.medics = [...tempAssignedMedics];

                // Remove new medics from onDuty if story started
                if (!c.pendingStart) {
                    c.medics.forEach(m => {
                        const idx = appData.onDuty.indexOf(m);
                        if (idx > -1) appData.onDuty.splice(idx, 1);
                    });
                }

                assigningCaseId = null;
                tempAssignedMedics = [];
                saveOpData();
                showNotif('Success', 'บันทึกแพทย์เรียบร้อย');
            }

            // Check pending start cases and move medics out of onDuty 10 minutes before start time
            function isTimeWithin10Minutes(timeStr, dateStr) {
                if (!timeStr) return false;
                const now = new Date();
                const [hours, minutes] = timeStr.split(':').map(Number);
                let targetTime;
                if (dateStr) {
                    targetTime = new Date(dateStr);
                    targetTime.setHours(hours, minutes, 0, 0);
                } else {
                    targetTime = new Date();
                    targetTime.setHours(hours, minutes, 0, 0);
                }
                const tenMinutesBefore = new Date(targetTime.getTime() - 10 * 60 * 1000);
                return now >= tenMinutesBefore && now < targetTime;
            }
            function checkCasePendingStart() {
                if (!appData.cases?.length) return;
                let needsSave = false;
                appData.cases.forEach(c => {
                    if (c.pendingStart && (isTimeWithin10Minutes(c.startTime, c.storyDate) || !isTimeInFuture(c.startTime, c.storyDate))) {
                        // 10 minutes before start time or start time reached, move medics out of onDuty/AFK
                        c.medics.forEach(m => {
                            // First check if medic is in AFK - move to OnDuty first
                            const afkIdx = appData.afk?.indexOf(m);
                            if (afkIdx > -1) {
                                appData.afk.splice(afkIdx, 1);
                                delete appData.afkTimes?.[m];
                                delete appData.afkPositions?.[m];
                                // Medic is now considered as moved from AFK to Story directly
                            }
                            // Then remove from onDuty (whether they were already there or just moved from AFK)
                            const idx = appData.onDuty.indexOf(m);
                            if (idx > -1) appData.onDuty.splice(idx, 1);
                        });
                        c.pendingStart = false;
                        needsSave = true;
                        if (c.medics.length > 0) {
                            showNotif('Info', `⏰ สตอรี่ ${c.partyA} vs ${c.partyB} - แพทย์ออกจาก On Duty/AFK (10 นาทีก่อนเริ่ม)`);
                        }
                    }
                });
                if (needsSave) saveOpData();
            }

            // Check every 30 seconds for pending start cases
            setInterval(checkCasePendingStart, 30000);

            async function closeCase(id) {
                const c = await showConfirm('ยืนยันปิดเคส', 'ปิดเคสและนำแพทย์กลับ?'); if (!c) return; const idx = appData.cases.findIndex(x => x.id === id); if (idx > -1) {
                    const cs = appData.cases[idx];
                    // Mark as closed instead of removing (so it shows "Clear" label)
                    cs.closed = true;
                    cs.closedAt = Date.now();
                    // Also add to closedCases for summary
                    if (!appData.closedCases) appData.closedCases = [];
                    appData.closedCases.push({ ...cs });
                    // Return medics to onDuty
                    cs.medics.forEach(m => { if (!appData.onDuty.includes(m)) appData.onDuty.push(m); });
                    // NOTE: Don't splice - keep story in cases array with closed=true
                    saveOpData();
                    showNotif('Success', 'ปิดเคสเรียบร้อย');
                }
            }

            function copyPhoneNotFound() { const cmd = getAnnounceCmd(); const phone = document.getElementById('phone-input-1').value.trim(); if (!phone) return showNotif('Error', 'กรุณากรอกเบอร์โทร'); const msg = `${cmd} คนไข้เบอร์ ${phone} หมอไม่พบร่างรบกวนเข้าห้องติดต่อหมอในนิตยสารประเทศ ขอบคุณครับ/ค่ะ`; navigator.clipboard.writeText(msg); document.getElementById('phone-input-1').value = ''; showNotif('Success', 'คัดลอกแล้ว'); }
            function copyPhoneUnreachable() { const cmd = getAnnounceCmd(); const phone = document.getElementById('phone-input-1').value.trim(); if (!phone) return showNotif('Error', 'กรุณากรอกเบอร์โทร'); const msg = `${cmd} คนไข้เบอร์ ${phone} หมอไม่สามารถเข้าถึงพื้นที่ได้ รบกวนเข้าห้องติดต่อหมอในนิตยสารประเทศ ขอบคุณครับ/ค่ะ`; navigator.clipboard.writeText(msg); document.getElementById('phone-input-1').value = ''; showNotif('Success', 'คัดลอกแล้ว'); }
            function copyAnnounce(type, pA, pB) { const cmd = getAnnounceCmd(); let msg = ''; if (type === 'cooldown') { const now = new Date(), later = new Date(now.getTime() + 10 * 60 * 1000); msg = `${cmd} ประกาศคูลดาวน์สตอรี่ ระหว่าง ${pA} vs ${pB} เป็นเวลา 10 นาที ตั้งแต่เวลา ${now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} - ${later.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} น. หรือหากพร้อม สามารถเริ่มได้ทันที`; } else { msg = `${cmd} แพทย์กำลังเข้าพื้นที่สตอรี่ ${pA} vs ${pB} ขอให้แก๊งที่ชนะ ออกจากพื้นที่และหยุดการกระทำทุกอย่างภายใน 2 นาที ขออภัยในความไม่สะดวก`; } navigator.clipboard.writeText(msg); showNotif('Success', 'คัดลอกแล้ว'); }

            let handoverWarned5 = false, handoverWarned1 = false;
            let prevPendingStates = {}; // Track previous pending states for auto-refresh
            setInterval(() => {
                const now = Date.now();

                // Check if any story has transitioned from pending to started
                if (appData.cases?.length) {
                    let needsRefresh = false;
                    appData.cases.forEach(c => {
                        const currentlyPending = isTimeInFuture(c.startTime, c.storyDate);
                        const prevPending = prevPendingStates[c.id];
                        // If was pending before and now is not pending -> needs refresh
                        if (prevPending === true && !currentlyPending) {
                            needsRefresh = true;
                        }
                        prevPendingStates[c.id] = currentlyPending;
                    });
                    // Clean up old entries for removed cases
                    const caseIds = new Set(appData.cases.map(c => c.id));
                    Object.keys(prevPendingStates).forEach(id => {
                        if (!caseIds.has(id)) delete prevPendingStates[id];
                    });
                    if (needsRefresh) renderAllDebounced();
                }
                if (appData.shiftStart) { const d = now - appData.shiftStart; const timerEl = document.getElementById('op-shift-timer'); if (timerEl) timerEl.textContent = `${String(Math.floor(d / 3600000)).padStart(2, '0')}:${String(Math.floor((d % 3600000) / 60000)).padStart(2, '0')}:${String(Math.floor((d % 60000) / 1000)).padStart(2, '0')}`; } else { const timerEl = document.getElementById('op-shift-timer'); if (timerEl) timerEl.textContent = '00:00:00'; }
                document.querySelectorAll('.afk-timer').forEach(el => { const start = parseInt(el.dataset.start); if (start) { const d = now - start; el.textContent = ` ${String(Math.floor(d / 60000)).padStart(2, '0')}:${String(Math.floor((d % 60000) / 1000)).padStart(2, '0')}`; } });
                // Handover countdown
                if (appData.handoverNextOP && appData.opHandoverTargetTime) {
                    const targetRemaining = appData.opHandoverTargetTime - now;
                    const countdownStart = appData.opHandoverAt || (appData.opHandoverTargetTime - (serverSettings.countdownMinutes || 30) * 60 * 1000);
                    const shouldShowCountdown = now >= countdownStart;
                    if (targetRemaining <= 0) { performHandover(); handoverWarned5 = false; handoverWarned1 = false; }
                    else if (shouldShowCountdown) {
                        const mins = Math.floor(targetRemaining / 60000), secs = Math.floor((targetRemaining % 60000) / 1000);
                        document.getElementById('handover-timer').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                        // Show warnings to both OP and Sup OP
                        if (currentUser?.fullName === appData.currentOP || currentUser?.fullName === appData.supOP) {
                            if (targetRemaining <= 5 * 60 * 1000 && !handoverWarned5) { handoverWarned5 = true; showNotif('Warning', 'เหลือเวลา 5 นาที ก่อนเปลี่ยน OP!'); addNotification('เหลือเวลา 5 นาที ก่อนเปลี่ยน OP!', 'warning'); }
                            if (targetRemaining <= 1 * 60 * 1000 && !handoverWarned1) { handoverWarned1 = true; showNotif('Warning', 'เหลือเวลา 1 นาที!'); addNotification('เหลือเวลา 1 นาที!', 'warning'); }
                        }
                    } else {
                        const targetTimeStr = new Date(appData.opHandoverTargetTime).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
                        document.getElementById('handover-timer').textContent = `เริ่ม ${targetTimeStr}`;
                    }
                } else { handoverWarned5 = false; handoverWarned1 = false; document.getElementById('handover-timer').textContent = ''; }

                // Server Restart countdown (30 minutes before restart)
                if (appData.currentOP) {
                    const nextRestart = getNextRestartTime();
                    const restartRemaining = nextRestart - now;
                    const RESTART_COUNTDOWN_START = 30 * 60 * 1000; // 30 minutes
                    const handoverCountdownEl = document.getElementById('op-handover-countdown');
                    const handoverTimerEl = document.getElementById('handover-timer');
                    const handoverLabelEl = document.getElementById('handover-next-op');

                    // Only show restart countdown if NOT showing handover countdown
                    const isHandoverActive = appData.handoverNextOP && appData.opHandoverTargetTime && (appData.opHandoverTargetTime - now) > 0 && now >= (appData.opHandoverAt || (appData.opHandoverTargetTime - 30 * 60 * 1000));

                    if (!isHandoverActive && restartRemaining <= RESTART_COUNTDOWN_START && restartRemaining > 0) {
                        // Show restart countdown
                        if (handoverCountdownEl) handoverCountdownEl.classList.remove('hidden');
                        handoverCountdownEl.style.background = 'rgba(239, 68, 68, 0.3)'; // Red tint
                        handoverCountdownEl.style.borderColor = 'rgba(239, 68, 68, 0.5)';

                        const mins = Math.floor(restartRemaining / 60000);
                        const secs = Math.floor((restartRemaining % 60000) / 1000);
                        if (handoverTimerEl) {
                            handoverTimerEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                            handoverTimerEl.style.color = '#f87171'; // Red color
                        }

                        // Update label
                        const handoverLabel = handoverCountdownEl.querySelector('.text-amber-400');
                        if (handoverLabel) {
                            handoverLabel.textContent = '🔄 Server Restart ใน';
                            handoverLabel.classList.remove('text-amber-400');
                            handoverLabel.classList.add('text-rose-400');
                        }
                        if (handoverLabelEl) handoverLabelEl.textContent = 'กะจะถูกจบโดยอัตโนมัติ';

                        // Show warnings at: 30 (start countdown), 15, 10, 5, 2 minutes
                        if (!restartWarned30) {
                            restartWarned30 = true;
                            showNotif('Warning', '🔄 Server Restart ใน 30 นาที - เริ่มนับถอยหลัง');
                            addNotification('🔄 Server Restart ใน 30 นาที - เริ่มนับถอยหลัง', 'warning');
                        }
                        if (restartRemaining <= 15 * 60 * 1000 && !restartWarned15) {
                            restartWarned15 = true;
                            showNotif('Warning', '🔄 เหลือเวลา 15 นาที ก่อน Server Restart!');
                            addNotification('🔄 เหลือเวลา 15 นาที ก่อน Server Restart!', 'warning');
                        }
                        if (restartRemaining <= 10 * 60 * 1000 && !restartWarned10) {
                            restartWarned10 = true;
                            showNotif('Warning', '🔄 เหลือเวลา 10 นาที ก่อน Server Restart!');
                            addNotification('🔄 เหลือเวลา 10 นาที ก่อน Server Restart!', 'warning');
                        }
                        if (restartRemaining <= 5 * 60 * 1000 && !restartWarned5) {
                            restartWarned5 = true;
                            showNotif('Warning', '🔄 เหลือเวลา 5 นาที! กะจะถูกจบโดยอัตโนมัติ');
                            addNotification('🔄 เหลือเวลา 5 นาที ก่อน Server Restart!', 'warning');
                        }
                        if (restartRemaining <= 2 * 60 * 1000 && !restartWarned2) {
                            restartWarned2 = true;
                            showNotif('Warning', '🔄 เหลือเวลา 2 นาที!! เตรียมปิดสตอรี่ที่กำลังดำเนินอยู่!');
                            addNotification('🔄 เหลือเวลา 2 นาที - ปิดสตอรี่ที่กำลังดำเนินอยู่!', 'warning');
                        }
                    } else if (!isHandoverActive && restartRemaining <= 0 && restartRemaining > -60000) {
                        // Restart time reached - auto end shift
                        autoEndShiftForRestart();
                        // Reset warnings for next restart cycle
                        setTimeout(() => {
                            restartWarned30 = false;
                            restartWarned15 = false;
                            restartWarned10 = false;
                            restartWarned5 = false;
                            restartWarned2 = false;
                            restartEndedForSession = false;
                        }, 65000); // Reset after 65 seconds
                    } else if (!isHandoverActive) {
                        // Not in countdown zone - reset styling
                        if (handoverCountdownEl && !appData.handoverNextOP) {
                            handoverCountdownEl.classList.add('hidden');
                            handoverCountdownEl.style.background = '';
                            handoverCountdownEl.style.borderColor = '';
                        }
                        if (handoverTimerEl) handoverTimerEl.style.color = '';
                        const handoverLabel = handoverCountdownEl?.querySelector('.text-rose-400');
                        if (handoverLabel) {
                            handoverLabel.classList.remove('text-rose-400');
                            handoverLabel.classList.add('text-amber-400');
                        }
                    }
                }
            }, 1000);

            async function initApp() {
                // Initialize Electron title bar (if in Electron)
                const isElectron = window.electronEnv?.isElectron || window.isElectronApp;
                if (isElectron) {
                    const titleBar = document.getElementById('electron-title-bar');
                    if (titleBar) {
                        titleBar.classList.remove('hidden');
                        document.body.classList.add('has-title-bar');
                    }
                    // Setup window control buttons
                    document.getElementById('btn-minimize')?.addEventListener('click', () => {
                        window.windowControls?.minimize();
                    });
                    document.getElementById('btn-maximize')?.addEventListener('click', () => {
                        window.windowControls?.maximize();
                    });
                    document.getElementById('btn-close')?.addEventListener('click', () => {
                        window.windowControls?.close();
                    });
                }

                // Load version from Firebase and display on login page
                try {
                    const versionDoc = await db.collection('settings').doc('appVersion').get();
                    if (versionDoc.exists && versionDoc.data().version) {
                        const firestoreVersion = versionDoc.data().version;
                        const loginVersionEl = document.getElementById('login-version-display');
                        if (loginVersionEl) loginVersionEl.textContent = 'v.' + firestoreVersion;
                    }
                } catch (e) { console.log('Version load error:', e); }

                // Check for Electron login data from query params
                const urlParams = new URLSearchParams(window.location.search);
                const userDataParam = urlParams.get('userData');
                if (userDataParam) {
                    try {
                        const userData = JSON.parse(decodeURIComponent(userDataParam));
                        if (userData && userData.username) {
                            currentUser = userData;
                            sessionStorage.setItem('op_session_current', JSON.stringify(currentUser));
                            loginSuccess(true); // Show welcome animation
                            ensureAdminAccount();
                            return;
                        }
                    } catch (e) { console.log('Parse user data error:', e); }
                }

                const ss = sessionStorage.getItem('op_session_current');
                if (ss) { try { currentUser = JSON.parse(ss); loginSuccess(false); ensureAdminAccount(); return; } catch (e) { } }
                const ls = localStorage.getItem('op_session');
                if (ls) { try { const sess = JSON.parse(ls); if (sess.expiry > Date.now()) { currentUser = sess.user; sessionStorage.setItem('op_session_current', JSON.stringify(currentUser)); loginSuccess(false); ensureAdminAccount(); return; } } catch (e) { } localStorage.removeItem('op_session'); }
                document.getElementById('auth-container').classList.remove('hidden');
                ensureAdminAccount();
            }
            async function ensureAdminAccount() { try { const doc = await db.collection('op_users').doc('admin').get(); if (!doc.exists) await db.collection('op_users').doc('admin').set({ password: '123456', firstName: 'Admin', lastName: 'System', fullName: 'Admin System', avatar: '', workStatus: 'ทำงาน', role: 'Owner', createdAt: Date.now() }); } catch (e) { } }
            document.addEventListener('DOMContentLoaded', initApp);
            document.getElementById('op-sup-select').addEventListener('change', e => {
                const supName = e.target.value;
                const supFirstName = supName ? supName.split(' ')[0] : '';
                appData.supOP = supName;
                if (supFirstName) {
                    const idx = appData.onDuty?.indexOf(supFirstName);
                    if (idx > -1) appData.onDuty.splice(idx, 1);
                    const offIdx = appData.offDuty?.indexOf(supFirstName);
                    if (offIdx > -1) appData.offDuty.splice(offIdx, 1);
                }
                updateSupOPDisplay();
                saveOpData();
            });

            function updateSupOPDisplay() {
                const display = document.getElementById('sup-op-display');
                const nameEl = document.getElementById('sup-op-name');
                const select = document.getElementById('op-sup-select');
                if (appData.supOP) {
                    const firstName = appData.supOP.split(' ')[0];
                    if (nameEl) nameEl.textContent = firstName;
                    if (display) display.classList.remove('hidden');
                    if (select) select.classList.add('hidden');
                } else {
                    if (display) display.classList.add('hidden');
                    if (select) select.classList.remove('hidden');
                }
            }

            function removeSupOP() {
                if (!appData.supOP) return;
                const supFirstName = appData.supOP.split(' ')[0];
                // Move Sup OP to On Duty
                if (supFirstName && !appData.onDuty?.includes(supFirstName)) {
                    if (!appData.onDuty) appData.onDuty = [];
                    appData.onDuty.push(supFirstName);
                }
                appData.supOP = null;
                document.getElementById('op-sup-select').value = '';
                updateSupOPDisplay();
                saveOpData();
                showNotif('Success', `ลบ Sup OP แล้ว - ${supFirstName} ย้ายไป On Duty`);
            }

            // Image Preview Modal Functions
            function showImagePreview(imgSrc, name) {
                const modal = document.getElementById('image-preview-modal');
                const img = document.getElementById('preview-image-src');
                const nameEl = document.getElementById('preview-image-name');
                img.src = imgSrc;
                nameEl.textContent = name || '';
                modal.classList.remove('hidden');
            }
            function closeImagePreview() {
                document.getElementById('image-preview-modal').classList.add('hidden');
            }



            // Refresh Music Player UI - Fix button styling issues
            function refreshMusicPlayerUI() {
                const container = document.getElementById('music-player-container');
                if (container) {
                    // Force re-render by temporarily hiding and showing
                    container.style.display = 'none';
                    setTimeout(() => {
                        container.style.display = '';
                        // Re-apply inline styles to make sure buttons render correctly
                        const playBtn = document.getElementById('music-play-btn');
                        if (playBtn) {
                            playBtn.style.background = 'linear-gradient(135deg, #ec4899 0%, #a855f7 100%)';
                            playBtn.style.width = '28px';
                            playBtn.style.height = '28px';
                            playBtn.style.borderRadius = '50%';
                            playBtn.style.display = 'flex';
                            playBtn.style.alignItems = 'center';
                            playBtn.style.justifyContent = 'center';
                        }
                        showNotif('Success', '🔄 Refresh Music Player สำเร็จ');
                    }, 100);
                }
            }

            // --- Discord OAuth2 Link Functions ---
            const DISCORD_AUTH_URL = 'https://us-central1-medic-op.cloudfunctions.net/discordAuth';

            function linkDiscordOAuth() {
                if (!currentUser?.username) {
                    showNotif('Error', '❌ กรุณาเข้าสู่ระบบก่อน');
                    return;
                }

                // Open Discord OAuth popup
                const authUrl = `${DISCORD_AUTH_URL}?userId=${encodeURIComponent(currentUser.username)}`;
                const popup = window.open(authUrl, 'Discord Link', 'width=500,height=700');

                // Listen for popup close
                const checkPopup = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkPopup);
                        // Refresh user data to check if discord was linked
                        setTimeout(() => refreshDiscordLinkStatus(), 1000);
                    }
                }, 500);
            }

            async function refreshDiscordLinkStatus() {
                if (!currentUser?.username) return;

                try {
                    const userDoc = await db.collection('op_users').doc(currentUser.username).get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        if (data.discordId && data.discordUsername) {
                            // Update currentUser with Discord info
                            currentUser.discordId = data.discordId;
                            currentUser.discordUsername = data.discordUsername;
                            currentUser.discordAvatar = data.discordAvatar || '';

                            // Re-render profile modal if open
                            const profileModal = document.getElementById('profile-modal');
                            if (profileModal && !profileModal.classList.contains('hidden')) {
                                showProfileModal(); // Re-render to show Discord status
                            }

                            showNotif('Success', `✅ เชื่อมต่อ Discord สำเร็จ: ${data.discordUsername}`);
                        }
                    }
                } catch (e) {
                    console.error('Error checking discord link:', e);
                }
            }

            function updateDiscordLinkUI() {
                const notLinked = document.getElementById('discord-not-linked');
                const linked = document.getElementById('discord-linked');
                const avatar = document.getElementById('discord-linked-avatar');
                const username = document.getElementById('discord-linked-username');

                if (!notLinked || !linked) return;

                if (currentUser?.discordId && currentUser?.discordUsername) {
                    notLinked.classList.add('hidden');
                    linked.classList.remove('hidden');
                    if (avatar) avatar.src = currentUser.discordAvatar || `https://cdn.discordapp.com/embed/avatars/0.png`;
                    if (username) username.textContent = currentUser.discordUsername;
                } else {
                    notLinked.classList.remove('hidden');
                    linked.classList.add('hidden');
                }
            }

            async function unlinkDiscord() {
                if (!currentUser?.username) return;

                const conf = await showConfirm('ยกเลิกการเชื่อมต่อ', 'ต้องการยกเลิกการเชื่อมต่อ Discord หรือไม่?');
                if (!conf) return;

                try {
                    await db.collection('op_users').doc(currentUser.username).update({
                        discordId: null,
                        discordUsername: null,
                        discordAvatar: null,
                        discordBadge: null,
                        discordLinkedAt: null
                    });

                    currentUser.discordId = null;
                    currentUser.discordUsername = null;
                    currentUser.discordAvatar = null;

                    sessionStorage.setItem('op_session_current', JSON.stringify(currentUser));
                    updateDiscordLinkUI();
                    showNotif('Success', '✅ ยกเลิกการเชื่อมต่อ Discord เรียบร้อย');
                } catch (e) {
                    console.error('Unlink Discord error:', e);
                    showNotif('Error', '❌ เกิดข้อผิดพลาด');
                }
            }

            // Listen for postMessage from OAuth popup
            window.addEventListener('message', (event) => {
                if (event.data && event.data.discordLinked !== undefined) {
                    if (event.data.discordLinked) {
                        refreshDiscordLinkStatus();
                    }
                }
            });
        </script>
</body>

</html>